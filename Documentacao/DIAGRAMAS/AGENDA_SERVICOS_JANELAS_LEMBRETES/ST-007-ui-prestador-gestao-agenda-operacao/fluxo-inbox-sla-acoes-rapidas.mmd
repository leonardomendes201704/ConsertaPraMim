flowchart TD
    A[Prestador abre Minha Agenda] --> B[Carregar agendamentos]
    B --> C[Filtrar pendentes de confirmacao]
    C --> D[Ordenar por SLA de expiracao ascendente]
    D --> E[Renderizar inbox com risco/SLA e acoes rapidas]

    B --> F[Consolidar agendamentos por data local]
    F --> G[Montar calendario semanal]
    F --> H[Montar calendario mensal]
    G --> I[Alternar visualizacao por botao Semanal/Mensal]
    H --> I
    F --> R[Exibir historico recente e motivos por card]
    R --> S[Link para timeline completa em Details]

    E --> J{Acao rapida}
    J -->|Confirmar| K[POST /ServiceRequests/ConfirmAppointment]
    K --> N[Atualizar status para confirmado]

    J -->|Recusar| L[POST /ServiceRequests/RejectAppointment]
    L --> O[Registrar motivo e status recusado]

    J -->|Propor novo horario| M[POST /ServiceRequests/RequestAppointmentReschedule]
    M --> P[Salvar janela proposta e motivo]

    N --> Q[Recarregar agenda com feedback]
    O --> Q
    P --> Q
    S --> Q

    T[Cliente cria agendamento] --> U[ServiceAppointmentService.CreateAsync]
    U --> V[HubNotificationService envia ReceiveNotification para grupo do prestador]
    V --> W[Layout do prestador recebe evento cpm:notification]
    W --> X{Subject indica novo agendamento pendente?}
    X -->|Sim| Y[Agenda exibe banner real-time com countdown]
    Y --> Z[Recarregar agenda em 3s ou botao Atualizar agora]
    Z --> B
    X -->|Nao| AA[Manter fluxo atual sem refresh automatico]
