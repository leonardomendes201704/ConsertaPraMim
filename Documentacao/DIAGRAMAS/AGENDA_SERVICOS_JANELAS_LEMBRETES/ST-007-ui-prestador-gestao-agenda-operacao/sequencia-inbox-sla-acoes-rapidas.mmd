sequenceDiagram
    autonumber
    actor Cliente
    actor Prestador
    participant UI as Web.Provider Agenda.cshtml
    participant Controller as ServiceRequestsController
    participant ApptSvc as IServiceAppointmentService
    participant RequestSvc as IServiceRequestService
    participant HubNotify as HubNotificationService/NotificationHub

    Prestador->>Controller: GET /ServiceRequests/Agenda
    Controller->>ApptSvc: GetMyAppointmentsAsync(providerId, Provider)
    ApptSvc-->>Controller: Lista de agendamentos
    Controller->>RequestSvc: GetByIdAsync(...) para pendentes
    RequestSvc-->>Controller: Dados do pedido
    Controller-->>UI: PendingConfirmationViewModel + ProviderAppointments
    UI->>UI: Ordenar inbox por SLA
    UI->>UI: Agrupar appointments por data local
    UI->>UI: Renderizar calendario semanal e mensal
    UI->>UI: Renderizar historico recente e motivos por agendamento
    UI-->>Prestador: Inbox com SLA + calendario consolidado

    alt Confirmar
        Prestador->>Controller: POST ConfirmAppointment(appointmentId, requestId)
        Controller->>ApptSvc: ConfirmAsync(providerId, Provider, appointmentId)
        ApptSvc-->>Controller: OperationResult
        Controller-->>Prestador: Redirect com Success/Error
    else Recusar
        Prestador->>Controller: POST RejectAppointment(..., reason)
        Controller->>ApptSvc: RejectAsync(providerId, Provider, appointmentId, reason)
        ApptSvc-->>Controller: OperationResult
        Controller-->>Prestador: Redirect com Success/Error
    else Propor novo horario
        Prestador->>Controller: POST RequestAppointmentReschedule(startLocal, endLocal, reason)
        Controller->>Controller: Converter horario local para UTC
        Controller->>ApptSvc: RequestRescheduleAsync(providerId, Provider, appointmentId, dto)
        ApptSvc-->>Controller: OperationResult
        Controller-->>Prestador: Redirect com Success/Error
    end

    opt Alternar calendario
        Prestador->>UI: Clique em Semanal/Mensal
        UI->>UI: Toggle das visoes sem reload completo
    end

    opt Consultar historico completo
        Prestador->>UI: Clique em "Ver historico completo"
        UI->>Controller: GET /ServiceRequests/Details/{requestId}
        Controller-->>UI: Appointment.History completo
        UI-->>Prestador: Timeline com status, operacional e motivos
    end

    opt Nova solicitacao em tempo real
        Cliente->>ApptSvc: CreateAsync(clientId, requestId, providerId, janela)
        ApptSvc->>HubNotify: SendNotificationAsync(providerId, "Novo agendamento pendente", ...)
        HubNotify-->>UI: ReceiveNotification(payload)
        UI->>UI: Dispatch cpm:notification
        UI->>UI: Detectar payload de pendencia
        UI->>UI: Exibir banner e iniciar countdown de 3s
        UI->>Controller: GET /ServiceRequests/Agenda (auto refresh)
        Controller-->>UI: Inbox atualizada com novo item
        UI-->>Prestador: Card em "Aguardando confirmacao" com SLA
    end
