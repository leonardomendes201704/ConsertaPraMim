# Admin Portal Changelog

## Como usar

1. Concluiu uma story: mover para `STORIES/DONE/`.
2. Adicionar uma nova entrada em `Unreleased`.
3. Em release, mover blocos de `Unreleased` para uma secao versionada.

## Unreleased

- [2026-02-18] [ST-019] Monitoramento E2E da API com dashboard operacional no portal admin
- Tipo: feat
- Resumo: implementado monitoramento completo de requests da API com middleware global (correlationId, severidade, warnings, sanitizacao), buffer assÃ­ncrono + workers de flush/agregacao/retencao, endpoints admin dedicados (`/api/admin/monitoring/*`), dashboard de monitoramento no Web.Admin, seeds para validacao local, testes unitarios/integracao e diagramas Mermaid (fluxo e sequencia).
- Arquivos principais: `ConsertaPraMim.API/Middleware/RequestTelemetryMiddleware.cs`, `ConsertaPraMim.API/Controllers/AdminMonitoringController.cs`, `ConsertaPraMim.Infrastructure/Services/AdminMonitoringService.cs`, `ConsertaPraMim.Web.Admin/Views/AdminMonitoring/Index.cshtml`, `ConsertaPraMim.Infrastructure/Migrations/20260218192717_AddApiMonitoringTelemetry.cs`, `tests/ConsertaPraMim.Tests.Unit/Middleware/RequestTelemetryMiddlewareTests.cs`, `tests/ConsertaPraMim.Tests.Unit/Integration/Controllers/AdminMonitoringControllerSqliteIntegrationTests.cs`
- Risco/Impacto: medio
- [2026-02-16] [ST-017] Regressao E2E de creditos: concessao admin ate abatimento da mensalidade
- Tipo: test
- Resumo: adicionado teste de integracao SQLite cobrindo o fluxo completo de negocio `admin concede credito -> prestador recebe notificacao -> simulacao de mensalidade consome credito -> saldo/extrato refletem debit`, incluindo ajuste de compatibilidade dos testes com a assinatura atual do `AdminProviderCreditService`.
- Arquivos principais: `tests/ConsertaPraMim.Tests.Unit/Integration/Controllers/AdminProviderCreditsControllerSqliteIntegrationTests.cs`, `tests/ConsertaPraMim.Tests.Unit/Services/AdminProviderCreditServiceTests.cs`, `Documentacao/ADMIN_PORTAL/STORIES/DONE/ST-017-aplicacao-creditos-mensalidade-visibilidade.md`, `Documentacao/ADMIN_PORTAL/INDEX.md`
- Risco/Impacto: baixo
- [2026-02-16] [ST-017] Manual admin atualizado para relatorio consolidado de creditos
- Tipo: docs
- Resumo: manual HTML do portal admin passou a cobrir o relatorio consolidado de uso de creditos (filtros, paginacao, totais), com novo caso QA-ADM-023, ajustes de checklist e troubleshooting especifico.
- Arquivos principais: `ConsertaPraMim.Web.Admin/Views/AdminManual/Index.cshtml`, `Documentacao/ADMIN_PORTAL/STORIES/IN_PROGRESS/ST-017-aplicacao-creditos-mensalidade-visibilidade.md`
- Risco/Impacto: baixo
- [2026-02-16] [ST-017] Relatorio administrativo de uso de creditos com filtros e paginacao
- Tipo: feat
- Resumo: adicionados endpoint/API client e tela administrativa consolidada para uso de creditos por prestador, com filtros de periodo/tipo/status/busca textual, cards de totais, tabela paginada e coexistencia com o extrato individual por email.
- Arquivos principais: `ConsertaPraMim.API/Controllers/AdminProviderCreditsController.cs`, `ConsertaPraMim.Application/Services/AdminProviderCreditService.cs`, `ConsertaPraMim.Web.Admin/Controllers/AdminProviderCreditsController.cs`, `ConsertaPraMim.Web.Admin/Views/AdminProviderCredits/Index.cshtml`, `Documentacao/ADMIN_PORTAL/STORIES/IN_PROGRESS/ST-017-aplicacao-creditos-mensalidade-visibilidade.md`
- Risco/Impacto: medio
- [2026-02-16] [ST-017] KPIs de creditos no dashboard administrativo
- Tipo: feat
- Resumo: dashboard admin passou a exibir KPIs financeiros de creditos (concedidos no periodo, consumidos no periodo, saldo total em aberto e creditos com vencimento nos proximos 30 dias), com calculo consolidado no backend e atualizacao via snapshot/polling.
- Arquivos principais: `ConsertaPraMim.Application/DTOs/AdminDashboardDTOs.cs`, `ConsertaPraMim.Application/Services/AdminDashboardService.cs`, `ConsertaPraMim.Web.Admin/Views/AdminHome/Index.cshtml`, `Documentacao/ADMIN_PORTAL/STORIES/IN_PROGRESS/ST-017-aplicacao-creditos-mensalidade-visibilidade.md`
- Risco/Impacto: medio
- [2026-02-16] [ST-017] UI do prestador para carteira de creditos e extrato operacional
- Tipo: feat
- Resumo: criado modulo `Creditos` no portal do prestador com saldo atual, previsao de abatimento da proxima mensalidade, simulacao de impacto no valor final e extrato paginado/filtravel de movimentacoes (`Concessao`, `Consumo`, `Expiracao`, `Estorno`).
- Arquivos principais: `ConsertaPraMim.Web.Provider/Controllers/ProviderCreditsController.cs`, `ConsertaPraMim.Web.Provider/Models/ProviderCreditsViewModel.cs`, `ConsertaPraMim.Web.Provider/Views/ProviderCredits/Index.cshtml`, `ConsertaPraMim.Web.Provider/Views/Shared/_Layout.cshtml`, `Documentacao/ADMIN_PORTAL/STORIES/IN_PROGRESS/ST-017-aplicacao-creditos-mensalidade-visibilidade.md`
- Risco/Impacto: medio
- [2026-02-16] [ST-017] Expiracao automatica de creditos vencidos na simulacao
- Tipo: feat
- Resumo: antes de calcular/aplicar creditos na simulacao de mensalidade, o motor agora reconcilia o ledger e gera lancamento automatico `Expire` para saldo vencido, evitando abatimento indevido com creditos fora da vigencia.
- Arquivos principais: `ConsertaPraMim.Application/Services/PlanGovernanceService.cs`, `ConsertaPraMim.Domain/Repositories/IProviderCreditRepository.cs`, `ConsertaPraMim.Infrastructure/Repositories/ProviderCreditRepository.cs`, `tests/ConsertaPraMim.Tests.Unit/Services/PlanGovernanceServiceTests.cs`
- Risco/Impacto: medio
- [2026-02-16] [ST-017] Consumo opcional de creditos no simulador de mensalidade
- Tipo: feat
- Resumo: adicionada flag `consumeCredits` na simulacao de mensalidade para efetivar debito no ledger de creditos do prestador, com validacao de `ProviderUserId`, consumo atomico (respeitando saldo corrente) e retorno de telemetria de consumo (`creditsConsumed`, `creditsConsumptionEntryId`).
- Arquivos principais: `ConsertaPraMim.Application/Services/PlanGovernanceService.cs`, `ConsertaPraMim.Application/DTOs/PlanGovernanceDTOs.cs`, `ConsertaPraMim.Web.Admin/Controllers/AdminPlanGovernanceController.cs`, `ConsertaPraMim.Web.Admin/Models/AdminOperationsViewModels.cs`, `ConsertaPraMim.Web.Admin/Views/AdminPlanGovernance/Index.cshtml`, `tests/ConsertaPraMim.Tests.Unit/Services/PlanGovernanceServiceTests.cs`
- Risco/Impacto: medio
- [2026-02-16] [ST-017] Simulacao de mensalidade com aplicacao de creditos do prestador
- Tipo: feat
- Resumo: motor de simulacao de governanca comercial passou a aplicar saldo de creditos (quando `ProviderUserId` informado), mantendo ordem de calculo base -> promocao -> cupom -> credito, com novos campos de transparencia (`priceBeforeCredits`, `availableCredits`, `creditsApplied`, `creditsRemaining`) e cobertura de testes unitarios.
- Arquivos principais: `ConsertaPraMim.Application/Services/PlanGovernanceService.cs`, `ConsertaPraMim.Application/DTOs/PlanGovernanceDTOs.cs`, `ConsertaPraMim.Web.Admin/Views/AdminPlanGovernance/Index.cshtml`, `tests/ConsertaPraMim.Tests.Unit/Services/PlanGovernanceServiceTests.cs`, `Documentacao/ADMIN_PORTAL/STORIES/IN_PROGRESS/ST-017-aplicacao-creditos-mensalidade-visibilidade.md`
- Risco/Impacto: medio
- [2026-02-16] [ST-016] Backend inicial para concessao/estorno administrativo de creditos
- Tipo: feat
- Resumo: adicionados endpoints admin para concessao (`grants`) e estorno (`reversals`) com validacoes de negocio, template de notificacao por tipo de concessao, trilha de auditoria `before/after` e testes unitarios iniciais do fluxo.
- Arquivos principais: `ConsertaPraMim.API/Controllers/AdminProviderCreditsController.cs`, `ConsertaPraMim.Application/Services/AdminProviderCreditService.cs`, `ConsertaPraMim.Application/DTOs/AdminProviderCreditsDTOs.cs`, `ConsertaPraMim.Domain/Enums/ProviderCreditGrantType.cs`, `tests/ConsertaPraMim.Tests.Unit/Services/AdminProviderCreditServiceTests.cs`, `Documentacao/ADMIN_PORTAL/STORIES/DONE/ST-016-concessao-admin-creditos-notificacao-premio.md`
- Risco/Impacto: medio
- [2026-02-16] [ST-016] UI admin para concessao/estorno e consulta de creditos por prestador
- Tipo: feat
- Resumo: criado modulo web `Creditos` no portal admin com busca por prestador, saldo, extrato paginado, filtros operacionais (periodo/tipo/status) e modais para concessao/estorno com validacao de payload; manual operacional/QA atualizado com os novos fluxos.
- Arquivos principais: `ConsertaPraMim.Web.Admin/Controllers/AdminProviderCreditsController.cs`, `ConsertaPraMim.Web.Admin/Views/AdminProviderCredits/Index.cshtml`, `ConsertaPraMim.Web.Admin/Views/Shared/_Layout.cshtml`, `ConsertaPraMim.Web.Admin/Views/AdminManual/Index.cshtml`, `Documentacao/ADMIN_PORTAL/STORIES/DONE/ST-016-concessao-admin-creditos-notificacao-premio.md`
- Risco/Impacto: medio
- [2026-02-16] [ST-016] Testes de integracao da API de creditos e notificacao de premio
- Tipo: test
- Resumo: adicionados testes SQLite de integracao para `AdminProviderCreditsController` cobrindo concessao via endpoint admin, atualizacao de saldo/extrato, auditoria e envio de notificacao realtime (`HubNotificationService`), alem de cenario de estorno com saldo insuficiente sem notificacao.
- Arquivos principais: `tests/ConsertaPraMim.Tests.Unit/Integration/Controllers/AdminProviderCreditsControllerSqliteIntegrationTests.cs`, `Documentacao/ADMIN_PORTAL/STORIES/DONE/ST-016-concessao-admin-creditos-notificacao-premio.md`, `Documentacao/ADMIN_PORTAL/INDEX.md`
- Risco/Impacto: baixo
- [2026-02-16] [ST-014] Revisao periodica do manual operacional/QA
- Tipo: docs
- Resumo: manual HTML revisado para refletir entregas ST-011/ST-013/ST-015, incluindo creditos via API admin, novos casos QA/checklist, troubleshooting e historico formal de revisoes.
- Arquivos principais: `ConsertaPraMim.Web.Admin/Views/AdminManual/Index.cshtml`, `Documentacao/ADMIN_PORTAL/STORIES/DONE/ST-014-manual-html-operacao-qa-portal-admin.md`, `Documentacao/ADMIN_PORTAL/INDEX.md`
- Risco/Impacto: baixo
- [2026-02-14] [ST-014] Manual HTML completo de operacao e QA no portal admin
- Tipo: docs
- Resumo: criado manual operacional/QA em HTML dentro do `ConsertaPraMim.Web.Admin`, com cobertura de todos os modulos do admin, casos de uso, casos de teste funcionais, checklist de operacao, troubleshooting e regra obrigatoria de atualizacao do manual em toda mudanca funcional.
- Arquivos principais: `ConsertaPraMim.Web.Admin/Controllers/AdminManualController.cs`, `ConsertaPraMim.Web.Admin/Views/AdminManual/Index.cshtml`, `ConsertaPraMim.Web.Admin/Views/Shared/_Layout.cshtml`, `Documentacao/ADMIN_PORTAL/EPICS/EPIC-005-manual-operacional-qa-portal-admin.md`, `Documentacao/ADMIN_PORTAL/STORIES/DONE/ST-014-manual-html-operacao-qa-portal-admin.md`
- Risco/Impacto: baixo
- [2026-02-14] [ST-012] KPI de renda mensal de assinaturas no dashboard admin
- Tipo: feat
- Resumo: adicionado calculo de receita mensal estimada por planos (`Bronze`, `Silver`, `Gold`) no dashboard admin, com breakdown por plano e total de prestadores assinantes; seed ajustado para incluir prestador em plano `Gold` e seeder auxiliar atualizado para plano pagante.
- Arquivos principais: `ConsertaPraMim.Application/Services/AdminDashboardService.cs`, `ConsertaPraMim.Application/DTOs/AdminDashboardDTOs.cs`, `ConsertaPraMim.Web.Admin/Views/AdminHome/Index.cshtml`, `ConsertaPraMim.Infrastructure/Data/DbInitializer.cs`, `ConsertaPraMim.DatabaseSeeder/Program.cs`
- Risco/Impacto: medio
- [2026-02-13] [ST-001] Hardening inicial de seguranca para Admin
- Tipo: feat
- Resumo: bloqueio de auto-cadastro com role Admin, policy `AdminOnly` criada e seed de admin controlado por ambiente/config.
- Arquivos principais: `ConsertaPraMim.Application/Services/AuthService.cs`, `ConsertaPraMim.API/Controllers/AuthController.cs`, `ConsertaPraMim.Infrastructure/Data/DbInitializer.cs`, `ConsertaPraMim.Web.Provider/Controllers/AdminController.cs`
- Risco/Impacto: medio
- [2026-02-13] [ST-001] Cobertura de autorizacao para usuario nao-admin em rotas admin
- Tipo: test
- Resumo: adicionado teste de autorizacao para validar que usuarios nao-admin falham na policy `AdminOnly` e usuarios admin sao autorizados.
- Arquivos principais: `ConsertaPraMim.Tests.Unit/Services/AdminAuthorizationPolicyTests.cs`
- Risco/Impacto: baixo
- [2026-02-13] [ST-002] Bootstrap do novo portal web admin
- Tipo: feat
- Resumo: criado projeto `ConsertaPraMim.Web.Admin` com cookie auth, policy `AdminOnly`, login admin e dashboard inicial.
- Arquivos principais: `ConsertaPraMim.Web.Admin/Program.cs`, `ConsertaPraMim.Web.Admin/Controllers/AccountController.cs`, `ConsertaPraMim.Web.Admin/Controllers/AdminHomeController.cs`, `ConsertaPraMim.Web.Admin/Views/Shared/_Layout.cshtml`
- Risco/Impacto: medio
- [2026-02-13] [ST-003] API de dashboard administrativo com filtros e eventos paginados
- Tipo: feat
- Resumo: criado endpoint `GET /api/admin/dashboard` protegido por `AdminOnly`, com agregados de usuarios/pedidos/propostas/chat e eventos recentes paginados com filtros.
- Arquivos principais: `ConsertaPraMim.API/Controllers/AdminDashboardController.cs`, `ConsertaPraMim.Application/Services/AdminDashboardService.cs`, `ConsertaPraMim.Application/DTOs/AdminDashboardDTOs.cs`, `ConsertaPraMim.Infrastructure/Repositories/ProposalRepository.cs`
- Risco/Impacto: medio
- [2026-02-13] [ST-004] API Admin para gestao de usuarios com auditoria
- Tipo: feat
- Resumo: adicionados endpoints admin para listar/filtrar usuarios, detalhe por id e alteracao de status com regras de seguranca (ultimo admin e auto-bloqueio) e registro de auditoria.
- Arquivos principais: `ConsertaPraMim.API/Controllers/AdminUsersController.cs`, `ConsertaPraMim.Application/Services/AdminUserService.cs`, `ConsertaPraMim.Domain/Entities/AdminAuditLog.cs`, `ConsertaPraMim.Infrastructure/Migrations/20260213021345_AddAdminAuditLogs.cs`
- Risco/Impacto: medio
- [2026-02-13] [ST-005] API Admin para gestao de pedidos e propostas
- Tipo: feat
- Resumo: criados endpoints admin para listagem/detalhe de pedidos, alteracao administrativa de status, listagem de propostas e invalidacao com auditoria e regras de seguranca.
- Arquivos principais: `ConsertaPraMim.API/Controllers/AdminServiceRequestsController.cs`, `ConsertaPraMim.API/Controllers/AdminProposalsController.cs`, `ConsertaPraMim.Application/Services/AdminRequestProposalService.cs`, `ConsertaPraMim.Infrastructure/Migrations/20260213110423_AddProposalInvalidation.cs`
- Risco/Impacto: medio
- [2026-02-13] [ST-006] API Admin para monitoramento de chats e notificacao manual
- Tipo: feat
- Resumo: adicionados endpoints admin para listagem/detalhe de conversas, consulta de anexos com filtros, envio manual de notificacao para usuario e auditoria com mascaramento de dados sensiveis.
- Arquivos principais: `ConsertaPraMim.API/Controllers/AdminChatsController.cs`, `ConsertaPraMim.API/Controllers/AdminChatAttachmentsController.cs`, `ConsertaPraMim.API/Controllers/AdminNotificationsController.cs`, `ConsertaPraMim.Application/Services/AdminChatNotificationService.cs`
- Risco/Impacto: medio
- [2026-02-13] [ST-007] Dashboard web admin integrado com API e polling
- Tipo: feat
- Resumo: dashboard do `ConsertaPraMim.Web.Admin` passou a consumir `GET /api/admin/dashboard` com filtros, cards KPI, tabela de eventos e estados de loading/erro/vazio com atualizacao automatica via polling controlado.
- Arquivos principais: `ConsertaPraMim.Web.Admin/Controllers/AdminHomeController.cs`, `ConsertaPraMim.Web.Admin/Views/AdminHome/Index.cshtml`, `ConsertaPraMim.Web.Admin/Services/AdminDashboardApiClient.cs`, `ConsertaPraMim.Web.Admin/Controllers/AccountController.cs`
- Risco/Impacto: medio
- [2026-02-13] [ST-008] UI Admin para operacao de usuarios
- Tipo: feat
- Resumo: implementada tela de usuarios no portal admin com filtros e paginacao, detalhe de usuario, acao de ativar/desativar com confirmacao e atualizacao da linha sem refresh completo.
- Arquivos principais: `ConsertaPraMim.Web.Admin/Controllers/AdminUsersController.cs`, `ConsertaPraMim.Web.Admin/Views/AdminUsers/Index.cshtml`, `ConsertaPraMim.Web.Admin/Views/AdminUsers/Details.cshtml`, `ConsertaPraMim.Web.Admin/Services/AdminUsersApiClient.cs`
- Risco/Impacto: medio
- [2026-02-13] [ST-009] UI Admin para operacao de pedidos, propostas e conversas
- Tipo: feat
- Resumo: criados modulos web admin para pedidos, propostas e conversas com filtros, detalhes, acoes administrativas com confirmacao, envio de notificacao manual e navegacao cruzada entre usuario, pedido, proposta e chat.
- Arquivos principais: `ConsertaPraMim.Web.Admin/Controllers/AdminServiceRequestsController.cs`, `ConsertaPraMim.Web.Admin/Controllers/AdminProposalsController.cs`, `ConsertaPraMim.Web.Admin/Controllers/AdminChatsController.cs`, `ConsertaPraMim.Web.Admin/Services/AdminOperationsApiClient.cs`
- Risco/Impacto: medio
- [2026-02-13] [ST-010] Auditoria final, QA de seguranca e rollout com desativacao do admin legado
- Tipo: feat
- Resumo: padronizado metadata de auditoria com `before/after` nas acoes sensiveis, adicionados logs estruturados para operacao/incidentes, criada feature flag `LegacyAdmin:Enabled` no portal do prestador, adicionados testes automatizados de autorizacao/feature flag e publicado runbook de deploy/rollback.
- Arquivos principais: `ConsertaPraMim.Application/Services/AdminUserService.cs`, `ConsertaPraMim.Application/Services/AdminRequestProposalService.cs`, `ConsertaPraMim.Application/Services/AdminChatNotificationService.cs`, `ConsertaPraMim.Web.Provider/Controllers/AdminController.cs`, `ConsertaPraMim.Tests.Unit/Services/ProviderLegacyAdminFeatureFlagTests.cs`, `Documentacao/ADMIN_PORTAL/RUNBOOKS/DEPLOY_ROLLBACK_ST-010.md`
- Risco/Impacto: medio

## Template de entrada

- `[YYYY-MM-DD] [ST-XXX] Titulo curto`
- `Tipo: feat|fix|refactor|docs|test`
- `Resumo: o que foi entregue`
- `Arquivos principais: caminho1, caminho2`
- `Risco/Impacto: baixo|medio|alto`
