@using System.Globalization
@using System.Linq
@using ConsertaPraMim.Application.DTOs
@model ConsertaPraMim.Web.Admin.Models.AdminDashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    var dashboard = Model.Dashboard;
    var noShowDashboard = Model.NoShowDashboard;
    var noShowThresholds = Model.NoShowAlertThresholds;
    var revenueRows = dashboard?.RevenueByPlan ?? Array.Empty<AdminPlanRevenueDto>();
    var paymentFailureByProviderRows = dashboard?.PaymentFailuresByProvider ?? Array.Empty<AdminPaymentFailureByProviderDto>();
    var paymentFailureByChannelRows = dashboard?.PaymentFailuresByChannel ?? Array.Empty<AdminStatusCountDto>();
    var providerReviewRankingRows = dashboard?.ProviderReviewRanking ?? Array.Empty<AdminReviewRankingItemDto>();
    var clientReviewRankingRows = dashboard?.ClientReviewRanking ?? Array.Empty<AdminReviewRankingItemDto>();
    var reviewOutlierRows = dashboard?.ReviewOutliers ?? Array.Empty<AdminReviewOutlierDto>();
    var totalPaymentFailures = paymentFailureByChannelRows.Sum(item => item.Count);
    var currencyCulture = CultureInfo.GetCultureInfo("pt-BR");
    var fromValue = Model.Filters.FromUtc?.ToString("yyyy-MM-dd") ?? string.Empty;
    var toValue = Model.Filters.ToUtc?.ToString("yyyy-MM-dd") ?? string.Empty;
    var noShowCityValue = Model.Filters.NoShowCity ?? string.Empty;
    var noShowCategoryValue = Model.Filters.NoShowCategory ?? string.Empty;
    var noShowRiskLevelValue = Model.Filters.NoShowRiskLevel ?? "all";
    var noShowQueueTakeValue = Model.Filters.NoShowQueueTake.ToString();
    var noShowCancelWindowValue = Model.Filters.NoShowCancellationWindowHours.ToString();
    var snapshotUrl = Url.Action("Snapshot", "AdminHome") ?? "/AdminHome/Snapshot";
    var updateNoShowThresholdsUrl = Url.Action("UpdateNoShowThresholds", "AdminHome") ?? "/AdminHome/UpdateNoShowThresholds";
    var thresholdNoShowWarning = (noShowThresholds?.NoShowRateWarningPercent ?? 20m).ToString(CultureInfo.InvariantCulture);
    var thresholdNoShowCritical = (noShowThresholds?.NoShowRateCriticalPercent ?? 30m).ToString(CultureInfo.InvariantCulture);
    var thresholdQueueWarning = (noShowThresholds?.HighRiskQueueWarningCount ?? 10).ToString(CultureInfo.InvariantCulture);
    var thresholdQueueCritical = (noShowThresholds?.HighRiskQueueCriticalCount ?? 20).ToString(CultureInfo.InvariantCulture);
    var thresholdReminderWarning = (noShowThresholds?.ReminderSendSuccessWarningPercent ?? 95m).ToString(CultureInfo.InvariantCulture);
    var thresholdReminderCritical = (noShowThresholds?.ReminderSendSuccessCriticalPercent ?? 90m).ToString(CultureInfo.InvariantCulture);
    var thresholdNotes = noShowThresholds?.Notes ?? string.Empty;
}

<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
    }

    @@media (min-width: 576px) {
        .metrics-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    @@media (min-width: 992px) {
        .metrics-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
    }

    @@media (min-width: 1200px) {
        .metrics-grid {
            grid-template-columns: repeat(5, minmax(0, 1fr));
        }
    }

    .metric-card {
        --metric-gradient: linear-gradient(135deg, #ecf2ff 0%, #dfe9ff 100%);
        border: 0;
        border-radius: 14px;
        box-shadow: 0 10px 20px rgba(15, 23, 42, .10);
        min-height: 148px;
        background: var(--metric-gradient);
        position: relative;
        overflow: hidden;
        isolation: isolate;
    }

    .metric-card::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 14px;
        background: linear-gradient(155deg, rgba(255, 255, 255, .42) 0%, rgba(255, 255, 255, 0) 62%);
        z-index: 0;
    }

    .metric-card .card-body {
        position: relative;
        z-index: 2;
    }

    .metric-title {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: .05em;
        color: #516079;
    }

    .metric-value {
        font-size: 1.95rem;
        font-weight: 800;
        color: #1e293b;
        line-height: 1.1;
    }

    .metric-subtitle {
        color: #52637f;
        font-size: .85rem;
    }

    .metric-bg-icon {
        position: absolute;
        right: -30px;
        bottom: -36px;
        font-size: 8.88rem;
        line-height: 1;
        color: rgba(30, 41, 59, .14);
        transform: rotate(-25deg);
        z-index: 1;
        pointer-events: none;
        user-select: none;
    }

    .metric-card--users {
        --metric-gradient: linear-gradient(135deg, #ebf3ff 0%, #dfeaff 100%);
    }

    .metric-card--online {
        --metric-gradient: linear-gradient(135deg, #e9f8ef 0%, #daf2e5 100%);
    }

    .metric-card--requests {
        --metric-gradient: linear-gradient(135deg, #fff8e8 0%, #feeecf 100%);
    }

    .metric-card--proposals {
        --metric-gradient: linear-gradient(135deg, #fff3eb 0%, #ffe5d6 100%);
    }

    .metric-card--chat {
        --metric-gradient: linear-gradient(135deg, #ebf8fc 0%, #dceff8 100%);
    }

    .metric-card--credits-granted {
        --metric-gradient: linear-gradient(135deg, #eef9f3 0%, #ddf2e6 100%);
    }

    .metric-card--credits-consumed {
        --metric-gradient: linear-gradient(135deg, #fff3ee 0%, #ffe4d8 100%);
    }

    .metric-card--credits-open {
        --metric-gradient: linear-gradient(135deg, #edf4ff 0%, #dce9ff 100%);
    }

    .metric-card--credits-expiring {
        --metric-gradient: linear-gradient(135deg, #fff9ec 0%, #fff0d5 100%);
    }

    .metric-card--agenda-ops {
        --metric-gradient: linear-gradient(135deg, #eef2ff 0%, #e1f6ea 100%);
    }

    .widget-card {
        border: 0;
        border-radius: 14px;
        box-shadow: 0 10px 22px rgba(15, 23, 42, .08);
        overflow: hidden;
    }

    .event-table th {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: .04em;
        color: #64748b;
        border-top: 0;
    }

    .event-table td {
        vertical-align: middle;
    }

    .request-status-list li {
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .request-status-list li:last-child {
        border-bottom: 0;
    }

    .revenue-table th {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: .04em;
        color: #64748b;
        border-top: 0;
        white-space: nowrap;
    }

    .revenue-total {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1.1;
        color: #0f172a;
    }

    .dashboard-state {
        border-radius: 12px;
    }

    .no-show-grid {
        display: grid;
        grid-template-columns: repeat(1, minmax(0, 1fr));
        gap: 12px;
    }

    @@media (min-width: 768px) {
        .no-show-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    @@media (min-width: 1200px) {
        .no-show-grid {
            grid-template-columns: repeat(5, minmax(0, 1fr));
        }
    }

    .no-show-card {
        border: 0;
        border-radius: 14px;
        box-shadow: 0 8px 18px rgba(15, 23, 42, .08);
        background: #f8fafc;
    }

    .no-show-card .title {
        font-size: .74rem;
        text-transform: uppercase;
        letter-spacing: .05em;
        color: #64748b;
    }

    .no-show-card .value {
        font-size: 1.6rem;
        font-weight: 800;
        color: #0f172a;
    }

    .no-show-card .sub {
        font-size: .8rem;
        color: #64748b;
    }

    .no-show-threshold-form .form-label {
        font-size: .78rem;
        text-transform: uppercase;
        letter-spacing: .04em;
        color: #64748b;
    }

    .threshold-hint {
        font-size: .75rem;
        color: #64748b;
    }

    .threshold-summary .badge {
        font-size: .72rem;
    }

    @@media (max-width: 768px) {
        .metric-value {
            font-size: 1.7rem;
        }
    }
</style>

<div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
    <div>
        <h1 class="h4 fw-bold mb-1">Dashboard Administrativo</h1>
        <p class="text-muted mb-0">Visao consolidada de usuarios, operacao e conversas.</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="refresh-dashboard-btn">
            <i class="fas fa-rotate-right"></i> Atualizar
        </button>
        <span class="text-muted small" id="last-updated-label">
            Atualizado em @(Model.LastUpdatedUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss"))
        </span>
    </div>
</div>

<form id="dashboard-filters" class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-12 col-md-2">
                <label class="form-label fw-semibold" for="fromUtc">De</label>
                <input class="form-control" type="date" id="fromUtc" name="fromUtc" value="@fromValue" />
            </div>
            <div class="col-12 col-md-2">
                <label class="form-label fw-semibold" for="toUtc">Ate</label>
                <input class="form-control" type="date" id="toUtc" name="toUtc" value="@toValue" />
            </div>
            <div class="col-12 col-md-2">
                <label class="form-label fw-semibold" for="eventType">Evento</label>
                <select class="form-select" id="eventType" name="eventType">
                    @if (Model.Filters.EventType == "all")
                    {
                        <option value="all" selected>Todos</option>
                    }
                    else
                    {
                        <option value="all">Todos</option>
                    }

                    @if (Model.Filters.EventType == "request")
                    {
                        <option value="request" selected>Pedidos</option>
                    }
                    else
                    {
                        <option value="request">Pedidos</option>
                    }

                    @if (Model.Filters.EventType == "proposal")
                    {
                        <option value="proposal" selected>Propostas</option>
                    }
                    else
                    {
                        <option value="proposal">Propostas</option>
                    }

                    @if (Model.Filters.EventType == "chat")
                    {
                        <option value="chat" selected>Chats</option>
                    }
                    else
                    {
                        <option value="chat">Chats</option>
                    }
                </select>
            </div>
            <div class="col-12 col-md-2">
                <label class="form-label fw-semibold" for="operationalStatus">Status operacional</label>
                <select class="form-select" id="operationalStatus" name="operationalStatus">
                    @if (Model.Filters.OperationalStatus == "all")
                    {
                        <option value="all" selected>Todos</option>
                    }
                    else
                    {
                        <option value="all">Todos</option>
                    }

                    @if (Model.Filters.OperationalStatus == "OnTheWay")
                    {
                        <option value="OnTheWay" selected>A caminho</option>
                    }
                    else
                    {
                        <option value="OnTheWay">A caminho</option>
                    }

                    @if (Model.Filters.OperationalStatus == "OnSite")
                    {
                        <option value="OnSite" selected>No local</option>
                    }
                    else
                    {
                        <option value="OnSite">No local</option>
                    }

                    @if (Model.Filters.OperationalStatus == "InService")
                    {
                        <option value="InService" selected>Em atendimento</option>
                    }
                    else
                    {
                        <option value="InService">Em atendimento</option>
                    }

                    @if (Model.Filters.OperationalStatus == "WaitingParts")
                    {
                        <option value="WaitingParts" selected>Aguardando peca</option>
                    }
                    else
                    {
                        <option value="WaitingParts">Aguardando peca</option>
                    }

                    @if (Model.Filters.OperationalStatus == "Completed")
                    {
                        <option value="Completed" selected>Concluido</option>
                    }
                    else
                    {
                        <option value="Completed">Concluido</option>
                    }
                </select>
            </div>
            <div class="col-12 col-md-2">
                <label class="form-label fw-semibold" for="searchTerm">Busca</label>
                <input class="form-control" type="text" id="searchTerm" name="searchTerm" placeholder="Titulo ou descricao" value="@Model.Filters.SearchTerm" />
            </div>
            <div class="col-12 col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Aplicar
                </button>
            </div>
        </div>
        <input type="hidden" id="page" name="page" value="@Model.Filters.Page" />
        <input type="hidden" id="pageSize" name="pageSize" value="@Model.Filters.PageSize" />

        <hr class="my-4" />
        <div class="row g-3 align-items-end">
            <div class="col-12 col-md-3">
                <label class="form-label fw-semibold" for="noShowCity">No-show: Cidade</label>
                <input class="form-control" type="text" id="noShowCity" name="noShowCity" value="@noShowCityValue" placeholder="Ex.: Praia Grande" />
            </div>
            <div class="col-12 col-md-3">
                <label class="form-label fw-semibold" for="noShowCategory">No-show: Categoria</label>
                <input class="form-control" type="text" id="noShowCategory" name="noShowCategory" value="@noShowCategoryValue" placeholder="Ex.: Hidraulica" />
            </div>
            <div class="col-12 col-md-2">
                <label class="form-label fw-semibold" for="noShowRiskLevel">No-show: Risco</label>
                <select class="form-select" id="noShowRiskLevel" name="noShowRiskLevel">
                    @if (noShowRiskLevelValue == "all")
                    {
                        <option value="all" selected>Todos</option>
                    }
                    else
                    {
                        <option value="all">Todos</option>
                    }
                    @if (noShowRiskLevelValue == "Low")
                    {
                        <option value="Low" selected>Baixo</option>
                    }
                    else
                    {
                        <option value="Low">Baixo</option>
                    }
                    @if (noShowRiskLevelValue == "Medium")
                    {
                        <option value="Medium" selected>Medio</option>
                    }
                    else
                    {
                        <option value="Medium">Medio</option>
                    }
                    @if (noShowRiskLevelValue == "High")
                    {
                        <option value="High" selected>Alto</option>
                    }
                    else
                    {
                        <option value="High">Alto</option>
                    }
                </select>
            </div>
            <div class="col-12 col-md-2">
                <label class="form-label fw-semibold" for="noShowQueueTake">Fila (max)</label>
                <input class="form-control" type="number" min="1" max="500" id="noShowQueueTake" name="noShowQueueTake" value="@noShowQueueTakeValue" />
            </div>
            <div class="col-12 col-md-2">
                <label class="form-label fw-semibold" for="noShowCancellationNoShowWindowHours">Cancelamento no-show (h)</label>
                <input class="form-control" type="number" min="1" max="168" id="noShowCancellationNoShowWindowHours" name="noShowCancellationNoShowWindowHours" value="@noShowCancelWindowValue" />
            </div>
        </div>
    </div>
</form>

<div id="loading-state" class="alert alert-info dashboard-state d-none">
    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    Atualizando dashboard...
</div>

<div id="error-state" class="alert alert-danger dashboard-state @(Model.HasError ? string.Empty : "d-none")">
    @Model.ErrorMessage
</div>

<section id="dashboard-content" class="@(Model.HasData ? string.Empty : "d-none")">
    <div class="metrics-grid mb-4">
        <div>
            <div class="metric-card metric-card--users card">
                <div class="card-body">
                    <div class="metric-title mb-2">Usuarios Totais</div>
                    <div class="metric-value" data-kpi-total-users>@(dashboard?.TotalUsers ?? 0)</div>
                    <div class="metric-subtitle mt-2">Ativos: <span data-kpi-active-users>@(dashboard?.ActiveUsers ?? 0)</span></div>
                </div>
                <i class="metric-bg-icon fas fa-users" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--online card">
                <div class="card-body">
                    <div class="metric-title mb-2">Usuarios Online</div>
                    <div class="metric-value" data-kpi-online-total>@((dashboard?.OnlineClients ?? 0) + (dashboard?.OnlineProviders ?? 0))</div>
                    <div class="metric-subtitle mt-2">Clientes Online: <span data-kpi-online-clients>@(dashboard?.OnlineClients ?? 0)</span></div>
                    <div class="metric-subtitle">Prestadores Online: <span data-kpi-online-providers>@(dashboard?.OnlineProviders ?? 0)</span></div>
                </div>
                <i class="metric-bg-icon fas fa-user-check" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--requests card">
                <div class="card-body">
                    <div class="metric-title mb-2">Pedidos Ativos</div>
                    <div class="metric-value" data-kpi-active-requests>@(dashboard?.ActiveRequests ?? 0)</div>
                    <div class="metric-subtitle mt-2">No periodo: <span data-kpi-requests-period>@(dashboard?.RequestsInPeriod ?? 0)</span></div>
                </div>
                <i class="metric-bg-icon fas fa-clipboard-list" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--proposals card">
                <div class="card-body">
                    <div class="metric-title mb-2">Propostas Aceitas</div>
                    <div class="metric-value" data-kpi-accepted-proposals>@(dashboard?.AcceptedProposalsInPeriod ?? 0)</div>
                    <div class="metric-subtitle mt-2">No periodo: <span data-kpi-proposals-period>@(dashboard?.ProposalsInPeriod ?? 0)</span></div>
                </div>
                <i class="metric-bg-icon fas fa-handshake" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--chat card">
                <div class="card-body">
                    <div class="metric-title mb-2">Conversas Ativas</div>
                    <div class="metric-value" data-kpi-active-chat>@(dashboard?.ActiveChatConversationsLast24h ?? 0)</div>
                    <div class="metric-subtitle mt-2">Ultimas 24 horas</div>
                </div>
                <i class="metric-bg-icon fas fa-comments" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--credits-granted card">
                <div class="card-body">
                    <div class="metric-title mb-2">Creditos Concedidos</div>
                    <div class="metric-value" data-kpi-credits-granted>@((dashboard?.CreditsGrantedInPeriod ?? 0m).ToString("C", currencyCulture))</div>
                    <div class="metric-subtitle mt-2">No periodo filtrado</div>
                </div>
                <i class="metric-bg-icon fas fa-gift" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--credits-consumed card">
                <div class="card-body">
                    <div class="metric-title mb-2">Creditos Consumidos</div>
                    <div class="metric-value" data-kpi-credits-consumed>@((dashboard?.CreditsConsumedInPeriod ?? 0m).ToString("C", currencyCulture))</div>
                    <div class="metric-subtitle mt-2">Debitos de mensalidade/ajustes</div>
                </div>
                <i class="metric-bg-icon fas fa-coins" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--credits-open card">
                <div class="card-body">
                    <div class="metric-title mb-2">Saldo em Aberto</div>
                    <div class="metric-value" data-kpi-credits-open>@((dashboard?.CreditsOpenBalance ?? 0m).ToString("C", currencyCulture))</div>
                    <div class="metric-subtitle mt-2">Carteira total dos prestadores</div>
                </div>
                <i class="metric-bg-icon fas fa-wallet" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--credits-expiring card">
                <div class="card-body">
                    <div class="metric-title mb-2">Creditos a Expirar</div>
                    <div class="metric-value" data-kpi-credits-expiring>@((dashboard?.CreditsExpiringInNext30Days ?? 0m).ToString("C", currencyCulture))</div>
                    <div class="metric-subtitle mt-2">Vencimento nos proximos 30 dias</div>
                </div>
                <i class="metric-bg-icon fas fa-hourglass-half" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--agenda-ops card">
                <div class="card-body">
                    <div class="metric-title mb-2">Operacao da Agenda</div>
                    <div class="metric-subtitle mt-2">
                        Confirmacao no SLA:
                        <span class="fw-semibold" data-kpi-appointment-confirmation-sla>@((dashboard?.AppointmentConfirmationInSlaRatePercent ?? 0m).ToString("N1", currencyCulture))%</span>
                    </div>
                    <div class="metric-subtitle">
                        Reagendamento:
                        <span class="fw-semibold" data-kpi-appointment-reschedule-rate>@((dashboard?.AppointmentRescheduleRatePercent ?? 0m).ToString("N1", currencyCulture))%</span>
                    </div>
                    <div class="metric-subtitle">
                        Cancelamento:
                        <span class="fw-semibold" data-kpi-appointment-cancellation-rate>@((dashboard?.AppointmentCancellationRatePercent ?? 0m).ToString("N1", currencyCulture))%</span>
                    </div>
                    <div class="metric-subtitle">
                        Falha de lembrete:
                        <span class="fw-semibold" data-kpi-reminder-failure-rate>@((dashboard?.ReminderFailureRatePercent ?? 0m).ToString("N1", currencyCulture))%</span>
                        <small class="text-muted ms-1">(<span data-kpi-reminder-failures>@(dashboard?.ReminderFailuresInPeriod ?? 0)</span>/<span data-kpi-reminder-attempts>@(dashboard?.ReminderAttemptsInPeriod ?? 0)</span>)</small>
                    </div>
                </div>
                <i class="metric-bg-icon fas fa-calendar-check" aria-hidden="true"></i>
            </div>
        </div>
    </div>

    <div id="no-show-error-state" class="alert alert-warning dashboard-state @(string.IsNullOrWhiteSpace(Model.NoShowErrorMessage) ? "d-none" : string.Empty)">
        @Model.NoShowErrorMessage
    </div>

    <section id="no-show-content" class="mb-4 @(Model.HasNoShowData ? string.Empty : "d-none")">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <h2 class="h5 fw-bold mb-0">Painel Operacional de No-show</h2>
            <span class="text-muted small" id="no-show-range-label">
                @if (noShowDashboard != null)
                {
                    <text>@noShowDashboard.FromUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ate @noShowDashboard.ToUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</text>
                }
            </span>
        </div>

        <div class="no-show-grid mb-3">
            <div class="card no-show-card">
                <div class="card-body">
                    <div class="title mb-1">Taxa de no-show</div>
                    <div class="value" data-no-show-rate>@((noShowDashboard?.NoShowRatePercent ?? 0m).ToString("N1", currencyCulture))%</div>
                    <div class="sub mt-1">No-show: <span data-no-show-count>@(noShowDashboard?.NoShowAppointments ?? 0)</span></div>
                </div>
            </div>
            <div class="card no-show-card">
                <div class="card-body">
                    <div class="title mb-1">Comparecimento</div>
                    <div class="value" data-attendance-rate>@((noShowDashboard?.AttendanceRatePercent ?? 0m).ToString("N1", currencyCulture))%</div>
                    <div class="sub mt-1">Atendidos: <span data-attendance-count>@(noShowDashboard?.AttendanceAppointments ?? 0)</span></div>
                </div>
            </div>
            <div class="card no-show-card">
                <div class="card-body">
                    <div class="title mb-1">Confirmacao dupla</div>
                    <div class="value" data-dual-presence-rate>@((noShowDashboard?.DualPresenceConfirmationRatePercent ?? 0m).ToString("N1", currencyCulture))%</div>
                    <div class="sub mt-1">Confirmados: <span data-dual-presence-count>@(noShowDashboard?.DualPresenceConfirmedAppointments ?? 0)</span></div>
                </div>
            </div>
            <div class="card no-show-card">
                <div class="card-body">
                    <div class="title mb-1">Risco alto</div>
                    <div class="value" data-high-risk-count>@(noShowDashboard?.HighRiskAppointments ?? 0)</div>
                    <div class="sub mt-1">Conversao: <span data-high-risk-conversion>@((noShowDashboard?.HighRiskConversionRatePercent ?? 0m).ToString("N1", currencyCulture))%</span></div>
                </div>
            </div>
            <div class="card no-show-card">
                <div class="card-body">
                    <div class="title mb-1">Fila operacional</div>
                    <div class="value" data-open-queue-count>@(noShowDashboard?.OpenQueueItems ?? 0)</div>
                    <div class="sub mt-1">Idade media: <span data-open-queue-age>@((noShowDashboard?.AverageQueueAgeMinutes ?? 0d).ToString("N1", currencyCulture))</span> min</div>
                </div>
            </div>
        </div>

        <div class="widget-card card mb-3">
            <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-center gap-2">
                <h3 class="h6 fw-semibold mb-0">Thresholds de Alertas Proativos</h3>
                <div class="threshold-summary d-flex flex-wrap gap-2">
                    <span class="badge text-bg-light border">No-show warning: <strong data-threshold-summary-no-show-warning>@(noShowThresholds?.NoShowRateWarningPercent.ToString("N1", currencyCulture) ?? "20,0")%</strong></span>
                    <span class="badge text-bg-light border">No-show critical: <strong data-threshold-summary-no-show-critical>@(noShowThresholds?.NoShowRateCriticalPercent.ToString("N1", currencyCulture) ?? "30,0")%</strong></span>
                    <span class="badge text-bg-light border">Fila warning: <strong data-threshold-summary-queue-warning>@(noShowThresholds?.HighRiskQueueWarningCount ?? 10)</strong></span>
                    <span class="badge text-bg-light border">Fila critical: <strong data-threshold-summary-queue-critical>@(noShowThresholds?.HighRiskQueueCriticalCount ?? 20)</strong></span>
                </div>
            </div>
            <div class="card-body">
                <div id="no-show-threshold-success-state" class="alert alert-success d-none py-2 mb-3"></div>
                <div id="no-show-threshold-error-state" class="alert alert-danger py-2 mb-3 @(string.IsNullOrWhiteSpace(Model.NoShowThresholdErrorMessage) ? "d-none" : string.Empty)">
                    @Model.NoShowThresholdErrorMessage
                </div>

                <form id="no-show-threshold-form" class="no-show-threshold-form">
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-semibold" for="thresholdNoShowRateWarningPercent">Taxa no-show warning (%)</label>
                            <input class="form-control" type="number" step="0.1" min="0" max="100" id="thresholdNoShowRateWarningPercent" value="@thresholdNoShowWarning" />
                            <div class="threshold-hint mt-1">Alerta preventivo quando taxa de no-show atingir este valor.</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-semibold" for="thresholdNoShowRateCriticalPercent">Taxa no-show critical (%)</label>
                            <input class="form-control" type="number" step="0.1" min="0" max="100" id="thresholdNoShowRateCriticalPercent" value="@thresholdNoShowCritical" />
                            <div class="threshold-hint mt-1">Escalonamento imediato quando taxa de no-show atingir este valor.</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-semibold" for="thresholdReminderSendSuccessWarningPercent">Sucesso lembrete warning (%)</label>
                            <input class="form-control" type="number" step="0.1" min="0" max="100" id="thresholdReminderSendSuccessWarningPercent" value="@thresholdReminderWarning" />
                            <div class="threshold-hint mt-1">Warning quando taxa de entrega cair abaixo deste valor.</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-semibold" for="thresholdReminderSendSuccessCriticalPercent">Sucesso lembrete critical (%)</label>
                            <input class="form-control" type="number" step="0.1" min="0" max="100" id="thresholdReminderSendSuccessCriticalPercent" value="@thresholdReminderCritical" />
                            <div class="threshold-hint mt-1">Critical quando taxa de entrega cair abaixo deste valor.</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-semibold" for="thresholdHighRiskQueueWarningCount">Fila de risco warning</label>
                            <input class="form-control" type="number" step="1" min="0" max="100000" id="thresholdHighRiskQueueWarningCount" value="@thresholdQueueWarning" />
                            <div class="threshold-hint mt-1">Warning quando itens abertos atingir este volume.</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-semibold" for="thresholdHighRiskQueueCriticalCount">Fila de risco critical</label>
                            <input class="form-control" type="number" step="1" min="0" max="100000" id="thresholdHighRiskQueueCriticalCount" value="@thresholdQueueCritical" />
                            <div class="threshold-hint mt-1">Critical quando a fila estiver acima deste volume.</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold" for="thresholdNotes">Observacoes</label>
                            <textarea class="form-control" id="thresholdNotes" rows="2" maxlength="1000" placeholder="Ex.: Ajustado apos incidente operacional.">@thresholdNotes</textarea>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button type="submit" class="btn btn-primary" id="save-no-show-threshold-btn">
                            <i class="fas fa-floppy-disk me-1"></i> Salvar thresholds
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-12 col-lg-6">
                <div class="widget-card card h-100">
                    <div class="card-header bg-white">
                        <h3 class="h6 fw-semibold mb-0">No-show por Categoria</h3>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled request-status-list mb-0" id="no-show-category-breakdown">
                            @if (noShowDashboard?.NoShowByCategory?.Any() == true)
                            {
                                @foreach (var item in noShowDashboard.NoShowByCategory)
                                {
                                    <li class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">@item.Name</span>
                                        <span>
                                            <span class="badge bg-danger-subtle text-danger me-1">@item.NoShowAppointments</span>
                                            <span class="badge bg-secondary">@item.NoShowRatePercent.ToString("N1", currencyCulture)%</span>
                                        </span>
                                    </li>
                                }
                            }
                            else
                            {
                                <li class="text-muted">Sem dados por categoria para os filtros selecionados.</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="widget-card card h-100">
                    <div class="card-header bg-white">
                        <h3 class="h6 fw-semibold mb-0">No-show por Cidade</h3>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled request-status-list mb-0" id="no-show-city-breakdown">
                            @if (noShowDashboard?.NoShowByCity?.Any() == true)
                            {
                                @foreach (var item in noShowDashboard.NoShowByCity)
                                {
                                    <li class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">@item.Name</span>
                                        <span>
                                            <span class="badge bg-danger-subtle text-danger me-1">@item.NoShowAppointments</span>
                                            <span class="badge bg-secondary">@item.NoShowRatePercent.ToString("N1", currencyCulture)%</span>
                                        </span>
                                    </li>
                                }
                            }
                            else
                            {
                                <li class="text-muted">Sem dados por cidade para os filtros selecionados.</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="widget-card card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h6 fw-semibold mb-0">Fila de Risco (No-show)</h3>
                <span class="text-muted small">Prioridade: risco alto e score maior</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0 event-table">
                    <thead>
                        <tr>
                            <th>Risco</th>
                            <th>Score</th>
                            <th>Janela</th>
                            <th>Categoria</th>
                            <th>Cidade</th>
                            <th>Prestador</th>
                            <th>Cliente</th>
                            <th>Motivos</th>
                        </tr>
                    </thead>
                    <tbody id="no-show-queue-body">
                        @if (noShowDashboard?.OpenRiskQueue?.Any() == true)
                        {
                            @foreach (var item in noShowDashboard.OpenRiskQueue)
                            {
                                <tr>
                                    <td>
                                        <span class="badge @(item.RiskLevel == "High" ? "bg-danger" : item.RiskLevel == "Medium" ? "bg-warning text-dark" : "bg-success")">
                                            @item.RiskLevel
                                        </span>
                                    </td>
                                    <td>@item.Score</td>
                                    <td>@item.WindowStartUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@item.Category</td>
                                    <td>@item.City</td>
                                    <td>@item.ProviderName</td>
                                    <td>@item.ClientName</td>
                                    <td class="text-muted">@item.Reasons</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr id="no-show-queue-empty">
                                <td colspan="8" class="text-center text-muted py-3">Sem itens na fila de risco para os filtros selecionados.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <div class="row g-3 mb-4">
        <div class="col-12">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Receita Mensal de Assinaturas</h2>
                    <span class="text-muted small">
                        Competencia: @DateTime.UtcNow.ToLocalTime().ToString("MM/yyyy")
                    </span>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-end gap-2 mb-3">
                        <div>
                            <div class="text-muted small text-uppercase">Total mensal estimado</div>
                            <div class="revenue-total" data-kpi-revenue-total>@((dashboard?.MonthlySubscriptionRevenue ?? 0m).ToString("C", currencyCulture))</div>
                        </div>
                        <div class="text-muted small">
                            Prestadores assinantes:
                            <span class="fw-semibold" data-kpi-paying-providers>@(dashboard?.PayingProviders ?? 0)</span>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0 revenue-table">
                            <thead>
                            <tr>
                                <th>Plano</th>
                                <th class="text-end">Prestadores</th>
                                <th class="text-end">Valor Unitario</th>
                                <th class="text-end">Receita Mensal</th>
                            </tr>
                            </thead>
                            <tbody id="subscription-revenue-body">
                            @if (revenueRows.Any())
                            {
                                @foreach (var revenueItem in revenueRows)
                                {
                                    <tr>
                                        <td class="fw-semibold">@revenueItem.Plan</td>
                                        <td class="text-end">@revenueItem.Providers</td>
                                        <td class="text-end">@revenueItem.UnitMonthlyPrice.ToString("C", currencyCulture)</td>
                                        <td class="text-end fw-semibold">@revenueItem.TotalMonthlyRevenue.ToString("C", currencyCulture)</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">Sem assinaturas pagantes no periodo atual.</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white">
                    <h2 class="h6 fw-semibold mb-0">Pedidos por Status</h2>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled request-status-list mb-0" id="request-status-list">
                        @if (dashboard?.RequestsByStatus?.Any() == true)
                        {
                            @foreach (var status in dashboard.RequestsByStatus)
                            {
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">@status.Status</span>
                                    <span class="badge bg-secondary">@status.Count</span>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">Sem dados de status para o filtro selecionado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Pedidos por Categoria</h2>
                    <span class="text-muted small">Maior para menor</span>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled request-status-list mb-0" id="request-category-list">
                        @if (dashboard?.RequestsByCategory?.Any() == true)
                        {
                            @foreach (var category in dashboard.RequestsByCategory)
                            {
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">@category.Category</span>
                                    <span class="badge bg-primary">@category.Count</span>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">Sem dados de categoria para o filtro selecionado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Atendimento Operacional</h2>
                    <span class="text-muted small">Agendamentos</span>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled request-status-list mb-0" id="operational-status-list">
                        @if (dashboard?.AppointmentsByOperationalStatus?.Any() == true)
                        {
                            @foreach (var item in dashboard.AppointmentsByOperationalStatus)
                            {
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">@item.Status</span>
                                    <span class="badge bg-dark">@item.Count</span>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">Sem dados operacionais para o filtro selecionado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-xl-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Ranking de Prestadores</h2>
                    <span class="text-muted small">Media e volume</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 event-table">
                        <thead>
                        <tr>
                            <th>Prestador</th>
                            <th class="text-end">Media</th>
                            <th class="text-end">Reviews</th>
                        </tr>
                        </thead>
                        <tbody id="provider-review-ranking-body">
                        @if (providerReviewRankingRows.Any())
                        {
                            @foreach (var item in providerReviewRankingRows)
                            {
                                <tr>
                                    <td class="fw-semibold">@item.UserName</td>
                                    <td class="text-end">@item.AverageRating.ToString("N2", currencyCulture)</td>
                                    <td class="text-end">@item.TotalReviews</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-center text-muted py-3">Sem ranking de prestadores para o periodo.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Ranking de Clientes</h2>
                    <span class="text-muted small">Media e volume</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 event-table">
                        <thead>
                        <tr>
                            <th>Cliente</th>
                            <th class="text-end">Media</th>
                            <th class="text-end">Reviews</th>
                        </tr>
                        </thead>
                        <tbody id="client-review-ranking-body">
                        @if (clientReviewRankingRows.Any())
                        {
                            @foreach (var item in clientReviewRankingRows)
                            {
                                <tr>
                                    <td class="fw-semibold">@item.UserName</td>
                                    <td class="text-end">@item.AverageRating.ToString("N2", currencyCulture)</td>
                                    <td class="text-end">@item.TotalReviews</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-center text-muted py-3">Sem ranking de clientes para o periodo.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Outliers de Reputacao</h2>
                    <span class="text-muted small">Sinais para analise</span>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled request-status-list mb-0" id="review-outlier-list">
                        @if (reviewOutlierRows.Any())
                        {
                            @foreach (var item in reviewOutlierRows)
                            {
                                <li class="d-flex justify-content-between align-items-center gap-2">
                                    <div>
                                        <div class="fw-semibold">@item.UserName <span class="text-muted small">(@item.UserRole)</span></div>
                                        <div class="small text-muted">@item.Reason</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-danger-subtle text-danger">@item.OneStarRatePercent.ToString("N1", currencyCulture)% 1 estrela</span>
                                    </div>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">Nenhum outlier de reputacao no periodo filtrado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-8">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Falhas de Pagamento por Prestador</h2>
                    <span class="text-muted small">
                        No periodo: <strong data-kpi-payment-failures>@totalPaymentFailures</strong>
                    </span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 event-table">
                        <thead>
                        <tr>
                            <th>Prestador</th>
                            <th class="text-end">Falhas</th>
                            <th class="text-end">Pedidos impactados</th>
                            <th class="text-end">Ultima falha</th>
                        </tr>
                        </thead>
                        <tbody id="payment-failure-provider-body">
                        @if (paymentFailureByProviderRows.Any())
                        {
                            @foreach (var item in paymentFailureByProviderRows)
                            {
                                <tr>
                                    <td class="fw-semibold">@item.ProviderName</td>
                                    <td class="text-end">
                                        <span class="badge bg-danger-subtle text-danger">@item.FailedTransactions</span>
                                    </td>
                                    <td class="text-end">@item.AffectedRequests</td>
                                    <td class="text-end text-muted">
                                        @(item.LastFailureAtUtc.HasValue
                                            ? item.LastFailureAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                            : "-")
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr id="payment-failure-provider-empty">
                                <td colspan="4" class="text-center text-muted py-3">Sem falhas de pagamento no periodo selecionado.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Falhas por Canal</h2>
                    <span class="text-muted small">PIX / Cartao</span>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled request-status-list mb-0" id="payment-failure-channel-list">
                        @if (paymentFailureByChannelRows.Any())
                        {
                            @foreach (var item in paymentFailureByChannelRows)
                            {
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">@item.Status</span>
                                    <span class="badge bg-danger">@item.Count</span>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">Sem falhas por canal no periodo selecionado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Eventos Recentes</h2>
                    <span class="text-muted small" id="range-label">
                        @if (dashboard != null)
                        {
                            <text>@dashboard.FromUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ate @dashboard.ToUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</text>
                        }
                    </span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 event-table">
                        <thead>
                        <tr>
                            <th scope="col">Tipo</th>
                            <th scope="col">Titulo</th>
                            <th scope="col">Descricao</th>
                            <th scope="col">Data</th>
                        </tr>
                        </thead>
                        <tbody id="recent-events-body">
                        @if (dashboard?.RecentEvents?.Any() == true)
                        {
                            @foreach (var eventItem in dashboard.RecentEvents)
                            {
                                <tr>
                                    <td><span class="badge bg-dark">@eventItem.Type</span></td>
                                    <td class="fw-semibold">@eventItem.Title</td>
                                    <td class="text-muted">@eventItem.Description</td>
                                    <td class="text-muted">@eventItem.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr id="events-empty-row">
                                <td colspan="4" class="text-center text-muted py-4">Nenhum evento encontrado para os filtros selecionados.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="empty-state" class="alert alert-secondary dashboard-state @(Model.IsEmpty && !Model.HasError ? string.Empty : "d-none")">
        Nenhum evento disponivel com os filtros atuais. Ajuste periodo, tipo ou busca.
    </div>
</section>

@section Scripts {
    <script>
        (function () {
            const snapshotUrl = "@snapshotUrl";
            const updateNoShowThresholdsUrl = "@updateNoShowThresholdsUrl";
            const form = document.getElementById("dashboard-filters");
            const refreshButton = document.getElementById("refresh-dashboard-btn");
            const loadingState = document.getElementById("loading-state");
            const errorState = document.getElementById("error-state");
            const dashboardContent = document.getElementById("dashboard-content");
            const noShowContent = document.getElementById("no-show-content");
            const noShowErrorState = document.getElementById("no-show-error-state");
            const noShowThresholdForm = document.getElementById("no-show-threshold-form");
            const noShowThresholdSuccessState = document.getElementById("no-show-threshold-success-state");
            const noShowThresholdErrorState = document.getElementById("no-show-threshold-error-state");
            const saveNoShowThresholdButton = document.getElementById("save-no-show-threshold-btn");
            const emptyState = document.getElementById("empty-state");
            const lastUpdatedLabel = document.getElementById("last-updated-label");
            const pollIntervalMs = 30000;

            let requestInFlight = false;
            let pollHandle = null;

            function buildQueryString() {
                const formData = new FormData(form);
                const params = new URLSearchParams();

                for (const [key, value] of formData.entries()) {
                    const stringValue = String(value ?? "").trim();
                    if (stringValue.length > 0) {
                        params.set(key, stringValue);
                    }
                }

                if (!params.has("page")) {
                    params.set("page", "1");
                }

                if (!params.has("pageSize")) {
                    params.set("pageSize", "20");
                }

                return params.toString();
            }

            function setLoadingState(isVisible) {
                loadingState.classList.toggle("d-none", !isVisible);
            }

            function setError(message) {
                if (!message) {
                    errorState.classList.add("d-none");
                    errorState.textContent = "";
                    return;
                }

                errorState.textContent = message;
                errorState.classList.remove("d-none");
            }

            function setNoShowError(message) {
                if (!message) {
                    noShowErrorState.classList.add("d-none");
                    noShowErrorState.textContent = "";
                    return;
                }

                noShowErrorState.textContent = message;
                noShowErrorState.classList.remove("d-none");
            }

            function setNoShowThresholdError(message) {
                if (!noShowThresholdErrorState) {
                    return;
                }

                if (!message) {
                    noShowThresholdErrorState.classList.add("d-none");
                    noShowThresholdErrorState.textContent = "";
                    return;
                }

                noShowThresholdErrorState.textContent = message;
                noShowThresholdErrorState.classList.remove("d-none");
            }

            function setNoShowThresholdSuccess(message) {
                if (!noShowThresholdSuccessState) {
                    return;
                }

                if (!message) {
                    noShowThresholdSuccessState.classList.add("d-none");
                    noShowThresholdSuccessState.textContent = "";
                    return;
                }

                noShowThresholdSuccessState.textContent = message;
                noShowThresholdSuccessState.classList.remove("d-none");
            }

            function escapeHtml(value) {
                return String(value ?? "")
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll("\"", "&quot;")
                    .replaceAll("'", "&#39;");
            }

            function formatNumber(value) {
                return new Intl.NumberFormat("pt-BR").format(Number(value ?? 0));
            }

            function formatCurrency(value) {
                return new Intl.NumberFormat("pt-BR", {
                    style: "currency",
                    currency: "BRL"
                }).format(Number(value ?? 0));
            }

            function formatPercent(value) {
                return `${Number(value ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%`;
            }

            function formatDateTime(value) {
                if (!value) {
                    return "-";
                }

                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return "-";
                }

                return date.toLocaleString("pt-BR");
            }

            function resolveEventBadge(type) {
                const normalized = String(type ?? "").toLowerCase();
                if (normalized === "request") return "bg-primary";
                if (normalized === "proposal") return "bg-success";
                if (normalized === "chat") return "bg-info text-dark";
                return "bg-dark";
            }

            function updateKpis(data) {
                const onlineClients = Number(data.onlineClients ?? 0);
                const onlineProviders = Number(data.onlineProviders ?? 0);

                document.querySelector("[data-kpi-total-users]").textContent = formatNumber(data.totalUsers);
                document.querySelector("[data-kpi-active-users]").textContent = formatNumber(data.activeUsers);
                document.querySelector("[data-kpi-online-clients]").textContent = formatNumber(onlineClients);
                document.querySelector("[data-kpi-online-providers]").textContent = formatNumber(onlineProviders);
                document.querySelector("[data-kpi-online-total]").textContent = formatNumber(onlineClients + onlineProviders);
                document.querySelector("[data-kpi-active-requests]").textContent = formatNumber(data.activeRequests);
                document.querySelector("[data-kpi-requests-period]").textContent = formatNumber(data.requestsInPeriod);
                document.querySelector("[data-kpi-accepted-proposals]").textContent = formatNumber(data.acceptedProposalsInPeriod);
                document.querySelector("[data-kpi-proposals-period]").textContent = formatNumber(data.proposalsInPeriod);
                document.querySelector("[data-kpi-active-chat]").textContent = formatNumber(data.activeChatConversationsLast24h);
                document.querySelector("[data-kpi-credits-granted]").textContent = formatCurrency(data.creditsGrantedInPeriod);
                document.querySelector("[data-kpi-credits-consumed]").textContent = formatCurrency(data.creditsConsumedInPeriod);
                document.querySelector("[data-kpi-credits-open]").textContent = formatCurrency(data.creditsOpenBalance);
                document.querySelector("[data-kpi-credits-expiring]").textContent = formatCurrency(data.creditsExpiringInNext30Days);
                document.querySelector("[data-kpi-appointment-confirmation-sla]").textContent = formatPercent(data.appointmentConfirmationInSlaRatePercent);
                document.querySelector("[data-kpi-appointment-reschedule-rate]").textContent = formatPercent(data.appointmentRescheduleRatePercent);
                document.querySelector("[data-kpi-appointment-cancellation-rate]").textContent = formatPercent(data.appointmentCancellationRatePercent);
                document.querySelector("[data-kpi-reminder-failure-rate]").textContent = formatPercent(data.reminderFailureRatePercent);
                document.querySelector("[data-kpi-reminder-attempts]").textContent = formatNumber(data.reminderAttemptsInPeriod);
                document.querySelector("[data-kpi-reminder-failures]").textContent = formatNumber(data.reminderFailuresInPeriod);
            }

            function updateStatusWidget(data) {
                const list = document.getElementById("request-status-list");
                const statuses = Array.isArray(data.requestsByStatus) ? data.requestsByStatus : [];

                if (statuses.length === 0) {
                    list.innerHTML = "<li class=\"text-muted\">Sem dados de status para o filtro selecionado.</li>";
                    return;
                }

                list.innerHTML = statuses
                    .map(status => `
                        <li class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">${escapeHtml(status.status)}</span>
                            <span class="badge bg-secondary">${formatNumber(status.count)}</span>
                        </li>`)
                    .join("");
            }

            function updateCategoryWidget(data) {
                const list = document.getElementById("request-category-list");
                const categories = Array.isArray(data.requestsByCategory) ? data.requestsByCategory : [];

                if (categories.length === 0) {
                    list.innerHTML = "<li class=\"text-muted\">Sem dados de categoria para o filtro selecionado.</li>";
                    return;
                }

                list.innerHTML = categories
                    .map(category => `
                        <li class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">${escapeHtml(category.category)}</span>
                            <span class="badge bg-primary">${formatNumber(category.count)}</span>
                        </li>`)
                    .join("");
            }

            function updateOperationalWidget(data) {
                const list = document.getElementById("operational-status-list");
                const items = Array.isArray(data.appointmentsByOperationalStatus) ? data.appointmentsByOperationalStatus : [];

                if (items.length === 0) {
                    list.innerHTML = "<li class=\"text-muted\">Sem dados operacionais para o filtro selecionado.</li>";
                    return;
                }

                list.innerHTML = items
                    .map(item => `
                        <li class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">${escapeHtml(item.status)}</span>
                            <span class="badge bg-dark">${formatNumber(item.count)}</span>
                        </li>`)
                    .join("");
            }

            function formatRating(value) {
                return Number(value ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function updateReviewReputationWidgets(data) {
                const providerBody = document.getElementById("provider-review-ranking-body");
                const providerRows = Array.isArray(data.providerReviewRanking) ? data.providerReviewRanking : [];
                if (providerBody) {
                    if (!providerRows.length) {
                        providerBody.innerHTML = "<tr><td colspan=\"3\" class=\"text-center text-muted py-3\">Sem ranking de prestadores para o periodo.</td></tr>";
                    } else {
                        providerBody.innerHTML = providerRows
                            .map(item => `
                                <tr>
                                    <td class="fw-semibold">${escapeHtml(item.userName)}</td>
                                    <td class="text-end">${formatRating(item.averageRating)}</td>
                                    <td class="text-end">${formatNumber(item.totalReviews)}</td>
                                </tr>`)
                            .join("");
                    }
                }

                const clientBody = document.getElementById("client-review-ranking-body");
                const clientRows = Array.isArray(data.clientReviewRanking) ? data.clientReviewRanking : [];
                if (clientBody) {
                    if (!clientRows.length) {
                        clientBody.innerHTML = "<tr><td colspan=\"3\" class=\"text-center text-muted py-3\">Sem ranking de clientes para o periodo.</td></tr>";
                    } else {
                        clientBody.innerHTML = clientRows
                            .map(item => `
                                <tr>
                                    <td class="fw-semibold">${escapeHtml(item.userName)}</td>
                                    <td class="text-end">${formatRating(item.averageRating)}</td>
                                    <td class="text-end">${formatNumber(item.totalReviews)}</td>
                                </tr>`)
                            .join("");
                    }
                }

                const outlierList = document.getElementById("review-outlier-list");
                const outlierRows = Array.isArray(data.reviewOutliers) ? data.reviewOutliers : [];
                if (outlierList) {
                    if (!outlierRows.length) {
                        outlierList.innerHTML = "<li class=\"text-muted\">Nenhum outlier de reputacao no periodo filtrado.</li>";
                    } else {
                        outlierList.innerHTML = outlierRows
                            .map(item => `
                                <li class="d-flex justify-content-between align-items-center gap-2">
                                    <div>
                                        <div class="fw-semibold">${escapeHtml(item.userName)} <span class="text-muted small">(${escapeHtml(item.userRole)})</span></div>
                                        <div class="small text-muted">${escapeHtml(item.reason)}</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-danger-subtle text-danger">${Number(item.oneStarRatePercent ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 })}% 1 estrela</span>
                                    </div>
                                </li>`)
                            .join("");
                    }
                }
            }

            function updatePaymentFailureWidgets(data) {
                const providerBody = document.getElementById("payment-failure-provider-body");
                const providerRows = Array.isArray(data.paymentFailuresByProvider) ? data.paymentFailuresByProvider : [];

                if (providerBody) {
                    if (providerRows.length === 0) {
                        providerBody.innerHTML = "<tr id=\"payment-failure-provider-empty\"><td colspan=\"4\" class=\"text-center text-muted py-3\">Sem falhas de pagamento no periodo selecionado.</td></tr>";
                    } else {
                        providerBody.innerHTML = providerRows
                            .map(item => `
                                <tr>
                                    <td class="fw-semibold">${escapeHtml(item.providerName ?? "Prestador")}</td>
                                    <td class="text-end"><span class="badge bg-danger-subtle text-danger">${formatNumber(item.failedTransactions)}</span></td>
                                    <td class="text-end">${formatNumber(item.affectedRequests)}</td>
                                    <td class="text-end text-muted">${formatDateTime(item.lastFailureAtUtc)}</td>
                                </tr>`)
                            .join("");
                    }
                }

                const channelList = document.getElementById("payment-failure-channel-list");
                const channelRows = Array.isArray(data.paymentFailuresByChannel) ? data.paymentFailuresByChannel : [];
                if (channelList) {
                    if (channelRows.length === 0) {
                        channelList.innerHTML = "<li class=\"text-muted\">Sem falhas por canal no periodo selecionado.</li>";
                    } else {
                        channelList.innerHTML = channelRows
                            .map(item => `
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">${escapeHtml(item.status)}</span>
                                    <span class="badge bg-danger">${formatNumber(item.count)}</span>
                                </li>`)
                            .join("");
                    }
                }

                const totalFailuresEl = document.querySelector("[data-kpi-payment-failures]");
                if (totalFailuresEl) {
                    const totalFailures = channelRows.reduce((sum, item) => sum + Number(item.count ?? 0), 0);
                    totalFailuresEl.textContent = formatNumber(totalFailures);
                }
            }

            function updateRevenueWidget(data) {
                const revenueBody = document.getElementById("subscription-revenue-body");
                const rows = Array.isArray(data.revenueByPlan) ? data.revenueByPlan : [];
                const payingProviders = Number(data.payingProviders ?? 0);

                document.querySelector("[data-kpi-revenue-total]").textContent = formatCurrency(data.monthlySubscriptionRevenue);
                document.querySelector("[data-kpi-paying-providers]").textContent = formatNumber(payingProviders);

                if (rows.length === 0) {
                    revenueBody.innerHTML = "<tr><td colspan=\"4\" class=\"text-center text-muted py-3\">Sem assinaturas pagantes no periodo atual.</td></tr>";
                    return;
                }

                revenueBody.innerHTML = rows
                    .map(row => `
                        <tr>
                            <td class="fw-semibold">${escapeHtml(row.plan)}</td>
                            <td class="text-end">${formatNumber(row.providers)}</td>
                            <td class="text-end">${formatCurrency(row.unitMonthlyPrice)}</td>
                            <td class="text-end fw-semibold">${formatCurrency(row.totalMonthlyRevenue)}</td>
                        </tr>`)
                    .join("");
            }

            function updateEvents(data) {
                const body = document.getElementById("recent-events-body");
                const events = Array.isArray(data.recentEvents) ? data.recentEvents : [];

                if (events.length === 0) {
                    body.innerHTML = "<tr id=\"events-empty-row\"><td colspan=\"4\" class=\"text-center text-muted py-4\">Nenhum evento encontrado para os filtros selecionados.</td></tr>";
                    emptyState.classList.remove("d-none");
                    return;
                }

                emptyState.classList.add("d-none");
                body.innerHTML = events
                    .map(eventItem => `
                        <tr>
                            <td><span class="badge ${resolveEventBadge(eventItem.type)}">${escapeHtml(eventItem.type)}</span></td>
                            <td class="fw-semibold">${escapeHtml(eventItem.title)}</td>
                            <td class="text-muted">${escapeHtml(eventItem.description ?? "")}</td>
                            <td class="text-muted">${formatDateTime(eventItem.createdAt)}</td>
                        </tr>`)
                    .join("");
            }

            function updateRangeLabel(data) {
                const rangeLabel = document.getElementById("range-label");
                rangeLabel.textContent = `${formatDateTime(data.fromUtc)} ate ${formatDateTime(data.toUtc)}`;
            }

            function resolveRiskBadgeClass(level) {
                const normalized = String(level ?? "").toLowerCase();
                if (normalized === "high") return "bg-danger";
                if (normalized === "medium") return "bg-warning text-dark";
                if (normalized === "low") return "bg-success";
                return "bg-secondary";
            }

            function toPercentLabel(value) {
                return Number(value ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 });
            }

            function updateNoShowThresholdSummary(configuration) {
                if (!configuration) {
                    return;
                }

                const setText = (selector, value) => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.textContent = value;
                    }
                };

                setText("[data-threshold-summary-no-show-warning]", `${toPercentLabel(configuration.noShowRateWarningPercent)}%`);
                setText("[data-threshold-summary-no-show-critical]", `${toPercentLabel(configuration.noShowRateCriticalPercent)}%`);
                setText("[data-threshold-summary-queue-warning]", formatNumber(configuration.highRiskQueueWarningCount));
                setText("[data-threshold-summary-queue-critical]", formatNumber(configuration.highRiskQueueCriticalCount));

                const setInputValue = (id, value) => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = value;
                    }
                };

                setInputValue("thresholdNoShowRateWarningPercent", Number(configuration.noShowRateWarningPercent ?? 0));
                setInputValue("thresholdNoShowRateCriticalPercent", Number(configuration.noShowRateCriticalPercent ?? 0));
                setInputValue("thresholdHighRiskQueueWarningCount", Number(configuration.highRiskQueueWarningCount ?? 0));
                setInputValue("thresholdHighRiskQueueCriticalCount", Number(configuration.highRiskQueueCriticalCount ?? 0));
                setInputValue("thresholdReminderSendSuccessWarningPercent", Number(configuration.reminderSendSuccessWarningPercent ?? 0));
                setInputValue("thresholdReminderSendSuccessCriticalPercent", Number(configuration.reminderSendSuccessCriticalPercent ?? 0));

                const notesInput = document.getElementById("thresholdNotes");
                if (notesInput) {
                    notesInput.value = configuration.notes ?? "";
                }
            }

            function updateNoShowDashboard(data, errorMessage) {
                if (!data) {
                    noShowContent.classList.add("d-none");
                    setNoShowError(errorMessage || "Falha ao carregar painel de no-show.");
                    return;
                }

                setNoShowError(null);
                noShowContent.classList.remove("d-none");

                const setText = (selector, value) => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.textContent = value;
                    }
                };

                setText("[data-no-show-rate]", `${Number(data.noShowRatePercent ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%`);
                setText("[data-no-show-count]", formatNumber(data.noShowAppointments));
                setText("[data-attendance-rate]", `${Number(data.attendanceRatePercent ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%`);
                setText("[data-attendance-count]", formatNumber(data.attendanceAppointments));
                setText("[data-dual-presence-rate]", `${Number(data.dualPresenceConfirmationRatePercent ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%`);
                setText("[data-dual-presence-count]", formatNumber(data.dualPresenceConfirmedAppointments));
                setText("[data-high-risk-count]", formatNumber(data.highRiskAppointments));
                setText("[data-high-risk-conversion]", `${Number(data.highRiskConversionRatePercent ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%`);
                setText("[data-open-queue-count]", formatNumber(data.openQueueItems));
                setText("[data-open-queue-age]", Number(data.averageQueueAgeMinutes ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 }));

                const noShowRangeLabel = document.getElementById("no-show-range-label");
                if (noShowRangeLabel) {
                    noShowRangeLabel.textContent = `${formatDateTime(data.fromUtc)} ate ${formatDateTime(data.toUtc)}`;
                }

                const categoryList = document.getElementById("no-show-category-breakdown");
                const categoryRows = Array.isArray(data.noShowByCategory) ? data.noShowByCategory : [];
                if (categoryList) {
                    if (!categoryRows.length) {
                        categoryList.innerHTML = "<li class=\"text-muted\">Sem dados por categoria para os filtros selecionados.</li>";
                    } else {
                        categoryList.innerHTML = categoryRows
                            .map(item => `
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">${escapeHtml(item.name)}</span>
                                    <span>
                                        <span class="badge bg-danger-subtle text-danger me-1">${formatNumber(item.noShowAppointments)}</span>
                                        <span class="badge bg-secondary">${Number(item.noShowRatePercent ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%</span>
                                    </span>
                                </li>`)
                            .join("");
                    }
                }

                const cityList = document.getElementById("no-show-city-breakdown");
                const cityRows = Array.isArray(data.noShowByCity) ? data.noShowByCity : [];
                if (cityList) {
                    if (!cityRows.length) {
                        cityList.innerHTML = "<li class=\"text-muted\">Sem dados por cidade para os filtros selecionados.</li>";
                    } else {
                        cityList.innerHTML = cityRows
                            .map(item => `
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">${escapeHtml(item.name)}</span>
                                    <span>
                                        <span class="badge bg-danger-subtle text-danger me-1">${formatNumber(item.noShowAppointments)}</span>
                                        <span class="badge bg-secondary">${Number(item.noShowRatePercent ?? 0).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%</span>
                                    </span>
                                </li>`)
                            .join("");
                    }
                }

                const queueBody = document.getElementById("no-show-queue-body");
                const queueRows = Array.isArray(data.openRiskQueue) ? data.openRiskQueue : [];
                if (queueBody) {
                    if (!queueRows.length) {
                        queueBody.innerHTML = "<tr id=\"no-show-queue-empty\"><td colspan=\"8\" class=\"text-center text-muted py-3\">Sem itens na fila de risco para os filtros selecionados.</td></tr>";
                    } else {
                        queueBody.innerHTML = queueRows
                            .map(item => `
                                <tr>
                                    <td><span class="badge ${resolveRiskBadgeClass(item.riskLevel)}">${escapeHtml(item.riskLevel)}</span></td>
                                    <td>${formatNumber(item.score)}</td>
                                    <td>${formatDateTime(item.windowStartUtc)}</td>
                                    <td>${escapeHtml(item.category)}</td>
                                    <td>${escapeHtml(item.city)}</td>
                                    <td>${escapeHtml(item.providerName)}</td>
                                    <td>${escapeHtml(item.clientName)}</td>
                                    <td class="text-muted">${escapeHtml(item.reasons ?? "")}</td>
                                </tr>`)
                            .join("");
                    }
                }
            }

            function updateLastUpdated() {
                lastUpdatedLabel.textContent = `Atualizado em ${formatDateTime(new Date().toISOString())}`;
            }

            function updateDashboard(data) {
                updateKpis(data);
                updateRevenueWidget(data);
                updateStatusWidget(data);
                updateCategoryWidget(data);
                updateOperationalWidget(data);
                updateReviewReputationWidgets(data);
                updatePaymentFailureWidgets(data);
                updateEvents(data);
                updateRangeLabel(data);
                updateLastUpdated();
                dashboardContent.classList.remove("d-none");
            }

            async function fetchDashboard(options) {
                if (requestInFlight) {
                    return;
                }

                const showLoading = options?.showLoading ?? true;
                const updateUrl = options?.updateUrl ?? false;
                const query = buildQueryString();

                requestInFlight = true;
                if (showLoading) {
                    setLoadingState(true);
                }
                setError(null);

                try {
                    const response = await fetch(`${snapshotUrl}?${query}`, {
                        method: "GET",
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });

                    const payload = await response.json().catch(() => null);

                    if (!response.ok || !payload || payload.success !== true || !payload.data) {
                        const fallbackMessage = `Falha ao atualizar dashboard (${response.status}).`;
                        const message = payload?.errorMessage || fallbackMessage;
                        setError(message);
                        return;
                    }

                    updateDashboard(payload.data);
                    updateNoShowDashboard(payload.noShowData, payload.noShowErrorMessage);

                    if (updateUrl) {
                        window.history.replaceState({}, "", `${window.location.pathname}?${query}`);
                    }
                } catch (error) {
                    setError("Nao foi possivel atualizar o dashboard no momento.");
                    console.error(error);
                } finally {
                    if (showLoading) {
                        setLoadingState(false);
                    }
                    requestInFlight = false;
                }
            }

            form.addEventListener("submit", function (event) {
                event.preventDefault();
                document.getElementById("page").value = "1";
                fetchDashboard({ showLoading: true, updateUrl: true });
            });

            if (noShowThresholdForm) {
                noShowThresholdForm.addEventListener("submit", async function (event) {
                    event.preventDefault();
                    setNoShowThresholdSuccess(null);
                    setNoShowThresholdError(null);

                    const payload = {
                        noShowRateWarningPercent: Number(document.getElementById("thresholdNoShowRateWarningPercent")?.value ?? 0),
                        noShowRateCriticalPercent: Number(document.getElementById("thresholdNoShowRateCriticalPercent")?.value ?? 0),
                        highRiskQueueWarningCount: Number(document.getElementById("thresholdHighRiskQueueWarningCount")?.value ?? 0),
                        highRiskQueueCriticalCount: Number(document.getElementById("thresholdHighRiskQueueCriticalCount")?.value ?? 0),
                        reminderSendSuccessWarningPercent: Number(document.getElementById("thresholdReminderSendSuccessWarningPercent")?.value ?? 0),
                        reminderSendSuccessCriticalPercent: Number(document.getElementById("thresholdReminderSendSuccessCriticalPercent")?.value ?? 0),
                        notes: (document.getElementById("thresholdNotes")?.value ?? "").trim()
                    };

                    if (saveNoShowThresholdButton) {
                        saveNoShowThresholdButton.disabled = true;
                    }

                    try {
                        const response = await fetch(updateNoShowThresholdsUrl, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json().catch(() => null);
                        if (!response.ok || !result || result.success !== true || !result.configuration) {
                            setNoShowThresholdError(result?.errorMessage || "Falha ao atualizar thresholds de no-show.");
                            return;
                        }

                        updateNoShowThresholdSummary(result.configuration);
                        setNoShowThresholdSuccess("Thresholds atualizados com sucesso.");
                    } catch (error) {
                        setNoShowThresholdError("Nao foi possivel atualizar thresholds de no-show.");
                        console.error(error);
                    } finally {
                        if (saveNoShowThresholdButton) {
                            saveNoShowThresholdButton.disabled = false;
                        }
                    }
                });
            }

            refreshButton.addEventListener("click", function () {
                fetchDashboard({ showLoading: true, updateUrl: false });
            });

            function startPolling() {
                stopPolling();
                pollHandle = setInterval(function () {
                    if (document.hidden) {
                        return;
                    }
                    fetchDashboard({ showLoading: false, updateUrl: false });
                }, pollIntervalMs);
            }

            function stopPolling() {
                if (pollHandle) {
                    clearInterval(pollHandle);
                    pollHandle = null;
                }
            }

            document.addEventListener("visibilitychange", function () {
                if (!document.hidden) {
                    fetchDashboard({ showLoading: false, updateUrl: false });
                }
            });

            startPolling();
        })();
    </script>
}
