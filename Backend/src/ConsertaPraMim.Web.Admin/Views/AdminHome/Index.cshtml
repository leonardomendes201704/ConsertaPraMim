@using System.Globalization
@using System.Linq
@using ConsertaPraMim.Application.DTOs
@model ConsertaPraMim.Web.Admin.Models.AdminDashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    var dashboard = Model.Dashboard;
    var noShowDashboard = Model.NoShowDashboard;
    var revenueRows = dashboard?.RevenueByPlan ?? Array.Empty<AdminPlanRevenueDto>();
    var paymentFailureByProviderRows = dashboard?.PaymentFailuresByProvider ?? Array.Empty<AdminPaymentFailureByProviderDto>();
    var paymentFailureByChannelRows = dashboard?.PaymentFailuresByChannel ?? Array.Empty<AdminStatusCountDto>();
    var providerOperationalStatusRows = dashboard?.ProvidersByOperationalStatus ?? Array.Empty<AdminStatusCountDto>();
    var providerReviewRankingRows = dashboard?.ProviderReviewRanking ?? Array.Empty<AdminReviewRankingItemDto>();
    var clientReviewRankingRows = dashboard?.ClientReviewRanking ?? Array.Empty<AdminReviewRankingItemDto>();
    var reviewOutlierRows = dashboard?.ReviewOutliers ?? Array.Empty<AdminReviewOutlierDto>();
    var totalPaymentFailures = paymentFailureByChannelRows.Sum(item => item.Count);
    var currencyCulture = CultureInfo.GetCultureInfo("pt-BR");
    var fromValue = Model.Filters.FromUtc?.ToString("yyyy-MM-dd") ?? string.Empty;
    var toValue = Model.Filters.ToUtc?.ToString("yyyy-MM-dd") ?? string.Empty;
    var noShowCityValue = Model.Filters.NoShowCity ?? string.Empty;
    var noShowCategoryValue = Model.Filters.NoShowCategory ?? string.Empty;
    var noShowRiskLevelValue = Model.Filters.NoShowRiskLevel ?? "all";
    var noShowQueueTakeValue = Model.Filters.NoShowQueueTake.ToString();
    var noShowCancelWindowValue = Model.Filters.NoShowCancellationWindowHours.ToString();
    var snapshotUrl = Url.Action("Snapshot", "AdminHome") ?? "/AdminHome/Snapshot";
    var coverageMapSnapshotUrl = Url.Action("Snapshot", "AdminCoverageMap") ?? "/AdminCoverageMap/Snapshot";
}

<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
    }

    @@media (min-width: 576px) {
        .metrics-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    @@media (min-width: 992px) {
        .metrics-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
    }

    @@media (min-width: 1200px) {
        .metrics-grid {
            grid-template-columns: repeat(5, minmax(0, 1fr));
        }
    }

    .metric-card {
        --metric-gradient: linear-gradient(135deg, #ecf2ff 0%, #dfe9ff 100%);
        border: 0;
        border-radius: 14px;
        box-shadow: 0 10px 20px rgba(15, 23, 42, .10);
        min-height: 148px;
        background: var(--metric-gradient);
        position: relative;
        overflow: hidden;
        isolation: isolate;
    }

    .metric-card::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 14px;
        background: linear-gradient(155deg, rgba(255, 255, 255, .42) 0%, rgba(255, 255, 255, 0) 62%);
        z-index: 0;
    }

    .metric-card .card-body {
        position: relative;
        z-index: 2;
    }

    .metric-title {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: .05em;
        color: #516079;
    }

    .metric-value {
        font-size: 1.95rem;
        font-weight: 800;
        color: #1e293b;
        line-height: 1.1;
    }

    .metric-subtitle {
        color: #52637f;
        font-size: .85rem;
    }

    .metric-bg-icon {
        position: absolute;
        right: -30px;
        bottom: -36px;
        font-size: 8.88rem;
        line-height: 1;
        color: rgba(30, 41, 59, .14);
        transform: rotate(-25deg);
        z-index: 1;
        pointer-events: none;
        user-select: none;
    }

    .metric-card--users {
        --metric-gradient: linear-gradient(135deg, #ebf3ff 0%, #dfeaff 100%);
    }

    .metric-card--online {
        --metric-gradient: linear-gradient(135deg, #e9f8ef 0%, #daf2e5 100%);
    }

    .metric-card--requests {
        --metric-gradient: linear-gradient(135deg, #fff8e8 0%, #feeecf 100%);
    }

    .metric-card--proposals {
        --metric-gradient: linear-gradient(135deg, #fff3eb 0%, #ffe5d6 100%);
    }

    .metric-card--chat {
        --metric-gradient: linear-gradient(135deg, #ebf8fc 0%, #dceff8 100%);
    }

    .metric-card--credits-granted {
        --metric-gradient: linear-gradient(135deg, #eef9f3 0%, #ddf2e6 100%);
    }

    .metric-card--credits-consumed {
        --metric-gradient: linear-gradient(135deg, #fff3ee 0%, #ffe4d8 100%);
    }

    .metric-card--credits-open {
        --metric-gradient: linear-gradient(135deg, #edf4ff 0%, #dce9ff 100%);
    }

    .metric-card--credits-expiring {
        --metric-gradient: linear-gradient(135deg, #fff9ec 0%, #fff0d5 100%);
    }

    .metric-card--agenda-ops {
        --metric-gradient: linear-gradient(135deg, #eef2ff 0%, #e1f6ea 100%);
    }

    .widget-card {
        border: 0;
        border-radius: 14px;
        box-shadow: 0 10px 22px rgba(15, 23, 42, .08);
        overflow: hidden;
    }

    .event-table th {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: .04em;
        color: #64748b;
        border-top: 0;
    }

    .event-table td {
        vertical-align: middle;
    }

    .request-status-list li {
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .request-status-list li:last-child {
        border-bottom: 0;
    }

    .revenue-table th {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: .04em;
        color: #64748b;
        border-top: 0;
        white-space: nowrap;
    }

    .revenue-total {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1.1;
        color: #0f172a;
    }

    .dashboard-state {
        border-radius: 12px;
    }

    .no-show-grid {
        display: grid;
        grid-template-columns: repeat(1, minmax(0, 1fr));
        gap: 12px;
    }

    @@media (min-width: 768px) {
        .no-show-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    @@media (min-width: 1200px) {
        .no-show-grid {
            grid-template-columns: repeat(5, minmax(0, 1fr));
        }
    }

    .no-show-card {
        border: 0;
        border-radius: 14px;
        box-shadow: 0 8px 18px rgba(15, 23, 42, .08);
        background: #f8fafc;
    }

    .no-show-card .title {
        font-size: .74rem;
        text-transform: uppercase;
        letter-spacing: .05em;
        color: #64748b;
    }

    .no-show-card .value {
        font-size: 1.6rem;
        font-weight: 800;
        color: #0f172a;
    }

    .no-show-card .sub {
        font-size: .8rem;
        color: #64748b;
    }

    .dashboard-filters-drawer {
        width: min(520px, 100vw);
    }

    .home-coverage-map {
        height: 420px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }

    .home-coverage-map-city-filter {
        width: min(460px, 100%);
    }

    .home-coverage-map-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        color: #475569;
    }

    .home-coverage-map-legend-item {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        font-size: .85rem;
    }

    .home-coverage-map-legend-dot {
        width: 11px;
        height: 11px;
        border-radius: 50%;
        display: inline-block;
    }

    .home-coverage-map-legend-dot.radius {
        border: 1px solid #2563eb;
        background: rgba(37, 99, 235, 0.04);
    }

    .home-coverage-map-legend-icon {
        font-size: 1rem;
        line-height: 1;
        transform: translateY(-1px);
    }

    .home-coverage-map-legend-icon.provider {
        color: #2563eb;
    }

    .home-coverage-map-legend-icon.request {
        color: #e11d48;
    }

    .home-coverage-map-pin {
        background: transparent;
        border: none;
    }

    .home-coverage-map-pin i {
        font-size: 1.75rem;
        filter: drop-shadow(0 3px 4px rgba(15, 23, 42, 0.32));
        -webkit-text-stroke: 0.65px rgba(255, 255, 255, 0.95);
    }

    .home-coverage-map-pin.provider i {
        color: #2563eb;
    }

    .home-coverage-map-pin.request i {
        color: #e11d48;
    }

    @@media (max-width: 768px) {
        .metric-value {
            font-size: 1.7rem;
        }
    }
</style>

<div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
    <div>
        <h1 class="h4 fw-bold mb-1">Dashboard Administrativo</h1>
        <p class="text-muted mb-0">Visao consolidada de usuarios, operacao e conversas.</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="refresh-dashboard-btn">
            <i class="fas fa-rotate-right"></i> Atualizar
        </button>
        <span class="text-muted small" id="last-updated-label">
            Atualizado em @(Model.LastUpdatedUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss"))
        </span>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div class="d-flex flex-wrap gap-2">
            <button type="button"
                    class="btn btn-outline-primary"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#dashboardFiltersDrawer"
                    aria-controls="dashboardFiltersDrawer">
                <i class="fas fa-sliders-h me-1"></i> Filtros
            </button>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fas fa-eraser me-1"></i> Limpar
            </a>
        </div>
        <div class="text-muted small">
            Periodo:
            <strong>@(string.IsNullOrWhiteSpace(fromValue) ? "-" : fromValue) ate @(string.IsNullOrWhiteSpace(toValue) ? "-" : toValue)</strong>
            | Evento: <strong>@Model.Filters.EventType</strong>
            | Status: <strong>@Model.Filters.OperationalStatus</strong>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end dashboard-filters-drawer" tabindex="-1" id="dashboardFiltersDrawer" aria-labelledby="dashboardFiltersDrawerLabel">
    <div class="offcanvas-header">
        <h2 class="offcanvas-title fs-5" id="dashboardFiltersDrawerLabel">Filtros do dashboard</h2>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body">
        <form id="dashboard-filters" class="d-flex flex-column gap-3">
            <div>
                <label class="form-label fw-semibold" for="fromUtc">De</label>
                <input class="form-control" type="date" id="fromUtc" name="fromUtc" value="@fromValue" />
            </div>
            <div>
                <label class="form-label fw-semibold" for="toUtc">Ate</label>
                <input class="form-control" type="date" id="toUtc" name="toUtc" value="@toValue" />
            </div>
            <div>
                <label class="form-label fw-semibold" for="eventType">Evento</label>
                <select class="form-select" id="eventType" name="eventType">
                    @if (Model.Filters.EventType == "all")
                    {
                        <option value="all" selected>Todos</option>
                    }
                    else
                    {
                        <option value="all">Todos</option>
                    }

                    @if (Model.Filters.EventType == "request")
                    {
                        <option value="request" selected>Pedidos</option>
                    }
                    else
                    {
                        <option value="request">Pedidos</option>
                    }

                    @if (Model.Filters.EventType == "proposal")
                    {
                        <option value="proposal" selected>Propostas</option>
                    }
                    else
                    {
                        <option value="proposal">Propostas</option>
                    }

                    @if (Model.Filters.EventType == "chat")
                    {
                        <option value="chat" selected>Chats</option>
                    }
                    else
                    {
                        <option value="chat">Chats</option>
                    }
                </select>
            </div>
            <div>
                <label class="form-label fw-semibold" for="operationalStatus">Status operacional</label>
                <select class="form-select" id="operationalStatus" name="operationalStatus">
                    @if (Model.Filters.OperationalStatus == "all")
                    {
                        <option value="all" selected>Todos</option>
                    }
                    else
                    {
                        <option value="all">Todos</option>
                    }

                    @if (Model.Filters.OperationalStatus == "OnTheWay")
                    {
                        <option value="OnTheWay" selected>A caminho</option>
                    }
                    else
                    {
                        <option value="OnTheWay">A caminho</option>
                    }

                    @if (Model.Filters.OperationalStatus == "OnSite")
                    {
                        <option value="OnSite" selected>No local</option>
                    }
                    else
                    {
                        <option value="OnSite">No local</option>
                    }

                    @if (Model.Filters.OperationalStatus == "InService")
                    {
                        <option value="InService" selected>Em atendimento</option>
                    }
                    else
                    {
                        <option value="InService">Em atendimento</option>
                    }

                    @if (Model.Filters.OperationalStatus == "WaitingParts")
                    {
                        <option value="WaitingParts" selected>Aguardando peca</option>
                    }
                    else
                    {
                        <option value="WaitingParts">Aguardando peca</option>
                    }

                    @if (Model.Filters.OperationalStatus == "Completed")
                    {
                        <option value="Completed" selected>Concluido</option>
                    }
                    else
                    {
                        <option value="Completed">Concluido</option>
                    }
                </select>
            </div>
            <div>
                <label class="form-label fw-semibold" for="searchTerm">Busca</label>
                <input class="form-control" type="text" id="searchTerm" name="searchTerm" placeholder="Titulo ou descricao" value="@Model.Filters.SearchTerm" />
            </div>

            <input type="hidden" id="page" name="page" value="@Model.Filters.Page" />
            <input type="hidden" id="pageSize" name="pageSize" value="@Model.Filters.PageSize" />

            <hr class="my-2" />

            <div>
                <label class="form-label fw-semibold" for="noShowCity">No-show: Cidade</label>
                <input class="form-control" type="text" id="noShowCity" name="noShowCity" value="@noShowCityValue" placeholder="Ex.: Praia Grande" />
            </div>
            <div>
                <label class="form-label fw-semibold" for="noShowCategory">No-show: Categoria</label>
                <input class="form-control" type="text" id="noShowCategory" name="noShowCategory" value="@noShowCategoryValue" placeholder="Ex.: Hidraulica" />
            </div>
            <div>
                <label class="form-label fw-semibold" for="noShowRiskLevel">No-show: Risco</label>
                <select class="form-select" id="noShowRiskLevel" name="noShowRiskLevel">
                    @if (noShowRiskLevelValue == "all")
                    {
                        <option value="all" selected>Todos</option>
                    }
                    else
                    {
                        <option value="all">Todos</option>
                    }
                    @if (noShowRiskLevelValue == "Low")
                    {
                        <option value="Low" selected>Baixo</option>
                    }
                    else
                    {
                        <option value="Low">Baixo</option>
                    }
                    @if (noShowRiskLevelValue == "Medium")
                    {
                        <option value="Medium" selected>Medio</option>
                    }
                    else
                    {
                        <option value="Medium">Medio</option>
                    }
                    @if (noShowRiskLevelValue == "High")
                    {
                        <option value="High" selected>Alto</option>
                    }
                    else
                    {
                        <option value="High">Alto</option>
                    }
                </select>
            </div>
            <div>
                <label class="form-label fw-semibold" for="noShowQueueTake">Fila (max)</label>
                <input class="form-control" type="number" min="1" max="500" id="noShowQueueTake" name="noShowQueueTake" value="@noShowQueueTakeValue" />
            </div>
            <div>
                <label class="form-label fw-semibold" for="noShowCancellationNoShowWindowHours">Cancelamento no-show (h)</label>
                <input class="form-control" type="number" min="1" max="168" id="noShowCancellationNoShowWindowHours" name="noShowCancellationNoShowWindowHours" value="@noShowCancelWindowValue" />
            </div>

            <div class="d-grid gap-2 mt-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter me-1"></i> Aplicar filtros
                </button>
                <a asp-action="Index" class="btn btn-outline-secondary">Limpar filtros</a>
            </div>
        </form>
    </div>
</div>

<div id="loading-state" class="alert alert-info dashboard-state d-none">
    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    Atualizando dashboard...
</div>

<div id="error-state" class="alert alert-danger dashboard-state @(Model.HasError ? string.Empty : "d-none")">
    @Model.ErrorMessage
</div>

<section class="mb-4">
    <div class="widget-card card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center gap-2">
            <div>
                <h2 class="h6 fw-semibold mb-0">Mapa de Pedidos e Prestadores</h2>
                <span class="text-muted small">Cobertura por raio de atendimento dos prestadores</span>
            </div>
            <a asp-controller="AdminCoverageMap" asp-action="Index" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-map-location-dot me-1"></i> Abrir mapa completo
            </a>
        </div>
        <div class="card-body">
            <div class="input-group input-group-sm home-coverage-map-city-filter mb-3">
                <span class="input-group-text">
                    <i class="fas fa-city" aria-hidden="true"></i>
                </span>
                <input type="text"
                       id="home-coverage-map-city-input"
                       class="form-control"
                       placeholder="Filtrar mapa por cidade (ex: Praia Grande)"
                       autocomplete="off" />
                <button type="button" class="btn btn-outline-primary" id="home-coverage-map-city-apply-btn">
                    Filtrar
                </button>
                <button type="button" class="btn btn-outline-secondary" id="home-coverage-map-city-clear-btn">
                    Limpar
                </button>
            </div>
            <div id="home-coverage-map-state" class="alert alert-info py-2 px-3 mb-3">
                Carregando mapa operacional...
            </div>
            <div id="home-coverage-map" class="home-coverage-map" aria-label="Mapa operacional do dashboard"></div>
            <div class="home-coverage-map-legend mt-3">
                <span class="home-coverage-map-legend-item">
                    <i class="fas fa-map-marker-alt home-coverage-map-legend-icon provider" aria-hidden="true"></i>
                    Prestadores
                </span>
                <span class="home-coverage-map-legend-item">
                    <i class="fas fa-map-marker-alt home-coverage-map-legend-icon request" aria-hidden="true"></i>
                    Pedidos
                </span>
                <span class="home-coverage-map-legend-item">
                    <span class="home-coverage-map-legend-dot radius"></span>
                    Raio de atuacao
                </span>
            </div>
        </div>
    </div>
</section>

<section id="dashboard-content" class="@(Model.HasData ? string.Empty : "d-none")">
    <div class="metrics-grid mb-4">
        <div>
            <div class="metric-card metric-card--users card">
                <div class="card-body">
                    <div class="metric-title mb-2">Usuarios Totais</div>
                    <div class="metric-value" data-kpi-total-users>@(dashboard?.TotalUsers ?? 0)</div>
                    <div class="metric-subtitle mt-2">Ativos: <span data-kpi-active-users>@(dashboard?.ActiveUsers ?? 0)</span></div>
                </div>
                <i class="metric-bg-icon fas fa-users" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--online card">
                <div class="card-body">
                    <div class="metric-title mb-2">Usuarios Online</div>
                    <div class="metric-value" data-kpi-online-total>@((dashboard?.OnlineClients ?? 0) + (dashboard?.OnlineProviders ?? 0))</div>
                    <div class="metric-subtitle mt-2">Clientes Online: <span data-kpi-online-clients>@(dashboard?.OnlineClients ?? 0)</span></div>
                    <div class="metric-subtitle">Prestadores Online: <span data-kpi-online-providers>@(dashboard?.OnlineProviders ?? 0)</span></div>
                </div>
                <i class="metric-bg-icon fas fa-user-check" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--requests card">
                <div class="card-body">
                    <div class="metric-title mb-2">Pedidos Ativos</div>
                    <div class="metric-value" data-kpi-active-requests>@(dashboard?.ActiveRequests ?? 0)</div>
                    <div class="metric-subtitle mt-2">No periodo: <span data-kpi-requests-period>@(dashboard?.RequestsInPeriod ?? 0)</span></div>
                </div>
                <i class="metric-bg-icon fas fa-clipboard-list" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--proposals card">
                <div class="card-body">
                    <div class="metric-title mb-2">Propostas Aceitas</div>
                    <div class="metric-value" data-kpi-accepted-proposals>@(dashboard?.AcceptedProposalsInPeriod ?? 0)</div>
                    <div class="metric-subtitle mt-2">No periodo: <span data-kpi-proposals-period>@(dashboard?.ProposalsInPeriod ?? 0)</span></div>
                </div>
                <i class="metric-bg-icon fas fa-handshake" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--chat card">
                <div class="card-body">
                    <div class="metric-title mb-2">Conversas Ativas</div>
                    <div class="metric-value" data-kpi-active-chat>@(dashboard?.ActiveChatConversationsLast24h ?? 0)</div>
                    <div class="metric-subtitle mt-2">Ultimas 24 horas</div>
                </div>
                <i class="metric-bg-icon fas fa-comments" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--credits-granted card">
                <div class="card-body">
                    <div class="metric-title mb-2">Creditos Concedidos</div>
                    <div class="metric-value" data-kpi-credits-granted>@((dashboard?.CreditsGrantedInPeriod ?? 0m).ToString("C", currencyCulture))</div>
                    <div class="metric-subtitle mt-2">No periodo filtrado</div>
                </div>
                <i class="metric-bg-icon fas fa-gift" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--credits-consumed card">
                <div class="card-body">
                    <div class="metric-title mb-2">Creditos Consumidos</div>
                    <div class="metric-value" data-kpi-credits-consumed>@((dashboard?.CreditsConsumedInPeriod ?? 0m).ToString("C", currencyCulture))</div>
                    <div class="metric-subtitle mt-2">Debitos de mensalidade/ajustes</div>
                </div>
                <i class="metric-bg-icon fas fa-coins" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--credits-open card">
                <div class="card-body">
                    <div class="metric-title mb-2">Saldo em Aberto</div>
                    <div class="metric-value" data-kpi-credits-open>@((dashboard?.CreditsOpenBalance ?? 0m).ToString("C", currencyCulture))</div>
                    <div class="metric-subtitle mt-2">Carteira total dos prestadores</div>
                </div>
                <i class="metric-bg-icon fas fa-wallet" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--credits-expiring card">
                <div class="card-body">
                    <div class="metric-title mb-2">Creditos a Expirar</div>
                    <div class="metric-value" data-kpi-credits-expiring>@((dashboard?.CreditsExpiringInNext30Days ?? 0m).ToString("C", currencyCulture))</div>
                    <div class="metric-subtitle mt-2">Vencimento nos proximos 30 dias</div>
                </div>
                <i class="metric-bg-icon fas fa-hourglass-half" aria-hidden="true"></i>
            </div>
        </div>
        <div>
            <div class="metric-card metric-card--agenda-ops card">
                <div class="card-body">
                    <div class="metric-title mb-2">Operacao da Agenda</div>
                    <div class="metric-subtitle mt-2">
                        Confirmacao no SLA:
                        <span class="fw-semibold" data-kpi-appointment-confirmation-sla>@((dashboard?.AppointmentConfirmationInSlaRatePercent ?? 0m).ToString("N1", currencyCulture))%</span>
                    </div>
                    <div class="metric-subtitle">
                        Reagendamento:
                        <span class="fw-semibold" data-kpi-appointment-reschedule-rate>@((dashboard?.AppointmentRescheduleRatePercent ?? 0m).ToString("N1", currencyCulture))%</span>
                    </div>
                    <div class="metric-subtitle">
                        Cancelamento:
                        <span class="fw-semibold" data-kpi-appointment-cancellation-rate>@((dashboard?.AppointmentCancellationRatePercent ?? 0m).ToString("N1", currencyCulture))%</span>
                    </div>
                    <div class="metric-subtitle">
                        Falha de lembrete:
                        <span class="fw-semibold" data-kpi-reminder-failure-rate>@((dashboard?.ReminderFailureRatePercent ?? 0m).ToString("N1", currencyCulture))%</span>
                        <small class="text-muted ms-1">(<span data-kpi-reminder-failures>@(dashboard?.ReminderFailuresInPeriod ?? 0)</span>/<span data-kpi-reminder-attempts>@(dashboard?.ReminderAttemptsInPeriod ?? 0)</span>)</small>
                    </div>
                </div>
                <i class="metric-bg-icon fas fa-calendar-check" aria-hidden="true"></i>
            </div>
        </div>
    </div>

    <div id="no-show-error-state" class="alert alert-warning dashboard-state @(string.IsNullOrWhiteSpace(Model.NoShowErrorMessage) ? "d-none" : string.Empty)">
        @Model.NoShowErrorMessage
    </div>

    <section id="no-show-content" class="mb-4 @(Model.HasNoShowData ? string.Empty : "d-none")">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <h2 class="h5 fw-bold mb-0">Painel Operacional de No-show</h2>
            <span class="text-muted small" id="no-show-range-label">
                @if (noShowDashboard != null)
                {
                    <text>@noShowDashboard.FromUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ate @noShowDashboard.ToUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</text>
                }
            </span>
        </div>

        <div class="no-show-grid mb-3">
            <div class="card no-show-card">
                <div class="card-body">
                    <div class="title mb-1">Taxa de no-show</div>
                    <div class="value" data-no-show-rate>@((noShowDashboard?.NoShowRatePercent ?? 0m).ToString("N1", currencyCulture))%</div>
                    <div class="sub mt-1">No-show: <span data-no-show-count>@(noShowDashboard?.NoShowAppointments ?? 0)</span></div>
                </div>
            </div>
            <div class="card no-show-card">
                <div class="card-body">
                    <div class="title mb-1">Comparecimento</div>
                    <div class="value" data-attendance-rate>@((noShowDashboard?.AttendanceRatePercent ?? 0m).ToString("N1", currencyCulture))%</div>
                    <div class="sub mt-1">Atendidos: <span data-attendance-count>@(noShowDashboard?.AttendanceAppointments ?? 0)</span></div>
                </div>
            </div>
            <div class="card no-show-card">
                <div class="card-body">
                    <div class="title mb-1">Confirmacao dupla</div>
                    <div class="value" data-dual-presence-rate>@((noShowDashboard?.DualPresenceConfirmationRatePercent ?? 0m).ToString("N1", currencyCulture))%</div>
                    <div class="sub mt-1">Confirmados: <span data-dual-presence-count>@(noShowDashboard?.DualPresenceConfirmedAppointments ?? 0)</span></div>
                </div>
            </div>
            <div class="card no-show-card">
                <div class="card-body">
                    <div class="title mb-1">Risco alto</div>
                    <div class="value" data-high-risk-count>@(noShowDashboard?.HighRiskAppointments ?? 0)</div>
                    <div class="sub mt-1">Conversao: <span data-high-risk-conversion>@((noShowDashboard?.HighRiskConversionRatePercent ?? 0m).ToString("N1", currencyCulture))%</span></div>
                </div>
            </div>
            <div class="card no-show-card">
                <div class="card-body">
                    <div class="title mb-1">Fila operacional</div>
                    <div class="value" data-open-queue-count>@(noShowDashboard?.OpenQueueItems ?? 0)</div>
                    <div class="sub mt-1">Idade media: <span data-open-queue-age>@((noShowDashboard?.AverageQueueAgeMinutes ?? 0d).ToString("N1", currencyCulture))</span> min</div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-12 col-lg-6">
                <div class="widget-card card h-100">
                    <div class="card-header bg-white">
                        <h3 class="h6 fw-semibold mb-0">No-show por Categoria</h3>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled request-status-list mb-0" id="no-show-category-breakdown">
                            @if (noShowDashboard?.NoShowByCategory?.Any() == true)
                            {
                                @foreach (var item in noShowDashboard.NoShowByCategory)
                                {
                                    <li class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">@item.Name</span>
                                        <span>
                                            <span class="badge bg-danger-subtle text-danger me-1">@item.NoShowAppointments</span>
                                            <span class="badge bg-secondary">@item.NoShowRatePercent.ToString("N1", currencyCulture)%</span>
                                        </span>
                                    </li>
                                }
                            }
                            else
                            {
                                <li class="text-muted">Sem dados por categoria para os filtros selecionados.</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="widget-card card h-100">
                    <div class="card-header bg-white">
                        <h3 class="h6 fw-semibold mb-0">No-show por Cidade</h3>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled request-status-list mb-0" id="no-show-city-breakdown">
                            @if (noShowDashboard?.NoShowByCity?.Any() == true)
                            {
                                @foreach (var item in noShowDashboard.NoShowByCity)
                                {
                                    <li class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">@item.Name</span>
                                        <span>
                                            <span class="badge bg-danger-subtle text-danger me-1">@item.NoShowAppointments</span>
                                            <span class="badge bg-secondary">@item.NoShowRatePercent.ToString("N1", currencyCulture)%</span>
                                        </span>
                                    </li>
                                }
                            }
                            else
                            {
                                <li class="text-muted">Sem dados por cidade para os filtros selecionados.</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="widget-card card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h6 fw-semibold mb-0">Fila de Risco (No-show)</h3>
                <span class="text-muted small">Prioridade: risco alto e score maior</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0 event-table">
                    <thead>
                        <tr>
                            <th>Risco</th>
                            <th>Score</th>
                            <th>Janela</th>
                            <th>Categoria</th>
                            <th>Cidade</th>
                            <th>Prestador</th>
                            <th>Cliente</th>
                            <th>Motivos</th>
                        </tr>
                    </thead>
                    <tbody id="no-show-queue-body">
                        @if (noShowDashboard?.OpenRiskQueue?.Any() == true)
                        {
                            @foreach (var item in noShowDashboard.OpenRiskQueue)
                            {
                                <tr>
                                    <td>
                                        <span class="badge @(item.RiskLevel == "High" ? "bg-danger" : item.RiskLevel == "Medium" ? "bg-warning text-dark" : "bg-success")">
                                            @item.RiskLevel
                                        </span>
                                    </td>
                                    <td>@item.Score</td>
                                    <td>@item.WindowStartUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@item.Category</td>
                                    <td>@item.City</td>
                                    <td>@item.ProviderName</td>
                                    <td>@item.ClientName</td>
                                    <td class="text-muted">@item.Reasons</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr id="no-show-queue-empty">
                                <td colspan="8" class="text-center text-muted py-3">Sem itens na fila de risco para os filtros selecionados.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <div class="row g-3 mb-4">
        <div class="col-12">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Receita Mensal de Assinaturas</h2>
                    <span class="text-muted small">
                        Competencia: @DateTime.UtcNow.ToLocalTime().ToString("MM/yyyy")
                    </span>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-end gap-2 mb-3">
                        <div>
                            <div class="text-muted small text-uppercase">Total mensal estimado</div>
                            <div class="revenue-total" data-kpi-revenue-total>@((dashboard?.MonthlySubscriptionRevenue ?? 0m).ToString("C", currencyCulture))</div>
                        </div>
                        <div class="text-muted small">
                            Prestadores assinantes:
                            <span class="fw-semibold" data-kpi-paying-providers>@(dashboard?.PayingProviders ?? 0)</span>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0 revenue-table">
                            <thead>
                            <tr>
                                <th>Plano</th>
                                <th class="text-end">Prestadores</th>
                                <th class="text-end">Valor Unitario</th>
                                <th class="text-end">Receita Mensal</th>
                            </tr>
                            </thead>
                            <tbody id="subscription-revenue-body">
                            @if (revenueRows.Any())
                            {
                                @foreach (var revenueItem in revenueRows)
                                {
                                    <tr>
                                        <td class="fw-semibold">@revenueItem.Plan</td>
                                        <td class="text-end">@revenueItem.Providers</td>
                                        <td class="text-end">@revenueItem.UnitMonthlyPrice.ToString("C", currencyCulture)</td>
                                        <td class="text-end fw-semibold">@revenueItem.TotalMonthlyRevenue.ToString("C", currencyCulture)</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">Sem assinaturas pagantes no periodo atual.</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-3">
            <div class="widget-card card h-100">
                <div class="card-header bg-white">
                    <h2 class="h6 fw-semibold mb-0">Pedidos por Status</h2>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled request-status-list mb-0" id="request-status-list">
                        @if (dashboard?.RequestsByStatus?.Any() == true)
                        {
                            @foreach (var status in dashboard.RequestsByStatus)
                            {
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">@status.Status</span>
                                    <span class="badge bg-secondary">@status.Count</span>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">Sem dados de status para o filtro selecionado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-3">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Pedidos por Categoria</h2>
                    <span class="text-muted small">Maior para menor</span>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled request-status-list mb-0" id="request-category-list">
                        @if (dashboard?.RequestsByCategory?.Any() == true)
                        {
                            @foreach (var category in dashboard.RequestsByCategory)
                            {
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">@category.Category</span>
                                    <span class="badge bg-primary">@category.Count</span>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">Sem dados de categoria para o filtro selecionado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-3">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Atendimento Operacional</h2>
                    <span class="text-muted small">Agendamentos</span>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled request-status-list mb-0" id="operational-status-list">
                        @if (dashboard?.AppointmentsByOperationalStatus?.Any() == true)
                        {
                            @foreach (var item in dashboard.AppointmentsByOperationalStatus)
                            {
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">@item.Status</span>
                                    <span class="badge bg-dark">@item.Count</span>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">Sem dados operacionais para o filtro selecionado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-3">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Status dos Prestadores</h2>
                    <span class="text-muted small">Operacional</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0 event-table">
                        <thead>
                        <tr>
                            <th>Status</th>
                            <th class="text-end">Quantidade</th>
                        </tr>
                        </thead>
                        <tbody id="provider-operational-status-body">
                        @if (providerOperationalStatusRows.Any())
                        {
                            @foreach (var item in providerOperationalStatusRows)
                            {
                                <tr>
                                    <td class="text-muted">@item.Status</td>
                                    <td class="text-end"><span class="badge bg-info text-dark">@item.Count</span></td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="2" class="text-center text-muted py-3">Sem dados de prestadores para o filtro selecionado.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-xl-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Ranking de Prestadores</h2>
                    <span class="text-muted small">Media e volume</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 event-table">
                        <thead>
                        <tr>
                            <th>Prestador</th>
                            <th class="text-end">Media</th>
                            <th class="text-end">Reviews</th>
                        </tr>
                        </thead>
                        <tbody id="provider-review-ranking-body">
                        @if (providerReviewRankingRows.Any())
                        {
                            @foreach (var item in providerReviewRankingRows)
                            {
                                <tr>
                                    <td class="fw-semibold">@item.UserName</td>
                                    <td class="text-end">@item.AverageRating.ToString("N2", currencyCulture)</td>
                                    <td class="text-end">@item.TotalReviews</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-center text-muted py-3">Sem ranking de prestadores para o periodo.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Ranking de Clientes</h2>
                    <span class="text-muted small">Media e volume</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 event-table">
                        <thead>
                        <tr>
                            <th>Cliente</th>
                            <th class="text-end">Media</th>
                            <th class="text-end">Reviews</th>
                        </tr>
                        </thead>
                        <tbody id="client-review-ranking-body">
                        @if (clientReviewRankingRows.Any())
                        {
                            @foreach (var item in clientReviewRankingRows)
                            {
                                <tr>
                                    <td class="fw-semibold">@item.UserName</td>
                                    <td class="text-end">@item.AverageRating.ToString("N2", currencyCulture)</td>
                                    <td class="text-end">@item.TotalReviews</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-center text-muted py-3">Sem ranking de clientes para o periodo.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Outliers de Reputacao</h2>
                    <span class="text-muted small">Sinais para analise</span>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled request-status-list mb-0" id="review-outlier-list">
                        @if (reviewOutlierRows.Any())
                        {
                            @foreach (var item in reviewOutlierRows)
                            {
                                <li class="d-flex justify-content-between align-items-center gap-2">
                                    <div>
                                        <div class="fw-semibold">@item.UserName <span class="text-muted small">(@item.UserRole)</span></div>
                                        <div class="small text-muted">@item.Reason</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-danger-subtle text-danger">@item.OneStarRatePercent.ToString("N1", currencyCulture)% 1 estrela</span>
                                    </div>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">Nenhum outlier de reputacao no periodo filtrado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-8">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Falhas de Pagamento por Prestador</h2>
                    <span class="text-muted small">
                        No periodo: <strong data-kpi-payment-failures>@totalPaymentFailures</strong>
                    </span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 event-table">
                        <thead>
                        <tr>
                            <th>Prestador</th>
                            <th class="text-end">Falhas</th>
                            <th class="text-end">Pedidos impactados</th>
                            <th class="text-end">Ultima falha</th>
                        </tr>
                        </thead>
                        <tbody id="payment-failure-provider-body">
                        @if (paymentFailureByProviderRows.Any())
                        {
                            @foreach (var item in paymentFailureByProviderRows)
                            {
                                <tr>
                                    <td class="fw-semibold">@item.ProviderName</td>
                                    <td class="text-end">
                                        <span class="badge bg-danger-subtle text-danger">@item.FailedTransactions</span>
                                    </td>
                                    <td class="text-end">@item.AffectedRequests</td>
                                    <td class="text-end text-muted">
                                        @(item.LastFailureAtUtc.HasValue
                                            ? item.LastFailureAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                            : "-")
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr id="payment-failure-provider-empty">
                                <td colspan="4" class="text-center text-muted py-3">Sem falhas de pagamento no periodo selecionado.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Falhas por Canal</h2>
                    <span class="text-muted small">PIX / Cartao</span>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled request-status-list mb-0" id="payment-failure-channel-list">
                        @if (paymentFailureByChannelRows.Any())
                        {
                            @foreach (var item in paymentFailureByChannelRows)
                            {
                                <li class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">@item.Status</span>
                                    <span class="badge bg-danger">@item.Count</span>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">Sem falhas por canal no periodo selecionado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12">
            <div class="widget-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Eventos Recentes</h2>
                    <span class="text-muted small" id="range-label">
                        @if (dashboard != null)
                        {
                            <text>@dashboard.FromUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ate @dashboard.ToUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</text>
                        }
                    </span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 event-table">
                        <thead>
                        <tr>
                            <th scope="col">Tipo</th>
                            <th scope="col">Titulo</th>
                            <th scope="col">Descricao</th>
                            <th scope="col">Data</th>
                        </tr>
                        </thead>
                        <tbody id="recent-events-body">
                        @if (dashboard?.RecentEvents?.Any() == true)
                        {
                            @foreach (var eventItem in dashboard.RecentEvents)
                            {
                                <tr>
                                    <td><span class="badge bg-dark">@eventItem.Type</span></td>
                                    <td class="fw-semibold">@eventItem.Title</td>
                                    <td class="text-muted">@eventItem.Description</td>
                                    <td class="text-muted">@eventItem.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr id="events-empty-row">
                                <td colspan="4" class="text-center text-muted py-4">Nenhum evento encontrado para os filtros selecionados.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="empty-state" class="alert alert-secondary dashboard-state @(Model.IsEmpty && !Model.HasError ? string.Empty : "d-none")">
        Nenhum evento disponivel com os filtros atuais. Ajuste periodo, tipo ou busca.
    </div>
</section>

@section Styles {
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />
}

@section Scripts {
    <script>
    window.adminHomeConfig = {
        snapshotUrl: "@snapshotUrl",
        coverageMapSnapshotUrl: "@coverageMapSnapshotUrl",
        homeCoverageMapElementId: "home-coverage-map",
        homeCoverageMapStateElementId: "home-coverage-map-state",
        homeCoverageMapCityInputId: "home-coverage-map-city-input",
        homeCoverageMapCityApplyButtonId: "home-coverage-map-city-apply-btn",
        homeCoverageMapCityClearButtonId: "home-coverage-map-city-clear-btn"
    };
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
<script src="~/js/views/admin-home/index.js" asp-append-version="true"></script>
}
