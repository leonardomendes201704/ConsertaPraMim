@using ConsertaPraMim.Web.Admin.Security
@inject IConfiguration Configuration
@model ConsertaPraMim.Web.Admin.Models.AdminMonitoringIndexViewModel
@{
    ViewData["Title"] = "Monitoramento";
    var filters = Model.Filters;

    var apiBaseUrl = (Configuration["ApiBaseUrl"] ?? string.Empty).TrimEnd('/');
    var browserApiBaseUrl = apiBaseUrl;
    if (!string.IsNullOrWhiteSpace(apiBaseUrl) && Uri.TryCreate(apiBaseUrl, UriKind.Absolute, out var apiBaseUri))
    {
        var requestHost = (Context.Request.Host.Host ?? string.Empty).Trim();
        var isRequestFromLocalhost =
            requestHost.Equals("localhost", StringComparison.OrdinalIgnoreCase) ||
            requestHost.Equals("127.0.0.1", StringComparison.OrdinalIgnoreCase) ||
            requestHost.Equals("::1", StringComparison.OrdinalIgnoreCase);
        var isConfiguredLocalhost =
            apiBaseUri.Host.Equals("localhost", StringComparison.OrdinalIgnoreCase) ||
            apiBaseUri.Host.Equals("127.0.0.1", StringComparison.OrdinalIgnoreCase) ||
            apiBaseUri.Host.Equals("::1", StringComparison.OrdinalIgnoreCase);

        if (!isRequestFromLocalhost && isConfiguredLocalhost)
        {
            var browserApiBuilder = new UriBuilder(apiBaseUri)
            {
                Host = requestHost
            };
            browserApiBaseUrl = browserApiBuilder.Uri.GetLeftPart(UriPartial.Authority);
        }
    }

    var apiToken = User.FindFirst(AdminClaimTypes.ApiToken)?.Value ?? string.Empty;
}

<style>
    #requestsBody tr.monitoring-row-error > td {
        color: #b42318;
    }

    #requestsBody tr.monitoring-row-error .btn-link,
    #requestsBody tr.monitoring-row-error .small {
        color: #b42318 !important;
    }

    #requestsBody tr.monitoring-row-error > td,
    #requestsBody tr.monitoring-row-warn > td,
    #requestsBody tr.monitoring-row-error .btn-link,
    #requestsBody tr.monitoring-row-warn .btn-link,
    #requestsBody tr.monitoring-row-error .small,
    #requestsBody tr.monitoring-row-warn .small {
        font-weight: 400 !important;
    }

    .monitoring-uniform-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .monitoring-sort-btn {
        border: 0;
        background: transparent;
        padding: 0;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font: inherit;
        color: inherit;
        cursor: pointer;
    }

    .monitoring-sort-btn:hover {
        color: #0d6efd;
    }

    .monitoring-sort-btn .sort-icon {
        color: #97a2b1;
        font-size: 0.72rem;
    }

    .monitoring-sort-btn.is-active {
        color: #0d6efd;
    }

    .monitoring-sort-btn.is-active .sort-icon {
        color: #0d6efd;
    }

    .monitoring-grid-table tbody tr > td {
        transition: background-color 0.16s ease, color 0.16s ease;
    }

    .monitoring-grid-table tbody tr:hover > td {
        background-color: #ecf3ff;
        color: #102a43;
    }

    .monitoring-grid-table tbody tr:hover .btn-link,
    .monitoring-grid-table tbody tr:hover .small {
        color: #102a43 !important;
    }

    #requestsDrilldownTable th:not(.text-start),
    #requestsDrilldownTable td:not(.text-start) {
        text-align: center;
    }

    #requestsDrilldownTable th .monitoring-sort-btn {
        width: 100%;
        justify-content: center;
    }

    #requestsDrilldownTable th.text-start .monitoring-sort-btn {
        justify-content: flex-start;
    }

    #requestsBody tr.monitoring-row-error:hover > td {
        background-color: #ffe9e6;
        color: #912018;
    }

    #requestsBody tr.monitoring-row-error:hover .btn-link,
    #requestsBody tr.monitoring-row-error:hover .small {
        color: #912018 !important;
    }

    .kpi-card .kpi-icon {
        width: 2rem;
        height: 2rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        font-size: 0.9rem;
    }

    .kpi-card .kpi-value {
        font-weight: 700;
    }

    .kpi-card .kpi-label {
        font-size: 0.78rem;
        color: #6c757d;
    }

    .kpi-health-healthy {
        color: #198754;
    }

    .kpi-health-unhealthy {
        color: #dc3545;
    }

    .kpi-health-unknown {
        color: #fd7e14;
    }

    .monitoring-json {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 260px;
        overflow: auto;
        font-size: 0.78rem;
        line-height: 1.35;
        font-family: Consolas, "Courier New", monospace;
    }

    .telemetry-runtime-switch .form-check-input {
        cursor: pointer;
    }

    .telemetry-runtime-switch .form-check-label {
        cursor: pointer;
        user-select: none;
    }

    .monitoring-offline-state {
        border: 1px dashed #ced4da;
    }

    .monitoring-offline-state .offline-illustration {
        width: 130px;
        height: auto;
    }

    .monitoring-filters-drawer {
        width: min(420px, 92vw);
    }

</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-1">Monitoramento</h3>
        <p class="text-muted mb-0">Observabilidade E2E da API com m√©tricas operacionais e drilldown t√©cnico.</p>
    </div>
    <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
        <div class="form-check form-switch telemetry-runtime-switch mb-0">
            <input class="form-check-input" type="checkbox" role="switch" id="telemetryEnabledSwitch" disabled>
            <label class="form-check-label small text-muted" for="telemetryEnabledSwitch">Telemetria</label>
        </div>
        <span id="telemetryRuntimeStatusBadge" class="badge text-bg-secondary">Carregando...</span>
        <button id="btnRefreshMonitoring" type="button" class="btn btn-outline-primary">
            <i class="fas fa-rotate me-1"></i>Atualizar
        </button>
        <button id="btnOpenMonitoringFiltersDrawer"
                type="button"
                class="btn btn-outline-dark"
                data-bs-toggle="offcanvas"
                data-bs-target="#monitoringFiltersDrawer"
                aria-controls="monitoringFiltersDrawer">
            <i class="fas fa-sliders me-1"></i>Filtros
        </button>
        <button id="btnPauseMonitoringAutoRefresh" type="button" class="btn btn-outline-secondary">
            <i class="fas fa-pause me-1"></i>Pausar
        </button>
        <span id="monitoringAutoRefreshStatus" class="badge text-bg-light">Atualizando</span>
    </div>
</div>

<div id="monitoringOfflineState" class="card border-0 shadow-sm monitoring-offline-state d-none mb-3">
    <div class="card-body text-center py-5">
        <svg class="offline-illustration mb-3" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="16" y="20" width="96" height="72" rx="10" stroke="#6c757d" stroke-width="4"/>
            <rect x="24" y="30" width="80" height="18" rx="4" fill="#e9ecef"/>
            <rect x="24" y="54" width="80" height="12" rx="4" fill="#e9ecef"/>
            <rect x="24" y="70" width="36" height="12" rx="4" fill="#e9ecef"/>
            <path d="M28 106L100 22" stroke="#dc3545" stroke-width="6" stroke-linecap="round"/>
            <circle cx="64" cy="106" r="4" fill="#6c757d"/>
        </svg>
        <h5 class="mb-2">Telemetria desligada</h5>
        <p class="text-muted mb-0">Ative o switch de telemetria para voltar a exibir mÈtricas e gr·ficos de observabilidade.</p>
    </div>
</div>

<div class="offcanvas offcanvas-end monitoring-filters-drawer"
     tabindex="-1"
     id="monitoringFiltersDrawer"
     aria-labelledby="monitoringFiltersDrawerLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="monitoringFiltersDrawerLabel">Filtros de monitoramento</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body">
        <form id="monitoringFiltersForm" class="d-flex flex-column gap-3">
            <div>
                <label class="form-label small text-muted mb-1" for="range">Range</label>
                <select id="range" class="form-select form-select-sm">
                    <option value="1h" selected="@(filters.Range == "1h")">1h</option>
                    <option value="2h" selected="@(filters.Range == "2h")">2h</option>
                    <option value="4h" selected="@(filters.Range == "4h")">4h</option>
                    <option value="6h" selected="@(filters.Range == "6h")">6h</option>
                    <option value="8h" selected="@(filters.Range == "8h")">8h</option>
                    <option value="12h" selected="@(filters.Range == "12h")">12h</option>
                    <option value="24h" selected="@(filters.Range == "24h")">24h</option>
                    <option value="7d" selected="@(filters.Range == "7d")">7 dias</option>
                    <option value="30d" selected="@(filters.Range == "30d")">30 dias</option>
                </select>
            </div>
            <div>
                <label class="form-label small text-muted mb-1" for="refreshInterval">AtualizaÁ„o</label>
                <select id="refreshInterval" class="form-select form-select-sm">
                    <option value="1000">1s</option>
                    <option value="5000" selected>5s</option>
                    <option value="10000">10s</option>
                    <option value="15000">15s</option>
                    <option value="30000">30s</option>
                    <option value="60000">1m</option>
                    <option value="300000">5m</option>
                </select>
            </div>
            <div>
                <label class="form-label small text-muted mb-1" for="endpoint">Endpoint</label>
                <input id="endpoint" class="form-control form-control-sm" value="@filters.Endpoint" placeholder="Ex: /api/admin/..." />
            </div>
            <div>
                <label class="form-label small text-muted mb-1" for="statusCode">Status</label>
                <input id="statusCode" class="form-control form-control-sm" value="@filters.StatusCode" placeholder="200, 404, 500..." />
            </div>
            <div>
                <label class="form-label small text-muted mb-1" for="severity">Severidade</label>
                <select id="severity" class="form-select form-select-sm">
                    <option value="" selected="@(string.IsNullOrWhiteSpace(filters.Severity))">Todas</option>
                    <option value="info" selected="@(filters.Severity == "info")">Info</option>
                    <option value="warn" selected="@(filters.Severity == "warn")">Warn</option>
                    <option value="error" selected="@(filters.Severity == "error")">Error</option>
                </select>
            </div>
            <div>
                <label class="form-label small text-muted mb-1" for="tenantId">Tenant</label>
                <input id="tenantId" class="form-control form-control-sm" value="@filters.TenantId" placeholder="tenant-opcional" />
            </div>
            <div class="d-flex gap-2 pt-2">
                <button type="submit" class="btn btn-primary btn-sm flex-grow-1">Aplicar</button>
                <button id="btnClearMonitoringFilters" type="button" class="btn btn-outline-secondary btn-sm flex-grow-1">Limpar</button>
            </div>
        </form>
    </div>
</div>

<div id="monitoringDashboardContent">
<div id="monitoringErrorAlert" class="alert alert-warning d-none"></div>
<div id="monitoringLoadingAlert" class="alert alert-info d-none">Carregando m√©tricas de monitoramento...</div>

<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-5 g-2 mb-3" id="kpiCards">
    <div class="col">
        <div class="card border-0 shadow-sm kpi-card h-100">
            <div class="card-body d-flex align-items-center gap-2">
                <span class="kpi-icon text-bg-primary"><i class="fas fa-wave-square"></i></span>
                <div>
                    <div class="kpi-label">Total Requests</div>
                    <div id="kpiTotalRequests" class="h5 mb-0 kpi-value text-primary">-</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 shadow-sm kpi-card h-100">
            <div class="card-body d-flex align-items-center gap-2">
                <span class="kpi-icon text-bg-danger"><i class="fas fa-triangle-exclamation"></i></span>
                <div>
                    <div class="kpi-label">Error Rate</div>
                    <div id="kpiErrorRate" class="h5 mb-0 kpi-value text-danger">-</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 shadow-sm kpi-card h-100">
            <div class="card-body d-flex align-items-center gap-2">
                <span class="kpi-icon text-bg-warning text-dark"><i class="fas fa-stopwatch"></i></span>
                <div>
                    <div class="kpi-label">Latencia p95</div>
                    <div id="kpiP95" class="h5 mb-0 kpi-value text-warning">-</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 shadow-sm kpi-card h-100">
            <div class="card-body d-flex align-items-center gap-2">
                <span class="kpi-icon text-bg-info text-dark"><i class="fas fa-gauge"></i></span>
                <div>
                    <div class="kpi-label">Requests/min</div>
                    <div id="kpiRpm" class="h5 mb-0 kpi-value text-info">-</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 shadow-sm kpi-card h-100">
            <div class="card-body d-flex align-items-center gap-2">
                <span class="kpi-icon text-bg-success"><i class="fas fa-server"></i></span>
                <div>
                    <div class="kpi-label">Health API</div>
                    <div id="kpiApiHealth" class="h5 mb-0 kpi-value kpi-health-healthy">-</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 shadow-sm kpi-card h-100">
            <div class="card-body d-flex align-items-center gap-2">
                <span class="kpi-icon text-bg-secondary"><i class="fas fa-database"></i></span>
                <div>
                    <div class="kpi-label">Health Banco</div>
                    <div id="kpiDbHealth" class="h5 mb-0 kpi-value kpi-health-unknown">-</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 shadow-sm kpi-card h-100">
            <div class="card-body d-flex align-items-center gap-2">
                <span class="kpi-icon text-bg-dark"><i class="fas fa-clock"></i></span>
                <div>
                    <div class="kpi-label">Uptime API</div>
                    <div id="kpiApiUptime" class="h5 mb-0 kpi-value text-dark">-</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 shadow-sm kpi-card h-100">
            <div class="card-body d-flex align-items-center gap-2">
                <span class="kpi-icon text-bg-success"><i class="fas fa-user"></i></span>
                <div>
                    <div class="kpi-label">Health Portal Cliente</div>
                    <div id="kpiClientPortalHealth" class="h5 mb-0 kpi-value kpi-health-unknown">-</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 shadow-sm kpi-card h-100">
            <div class="card-body d-flex align-items-center gap-2">
                <span class="kpi-icon text-bg-info text-dark"><i class="fas fa-briefcase"></i></span>
                <div>
                    <div class="kpi-label">Health Portal Prestador</div>
                    <div id="kpiProviderPortalHealth" class="h5 mb-0 kpi-value kpi-health-unknown">-</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 shadow-sm kpi-card h-100">
            <div class="card-body d-flex align-items-center gap-2">
                <span class="kpi-icon text-bg-secondary"><i class="fas fa-route"></i></span>
                <div class="w-100">
                    <div class="kpi-label">Top Endpoint</div>
                    <div id="kpiTopEndpoint" class="h6 mb-0 kpi-value text-secondary text-truncate">-</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-12">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white"><strong>Requests, Erros e Latencia ao longo do tempo</strong></div>
            <div class="card-body">
                <canvas id="requestsErrorsChart" height="180"></canvas>
                <div class="d-flex align-items-center gap-3 mt-2 small text-muted">
                    <span><i class="fas fa-minus me-1" style="color:#0d6efd;"></i>Requests</span>
                    <span><i class="fas fa-minus me-1" style="color:#dc3545;"></i>Erros</span>
                    <span><i class="fas fa-minus me-1" style="color:#198754;"></i>Latencia p50</span>
                    <span><i class="fas fa-minus me-1" style="color:#fd7e14;"></i>Latencia p95</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white"><strong>Distribui√ß√£o por status code</strong></div>
            <div class="card-body" id="statusDistribution"></div>
        </div>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white"><strong>Top Endpoints</strong></div>
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0 monitoring-grid-table">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">
                                <button type="button" class="monitoring-sort-btn" data-sort-table="topEndpoints" data-sort-field="method">
                                    Tipo <i class="fas fa-sort sort-icon"></i>
                                </button>
                            </th>
                            <th class="text-start">
                                <button type="button" class="monitoring-sort-btn" data-sort-table="topEndpoints" data-sort-field="endpointTemplate">
                                    Endpoint <i class="fas fa-sort sort-icon"></i>
                                </button>
                            </th>
                            <th class="text-center">
                                <button type="button" class="monitoring-sort-btn" data-sort-table="topEndpoints" data-sort-field="hits">
                                    Hits <i class="fas fa-sort sort-icon"></i>
                                </button>
                            </th>
                            <th class="text-center">
                                <button type="button" class="monitoring-sort-btn" data-sort-table="topEndpoints" data-sort-field="p95LatencyMs">
                                    p95 <i class="fas fa-sort sort-icon"></i>
                                </button>
                            </th>
                            <th class="text-center">
                                <button type="button" class="monitoring-sort-btn" data-sort-table="topEndpoints" data-sort-field="errorRatePercent">
                                    Error Rate <i class="fas fa-sort sort-icon"></i>
                                </button>
                            </th>
                            <th class="text-center">
                                <button type="button" class="monitoring-sort-btn" data-sort-table="topEndpoints" data-sort-field="warningCount">
                                    Warnings <i class="fas fa-sort sort-icon"></i>
                                </button>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="topEndpointsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <strong>Top Erros</strong>
                <select id="groupBy" class="form-select form-select-sm w-auto">
                    <option value="type" selected="@(filters.GroupBy == "type")">Por tipo</option>
                    <option value="endpoint" selected="@(filters.GroupBy == "endpoint")">Por endpoint</option>
                    <option value="status" selected="@(filters.GroupBy == "status")">Por status</option>
                </select>
            </div>
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0 monitoring-grid-table">
                    <thead class="table-light">
                        <tr>
                            <th class="text-start">
                                <button type="button" class="monitoring-sort-btn" data-sort-table="topErrors" data-sort-field="errorType">
                                    Chave <i class="fas fa-sort sort-icon"></i>
                                </button>
                            </th>
                            <th class="text-center">
                                <button type="button" class="monitoring-sort-btn" data-sort-table="topErrors" data-sort-field="count">
                                    Qtd <i class="fas fa-sort sort-icon"></i>
                                </button>
                            </th>
                            <th class="text-center">Acoes</th>
                        </tr>
                    </thead>
                    <tbody id="topErrorsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>Requests (drilldown)</strong>
        <div class="d-flex align-items-center gap-2">
            <input id="search" class="form-control form-control-sm" style="width: 260px;" value="@filters.Search" placeholder="Buscar correlationId/endpoint/erro..." />
            <button id="btnSearch" type="button" class="btn btn-sm btn-outline-primary">Buscar</button>
            <button id="btnExportRequestsCsv" type="button" class="btn btn-sm btn-outline-success">Exportar CSV</button>
        </div>
    </div>
    <div class="table-responsive">
        <table id="requestsDrilldownTable" class="table table-sm align-middle mb-0 monitoring-grid-table">
            <thead class="table-light">
                <tr>
                    <th class="text-center">
                        <button type="button" class="monitoring-sort-btn" data-sort-table="requests" data-sort-field="method">
                            Tipo <i class="fas fa-sort sort-icon"></i>
                        </button>
                    </th>
                    <th class="text-center">
                        <button type="button" class="monitoring-sort-btn" data-sort-table="requests" data-sort-field="timestampUtc">
                            Data/Hora <i class="fas fa-sort sort-icon"></i>
                        </button>
                    </th>
                    <th class="text-start">
                        <button type="button" class="monitoring-sort-btn" data-sort-table="requests" data-sort-field="endpointTemplate">
                            Endpoint <i class="fas fa-sort sort-icon"></i>
                        </button>
                    </th>
                    <th class="text-start">
                        <button type="button" class="monitoring-sort-btn" data-sort-table="requests" data-sort-field="origin">
                            Origem <i class="fas fa-sort sort-icon"></i>
                        </button>
                    </th>
                    <th class="text-center">
                        <button type="button" class="monitoring-sort-btn" data-sort-table="requests" data-sort-field="environmentName">
                            Ambiente <i class="fas fa-sort sort-icon"></i>
                        </button>
                    </th>
                    <th class="text-center">
                        <button type="button" class="monitoring-sort-btn" data-sort-table="requests" data-sort-field="statusCode">
                            Status <i class="fas fa-sort sort-icon"></i>
                        </button>
                    </th>
                    <th class="text-center">
                        <button type="button" class="monitoring-sort-btn" data-sort-table="requests" data-sort-field="durationMs">
                            Dura√ß√£o <i class="fas fa-sort sort-icon"></i>
                        </button>
                    </th>
                    <th class="text-center">
                        <button type="button" class="monitoring-sort-btn" data-sort-table="requests" data-sort-field="severity">
                            Sev. <i class="fas fa-sort sort-icon"></i>
                        </button>
                    </th>
                    <th class="text-center">Acoes</th>
                </tr>
            </thead>
            <tbody id="requestsBody"></tbody>
        </table>
    </div>
    <div class="card-footer bg-white d-flex justify-content-between align-items-center">
        <small id="requestsPaginationText" class="text-muted"></small>
        <div id="requestsPaginationNav" class="d-flex align-items-center gap-1 flex-wrap">
            <button id="btnFirstPage" type="button" class="btn btn-sm btn-outline-secondary">Primeira</button>
            <button id="btnPrevPage" type="button" class="btn btn-sm btn-outline-secondary">Anterior</button>
            <div id="requestsPageNumbers" class="d-flex align-items-center gap-1 flex-wrap"></div>
            <button id="btnNextPage" type="button" class="btn btn-sm btn-outline-secondary">Proxima</button>
            <button id="btnLastPage" type="button" class="btn btn-sm btn-outline-secondary">Ultima</button>
        </div>
    </div>
</div>

</div>

<div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhe do Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="small text-muted">Metadados do request</div>
                        <button id="btnCopyRequestDetailsMeta" type="button" class="btn btn-sm btn-outline-secondary">Copiar</button>
                    </div>
                    <pre id="requestDetailsMetaJson" class="monitoring-json bg-light p-3 rounded border"></pre>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="small text-muted">Request body (JSON)</div>
                        <button id="btnCopyRequestDetailsRequest" type="button" class="btn btn-sm btn-outline-secondary">Copiar</button>
                    </div>
                    <pre id="requestDetailsRequestJson" class="monitoring-json bg-light p-3 rounded border"></pre>
                </div>
                <div>
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="small text-muted">Response body (JSON)</div>
                        <button id="btnCopyRequestDetailsResponse" type="button" class="btn btn-sm btn-outline-secondary">Copiar</button>
                    </div>
                    <pre id="requestDetailsResponseJson" class="monitoring-json bg-light p-3 rounded border"></pre>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="small text-muted">Contexto capturado (headers/query/route)</div>
                        <button id="btnCopyRequestDetailsContext" type="button" class="btn btn-sm btn-outline-secondary">Copiar</button>
                    </div>
                    <pre id="requestDetailsContextJson" class="monitoring-json bg-light p-3 rounded border"></pre>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="small text-muted">Diagnostico da captura</div>
                        <button id="btnCopyRequestDetailsDiagnostics" type="button" class="btn btn-sm btn-outline-secondary">Copiar</button>
                    </div>
                    <pre id="requestDetailsDiagnosticsJson" class="monitoring-json bg-light p-3 rounded border"></pre>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="errorDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhe do Erro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="small text-muted">Resumo do erro</div>
                        <button id="btnCopyErrorDetailsMeta" type="button" class="btn btn-sm btn-outline-secondary">Copiar</button>
                    </div>
                    <pre id="errorDetailsMetaJson" class="monitoring-json bg-light p-3 rounded border"></pre>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="small text-muted">Stack trace (amostra)</div>
                        <button id="btnCopyErrorDetailsStack" type="button" class="btn btn-sm btn-outline-secondary">Copiar</button>
                    </div>
                    <pre id="errorDetailsStackJson" class="monitoring-json bg-light p-3 rounded border"></pre>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="small text-muted">Ocorrencias recentes (com payload/cabecalhos/contexto)</div>
                        <button id="btnCopyErrorDetailsSamples" type="button" class="btn btn-sm btn-outline-secondary">Copiar</button>
                    </div>
                    <pre id="errorDetailsSamplesJson" class="monitoring-json bg-light p-3 rounded border"></pre>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0 monitoring-grid-table">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">Data/Hora</th>
                                <th class="text-center">Tipo</th>
                                <th class="text-start">Endpoint</th>
                                <th class="text-center">Status</th>
                                <th class="text-center">Sev.</th>
                                <th class="text-center">Duracao</th>
                                <th class="text-center">Acao</th>
                            </tr>
                        </thead>
                        <tbody id="errorDetailsSamplesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    window.adminMonitoringConfig = {
        monitoringApiBaseUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(browserApiBaseUrl)),
        monitoringHubToken: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(apiToken)),
        page: @filters.Page,
        pageSize: @filters.PageSize,
        endpoints: {
            overviewUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("Overview", "AdminMonitoring"))),
            topEndpointsUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("TopEndpoints", "AdminMonitoring"))),
            errorsUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("Errors", "AdminMonitoring"))),
            errorDetailsUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("ErrorDetails", "AdminMonitoring"))),
            requestsUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("Requests", "AdminMonitoring"))),
            requestDetailsUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("RequestDetails", "AdminMonitoring"))),
            exportRequestsCsvUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("ExportRequestsCsv", "AdminMonitoring"))),
            configUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("Config", "AdminMonitoring"))),
            toggleTelemetryUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("ToggleTelemetry", "AdminMonitoring")))
        }
    };
</script>
<script src="~/js/views/admin-monitoring/index.js" asp-append-version="true"></script>
}




