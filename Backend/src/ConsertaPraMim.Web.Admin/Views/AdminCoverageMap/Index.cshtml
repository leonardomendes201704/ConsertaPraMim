@{
    ViewData["Title"] = "Mapa Operacional";
    var snapshotUrl = Url.Action("Snapshot", "AdminCoverageMap") ?? "/AdminCoverageMap/Snapshot";
}

<div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
    <div>
        <h1 class="h4 fw-bold mb-1">Mapa Operacional</h1>
        <p class="text-muted mb-0">Pedidos e prestadores com visualizacao de raio de atuacao.</p>
    </div>
    <div class="d-flex flex-wrap align-items-center gap-2">
        <div class="input-group input-group-sm coverage-map-city-filter">
            <span class="input-group-text">
                <i class="fas fa-city" aria-hidden="true"></i>
            </span>
            <input type="text"
                   id="coverage-map-city-input"
                   class="form-control"
                   placeholder="Filtrar por cidade (ex: Praia Grande)"
                   autocomplete="off" />
            <button type="button" class="btn btn-outline-primary" id="coverage-map-city-apply-btn">
                Filtrar
            </button>
            <button type="button" class="btn btn-outline-secondary" id="coverage-map-city-clear-btn">
                Limpar
            </button>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm" id="coverage-map-refresh-btn">
            <i class="fas fa-rotate-right me-1"></i> Atualizar mapa
        </button>
        <div class="form-check form-switch coverage-map-auto-refresh-switch m-0">
            <input class="form-check-input"
                   type="checkbox"
                   role="switch"
                   id="coverage-map-auto-refresh-toggle"
                   checked />
            <label class="form-check-label small text-muted" for="coverage-map-auto-refresh-toggle">
                Atualizacao automatica
            </label>
        </div>
    </div>
</div>

<div class="widget-card card">
    <div class="card-body">
        <div id="coverage-map-state" class="alert alert-info py-2 px-3 mb-3">
            Carregando mapa operacional...
        </div>
        <div id="coverage-map" class="coverage-map"></div>
        <div class="coverage-map-legend mt-3">
            <span class="coverage-map-legend-item">
                <i class="fas fa-map-marker-alt coverage-map-legend-icon provider" aria-hidden="true"></i>
                Prestadores
                <span class="badge rounded-pill text-bg-primary-subtle text-primary-emphasis coverage-map-legend-count"
                      id="coverage-map-provider-count">0</span>
            </span>
            <span class="coverage-map-legend-item">
                <i class="fas fa-map-marker-alt coverage-map-legend-icon request" aria-hidden="true"></i>
                Pedidos
                <span class="badge rounded-pill text-bg-danger-subtle text-danger-emphasis coverage-map-legend-count"
                      id="coverage-map-request-count">0</span>
            </span>
            <span class="coverage-map-legend-item">
                <span class="coverage-map-legend-dot radius"></span>
                Raio de atuacao
            </span>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />
    <style>
        .coverage-map {
            height: min(72vh, 760px);
            min-height: 460px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .coverage-map-city-filter {
            width: min(480px, 92vw);
        }

        .coverage-map-auto-refresh-switch {
            min-width: 185px;
            padding-left: 2.3rem;
        }

        .coverage-map-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            color: #475569;
        }

        .coverage-map-legend-item {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            font-size: .86rem;
        }

        .coverage-map-legend-count {
            min-width: 2.1rem;
            text-align: center;
            font-weight: 600;
        }

        .coverage-map-legend-dot {
            width: 11px;
            height: 11px;
            border-radius: 50%;
            display: inline-block;
        }

        .coverage-map-legend-dot.provider {
            background: #2563eb;
        }

        .coverage-map-legend-dot.request {
            background: #e11d48;
        }

        .coverage-map-legend-dot.radius {
            border: 1px solid #2563eb;
            background: rgba(37, 99, 235, 0.04);
        }

        .coverage-map-legend-icon {
            font-size: 1rem;
            line-height: 1;
            transform: translateY(-1px);
        }

        .coverage-map-legend-icon.provider {
            color: #2563eb;
        }

        .coverage-map-legend-icon.request {
            color: #e11d48;
        }

        .coverage-map-pin {
            background: transparent;
            border: none;
        }

        .coverage-map-pin i {
            font-size: 1.75rem;
            filter: drop-shadow(0 3px 4px rgba(15, 23, 42, 0.32));
            -webkit-text-stroke: 0.65px rgba(255, 255, 255, 0.95);
        }

        .coverage-map-pin.provider i {
            color: #2563eb;
        }

        .coverage-map-pin.request i {
            color: #e11d48;
        }
    </style>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>
    <script>
        window.adminCoverageMapConfig = {
            snapshotUrl: "@snapshotUrl",
            mapElementId: "coverage-map",
            statusElementId: "coverage-map-state",
            refreshButtonId: "coverage-map-refresh-btn",
            cityInputId: "coverage-map-city-input",
            cityApplyButtonId: "coverage-map-city-apply-btn",
            cityClearButtonId: "coverage-map-city-clear-btn",
            autoRefreshToggleId: "coverage-map-auto-refresh-toggle"
        };
    </script>
    <script src="~/js/views/admin-coverage-map/index.js" asp-append-version="true"></script>
}
