@model ConsertaPraMim.Web.Admin.Models.AdminLoadTestsIndexViewModel
@{
    ViewData["Title"] = "Testes de Carga";
    var filters = Model.Filters;
    var initialErrorJson = System.Text.Json.JsonSerializer.Serialize(Model.ErrorMessage ?? string.Empty);
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-1">Testes de Carga</h3>
        <p class="text-muted mb-0">Historico de runs importados pelo load test runner e detalhe tecnico por execucao.</p>
    </div>
    <button id="btnRefreshLoadTests" type="button" class="btn btn-outline-primary">
        <i class="fas fa-rotate me-1"></i>Atualizar
    </button>
</div>

<form id="loadTestFiltersForm" class="card border-0 shadow-sm mb-3">
    <div class="card-body">
        <div class="row g-2">
            <div class="col-12 col-md-2">
                <label class="form-label small text-muted mb-1" for="scenario">Cenario</label>
                <select id="scenario" class="form-select form-select-sm">
                    <option value="" selected="@(string.IsNullOrWhiteSpace(filters.Scenario))">Todos</option>
                    <option value="smoke" selected="@(filters.Scenario == "smoke")">smoke</option>
                    <option value="baseline" selected="@(filters.Scenario == "baseline")">baseline</option>
                    <option value="stress" selected="@(filters.Scenario == "stress")">stress</option>
                </select>
            </div>
            <div class="col-12 col-md-2">
                <label class="form-label small text-muted mb-1" for="fromUtc">De (UTC)</label>
                <input id="fromUtc" type="datetime-local" class="form-control form-control-sm" value="@(filters.FromUtc?.ToString("yyyy-MM-ddTHH:mm"))" />
            </div>
            <div class="col-12 col-md-2">
                <label class="form-label small text-muted mb-1" for="toUtc">Ate (UTC)</label>
                <input id="toUtc" type="datetime-local" class="form-control form-control-sm" value="@(filters.ToUtc?.ToString("yyyy-MM-ddTHH:mm"))" />
            </div>
            <div class="col-12 col-md-3">
                <label class="form-label small text-muted mb-1" for="search">Busca</label>
                <input id="search" class="form-control form-control-sm" value="@filters.Search" placeholder="runId, baseUrl, source..." />
            </div>
            <div class="col-12 col-md-2">
                <label class="form-label small text-muted mb-1" for="pageSize">Page size</label>
                <select id="pageSize" class="form-select form-select-sm">
                    <option value="10" selected="@(filters.PageSize == 10)">10</option>
                    <option value="20" selected="@(filters.PageSize == 20)">20</option>
                    <option value="50" selected="@(filters.PageSize == 50)">50</option>
                    <option value="100" selected="@(filters.PageSize == 100)">100</option>
                </select>
            </div>
            <div class="col-12 col-md-1 d-grid">
                <label class="form-label small text-muted mb-1">&nbsp;</label>
                <button type="submit" class="btn btn-primary btn-sm">Aplicar</button>
            </div>
        </div>
    </div>
</form>

<div id="loadTestsErrorAlert" class="alert alert-warning d-none"></div>
<div id="loadTestsLoadingAlert" class="alert alert-info d-none">Carregando runs de carga...</div>

<div class="card border-0 shadow-sm">
    <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Inicio</th>
                    <th>Cenario</th>
                    <th>RunId</th>
                    <th>Base URL</th>
                    <th class="text-end">Requests</th>
                    <th class="text-end">Error Rate</th>
                    <th class="text-end">p95</th>
                    <th class="text-end">RPS</th>
                    <th>Source</th>
                    <th>Acoes</th>
                </tr>
            </thead>
            <tbody id="loadTestsBody"></tbody>
        </table>
    </div>
    <div class="card-footer bg-white d-flex justify-content-between align-items-center">
        <small id="loadTestsPaginationText" class="text-muted"></small>
        <div class="btn-group btn-group-sm">
            <button id="btnPrevPage" type="button" class="btn btn-outline-secondary">Anterior</button>
            <button id="btnNextPage" type="button" class="btn btn-outline-secondary">Proxima</button>
        </div>
    </div>
</div>

<div class="modal fade" id="loadTestDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhe do Run de Carga</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2 mb-3">
                    <div class="col-12 col-md-2"><div class="card border-0 bg-light"><div class="card-body p-2"><div class="small text-muted">Total</div><div id="detailTotalRequests" class="fw-semibold">-</div></div></div></div>
                    <div class="col-12 col-md-2"><div class="card border-0 bg-light"><div class="card-body p-2"><div class="small text-muted">Falhas</div><div id="detailFailedRequests" class="fw-semibold">-</div></div></div></div>
                    <div class="col-12 col-md-2"><div class="card border-0 bg-light"><div class="card-body p-2"><div class="small text-muted">Error Rate</div><div id="detailErrorRate" class="fw-semibold">-</div></div></div></div>
                    <div class="col-12 col-md-2"><div class="card border-0 bg-light"><div class="card-body p-2"><div class="small text-muted">RPS avg/pico</div><div id="detailRps" class="fw-semibold">-</div></div></div></div>
                    <div class="col-12 col-md-2"><div class="card border-0 bg-light"><div class="card-body p-2"><div class="small text-muted">Lat p95</div><div id="detailP95" class="fw-semibold">-</div></div></div></div>
                    <div class="col-12 col-md-2"><div class="card border-0 bg-light"><div class="card-body p-2"><div class="small text-muted">Duracao</div><div id="detailDuration" class="fw-semibold">-</div></div></div></div>
                </div>

                <div class="mb-3">
                    <div id="detailHeaderText" class="small text-muted"></div>
                </div>

                <div class="row g-3">
                    <div class="col-12 col-lg-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white"><strong>Top endpoints por hits</strong></div>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Endpoint</th>
                                            <th class="text-end">Hits</th>
                                            <th class="text-end">p95</th>
                                            <th class="text-end">Erro %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailTopEndpointsBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white"><strong>Top erros</strong></div>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Erro normalizado</th>
                                            <th class="text-end">Qtd</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailTopErrorsBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mt-3">
                    <div class="card-header bg-white"><strong>Amostras de falha</strong></div>
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Metodo</th>
                                    <th>Path</th>
                                    <th>Status</th>
                                    <th>CorrelationId</th>
                                    <th>Erro</th>
                                </tr>
                            </thead>
                            <tbody id="detailFailureSamplesBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-3">
                    <div class="small text-muted mb-1">Payload bruto do report</div>
                    <pre id="detailRawJson" class="bg-light border rounded p-3 mb-0" style="max-height:240px; overflow:auto; font-size:0.78rem;"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    window.cpmAdminLoadTests = {
        initialError: @Html.Raw(initialErrorJson),
        initialPage: @filters.Page,
        initialPageSize: @filters.PageSize,
        runsUrl: '@Url.Action("Runs", "AdminLoadTests")',
        runDetailsUrl: '@Url.Action("RunDetails", "AdminLoadTests")'
    };
</script>
<script src="~/js/views/admin-load-tests/index.js" asp-append-version="true"></script>
}
