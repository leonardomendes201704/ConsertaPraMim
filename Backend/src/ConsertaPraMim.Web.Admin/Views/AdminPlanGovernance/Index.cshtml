@using ConsertaPraMim.Domain.Enums
@using ConsertaPraMim.Application.DTOs
@model ConsertaPraMim.Web.Admin.Models.AdminPlanGovernanceIndexViewModel
@{
    ViewData["Title"] = "Planos e Ofertas";
    var snapshot = Model?.Snapshot;
    var settings = snapshot?.PlanSettings ?? Array.Empty<AdminPlanSettingDto>();
    var promotions = snapshot?.Promotions ?? Array.Empty<AdminPlanPromotionDto>();
    var coupons = snapshot?.Coupons ?? Array.Empty<AdminPlanCouponDto>();
    var updatePlanSettingUrl = Url.Action("UpdatePlanSetting", "AdminPlanGovernance") ?? "/AdminPlanGovernance/UpdatePlanSetting";
    var createPromotionUrl = Url.Action("CreatePromotion", "AdminPlanGovernance") ?? "/AdminPlanGovernance/CreatePromotion";
    var updatePromotionUrl = Url.Action("UpdatePromotion", "AdminPlanGovernance") ?? "/AdminPlanGovernance/UpdatePromotion";
    var updatePromotionStatusUrl = Url.Action("UpdatePromotionStatus", "AdminPlanGovernance") ?? "/AdminPlanGovernance/UpdatePromotionStatus";
    var createCouponUrl = Url.Action("CreateCoupon", "AdminPlanGovernance") ?? "/AdminPlanGovernance/CreateCoupon";
    var updateCouponUrl = Url.Action("UpdateCoupon", "AdminPlanGovernance") ?? "/AdminPlanGovernance/UpdateCoupon";
    var updateCouponStatusUrl = Url.Action("UpdateCouponStatus", "AdminPlanGovernance") ?? "/AdminPlanGovernance/UpdateCouponStatus";
    var simulateUrl = Url.Action("Simulate", "AdminPlanGovernance") ?? "/AdminPlanGovernance/Simulate";
    var allServiceCategories = Enum
        .GetValues(typeof(ServiceCategory))
        .Cast<ServiceCategory>()
        .Select(category => new { Value = category.ToString(), Label = category.ToPtBr() })
        .ToArray();
}

<style>
    .admin-card { border: 0; border-radius: 14px; box-shadow: 0 10px 22px rgba(15,23,42,.08); }
    .admin-table th { font-size:.75rem; text-transform:uppercase; letter-spacing:.04em; color:#64748b; border-top:0; white-space:nowrap; }
    .promotion-discount-hint { font-size:.8rem; color:#64748b; }
    .field-hint { font-size:.8rem; color:#64748b; }
    .plan-category-listbox { border: 1px solid #cbd5e1; border-radius: .5rem; max-height: 14rem; overflow: auto; padding: .75rem; background: #fff; }
    .plan-category-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .5rem .75rem; }
    .plan-category-option { display: flex; align-items: center; gap: .45rem; font-size: .95rem; color: #1e293b; }

    @@media (max-width: 767.98px) {
        .plan-category-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
    <div>
        <h1 class="h4 fw-bold mb-1">Planos e Ofertas</h1>
        <p class="text-muted mb-0">Preços, promoções, cupons e limites operacionais por plano.</p>
    </div>
    <div class="text-muted small">Atualizado em @((Model?.LastUpdatedUtc ?? DateTime.UtcNow).ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss"))</div>
</div>

<div id="plan-feedback" class="d-none alert mb-3"></div>

@if (!string.IsNullOrWhiteSpace(Model?.ErrorMessage))
{
    <div class="alert alert-danger">@Model?.ErrorMessage</div>
}
else
{
    <div class="admin-card card mb-4">
        <div class="card-header bg-white"><h2 class="h6 fw-semibold mb-0">Configuração por Plano</h2></div>
        <div class="table-responsive">
            <table class="table table-hover mb-0 admin-table">
                <thead><tr><th>Plano</th><th>Preço</th><th>Raio máx.</th><th>Máx. categorias</th><th>Categorias permitidas</th><th>Fora da regra</th><th class="text-end">Ações</th></tr></thead>
                <tbody>
                @foreach (var item in settings)
                {
                    <tr data-plan="@item.Plan"
                        data-price="@item.MonthlyPrice"
                        data-radius="@item.MaxRadiusKm"
                        data-max-categories="@item.MaxAllowedCategories"
                        data-allowed="@string.Join(",", item.AllowedCategories)">
                        <td class="fw-semibold">@item.PlanLabel</td>
                        <td>@item.MonthlyPrice.ToString("C")</td>
                        <td>@item.MaxRadiusKm.ToString("0.#") km</td>
                        <td>@item.MaxAllowedCategories</td>
                        <td>@string.Join(", ", item.AllowedCategories)</td>
                        <td><span class="badge @(item.ProvidersOutsideOperationalLimits > 0 ? "bg-warning text-dark" : "bg-success-subtle text-success-emphasis")">@item.ProvidersOutsideOperationalLimits</span></td>
                        <td class="text-end"><button type="button" class="btn btn-outline-primary btn-sm js-edit-plan"><i class="fas fa-pen"></i> Editar</button></td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-12 col-lg-6">
            <div class="admin-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Promoções</h2>
                    <button type="button" class="btn btn-primary btn-sm" id="create-promotion-btn"><i class="fas fa-plus"></i> Nova</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0 admin-table">
                        <thead><tr><th>Plano</th><th>Nome</th><th>Desconto</th><th>Status</th><th class="text-end">Ações</th></tr></thead>
                        <tbody>
                        @foreach (var item in promotions)
                        {
                            <tr data-id="@item.Id" data-plan="@item.Plan" data-name="@item.Name" data-discount-type="@item.DiscountType" data-discount-value="@item.DiscountValue" data-start="@item.StartsAtUtc.ToString("yyyy-MM-ddTHH:mm:ss")" data-end="@item.EndsAtUtc.ToString("yyyy-MM-ddTHH:mm:ss")" data-active="@item.IsActive.ToString().ToLowerInvariant()">
                                <td>@item.PlanLabel</td>
                                <td>@item.Name</td>
                                <td>@(item.DiscountType == PricingDiscountType.Percentage ? $"{item.DiscountValue:0.##}%" : item.DiscountValue.ToString("C"))</td>
                                <td><span class="badge @(item.IsCurrentlyActive ? "bg-success" : item.IsActive ? "bg-warning text-dark" : "bg-secondary")">@(item.IsCurrentlyActive ? "Ativa" : item.IsActive ? "Agendada/expirada" : "Inativa")</span></td>
                                <td class="text-end">
                                    <div class="d-inline-flex gap-2">
                                        <button type="button" class="btn btn-outline-secondary btn-sm js-edit-promotion"><i class="fas fa-pen"></i></button>
                                        <button type="button" class="btn @(item.IsActive ? "btn-outline-danger" : "btn-outline-success") btn-sm js-toggle-promotion"><i class="fas @(item.IsActive ? "fa-ban" : "fa-check")"></i></button>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="admin-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">Cupons</h2>
                    <button type="button" class="btn btn-primary btn-sm" id="create-coupon-btn"><i class="fas fa-plus"></i> Novo</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0 admin-table">
                        <thead><tr><th>Código</th><th>Plano</th><th>Desconto</th><th>Status</th><th class="text-end">Ações</th></tr></thead>
                        <tbody>
                        @foreach (var item in coupons)
                        {
                            <tr data-id="@item.Id" data-code="@item.Code" data-name="@item.Name" data-plan="@item.Plan" data-discount-type="@item.DiscountType" data-discount-value="@item.DiscountValue" data-start="@item.StartsAtUtc.ToString("yyyy-MM-ddTHH:mm:ss")" data-end="@item.EndsAtUtc.ToString("yyyy-MM-ddTHH:mm:ss")" data-max-global="@item.MaxGlobalUses" data-max-provider="@item.MaxUsesPerProvider" data-active="@item.IsActive.ToString().ToLowerInvariant()">
                                <td>@item.Code</td>
                                <td>@(item.PlanLabel ?? "Todos")</td>
                                <td>@(item.DiscountType == PricingDiscountType.Percentage ? $"{item.DiscountValue:0.##}%" : item.DiscountValue.ToString("C"))</td>
                                <td><span class="badge @(item.IsCurrentlyActive ? "bg-success" : item.IsActive ? "bg-warning text-dark" : "bg-secondary")">@(item.IsCurrentlyActive ? "Ativo" : item.IsActive ? "Agendado/expirado" : "Inativo")</span></td>
                                <td class="text-end">
                                    <div class="d-inline-flex gap-2">
                                        <button type="button" class="btn btn-outline-secondary btn-sm js-edit-coupon"><i class="fas fa-pen"></i></button>
                                        <button type="button" class="btn @(item.IsActive ? "btn-outline-danger" : "btn-outline-success") btn-sm js-toggle-coupon"><i class="fas @(item.IsActive ? "fa-ban" : "fa-check")"></i></button>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-card card">
        <div class="card-header bg-white"><h2 class="h6 fw-semibold mb-0">Simulador de Preço</h2></div>
        <div class="card-body">
            <form id="sim-form" class="row g-2 align-items-end">
                <div class="col-lg-2 col-md-4"><label class="form-label">Plano</label><select id="sim-plan" class="form-select"><option>Bronze</option><option>Silver</option><option>Gold</option></select></div>
                <div class="col-lg-2 col-md-4"><label class="form-label">Cupom (opcional)</label><input id="sim-coupon" class="form-control"></div>
                <div class="col-lg-2 col-md-6"><label class="form-label">ProviderUserId (opcional)</label><input id="sim-provider" class="form-control" placeholder="GUID do prestador"></div>
                <div class="col-lg-2 col-md-6"><label class="form-label">Data (opcional)</label><input id="sim-at" type="datetime-local" class="form-control"></div>
                <div class="col-lg-2 col-md-4">
                    <div class="form-check mt-4 pt-2">
                        <input class="form-check-input" type="checkbox" id="sim-consume-credits">
                        <label class="form-check-label" for="sim-consume-credits">Consumir creditos</label>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 d-grid"><button type="submit" class="btn btn-primary"><i class="fas fa-calculator"></i> Simular</button></div>
            </form>
            <div id="sim-result" class="alert alert-light border mt-3 mb-0">Preencha os campos e simule.</div>
        </div>
    </div>

    <div class="modal fade" id="promotionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title fs-5" id="promotion-modal-title">Promoção</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div id="promotion-modal-feedback" class="alert alert-danger d-none mb-3"></div>
                    <input type="hidden" id="promotion-id" />
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="promotion-plan">Plano</label>
                        <select id="promotion-plan" class="form-select">
                            <option value="Bronze">Bronze</option>
                            <option value="Silver">Silver</option>
                            <option value="Gold">Gold</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="promotion-name">Nome da promoção</label>
                        <input id="promotion-name" class="form-control" maxlength="140" placeholder="Ex.: Semana do Prestador" />
                    </div>
                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="promotion-discount-type">Tipo de desconto</label>
                            <select id="promotion-discount-type" class="form-select">
                                <option value="Percentage">Percentual (%)</option>
                                <option value="FixedAmount">Valor fixo (R$)</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="promotion-discount-value">Valor do desconto</label>
                            <input id="promotion-discount-value" class="form-control" inputmode="decimal" placeholder="0,00" />
                            <div id="promotion-discount-hint" class="promotion-discount-hint">Use percentual de 0,01% até 100,00%.</div>
                        </div>
                    </div>
                    <div class="row g-2 mt-1">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="promotion-start">Início</label>
                            <input id="promotion-start" type="datetime-local" class="form-control" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="promotion-end">Fim</label>
                            <input id="promotion-end" type="datetime-local" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-promotion-btn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="planSettingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title fs-5">Editar configuração de plano</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div id="plan-modal-feedback" class="alert alert-danger d-none mb-3"></div>
                    <input type="hidden" id="plan-setting-plan" />
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="plan-setting-plan-label">Plano</label>
                        <input id="plan-setting-plan-label" class="form-control" disabled />
                    </div>
                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="plan-setting-price">Preço mensal</label>
                            <input id="plan-setting-price" class="form-control" inputmode="decimal" placeholder="R$ 0,00" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="plan-setting-radius">Raio máximo (km)</label>
                            <input id="plan-setting-radius" class="form-control" inputmode="decimal" placeholder="0,0" />
                        </div>
                    </div>
                    <div class="mt-2 mb-3">
                        <label class="form-label fw-semibold" for="plan-setting-max-categories">Máx. categorias selecionáveis</label>
                        <input id="plan-setting-max-categories" type="number" min="1" class="form-control" />
                    </div>
                    <div>
                        <label class="form-label fw-semibold" for="plan-setting-allowed-list">Categorias permitidas</label>
                        <div id="plan-setting-allowed-list" class="plan-category-listbox" role="listbox" aria-multiselectable="true">
                            <div class="plan-category-grid">
                                @foreach (var category in allServiceCategories)
                                {
                                    var checkboxId = $"plan-setting-allowed-{category.Value}";
                                    <label class="plan-category-option" for="@checkboxId">
                                        <input type="checkbox"
                                               id="@checkboxId"
                                               class="form-check-input m-0 plan-setting-category-check"
                                               value="@category.Value"
                                               data-category-label="@category.Label" />
                                        <span>@category.Label</span>
                                    </label>
                                }
                            </div>
                        </div>
                        <div class="field-hint">Selecione as categorias permitidas para o plano.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-plan-setting-btn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="couponModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title fs-5" id="coupon-modal-title">Cupom</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div id="coupon-modal-feedback" class="alert alert-danger d-none mb-3"></div>
                    <input type="hidden" id="coupon-id" />
                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="coupon-code">Código</label>
                            <input id="coupon-code" class="form-control" maxlength="40" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="coupon-plan">Plano alvo (opcional)</label>
                            <select id="coupon-plan" class="form-select">
                                <option value="">Todos</option>
                                <option value="Bronze">Bronze</option>
                                <option value="Silver">Silver</option>
                                <option value="Gold">Gold</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-2 mb-3">
                        <label class="form-label fw-semibold" for="coupon-name">Nome do cupom</label>
                        <input id="coupon-name" class="form-control" maxlength="120" />
                    </div>
                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="coupon-discount-type">Tipo de desconto</label>
                            <select id="coupon-discount-type" class="form-select">
                                <option value="Percentage">Percentual (%)</option>
                                <option value="FixedAmount">Valor fixo (R$)</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="coupon-discount-value">Valor do desconto</label>
                            <input id="coupon-discount-value" class="form-control" inputmode="decimal" placeholder="0,00" />
                            <div id="coupon-discount-hint" class="field-hint">Use percentual de 0,01% até 100,00%.</div>
                        </div>
                    </div>
                    <div class="row g-2 mt-1">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="coupon-start">Início</label>
                            <input id="coupon-start" type="datetime-local" class="form-control" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="coupon-end">Fim</label>
                            <input id="coupon-end" type="datetime-local" class="form-control" />
                        </div>
                    </div>
                    <div class="row g-2 mt-1">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="coupon-max-global">Limite global (opcional)</label>
                            <input id="coupon-max-global" type="number" min="1" class="form-control" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="coupon-max-provider">Limite por prestador (opcional)</label>
                            <input id="coupon-max-provider" type="number" min="1" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-coupon-btn">Salvar</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
<script>
    window.adminPlanGovernanceConfig = {
        endpoints: {
            updateSetting: '@updatePlanSettingUrl',
            createPromotion: '@createPromotionUrl',
            updatePromotion: '@updatePromotionUrl',
            togglePromotion: '@updatePromotionStatusUrl',
            createCoupon: '@createCouponUrl',
            updateCoupon: '@updateCouponUrl',
            toggleCoupon: '@updateCouponStatusUrl',
            simulate: '@simulateUrl'
        }
    };
</script>
<script src="~/js/views/admin-plan-governance/index.js" asp-append-version="true"></script>
}

