@model ConsertaPraMim.Web.Admin.Models.AdminServiceRequestDetailsViewModel
@{
    ViewData["Title"] = "Detalhes do Pedido";
    var request = Model.Request;
    var appointments = request?.Appointments ?? Array.Empty<ConsertaPraMim.Application.DTOs.AdminServiceRequestAppointmentDto>();
    var evidences = request?.Evidences ?? Array.Empty<ConsertaPraMim.Application.DTOs.AdminServiceRequestEvidenceDto>();
    var scopeChanges = request?.ScopeChanges ?? Array.Empty<ConsertaPraMim.Application.DTOs.AdminServiceRequestScopeChangeDto>();
    var ptBr = new System.Globalization.CultureInfo("pt-BR");
    var updateStatusUrl = Url.Action("UpdateStatus", "AdminServiceRequests") ?? "/AdminServiceRequests/UpdateStatus";
    var sendNotificationUrl = Url.Action("Send", "AdminNotifications") ?? "/AdminNotifications/Send";
}

<style>
    .admin-card {
        border: 0;
        border-radius: 14px;
        box-shadow: 0 10px 22px rgba(15, 23, 42, .08);
    }

    .label-muted {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: .05em;
        color: #64748b;
    }
</style>

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
    <div>
        <h1 class="h4 fw-bold mb-1">Detalhes do Pedido</h1>
        <p class="text-muted mb-0">Analise completa, status e atuacao administrativa.</p>
    </div>
    <div class="d-flex gap-2">
        <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
        @if (request != null)
        {
            <a asp-controller="AdminProposals" asp-action="Index" asp-route-requestId="@request.Id" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-file-signature"></i> Propostas
            </a>
            <a asp-controller="AdminChats" asp-action="Index" asp-route-requestId="@request.Id" class="btn btn-outline-dark btn-sm">
                <i class="fas fa-comments"></i> Conversas
            </a>
        }
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}
else if (request == null)
{
    <div class="alert alert-secondary">Pedido nao encontrado.</div>
}
else
{
    <div id="request-feedback" class="d-none alert mb-3"></div>

    <div class="row g-3 mb-3">
        <div class="col-12 col-lg-8">
            <div class="admin-card card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h6 fw-semibold mb-0">@request.Description</h2>
                    <span class="badge bg-secondary" id="request-status-badge">@request.Status</span>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <div class="label-muted mb-1">Categoria</div>
                            <div>@request.Category</div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="label-muted mb-1">Criado em</div>
                            <div>@request.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</div>
                        </div>
                        <div class="col-12">
                            <div class="label-muted mb-1">Endereco</div>
                            <div>@request.Street, @request.City - CEP @request.Zip</div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="label-muted mb-1">Latitude / Longitude</div>
                            <div>@request.Latitude.ToString("F6") / @request.Longitude.ToString("F6")</div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="label-muted mb-1">Ultima atualizacao</div>
                            <div>@(request.UpdatedAt.HasValue ? request.UpdatedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss") : "-")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="admin-card card h-100">
                <div class="card-header bg-white">
                    <h2 class="h6 fw-semibold mb-0">Cliente</h2>
                </div>
                <div class="card-body">
                    <div class="label-muted mb-1">Nome</div>
                    <div class="mb-2">@request.ClientName</div>
                    <div class="label-muted mb-1">Email</div>
                    <div class="mb-2">@request.ClientEmail</div>
                    <div class="label-muted mb-1">Telefone</div>
                    <div class="mb-3">@request.ClientPhone</div>
                    <a asp-controller="AdminUsers" asp-action="Index" asp-route-searchTerm="@request.ClientEmail" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-user"></i> Buscar cliente
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-12 col-lg-6">
            <div class="admin-card card h-100">
                <div class="card-header bg-white">
                    <h2 class="h6 fw-semibold mb-0">Alterar Status do Pedido</h2>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="request-status-select">Novo status</label>
                        <select id="request-status-select" class="form-select">
                            @{
                                var statusOptions = new[] { "Created", "Matching", "Scheduled", "InProgress", "PendingClientCompletionAcceptance", "Completed", "Validated", "Canceled" };
                            }
                            @foreach (var option in statusOptions)
                            {
                                var selected = option.Equals(request.Status, StringComparison.OrdinalIgnoreCase);
                                <option value="@option" selected="@selected">@option</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="status-reason">Motivo</label>
                        <textarea id="status-reason" class="form-control" rows="3" maxlength="300" placeholder="Motivo administrativo da alteracao"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" id="update-status-btn">
                        <i class="fas fa-pen-to-square"></i> Atualizar status
                    </button>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="admin-card card h-100">
                <div class="card-header bg-white">
                    <h2 class="h6 fw-semibold mb-0">Enviar Notificacao Manual</h2>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="notification-target">Destinatario</label>
                        <select id="notification-target" class="form-select">
                            <option value="email:@request.ClientEmail">Cliente: @request.ClientName (@request.ClientEmail)</option>
                            @{
                                var providers = request.Proposals
                                    .GroupBy(p => p.ProviderId)
                                    .Select(g => g.First())
                                    .ToList();
                            }
                            @foreach (var provider in providers)
                            {
                                <option value="id:@provider.ProviderId:D">Prestador: @provider.ProviderName (@provider.ProviderEmail)</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="notification-subject">Assunto</label>
                        <input id="notification-subject" class="form-control" maxlength="120" value="Atualizacao no pedido @request.Id" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="notification-message">Mensagem</label>
                        <textarea id="notification-message" class="form-control" rows="3" maxlength="1000" placeholder="Mensagem para o destinatario"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="notification-reason">Motivo interno</label>
                        <input id="notification-reason" class="form-control" maxlength="200" placeholder="Ex.: Suporte operacional" />
                    </div>
                    <button type="button" class="btn btn-outline-primary" id="send-notification-btn">
                        <i class="fas fa-bell"></i> Enviar notificacao
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-card card mb-3">
        <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-center gap-2">
            <h2 class="h6 fw-semibold mb-0">Versoes comerciais e aditivos</h2>
            <div class="text-muted small">
                Versao atual: <span class="fw-semibold">@request.CommercialVersion</span> |
                Estado: <span class="fw-semibold">@(string.IsNullOrWhiteSpace(request.CommercialState) ? "-" : request.CommercialState)</span>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3 mb-3">
                <div class="col-12 col-md-3">
                    <div class="label-muted mb-1">Valor base</div>
                    <div class="fw-semibold">@((request.CommercialBaseValue ?? 0m).ToString("C2", ptBr))</div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="label-muted mb-1">Valor atual</div>
                    <div class="fw-semibold text-success">@((request.CommercialCurrentValue ?? 0m).ToString("C2", ptBr))</div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="label-muted mb-1">Delta aprovado</div>
                    <div class="fw-semibold text-primary">@((Math.Max(0m, (request.CommercialCurrentValue ?? 0m) - (request.CommercialBaseValue ?? 0m))).ToString("C2", ptBr))</div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="label-muted mb-1">Atualizado em</div>
                    <div class="text-muted">@(request.CommercialUpdatedAtUtc.HasValue ? request.CommercialUpdatedAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss") : "-")</div>
                </div>
            </div>

            @if (scopeChanges.Any())
            {
                <div class="d-grid gap-3">
                    @foreach (var scopeChange in scopeChanges
                        .OrderByDescending(item => item.RequestedAtUtc)
                        .ThenByDescending(item => item.Version))
                    {
                        var statusClass = scopeChange.Status switch
                        {
                            "PendingClientApproval" => "bg-warning-subtle text-warning border border-warning-subtle",
                            "ApprovedByClient" => "bg-success-subtle text-success border border-success-subtle",
                            "RejectedByClient" => "bg-danger-subtle text-danger border border-danger-subtle",
                            _ => "bg-light text-muted border border-light-subtle"
                        };
                        var statusLabel = scopeChange.Status switch
                        {
                            "PendingClientApproval" => "Aguardando cliente",
                            "ApprovedByClient" => "Aprovado pelo cliente",
                            "RejectedByClient" => "Rejeitado pelo cliente",
                            _ => scopeChange.Status
                        };

                        <div class="border rounded-3 p-3 bg-light-subtle">
                            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge @statusClass rounded-pill px-3">@statusLabel</span>
                                    <span class="badge bg-light text-muted border border-light-subtle">v@scopeChange.Version</span>
                                </div>
                                <small class="text-muted">@scopeChange.RequestedAtUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</small>
                            </div>

                            <div class="small text-muted mb-1">Prestador</div>
                            <div class="mb-2">@scopeChange.ProviderName</div>
                            <div class="small text-muted mb-1">Motivo</div>
                            <div class="mb-2">@scopeChange.Reason</div>
                            <div class="small text-muted mb-1">Escopo adicional</div>
                            <div class="mb-2">@scopeChange.AdditionalScopeDescription</div>

                            <div class="rounded border border-primary-subtle bg-primary-subtle p-2 mb-2">
                                <div class="row g-2 align-items-center">
                                    <div class="col-5">
                                        <div class="label-muted">Valor anterior</div>
                                        <div class="fw-semibold">@scopeChange.PreviousValue.ToString("C2", ptBr)</div>
                                    </div>
                                    <div class="col-2 text-center text-primary">
                                        <i class="fas fa-arrow-right"></i>
                                    </div>
                                    <div class="col-5 text-end">
                                        <div class="label-muted">Novo valor</div>
                                        <div class="fw-bold text-primary">@scopeChange.NewValue.ToString("C2", ptBr)</div>
                                    </div>
                                </div>
                                <div class="small text-success mt-1">
                                    <i class="fas fa-plus-circle me-1"></i>Incremento: @scopeChange.IncrementalValue.ToString("C2", ptBr)
                                </div>
                            </div>

                            @if (scopeChange.ClientRespondedAtUtc.HasValue)
                            {
                                <div class="small text-muted mb-2">
                                    Resposta do cliente em @scopeChange.ClientRespondedAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")
                                    @if (!string.IsNullOrWhiteSpace(scopeChange.ClientResponseReason))
                                    {
                                        <span> Â· Motivo: @scopeChange.ClientResponseReason</span>
                                    }
                                </div>
                            }

                            @if (scopeChange.Attachments.Any())
                            {
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var attachment in scopeChange.Attachments.OrderBy(a => a.CreatedAt))
                                    {
                                        var iconClass = attachment.MediaKind?.ToLowerInvariant() switch
                                        {
                                            "video" => "fa-video",
                                            "image" => "fa-image",
                                            _ => "fa-paperclip"
                                        };
                                        <a href="@attachment.FileUrl"
                                           target="_blank"
                                           rel="noopener noreferrer"
                                           class="btn btn-outline-secondary btn-sm rounded-pill">
                                            <i class="fas @iconClass me-1"></i>@attachment.FileName
                                        </a>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="small text-muted">Sem anexos de evidencia.</div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-light border mb-0">Nenhum aditivo de escopo registrado para este pedido.</div>
            }
        </div>
    </div>

    <div class="admin-card card mb-3">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h2 class="h6 fw-semibold mb-0">Agendamentos e status operacional</h2>
            <span class="text-muted small">@appointments.Count agendamento(s)</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                <tr>
                    <th>Prestador</th>
                    <th>Janela</th>
                    <th>Status agendamento</th>
                    <th>Status operacional</th>
                    <th>Atualizado em</th>
                    <th>Historico</th>
                </tr>
                </thead>
                <tbody>
                @if (appointments.Any())
                {
                    @foreach (var appointment in appointments)
                    {
                        var operationalLabel = appointment.OperationalStatus switch
                        {
                            "OnTheWay" => "A caminho",
                            "OnSite" => "No local",
                            "InService" => "Em atendimento",
                            "WaitingParts" => "Aguardando peca",
                            "Completed" => "Concluido",
                            _ => "Sem status"
                        };
                        var operationalBadge = appointment.OperationalStatus switch
                        {
                            "OnTheWay" => "bg-warning-subtle text-warning-emphasis",
                            "OnSite" => "bg-info-subtle text-info-emphasis",
                            "InService" => "bg-primary-subtle text-primary-emphasis",
                            "WaitingParts" => "bg-secondary-subtle text-secondary-emphasis",
                            "Completed" => "bg-success-subtle text-success-emphasis",
                            _ => "bg-light text-muted"
                        };
                        var historySummary = appointment.History
                            .OrderByDescending(h => h.OccurredAtUtc)
                            .Take(2)
                            .ToList();

                        <tr>
                            <td class="fw-semibold">@appointment.ProviderName</td>
                            <td>
                                <div>@appointment.WindowStartUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
                                <div class="text-muted small">ate @appointment.WindowEndUtc.ToLocalTime().ToString("HH:mm")</div>
                            </td>
                            <td><span class="badge bg-secondary">@appointment.Status</span></td>
                            <td>
                                <span class="badge @operationalBadge">@operationalLabel</span>
                                @if (!string.IsNullOrWhiteSpace(appointment.OperationalStatusReason))
                                {
                                    <div class="small text-muted mt-1">@appointment.OperationalStatusReason</div>
                                }
                            </td>
                            <td class="text-muted">
                                @(appointment.OperationalStatusUpdatedAtUtc.HasValue
                                    ? appointment.OperationalStatusUpdatedAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                    : "-")
                            </td>
                            <td>
                                @if (historySummary.Any())
                                {
                                    @foreach (var history in historySummary)
                                    {
                                        <div class="small mb-1">
                                            <span class="fw-semibold">@history.OccurredAtUtc.ToLocalTime().ToString("dd/MM HH:mm")</span>
                                            <span class="text-muted">- @history.ActorRole</span>
                                            <div class="text-muted">@(!string.IsNullOrWhiteSpace(history.NewOperationalStatus) ? history.NewOperationalStatus : history.NewStatus)</div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted small">Sem eventos</span>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">Nenhum agendamento vinculado a este pedido.</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>

    <div class="admin-card card mb-3">
        <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-center gap-2">
            <h2 class="h6 fw-semibold mb-0">Evidencias operacionais</h2>
            <span class="text-muted small">
                <span id="evidence-visible-count">@evidences.Count</span> de @evidences.Count evidencia(s)
            </span>
        </div>
        <div class="card-body">
            <div class="row g-2 mb-3">
                <div class="col-12 col-md-4">
                    <label class="form-label fw-semibold" for="evidence-phase-filter">Fase</label>
                    <select id="evidence-phase-filter" class="form-select form-select-sm">
                        <option value="all">Todas</option>
                        <option value="before">Antes</option>
                        <option value="during">Durante</option>
                        <option value="after">Depois</option>
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label fw-semibold" for="evidence-provider-filter">Prestador</label>
                    <input id="evidence-provider-filter" type="text" class="form-control form-control-sm" placeholder="Filtrar por nome do prestador" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label fw-semibold d-block">Pedido</label>
                    <span class="form-control form-control-sm bg-light">#@request.Id.ToString("N")[..8]</span>
                </div>
            </div>

            @if (evidences.Any())
            {
                <div class="row g-3" id="evidence-grid">
                    @foreach (var evidence in evidences.OrderByDescending(e => e.CreatedAt))
                    {
                        var phaseValue = (evidence.EvidencePhase ?? "unknown").Trim().ToLowerInvariant();
                        var phaseLabel = phaseValue switch
                        {
                            "before" => "Antes",
                            "during" => "Durante",
                            "after" => "Depois",
                            _ => "Sem fase"
                        };
                        var phaseBadge = phaseValue switch
                        {
                            "before" => "bg-warning-subtle text-warning-emphasis",
                            "during" => "bg-info-subtle text-info-emphasis",
                            "after" => "bg-success-subtle text-success-emphasis",
                            _ => "bg-light text-muted"
                        };
                        var providerFilter = (evidence.ProviderName ?? string.Empty).Trim().ToLowerInvariant();
                        var previewUrl = !string.IsNullOrWhiteSpace(evidence.PreviewUrl)
                            ? evidence.PreviewUrl
                            : evidence.FileUrl;

                        <div class="col-12 col-md-6 col-xl-4 evidence-item"
                             data-evidence-phase="@phaseValue"
                             data-evidence-provider="@providerFilter">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="ratio ratio-16x9 bg-light">
                                    @if (string.Equals(evidence.MediaKind, "video", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <video controls preload="metadata">
                                            <source src="@previewUrl" type="@evidence.ContentType" />
                                        </video>
                                    }
                                    else
                                    {
                                        <img src="@previewUrl" alt="@evidence.FileName" class="w-100 h-100 object-fit-cover" />
                                    }
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge @phaseBadge">@phaseLabel</span>
                                        <small class="text-muted">@evidence.CreatedAt.ToLocalTime().ToString("dd/MM HH:mm")</small>
                                    </div>
                                    <div class="fw-semibold text-truncate mb-1">@evidence.FileName</div>
                                    <div class="small text-muted mb-1">Prestador: @evidence.ProviderName</div>
                                    @if (!string.IsNullOrWhiteSpace(evidence.Caption))
                                    {
                                        <div class="small text-muted text-truncate mb-1">@evidence.Caption</div>
                                    }
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <small class="text-muted">
                                            @if (evidence.ServiceAppointmentId.HasValue)
                                            {
                                                <span>Agendamento #@evidence.ServiceAppointmentId.Value.ToString("N")[..8]</span>
                                            }
                                            else
                                            {
                                                <span>Sem agendamento</span>
                                            }
                                        </small>
                                        <a href="@evidence.FileUrl" target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-up-right-from-square"></i> Abrir
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div id="evidence-empty-filter" class="alert alert-secondary d-none mt-3 mb-0">
                    Nenhuma evidencia encontrada com os filtros aplicados.
                </div>
            }
            else
            {
                <div class="text-center text-muted py-3">
                    Nenhuma evidencia operacional vinculada a este pedido.
                </div>
            }
        </div>
    </div>

    <div class="admin-card card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h2 class="h6 fw-semibold mb-0">Propostas vinculadas</h2>
            <span class="text-muted small">@request.Proposals.Count proposta(s)</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                <tr>
                    <th>Prestador</th>
                    <th>Email</th>
                    <th>Valor estimado</th>
                    <th>Status</th>
                    <th>Data</th>
                    <th class="text-end">Acoes</th>
                </tr>
                </thead>
                <tbody>
                @if (request.Proposals.Any())
                {
                    @foreach (var proposal in request.Proposals)
                    {
                        <tr>
                            <td>@proposal.ProviderName</td>
                            <td>@proposal.ProviderEmail</td>
                            <td>@(proposal.EstimatedValue.HasValue ? proposal.EstimatedValue.Value.ToString("C") : "-")</td>
                            <td>
                                @if (proposal.IsInvalidated)
                                {
                                    <span class="badge bg-danger-subtle text-danger-emphasis">Invalidada</span>
                                }
                                else if (proposal.Accepted)
                                {
                                    <span class="badge bg-success-subtle text-success-emphasis">Aceita</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary-subtle text-secondary-emphasis">Pendente</span>
                                }
                            </td>
                            <td class="text-muted">@proposal.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                            <td class="text-end">
                                <div class="d-inline-flex gap-2">
                                    <a asp-controller="AdminProposals" asp-action="Index" asp-route-requestId="@request.Id" asp-route-providerId="@proposal.ProviderId" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-file-signature"></i> Proposta
                                    </a>
                                    <a asp-controller="AdminChats" asp-action="Details" asp-route-requestId="@request.Id" asp-route-providerId="@proposal.ProviderId" class="btn btn-outline-dark btn-sm">
                                        <i class="fas fa-comments"></i> Conversa
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">Nenhuma proposta vinculada a este pedido.</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>
}

@section Scripts {
    @if (request != null)
    {
        <script>
            (function () {
                const requestId = "@request.Id";
                const updateStatusUrl = "@updateStatusUrl";
                const sendNotificationUrl = "@sendNotificationUrl";
                const feedback = document.getElementById("request-feedback");
                const evidencePhaseFilter = document.getElementById("evidence-phase-filter");
                const evidenceProviderFilter = document.getElementById("evidence-provider-filter");
                const evidenceVisibleCount = document.getElementById("evidence-visible-count");
                const evidenceEmptyFilter = document.getElementById("evidence-empty-filter");
                const evidenceItems = Array.from(document.querySelectorAll(".evidence-item"));

                function showFeedback(type, message) {
                    feedback.className = `alert alert-${type} mb-3`;
                    feedback.textContent = message;
                    feedback.classList.remove("d-none");
                }

                function hideFeedback() {
                    feedback.classList.add("d-none");
                    feedback.textContent = "";
                }

                async function updateStatus() {
                    const status = document.getElementById("request-status-select").value;
                    const reason = document.getElementById("status-reason").value?.trim() || null;

                    if (!confirm(`Confirma alterar o status do pedido para "${status}"?`)) {
                        return;
                    }

                    hideFeedback();
                    try {
                        const response = await fetch(updateStatusUrl, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-Requested-With": "XMLHttpRequest"
                            },
                            body: JSON.stringify({ requestId, status, reason })
                        });

                        const payload = await response.json().catch(() => null);
                        if (!response.ok || !payload?.success) {
                            showFeedback("danger", payload?.errorMessage || `Falha ao atualizar status (${response.status}).`);
                            return;
                        }

                        document.getElementById("request-status-badge").textContent = status;
                        showFeedback("success", payload?.message || "Status atualizado com sucesso.");
                    } catch (error) {
                        console.error(error);
                        showFeedback("danger", "Erro inesperado ao atualizar status.");
                    }
                }

                function parseRecipient(value) {
                    if (!value) {
                        return {};
                    }

                    if (value.startsWith("id:")) {
                        return { recipientUserId: value.substring(3), recipientEmail: null };
                    }

                    if (value.startsWith("email:")) {
                        return { recipientUserId: null, recipientEmail: value.substring(6) };
                    }

                    return {};
                }

                async function sendNotification() {
                    const targetValue = document.getElementById("notification-target").value;
                    const subject = document.getElementById("notification-subject").value?.trim();
                    const message = document.getElementById("notification-message").value?.trim();
                    const reason = document.getElementById("notification-reason").value?.trim() || null;
                    const recipient = parseRecipient(targetValue);

                    if (!subject || !message) {
                        showFeedback("danger", "Assunto e mensagem sao obrigatorios.");
                        return;
                    }

                    if (!confirm("Confirma o envio da notificacao manual?")) {
                        return;
                    }

                    hideFeedback();
                    try {
                        const response = await fetch(sendNotificationUrl, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-Requested-With": "XMLHttpRequest"
                            },
                            body: JSON.stringify({
                                recipientUserId: recipient.recipientUserId || null,
                                recipientEmail: recipient.recipientEmail || null,
                                subject,
                                message,
                                reason,
                                actionUrl: `/ServiceRequests/Details/${requestId}`
                            })
                        });

                        const payload = await response.json().catch(() => null);
                        if (!response.ok || !payload?.success) {
                            showFeedback("danger", payload?.errorMessage || `Falha ao enviar notificacao (${response.status}).`);
                            return;
                        }

                        showFeedback("success", payload?.message || "Notificacao enviada com sucesso.");
                    } catch (error) {
                        console.error(error);
                        showFeedback("danger", "Erro inesperado ao enviar notificacao.");
                    }
                }

                function applyEvidenceFilters() {
                    if (!evidenceItems.length) {
                        return;
                    }

                    const selectedPhase = (evidencePhaseFilter?.value || "all").toLowerCase();
                    const providerTerm = (evidenceProviderFilter?.value || "").trim().toLowerCase();
                    let visibleCount = 0;

                    evidenceItems.forEach((item) => {
                        const itemPhase = (item.dataset.evidencePhase || "").toLowerCase();
                        const itemProvider = (item.dataset.evidenceProvider || "").toLowerCase();
                        const matchesPhase = selectedPhase === "all" || itemPhase === selectedPhase;
                        const matchesProvider = !providerTerm || itemProvider.includes(providerTerm);
                        const shouldShow = matchesPhase && matchesProvider;

                        item.classList.toggle("d-none", !shouldShow);
                        if (shouldShow) {
                            visibleCount += 1;
                        }
                    });

                    if (evidenceVisibleCount) {
                        evidenceVisibleCount.textContent = visibleCount.toString();
                    }

                    if (evidenceEmptyFilter) {
                        evidenceEmptyFilter.classList.toggle("d-none", visibleCount !== 0);
                    }
                }

                document.getElementById("update-status-btn")?.addEventListener("click", updateStatus);
                document.getElementById("send-notification-btn")?.addEventListener("click", sendNotification);
                evidencePhaseFilter?.addEventListener("change", applyEvidenceFilters);
                evidenceProviderFilter?.addEventListener("input", applyEvidenceFilters);
                applyEvidenceFilters();
            })();
        </script>
    }
}
