@{
    ViewData["Title"] = "Configuracoes Runtime";
}

<style>
    .runtime-config-section-editor {
        min-height: 210px;
        font-family: Consolas, "Courier New", monospace;
        font-size: 0.78rem;
        line-height: 1.35;
    }

    .runtime-config-section-updated {
        font-size: 0.72rem;
        color: #6c757d;
    }
</style>

<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
        <h1 class="h4 mb-1">Configuracoes Runtime (Banco)</h1>
        <p class="text-muted mb-0">Edite secoes em <code>SystemSettings</code> com aplicacao em runtime no backend.</p>
    </div>
    <button id="btnReloadRuntimeConfigSections" type="button" class="btn btn-outline-secondary">
        <i class="fas fa-rotate me-1"></i> Recarregar
    </button>
</div>

<div id="runtimeConfigAlertError" class="alert alert-danger d-none" role="alert"></div>
<div id="runtimeConfigAlertSuccess" class="alert alert-success d-none" role="alert"></div>

<div class="card border-0 shadow-sm mb-3">
    <div class="card-header bg-white">
        <strong>Secoes configuraveis</strong>
        <div class="small text-muted mt-1">
            Cada secao aceita JSON valido. Secoes marcadas como <em>Requer restart</em> so aplicam apos reinicio da API.
        </div>
    </div>
    <div class="card-body">
        <div id="runtimeConfigSectionsList" class="d-flex flex-column gap-3"></div>
    </div>
</div>

@section Scripts {
<script>
    (function () {
        const sectionsList = document.getElementById('runtimeConfigSectionsList');
        const errorAlert = document.getElementById('runtimeConfigAlertError');
        const successAlert = document.getElementById('runtimeConfigAlertSuccess');
        const reloadButton = document.getElementById('btnReloadRuntimeConfigSections');

        function showError(message) {
            errorAlert.textContent = message || 'Falha ao processar configuracao runtime.';
            errorAlert.classList.remove('d-none');
        }

        function clearError() {
            errorAlert.textContent = '';
            errorAlert.classList.add('d-none');
        }

        function showSuccess(message) {
            successAlert.textContent = message || 'Operacao concluida.';
            successAlert.classList.remove('d-none');
            window.setTimeout(function () {
                successAlert.classList.add('d-none');
            }, 2600);
        }

        function clearSuccess() {
            successAlert.textContent = '';
            successAlert.classList.add('d-none');
        }

        async function apiGet(url) {
            const response = await fetch(url, {
                method: 'GET',
                credentials: 'same-origin'
            });
            const payload = await response.json();
            if (!response.ok || !payload.success) {
                throw new Error(payload.errorMessage || 'Falha na chamada da API.');
            }

            return payload.data;
        }

        async function apiPost(url, body) {
            const response = await fetch(url, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body || {})
            });
            const payload = await response.json();
            if (!response.ok || !payload.success) {
                throw new Error(payload.errorMessage || 'Falha na chamada da API.');
            }

            return payload.data;
        }

        function prettyJsonText(rawJson) {
            if (!rawJson) {
                return '{}';
            }

            try {
                return JSON.stringify(JSON.parse(rawJson), null, 2);
            } catch {
                return String(rawJson);
            }
        }

        function formatDateTime(value) {
            if (!value) {
                return '-';
            }

            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return '-';
            }

            return date.toLocaleString('pt-BR');
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function renderSections(items) {
            sectionsList.innerHTML = '';

            if (!items || items.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'text-muted small';
                empty.textContent = 'Nenhuma secao configuravel encontrada.';
                sectionsList.appendChild(empty);
                return;
            }

            items.forEach(function (section) {
                const card = document.createElement('div');
                card.className = 'border rounded p-3 bg-light-subtle';

                const sectionPath = String(section.sectionPath || '');
                const editorId = `runtime-config-editor-${sectionPath.replace(/[^a-zA-Z0-9_-]/g, '-').toLowerCase()}`;
                const prettyJson = prettyJsonText(section.jsonValue);
                const updatedAtLabel = formatDateTime(section.updatedAtUtc);

                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">
                        <div>
                            <div class="fw-semibold">${escapeHtml(section.displayName || sectionPath)}</div>
                            <div class="small text-muted"><code>${escapeHtml(sectionPath)}</code></div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            ${section.requiresRestart ? '<span class="badge text-bg-warning">Requer restart</span>' : '<span class="badge text-bg-success">Hot reload</span>'}
                            <button type="button" class="btn btn-sm btn-primary runtime-config-save-btn">Salvar</button>
                        </div>
                    </div>
                    <div class="small text-muted mb-2">${escapeHtml(section.description || '')}</div>
                    <textarea id="${editorId}" class="form-control runtime-config-section-editor" spellcheck="false">${escapeHtml(prettyJson)}</textarea>
                    <div class="runtime-config-section-updated mt-2">Atualizado em: ${escapeHtml(updatedAtLabel)}</div>
                `;

                const saveButton = card.querySelector('.runtime-config-save-btn');
                const editor = card.querySelector('textarea');
                saveButton.addEventListener('click', async function () {
                    const originalLabel = saveButton.innerHTML;
                    const payload = editor.value || '{}';

                    try {
                        JSON.parse(payload);
                    } catch {
                        showError(`JSON invalido na secao ${sectionPath}.`);
                        return;
                    }

                    clearError();
                    clearSuccess();
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando';
                    try {
                        await apiPost('@Url.Action("Save", "AdminRuntimeConfig")', {
                            sectionPath: sectionPath,
                            jsonValue: payload
                        });
                        await loadSections();
                        showSuccess(`Secao ${sectionPath} salva com sucesso.`);
                    } catch (err) {
                        showError(err.message || `Falha ao salvar secao ${sectionPath}.`);
                    } finally {
                        saveButton.disabled = false;
                        saveButton.innerHTML = originalLabel;
                    }
                });

                sectionsList.appendChild(card);
            });
        }

        async function loadSections() {
            clearError();
            const data = await apiGet('@Url.Action("Sections", "AdminRuntimeConfig")');
            const items = Array.isArray(data.items) ? data.items : [];
            renderSections(items);
        }

        reloadButton.addEventListener('click', function () {
            loadSections().catch(function (err) {
                showError(err.message || 'Falha ao recarregar secoes runtime.');
            });
        });

        loadSections().catch(function (err) {
            showError(err.message || 'Falha ao carregar secoes runtime.');
        });
    })();
</script>
}
