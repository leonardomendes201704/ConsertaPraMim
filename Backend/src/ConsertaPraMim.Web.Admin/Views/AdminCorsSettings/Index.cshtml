@{
    ViewData["Title"] = "Configuração de CORS";
}

<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
        <h1 class="h4 mb-1">Configuração de CORS</h1>
        <p class="text-muted mb-0">Gerencie no banco as origins permitidas para o backend da API.</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <button id="btnReloadCorsConfig" type="button" class="btn btn-outline-secondary">
            <i class="fas fa-rotate me-1"></i> Recarregar
        </button>
        <button id="btnSaveCorsConfig" type="button" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Salvar
        </button>
    </div>
</div>

<div id="corsConfigAlertError" class="alert alert-danger d-none" role="alert"></div>
<div id="corsConfigAlertSuccess" class="alert alert-success d-none" role="alert"></div>

<div class="card border-0 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>Allowed Origins</strong>
        <div class="small text-muted">
            <span id="corsUpdatedAtLabel">Atualizado em: -</span>
            <span class="mx-2">|</span>
            <span id="corsOriginCountLabel">0 origins</span>
        </div>
    </div>
    <div class="card-body">
        <label for="corsAllowedOriginsInput" class="form-label fw-semibold">Uma origin por linha</label>
        <textarea id="corsAllowedOriginsInput"
                  class="form-control font-monospace"
                  rows="14"
                  placeholder="https://admin.seudominio.com&#10;https://cliente.seudominio.com&#10;capacitor://localhost"></textarea>
        <div class="form-text mt-2">
            Formatos válidos: <code>http(s)://host[:porta]</code>, <code>capacitor://localhost</code>, <code>ionic://localhost</code>.
        </div>
    </div>
</div>

@section Scripts {
<script>
    (function () {
        const errorAlert = document.getElementById('corsConfigAlertError');
        const successAlert = document.getElementById('corsConfigAlertSuccess');
        const input = document.getElementById('corsAllowedOriginsInput');
        const updatedAtLabel = document.getElementById('corsUpdatedAtLabel');
        const countLabel = document.getElementById('corsOriginCountLabel');
        const saveButton = document.getElementById('btnSaveCorsConfig');
        const reloadButton = document.getElementById('btnReloadCorsConfig');

        function showError(message) {
            errorAlert.textContent = message || 'Falha ao processar configuração de CORS.';
            errorAlert.classList.remove('d-none');
        }

        function clearError() {
            errorAlert.textContent = '';
            errorAlert.classList.add('d-none');
        }

        function showSuccess(message) {
            successAlert.textContent = message;
            successAlert.classList.remove('d-none');
            window.setTimeout(function () {
                successAlert.classList.add('d-none');
            }, 2600);
        }

        function parseOrigins() {
            const lines = String(input.value || '')
                .split(/\r?\n/g)
                .map(x => x.trim())
                .filter(x => x.length > 0);

            const dedup = [];
            const seen = new Set();
            lines.forEach(function (origin) {
                const key = origin.toLowerCase();
                if (!seen.has(key)) {
                    seen.add(key);
                    dedup.push(origin);
                }
            });

            return dedup;
        }

        function updateCountLabel() {
            const total = parseOrigins().length;
            countLabel.textContent = total + (total === 1 ? ' origin' : ' origins');
        }

        function formatDate(value) {
            if (!value) return '-';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleString('pt-BR');
        }

        async function apiGet(url) {
            const response = await fetch(url, {
                method: 'GET',
                credentials: 'same-origin'
            });
            const payload = await response.json();
            if (!response.ok || !payload.success) {
                throw new Error(payload.errorMessage || 'Falha na chamada da API.');
            }
            return payload.data;
        }

        async function apiPost(url, body) {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify(body || {})
            });

            const payload = await response.json();
            if (!response.ok || !payload.success) {
                throw new Error(payload.errorMessage || 'Falha na chamada da API.');
            }

            return payload.data;
        }

        async function loadConfig() {
            clearError();
            const data = await apiGet('@Url.Action("Config", "AdminCorsSettings")');
            const origins = Array.isArray(data.allowedOrigins) ? data.allowedOrigins : [];
            input.value = origins.join('\n');
            updatedAtLabel.textContent = 'Atualizado em: ' + formatDate(data.updatedAtUtc);
            updateCountLabel();
        }

        async function saveConfig() {
            clearError();
            saveButton.disabled = true;
            reloadButton.disabled = true;
            try {
                const allowedOrigins = parseOrigins();
                const data = await apiPost('@Url.Action("Save", "AdminCorsSettings")', { allowedOrigins: allowedOrigins });
                const persistedOrigins = Array.isArray(data.allowedOrigins) ? data.allowedOrigins : [];
                input.value = persistedOrigins.join('\n');
                updatedAtLabel.textContent = 'Atualizado em: ' + formatDate(data.updatedAtUtc);
                updateCountLabel();
                showSuccess('Configuração de CORS salva com sucesso.');
            } finally {
                saveButton.disabled = false;
                reloadButton.disabled = false;
            }
        }

        input.addEventListener('input', updateCountLabel);
        reloadButton.addEventListener('click', function () {
            loadConfig().catch(function (err) {
                showError(err.message || 'Falha ao recarregar configuração de CORS.');
            });
        });
        saveButton.addEventListener('click', function () {
            saveConfig().catch(function (err) {
                showError(err.message || 'Falha ao salvar configuração de CORS.');
            });
        });

        loadConfig().catch(function (err) {
            showError(err.message || 'Falha ao carregar configuração de CORS.');
        });
    })();
</script>
}
