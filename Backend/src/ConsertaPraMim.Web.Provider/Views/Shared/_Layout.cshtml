@inject IConfiguration Configuration
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    var apiBaseUrl = (Configuration["ApiBaseUrl"] ?? string.Empty).TrimEnd('/');
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
    var apiToken = User.FindFirst(ConsertaPraMim.Web.Provider.Security.WebProviderClaimTypes.ApiToken)?.Value ?? string.Empty;
    var csrfToken = Antiforgery.GetAndStoreTokens(Context).RequestToken ?? string.Empty;
    var legacyAdminEnabled = Configuration.GetValue<bool?>("LegacyAdmin:Enabled") ?? false;
}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - ConsertaPraMim Prestador</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <style>
        .global-chat-dock {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: row-reverse;
            align-items: flex-end;
            gap: 12px;
            max-width: calc(100vw - 24px);
            overflow-x: auto;
            padding: 4px;
        }

        .global-chat-dock::-webkit-scrollbar {
            height: 8px;
        }

        .global-chat-dock::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 999px;
        }

        .global-chat-widget {
            width: min(360px, calc(100vw - 32px));
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            max-height: min(620px, calc(100vh - 80px));
            flex: 0 0 auto;
        }

        .global-chat-widget.minimized .global-chat-body,
        .global-chat-widget.minimized .global-chat-footer {
            display: none;
        }

        .global-chat-widget.maximized {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: min(920px, calc(100vw - 40px));
            height: min(760px, calc(100vh - 40px));
            max-height: none;
            z-index: 2100;
        }

        .global-chat-header {
            background: #2563eb;
            color: #fff;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .global-chat-actions {
            display: flex;
            gap: 6px;
        }

        .global-chat-actions button {
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            cursor: pointer;
        }

        .global-chat-actions button i {
            pointer-events: none;
            font-size: 12px;
        }

        .global-chat-body {
            height: 300px;
            overflow-y: auto;
            background: #f8fafc;
            padding: 10px;
        }

        .global-chat-widget.maximized .global-chat-body {
            height: calc(100% - 130px);
        }

        .global-chat-footer {
            padding: 10px;
            border-top: 1px solid #e5e7eb;
            background: #fff;
        }

        .global-chat-inputbar .global-chat-text {
            resize: none;
        }

        .global-chat-attach,
        .global-chat-send {
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .global-chat-attach {
            border: 1px solid #cbd5e1;
            background: #fff;
            color: #2563eb;
        }

        .global-chat-attach:hover {
            background: #eff6ff;
            color: #1e40af;
        }

        .global-chat-attach i,
        .global-chat-send i {
            pointer-events: none;
        }

        .global-chat-row {
            display: flex;
            margin-bottom: 10px;
        }

        .global-chat-row.mine {
            justify-content: flex-end;
        }

        .global-chat-bubble {
            max-width: 80%;
            padding: 8px 10px;
            border-radius: 10px;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .global-chat-row.mine .global-chat-bubble {
            background: #dbeafe;
        }

        .global-chat-meta {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .global-chat-text {
            white-space: pre-wrap;
        }

        .global-chat-status {
            font-size: 11px;
            opacity: 0.95;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .global-chat-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #9ca3af;
            display: inline-block;
        }

        .global-chat-status-dot.status-online {
            background: #22c55e;
        }

        .global-chat-status-dot.status-ausente {
            background: #94a3b8;
        }

        .global-chat-status-dot.status-atendimento {
            background: #f59e0b;
        }

        .global-chat-receipt {
            display: inline-flex;
            align-items: center;
            margin-left: 2px;
            font-size: 11px;
        }

        .global-chat-receipt.sent {
            color: #64748b;
        }

        .global-chat-receipt.delivered {
            color: #334155;
        }

        .global-chat-receipt.read {
            color: #0ea5e9;
        }

        .global-chat-attachment {
            margin-top: 6px;
        }

        .global-chat-attachment img,
        .global-chat-attachment video {
            max-width: 220px;
            border-radius: 8px;
            display: block;
        }

        .quick-status-wrap {
            min-width: 230px;
        }

        .quick-status-label {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 2px;
            display: block;
        }

        .quick-status-select {
            min-width: 220px;
        }

        @@media (max-width: 768px) {
            .global-chat-dock {
                left: 10px;
                right: 10px;
                bottom: 10px;
                max-width: none;
                gap: 8px;
                padding: 0;
            }

            .global-chat-widget {
                width: calc(100vw - 20px);
            }

            .global-chat-widget.maximized {
                left: 10px;
                right: 10px;
                bottom: 10px;
                width: auto;
                height: calc(100vh - 20px);
            }
        }

        @@media (max-width: 992px) {
            .quick-status-wrap {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        @if (User.Identity.IsAuthenticated)
        {
            <div id="sidebar-wrapper">
                <div class="sidebar-heading">
                    <i class="fas fa-tools me-2"></i>ConsertaPraMim
                </div>
                <div class="list-group list-group-flush">
                    <a asp-controller="Home" asp-action="Index" class="sidebar-nav-item @(ViewContext.RouteData.Values["Controller"].ToString() == "Home" ? "active" : "")">
                        <i class="fas fa-home"></i>Dashboard
                    </a>
                    <a asp-controller="ServiceRequests" asp-action="Index" class="sidebar-nav-item @(ViewContext.RouteData.Values["Controller"].ToString() == "ServiceRequests" && ViewContext.RouteData.Values["Action"].ToString() == "Index" ? "active" : "")">
                        <i class="fas fa-search"></i>Novos Pedidos
                    </a>
                    <a asp-controller="ServiceRequests" asp-action="Agenda" class="sidebar-nav-item @(ViewContext.RouteData.Values["Controller"].ToString() == "ServiceRequests" && ViewContext.RouteData.Values["Action"].ToString() == "Agenda" ? "active" : "")">
                        <i class="fas fa-calendar-check"></i>Minha Agenda
                    </a>
                    <a asp-controller="Proposals" asp-action="Index" class="sidebar-nav-item @(ViewContext.RouteData.Values["Controller"].ToString() == "Proposals" ? "active" : "")">
                        <i class="fas fa-paper-plane"></i>Minhas Propostas
                    </a>
                    <a asp-controller="Chats" asp-action="Index" class="sidebar-nav-item @(ViewContext.RouteData.Values["Controller"].ToString() == "Chats" ? "active" : "")">
                        <i class="fas fa-comments"></i>Chats/Conversas
                    </a>
                    <a asp-controller="ServiceRequests" asp-action="History" class="sidebar-nav-item @(ViewContext.RouteData.Values["Controller"].ToString() == "ServiceRequests" && ViewContext.RouteData.Values["Action"].ToString() == "History" ? "active" : "")">
                        <i class="fas fa-history"></i>HistÃ³rico
                    </a>
                    <a asp-controller="Profile" asp-action="Index" class="sidebar-nav-item @(ViewContext.RouteData.Values["Controller"].ToString() == "Profile" ? "active" : "")">
                        <i class="fas fa-user-cog"></i>ConfiguraÃ§Ãµes
                    </a>
                    
                    @if (User.IsInRole("Admin") && legacyAdminEnabled)
                    {
                        <div class="sidebar-heading px-4 pt-3 small text-uppercase text-white-50">Admin</div>
                        <a asp-controller="Admin" asp-action="Index" class="sidebar-nav-item @(ViewContext.RouteData.Values["Controller"].ToString() == "Admin" ? "active" : "")">
                            <i class="fas fa-shield-alt"></i>AdministraÃ§Ã£o
                        </a>
                    }
                </div>
            </div>
        }

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom py-3">
                <div class="container-fluid">
                    @if (User.Identity.IsAuthenticated)
                    {
                        <button class="btn btn-outline-secondary" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                    }
                    else
                    {
                        <span class="navbar-brand mb-0 h1"><i class="fas fa-tools me-2 text-primary"></i>ConsertaPraMim</span>
                    }

                    <div class="ms-auto d-flex align-items-center">
                        @if (User.Identity.IsAuthenticated)
                        {
                            @if (User.IsInRole("Provider"))
                            {
                                <div class="quick-status-wrap me-3">
                                    <span class="quick-status-label">Status operacional</span>
                                    <select id="quickOperationalStatus" class="form-select form-select-sm quick-status-select">
                                        <option value="0">Ausente</option>
                                        <option value="1">Online</option>
                                        <option value="2">Em Atendimento</option>
                                    </select>
                                </div>
                            }

                            <div class="dropdown">
                                <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle text-dark" data-bs-toggle="dropdown">
                                    <span class="me-2 d-none d-md-block">@User.Identity.Name</span>
                                    <img src="https://ui-avatars.com/api/?name=@User.Identity.Name&background=0D6EFD&color=fff" class="nav-user-img" />
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                    <li><a class="dropdown-item" asp-controller="Profile" asp-action="Index"><i class="fas fa-user me-2"></i>Perfil</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form asp-controller="Account" asp-action="Logout" method="post" class="m-0">
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="fas fa-sign-out-alt me-2"></i>Sair
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <a asp-controller="Account" asp-action="Login" class="btn btn-outline-primary me-2">Login</a>
                            <a asp-controller="Account" asp-action="Register" class="btn btn-primary">Cadastrar-se</a>
                        }
                    </div>
                </div>
            </nav>

            <div class="container-fluid p-4">
                @RenderBody()
            </div>
        </div>
    </div>

    @if (User.Identity.IsAuthenticated)
    {
        <div id="global-chat-dock" class="global-chat-dock"></div>
    }

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script>
        window.cpmCsrfToken = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(csrfToken));
        (function () {
            if (!window.fetch) return;
            const csrfToken = window.cpmCsrfToken;
            if (!csrfToken) return;

            const originalFetch = window.fetch.bind(window);
            window.fetch = function (input, init) {
                const method = String((init && init.method) || "GET").toUpperCase();
                if (method === "GET" || method === "HEAD" || method === "OPTIONS" || method === "TRACE") {
                    return originalFetch(input, init);
                }

                const requestUrl = new URL(typeof input === "string" ? input : (input && input.url ? input.url : window.location.href), window.location.origin);
                if (requestUrl.origin !== window.location.origin) {
                    return originalFetch(input, init);
                }

                const headers = new Headers((init && init.headers) || {});
                if (!headers.has("RequestVerificationToken")) {
                    headers.set("RequestVerificationToken", csrfToken);
                }

                const nextInit = Object.assign({}, init || {}, {
                    headers: headers,
                    credentials: (init && init.credentials) || "same-origin"
                });

                return originalFetch(input, nextInit);
            };
        })();
    </script>
    <script>
        $("#sidebarToggle").click(function(e) {
            e.preventDefault();
            $("#wrapper").toggleClass("toggled");
        });

        @if (User.Identity.IsAuthenticated)
        {
            <text>
            const apiBaseUrl = "@apiBaseUrl";
            const hubAccessToken = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(apiToken));
            const hubUrl = apiBaseUrl ? `${apiBaseUrl}/notificationHub` : "/notificationHub";
            const connection = new signalR.HubConnectionBuilder()
                .withUrl(hubUrl, {
                    accessTokenFactory: function () { return hubAccessToken; }
                })
                .build();

            function toSafeNavigationUrl(value) {
                const raw = String(value || "").trim();
                if (!raw) return "";

                try {
                    const parsed = new URL(raw, window.location.origin);
                    if ((parsed.protocol !== "http:" && parsed.protocol !== "https:") || parsed.origin !== window.location.origin) {
                        return "";
                    }

                    return `${parsed.pathname}${parsed.search}${parsed.hash}`;
                } catch {
                    return "";
                }
            }

            connection.on("ReceiveNotification", function (data) {
                window.dispatchEvent(new CustomEvent("cpm:notification", { detail: data }));
                const actionUrl = toSafeNavigationUrl(data && data.actionUrl ? String(data.actionUrl) : "");
                const safeActionUrl = actionUrl.replace(/"/g, "&quot;");
                const toastId = `toast-${Date.now()}-${Math.floor(Math.random() * 100000)}`;
                const toastHtml = `
                    <div id="${toastId}" class="toast-container position-fixed bottom-0 end-0 p-3">
                        <div class="toast show border-0 shadow-lg rounded-4" role="alert" aria-live="assertive" aria-atomic="true" data-action-url="${safeActionUrl}">
                            <div class="toast-header bg-success text-white border-0 rounded-top-4">
                                <i class="fas fa-bell me-2"></i>
                                <strong class="me-auto">${data.subject}</strong>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                            <div class="toast-body bg-white rounded-bottom-4">
                                ${data.message}
                            </div>
                        </div>
                    </div>`;
                $("body").append(toastHtml);
                const $container = $(`#${toastId}`);
                const $toast = $container.find(".toast");
                if (actionUrl) {
                    $toast.css("cursor", "pointer");
                    $toast.on("click", function (event) {
                        if ($(event.target).closest(".btn-close").length) return;
                        window.location.href = actionUrl;
                    });
                }

                setTimeout(() => {
                    $container.fadeOut(200, function () { $(this).remove(); });
                }, 10000);
            });

            connection.start().then(function () {
                connection.invoke("JoinUserGroup");
            }).catch(function (err) {
                return console.error(err.toString());
            });

            (function setupQuickOperationalStatus() {
                if (!@User.IsInRole("Provider").ToString().ToLower()) return;

                const quickStatusSelect = document.getElementById("quickOperationalStatus");
                if (!quickStatusSelect || !hubAccessToken) return;

                const providerId = "@currentUserId";
                if (!providerId) return;

                const statusGetUrl = apiBaseUrl
                    ? `${apiBaseUrl}/api/profile/provider/${providerId}/status`
                    : `/api/profile/provider/${providerId}/status`;
                const statusPutUrl = apiBaseUrl
                    ? `${apiBaseUrl}/api/profile/provider/status`
                    : "/api/profile/provider/status";

                function statusToSelectValue(status) {
                    if (status === "Ausente") return "0";
                    if (status === "EmAtendimento") return "2";
                    return "1";
                }

                function selectValueToStatus(value) {
                    if (String(value) === "0") return "Ausente";
                    if (String(value) === "2") return "EmAtendimento";
                    return "Online";
                }

                async function loadCurrentStatus() {
                    try {
                        const response = await fetch(statusGetUrl, {
                            method: "GET",
                            headers: {
                                Accept: "application/json",
                                Authorization: `Bearer ${hubAccessToken}`
                            }
                        });

                        if (!response.ok) return;
                        const payload = await response.json();
                        quickStatusSelect.value = statusToSelectValue(payload && payload.status ? payload.status : "");
                    } catch (error) {
                        console.error(error);
                    }
                }

                quickStatusSelect.addEventListener("change", async function () {
                    quickStatusSelect.disabled = true;
                    try {
                        const numericStatus = Number(quickStatusSelect.value);
                        const response = await fetch(statusPutUrl, {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                Accept: "application/json",
                                Authorization: `Bearer ${hubAccessToken}`
                            },
                            body: JSON.stringify({
                                operationalStatus: numericStatus
                            })
                        });

                        if (!response.ok) {
                            throw new Error("Falha ao atualizar status operacional.");
                        }

                        window.dispatchEvent(new CustomEvent("cpm:provider-status", {
                            detail: {
                                providerId: providerId,
                                status: selectValueToStatus(quickStatusSelect.value),
                                updatedAt: new Date().toISOString()
                            }
                        }));
                    } catch (error) {
                        console.error(error);
                        await loadCurrentStatus();
                    } finally {
                        quickStatusSelect.disabled = false;
                    }
                });

                window.addEventListener("cpm:provider-status", function (event) {
                    const detail = event?.detail || {};
                    if (String(detail.providerId || "").toLowerCase() !== String(providerId).toLowerCase()) return;
                    quickStatusSelect.value = statusToSelectValue(detail.status);
                });

                loadCurrentStatus().catch(console.error);
            })();
            </text>
        }
    </script>

    @if (User.Identity.IsAuthenticated)
    {
        <script>
            (function () {
                const currentUserId = "@currentUserId";
                const chatAccessToken = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(apiToken));
                const chatApiBaseUrl = typeof apiBaseUrl !== "undefined" ? apiBaseUrl : "";
                const chatHubUrl = chatApiBaseUrl ? `${chatApiBaseUrl}/chatHub` : "/chatHub";
                const uploadUrl = chatApiBaseUrl ? `${chatApiBaseUrl}/api/chat-attachments/upload` : "/api/chat-attachments/upload";
                const allowedFileOrigins = new Set([window.location.origin]);
                if (chatApiBaseUrl) {
                    try {
                        allowedFileOrigins.add(new URL(chatApiBaseUrl, window.location.origin).origin);
                    } catch {
                        // no-op
                    }
                }

                const dockEl = document.getElementById("global-chat-dock");
                if (!dockEl || !currentUserId || !chatAccessToken) return;

                const chatConnection = new signalR.HubConnectionBuilder()
                    .withUrl(chatHubUrl, {
                        accessTokenFactory: function () { return chatAccessToken; }
                    })
                    .withAutomaticReconnect()
                    .build();

                const conversations = new Map();
                const providerStatusById = new Map();
                const userPresenceById = new Map();
                const seenMessageIds = new Set();
                let startPromise = null;
                let bootstrapActiveConversationsPromise = null;

                function normalizeId(value) {
                    return String(value || "").toLowerCase();
                }

                function conversationKey(requestId, providerId) {
                    return `${normalizeId(requestId)}:${normalizeId(providerId)}`;
                }

                function normalizeProviderStatus(value) {
                    const raw = String(value || "").trim();
                    if (raw === "Online" || raw === "Ausente" || raw === "EmAtendimento") {
                        return raw;
                    }

                    return "";
                }

                function normalizeCounterpartRole(value) {
                    const raw = String(value || "").trim();
                    if (raw === "Provider" || raw === "Client") {
                        return raw;
                    }

                    return "";
                }

                function providerStatusInfo(status) {
                    if (status === "Online") return { label: "Status: Online", dotClass: "status-online" };
                    if (status === "Ausente") return { label: "Status: Ausente", dotClass: "status-ausente" };
                    if (status === "EmAtendimento") return { label: "Status: Em atendimento", dotClass: "status-atendimento" };

                    return { label: "Status indisponivel", dotClass: "" };
                }

                function participantStatusInfo(conversation) {
                    const counterpartId = normalizeId(conversation?.counterpartUserId);
                    const counterpartRole = normalizeCounterpartRole(conversation?.counterpartRole);
                    const isOnline = counterpartId && userPresenceById.has(counterpartId)
                        ? userPresenceById.get(counterpartId)
                        : null;

                    if (counterpartRole === "Provider") {
                        if (isOnline === false) return { label: "Status: Offline", dotClass: "status-ausente" };

                        const providerStatus = normalizeProviderStatus(conversation?.providerStatus);
                        if (providerStatus) return providerStatusInfo(providerStatus);

                        if (isOnline === true) return { label: "Status: Online", dotClass: "status-online" };
                        return { label: "Status indisponivel", dotClass: "" };
                    }

                    if (counterpartRole === "Client") {
                        if (isOnline === true) return { label: "Status: Online", dotClass: "status-online" };
                        if (isOnline === false) return { label: "Status: Offline", dotClass: "status-ausente" };
                        return { label: "Status indisponivel", dotClass: "" };
                    }

                    const fallbackProviderStatus = normalizeProviderStatus(conversation?.providerStatus);
                    if (fallbackProviderStatus) return providerStatusInfo(fallbackProviderStatus);

                    return { label: "Status indisponivel", dotClass: "" };
                }

                function messageReceiptInfo(deliveredAt, readAt) {
                    if (readAt) return { icon: "fa-solid fa-check-double", cssClass: "read", label: "Lida" };
                    if (deliveredAt) return { icon: "fa-solid fa-check-double", cssClass: "delivered", label: "Entregue" };
                    return { icon: "fa-solid fa-check", cssClass: "sent", label: "Enviada" };
                }

                function escapeHtml(value) {
                    return String(value || "")
                        .replaceAll("&", "&amp;")
                        .replaceAll("<", "&lt;")
                        .replaceAll(">", "&gt;")
                        .replaceAll('"', "&quot;")
                        .replaceAll("'", "&#39;");
                }

                function rememberMessageId(messageId) {
                    const key = normalizeId(messageId);
                    if (!key) return false;
                    if (seenMessageIds.has(key)) return false;
                    seenMessageIds.add(key);

                    if (seenMessageIds.size > 800) {
                        const first = seenMessageIds.values().next().value;
                        seenMessageIds.delete(first);
                    }

                    return true;
                }

                function renderAttachment(attachment) {
                    const safeFileUrl = toSafeFileUrl(attachment.fileUrl);
                    if (!safeFileUrl) {
                        return `<div class="global-chat-attachment"><span class="text-muted small">Anexo bloqueado por seguranca.</span></div>`;
                    }

                    if (attachment.mediaKind === "image") {
                        return `<div class="global-chat-attachment"><a href="${safeFileUrl}" target="_blank" rel="noopener noreferrer"><img src="${safeFileUrl}" alt="Anexo" /></a></div>`;
                    }

                    if (attachment.mediaKind === "video") {
                        return `<div class="global-chat-attachment"><video controls src="${safeFileUrl}"></video></div>`;
                    }

                    return `<div class="global-chat-attachment"><a href="${safeFileUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(attachment.fileName || "Arquivo")}</a></div>`;
                }

                function toSafeFileUrl(value) {
                    const raw = String(value || "").trim();
                    if (!raw) return "";

                    try {
                        const parsed = new URL(raw, window.location.origin);
                        if ((parsed.protocol !== "http:" && parsed.protocol !== "https:") || !allowedFileOrigins.has(parsed.origin)) {
                            return "";
                        }

                        if (!parsed.pathname.toLowerCase().startsWith("/uploads/chat/")) {
                            return "";
                        }

                        return parsed.href;
                    } catch {
                        return "";
                    }
                }

                function renderMessage(message) {
                    const mine = normalizeId(message.senderId) === normalizeId(currentUserId);
                    const messageId = normalizeId(message.id);
                    const attachments = (message.attachments || []).map(renderAttachment).join("");
                    const text = message.text ? `<div class="global-chat-text">${escapeHtml(message.text)}</div>` : "";
                    const createdAt = message.createdAt ? new Date(message.createdAt).toLocaleString("pt-BR") : "";
                    const receipt = mine ? messageReceiptInfo(message.deliveredAt, message.readAt) : null;
                    const receiptHtml = receipt
                        ? `<span class="global-chat-receipt ${receipt.cssClass}" title="${receipt.label}" aria-label="${receipt.label}"><i class="${receipt.icon}"></i></span>`
                        : "";

                    return `
                        <div class="global-chat-row ${mine ? "mine" : ""}" data-message-id="${messageId}">
                            <div class="global-chat-bubble">
                                <div class="global-chat-meta"><strong>${escapeHtml(message.senderName || "Contato")}</strong> &bull; ${createdAt}${receiptHtml}</div>
                                ${text}
                                ${attachments}
                            </div>
                        </div>`;
                }

                function updateConversationStatus(conversation, status) {
                    if (status !== undefined) {
                        conversation.providerStatus = status || null;
                    }

                    const info = participantStatusInfo(conversation);

                    if (conversation.statusTextEl) {
                        conversation.statusTextEl.textContent = info.label;
                    }

                    if (conversation.statusDotEl) {
                        conversation.statusDotEl.className = `global-chat-status-dot${info.dotClass ? ` ${info.dotClass}` : ""}`;
                    }
                }

                function updateMessageReceipt(conversation, receiptPayload) {
                    if (!conversation || !conversation.bodyEl || !receiptPayload) return;

                    const messageId = normalizeId(receiptPayload.messageId);
                    if (!messageId) return;

                    const row = conversation.bodyEl.querySelector(`.global-chat-row.mine[data-message-id="${messageId}"]`);
                    if (!row) return;

                    const meta = row.querySelector(".global-chat-meta");
                    if (!meta) return;

                    const receipt = messageReceiptInfo(receiptPayload.deliveredAt, receiptPayload.readAt);
                    let receiptEl = meta.querySelector(".global-chat-receipt");
                    if (!receiptEl) {
                        receiptEl = document.createElement("span");
                        meta.appendChild(receiptEl);
                    }

                    receiptEl.className = `global-chat-receipt ${receipt.cssClass}`;
                    receiptEl.setAttribute("title", receipt.label);
                    receiptEl.setAttribute("aria-label", receipt.label);
                    receiptEl.innerHTML = `<i class="${receipt.icon}"></i>`;
                }

                function setMinimized(conversation, minimized) {
                    conversation.minimized = minimized;
                    conversation.widgetEl.classList.toggle("minimized", minimized);
                    if (!minimized) {
                        requestReceiptSync(conversation);
                    }
                }

                function setMaximized(conversation, maximized) {
                    conversation.maximized = maximized;
                    conversation.widgetEl.classList.toggle("maximized", maximized);
                    if (conversation.maximizeBtn) {
                        conversation.maximizeBtn.innerHTML = maximized
                            ? '<i class="fa-solid fa-compress"></i>'
                            : '<i class="fa-solid fa-expand"></i>';
                        conversation.maximizeBtn.title = maximized ? "Restaurar" : "Maximizar";
                    }
                    if (maximized) {
                        setMinimized(conversation, false);
                    }
                }

                function scrollBottom(conversation) {
                    if (!conversation || !conversation.bodyEl) return;
                    conversation.bodyEl.scrollTop = conversation.bodyEl.scrollHeight;
                }

                function closeConversation(key) {
                    const conversation = conversations.get(key);
                    if (!conversation) return;
                    conversation.widgetEl.remove();
                    conversations.delete(key);
                }

                function buildWidget(conversation) {
                    const widgetEl = document.createElement("div");
                    widgetEl.className = "global-chat-widget";
                    widgetEl.innerHTML = `
                        <div class="global-chat-header">
                            <div>
                                <div class="fw-semibold global-chat-title"></div>
                                <div class="global-chat-status">
                                    <span class="global-chat-status-dot"></span>
                                    <span class="global-chat-status-text">Status indisponivel</span>
                                </div>
                            </div>
                            <div class="global-chat-actions">
                                <button type="button" class="global-chat-minimize" title="Minimizar" aria-label="Minimizar"><i class="fa-solid fa-minus"></i></button>
                                <button type="button" class="global-chat-maximize" title="Maximizar" aria-label="Maximizar"><i class="fa-solid fa-expand"></i></button>
                                <button type="button" class="global-chat-close" title="Fechar" aria-label="Fechar"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>
                        <div class="global-chat-body"></div>
                        <div class="global-chat-footer">
                            <div class="input-group input-group-sm global-chat-inputbar">
                                <button class="btn global-chat-attach" type="button" title="Anexar arquivos" aria-label="Anexar arquivos"><i class="fa-solid fa-paperclip"></i></button>
                                <input class="global-chat-files d-none" type="file" multiple accept="image/*,video/*" />
                                <textarea class="global-chat-text form-control" rows="2" placeholder="Digite uma mensagem..."></textarea>
                                <button class="global-chat-send btn btn-primary" type="button" title="Enviar" aria-label="Enviar"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </div>`;

                    conversation.widgetEl = widgetEl;
                    conversation.titleEl = widgetEl.querySelector(".global-chat-title");
                    conversation.statusDotEl = widgetEl.querySelector(".global-chat-status-dot");
                    conversation.statusTextEl = widgetEl.querySelector(".global-chat-status-text");
                    conversation.bodyEl = widgetEl.querySelector(".global-chat-body");
                    conversation.filesEl = widgetEl.querySelector(".global-chat-files");
                    conversation.attachBtn = widgetEl.querySelector(".global-chat-attach");
                    conversation.textEl = widgetEl.querySelector(".global-chat-text");
                    conversation.sendBtn = widgetEl.querySelector(".global-chat-send");

                    const minimizeBtn = widgetEl.querySelector(".global-chat-minimize");
                    const maximizeBtn = widgetEl.querySelector(".global-chat-maximize");
                    const closeBtn = widgetEl.querySelector(".global-chat-close");
                    conversation.maximizeBtn = maximizeBtn;

                    minimizeBtn.addEventListener("click", function () {
                        setMinimized(conversation, !conversation.minimized);
                    });

                    maximizeBtn.addEventListener("click", function () {
                        setMaximized(conversation, !conversation.maximized);
                    });

                    closeBtn.addEventListener("click", function () {
                        closeConversation(conversation.key);
                    });

                    conversation.attachBtn.addEventListener("click", function () {
                        conversation.filesEl.click();
                    });

                    conversation.sendBtn.addEventListener("click", function () {
                        sendMessage(conversation);
                    });

                    conversation.textEl.addEventListener("keydown", function (event) {
                        if (event.key === "Enter" && !event.shiftKey) {
                            event.preventDefault();
                            sendMessage(conversation);
                        }
                    });

                    conversation.textEl.addEventListener("focus", function () {
                        requestReceiptSync(conversation);
                    });

                    dockEl.append(widgetEl);
                }

                function getOrCreateConversation(detail) {
                    const requestId = String(detail.requestId || "");
                    const providerId = String(detail.providerId || "");
                    if (!requestId || !providerId) return null;

                    const key = conversationKey(requestId, providerId);
                    let conversation = conversations.get(key);
                    if (!conversation) {
                        const providerStatus = providerStatusById.get(normalizeId(providerId)) || null;
                        conversation = {
                            key: key,
                            requestId: requestId,
                            providerId: providerId,
                            providerStatus: providerStatus,
                            counterpartUserId: null,
                            counterpartRole: "",
                            title: detail.title || "Chat",
                            minimized: false,
                            maximized: false,
                            joined: false,
                            historyLoaded: false,
                            historyLoading: null,
                            receiptSyncInFlight: false,
                            receiptSyncPending: false
                        };
                        buildWidget(conversation);
                        conversations.set(key, conversation);
                    }

                    if (detail.title) {
                        conversation.title = detail.title;
                    }

                    conversation.titleEl.textContent = conversation.title || "Chat";
                    updateConversationStatus(conversation, conversation.providerStatus);

                    const shouldMaximize = detail.maximized === true;
                    const shouldMinimize = !shouldMaximize && detail.minimized === true;

                    if (shouldMaximize) {
                        setMaximized(conversation, true);
                    } else {
                        setMaximized(conversation, false);
                        setMinimized(conversation, shouldMinimize);
                    }

                    return conversation;
                }

                async function ensureConnected() {
                    if (chatConnection.state === signalR.HubConnectionState.Connected) return;
                    if (!startPromise) {
                        startPromise = chatConnection.start()
                            .then(function () {
                                return chatConnection.invoke("JoinPersonalGroup");
                            })
                            .finally(function () {
                                startPromise = null;
                            });
                    }
                    await startPromise;
                }

                async function bootstrapActiveConversations() {
                    if (bootstrapActiveConversationsPromise) {
                        await bootstrapActiveConversationsPromise;
                        return;
                    }

                    bootstrapActiveConversationsPromise = (async function () {
                        await ensureConnected();
                        const activeConversations = await chatConnection.invoke("GetMyActiveConversations");
                        const list = Array.isArray(activeConversations) ? activeConversations : [];

                        list.forEach(function (item) {
                            if (!item || !item.requestId || !item.providerId) return;

                            const conversation = getOrCreateConversation({
                                requestId: item.requestId,
                                providerId: item.providerId,
                                title: item.title || "Chat",
                                minimized: true
                            });

                            if (!conversation) return;

                            if (item.counterpartUserId) {
                                conversation.counterpartUserId = item.counterpartUserId;
                            }

                            conversation.counterpartRole = normalizeCounterpartRole(item.counterpartRole);

                            const counterpartId = normalizeId(item.counterpartUserId);
                            if (counterpartId && typeof item.counterpartIsOnline === "boolean") {
                                userPresenceById.set(counterpartId, !!item.counterpartIsOnline);
                            }

                            const normalizedStatus = normalizeProviderStatus(item.providerStatus);
                            if (normalizedStatus && conversation.counterpartRole === "Provider") {
                                providerStatusById.set(normalizeId(item.counterpartUserId || item.providerId), normalizedStatus);
                                conversation.providerStatus = normalizedStatus;
                            }

                            updateConversationStatus(conversation);
                        });
                    })()
                        .catch(console.error)
                        .finally(function () {
                            bootstrapActiveConversationsPromise = null;
                        });

                    await bootstrapActiveConversationsPromise;
                }

                async function ensureConversationJoined(conversation) {
                    await ensureConnected();
                    if (conversation.joined) return;
                    await chatConnection.invoke(
                        "JoinRequestChat",
                        conversation.requestId,
                        conversation.providerId
                    );
                    conversation.joined = true;

                    try {
                        const participant = await chatConnection.invoke(
                            "GetConversationParticipantPresence",
                            conversation.requestId,
                            conversation.providerId
                        );

                        if (participant && participant.userId) {
                            const participantId = normalizeId(participant.userId);
                            const participantRole = normalizeCounterpartRole(participant.role);

                            conversation.counterpartUserId = participant.userId;
                            conversation.counterpartRole = participantRole;

                            if (typeof participant.isOnline === "boolean") {
                                userPresenceById.set(participantId, participant.isOnline);
                            }

                            if (participantRole === "Provider") {
                                const normalizedStatus = normalizeProviderStatus(participant.operationalStatus);
                                if (normalizedStatus) {
                                    providerStatusById.set(participantId, normalizedStatus);
                                    conversation.providerStatus = normalizedStatus;
                                }
                            }

                            updateConversationStatus(conversation);
                        }
                    } catch (error) {
                        console.error(error);
                    }
                }

                function shouldMarkAsRead(conversation) {
                    return !!conversation && !conversation.minimized && !document.hidden;
                }

                async function syncConversationReceipts(conversation) {
                    await ensureConversationJoined(conversation);
                    await chatConnection.invoke("MarkConversationDelivered", conversation.requestId, conversation.providerId);
                    if (shouldMarkAsRead(conversation)) {
                        await chatConnection.invoke("MarkConversationRead", conversation.requestId, conversation.providerId);
                    }
                }

                function requestReceiptSync(conversation) {
                    if (!conversation || !conversation.historyLoaded) return;

                    if (conversation.receiptSyncInFlight) {
                        conversation.receiptSyncPending = true;
                        return;
                    }

                    conversation.receiptSyncInFlight = true;
                    syncConversationReceipts(conversation)
                        .catch(console.error)
                        .finally(function () {
                            conversation.receiptSyncInFlight = false;
                            if (conversation.receiptSyncPending) {
                                conversation.receiptSyncPending = false;
                                requestReceiptSync(conversation);
                            }
                        });
                }

                async function loadHistory(conversation) {
                    if (!conversation) return;
                    if (conversation.historyLoaded) return;
                    if (conversation.historyLoading) {
                        await conversation.historyLoading;
                        return;
                    }

                    conversation.bodyEl.innerHTML = "<div class='text-muted small'>Carregando historico...</div>";
                    conversation.historyLoading = (async function () {
                        await ensureConversationJoined(conversation);
                        const history = await chatConnection.invoke(
                            "GetHistory",
                            conversation.requestId,
                            conversation.providerId
                        );

                        const list = history || [];
                        conversation.bodyEl.innerHTML = list.map(renderMessage).join("");
                        list.forEach(function (item) { rememberMessageId(item.id); });
                        conversation.historyLoaded = true;
                        scrollBottom(conversation);
                        requestReceiptSync(conversation);
                    })().finally(function () {
                        conversation.historyLoading = null;
                    });

                    await conversation.historyLoading;
                }

                async function uploadAttachments(conversation, files) {
                    const uploaded = [];
                    for (const file of files) {
                        const formData = new FormData();
                        formData.append("requestId", conversation.requestId);
                        formData.append("providerId", conversation.providerId);
                        formData.append("file", file);

                        const response = await fetch(uploadUrl, {
                            method: "POST",
                            headers: {
                                Authorization: `Bearer ${chatAccessToken}`
                            },
                            body: formData
                        });
                        if (!response.ok) throw new Error("Falha ao enviar anexo.");

                        const data = await response.json();
                        uploaded.push({
                            fileUrl: data.fileUrl,
                            fileName: data.fileName,
                            contentType: data.contentType,
                            sizeBytes: data.sizeBytes
                        });
                    }

                    return uploaded;
                }

                async function sendMessage(conversation) {
                    if (!conversation) return;

                    const text = conversation.textEl.value.trim();
                    const files = Array.from(conversation.filesEl.files || []);
                    if (!text && files.length === 0) return;

                    conversation.sendBtn.disabled = true;
                    try {
                        await ensureConversationJoined(conversation);
                        const attachments = await uploadAttachments(conversation, files);
                        await chatConnection.invoke(
                            "SendMessage",
                            conversation.requestId,
                            conversation.providerId,
                            text,
                            attachments
                        );
                        conversation.textEl.value = "";
                        conversation.filesEl.value = "";
                    } catch (error) {
                        console.error(error);
                        alert("Nao foi possivel enviar a mensagem.");
                    } finally {
                        conversation.sendBtn.disabled = false;
                    }
                }

                chatConnection.on("ReceiveProviderStatus", function (payload) {
                    if (!payload || !payload.providerId) return;

                    const providerId = normalizeId(payload.providerId);
                    const status = normalizeProviderStatus(payload.status);
                    if (!providerId || !status) return;

                    providerStatusById.set(providerId, status);
                    conversations.forEach(function (conversation) {
                        if (normalizeId(conversation.counterpartUserId || conversation.providerId) === providerId) {
                            updateConversationStatus(conversation, status);
                        }
                    });

                    window.dispatchEvent(new CustomEvent("cpm:provider-status", {
                        detail: {
                            providerId: providerId,
                            status: status,
                            updatedAt: payload.updatedAt || new Date().toISOString()
                        }
                    }));
                });

                chatConnection.on("ReceiveUserPresence", function (payload) {
                    if (!payload || !payload.userId) return;

                    const userId = normalizeId(payload.userId);
                    if (!userId) return;

                    userPresenceById.set(userId, !!payload.isOnline);
                    conversations.forEach(function (conversation) {
                        if (normalizeId(conversation.counterpartUserId) === userId) {
                            updateConversationStatus(conversation);
                        }
                    });
                });

                chatConnection.on("ReceiveMessageReceiptUpdated", function (receipt) {
                    if (!receipt || !receipt.requestId || !receipt.providerId) return;
                    const key = conversationKey(receipt.requestId, receipt.providerId);
                    const conversation = conversations.get(key);
                    if (!conversation) return;

                    updateMessageReceipt(conversation, receipt);
                });

                chatConnection.on("ReceiveChatMessage", async function (message) {
                    if (!message || !message.requestId || !message.providerId) return;
                    if (!rememberMessageId(message.id)) return;

                    const key = conversationKey(message.requestId, message.providerId);
                    const existingConversation = conversations.get(key);
                    const conversation = getOrCreateConversation({
                        requestId: message.requestId,
                        providerId: message.providerId,
                        title: existingConversation ? null : `Chat com ${message.senderName || "Contato"}`
                    });
                    if (!conversation) return;

                    if (!conversation.historyLoaded) {
                        await loadHistory(conversation);
                        return;
                    }

                    if (normalizeId(message.senderId) !== normalizeId(currentUserId) && !conversation.counterpartUserId) {
                        conversation.counterpartUserId = message.senderId;
                        conversation.counterpartRole = normalizeCounterpartRole(message.senderRole);
                        userPresenceById.set(normalizeId(message.senderId), true);
                        updateConversationStatus(conversation);
                    }

                    conversation.bodyEl.insertAdjacentHTML("beforeend", renderMessage(message));
                    scrollBottom(conversation);

                    if (normalizeId(message.senderId) !== normalizeId(currentUserId)) {
                        requestReceiptSync(conversation);
                    }
                });

                window.addEventListener("cpm:open-chat", function (event) {
                    const detail = event.detail || {};
                    if (!detail.requestId || !detail.providerId) return;

                    const conversation = getOrCreateConversation({
                        requestId: detail.requestId,
                        providerId: detail.providerId,
                        title: detail.title || "Chat",
                        minimized: detail.minimized === true,
                        maximized: detail.maximized === true
                    });
                    if (!conversation) return;

                    const shouldLoadHistory = detail.loadHistory !== false;
                    if (!shouldLoadHistory) {
                        return;
                    }

                    loadHistory(conversation)
                        .then(function () {
                            requestReceiptSync(conversation);
                        })
                        .catch(console.error);
                });

                document.addEventListener("visibilitychange", function () {
                    if (document.hidden) return;
                    conversations.forEach(function (conversation) {
                        if (!conversation.minimized) {
                            requestReceiptSync(conversation);
                        }
                    });
                });

                chatConnection.onreconnected(function () {
                    const reopenPromises = [];
                    conversations.forEach(function (conversation) {
                        conversation.joined = false;
                        reopenPromises.push(ensureConversationJoined(conversation));
                    });
                    Promise.all(reopenPromises)
                        .then(function () {
                            conversations.forEach(function (conversation) {
                                requestReceiptSync(conversation);
                            });
                        })
                        .catch(console.error);
                });

                ensureConnected()
                    .then(function () {
                        return bootstrapActiveConversations();
                    })
                    .catch(console.error);
            })();
        </script>
    }
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>


