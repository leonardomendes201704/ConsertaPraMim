@model IEnumerable<ConsertaPraMim.Application.DTOs.ServiceRequestDto>
@{
    ViewData["Title"] = "Dashboard";
    var providerCoverageMapJson = (ViewBag.ProviderCoverageMapJson as string) ?? "{}";
    var providerAvatarUrl = (ViewBag.ProviderAvatarUrl as string) ?? $"https://ui-avatars.com/api/?name={System.Uri.EscapeDataString(User.Identity?.Name ?? "Prestador")}&background=0D6EFD&color=fff";
    var providerStatus = (ViewBag.ProviderOperationalStatus as string) ?? "Online";
    var recentMatchesLimit = ViewBag.RecentMatchesLimit is int limit ? limit : 15;
    var statusBadgeClass = providerStatus switch
    {
        "Ausente" => "bg-secondary",
        "EmAtendimento" => "bg-warning text-dark",
        _ => "bg-success"
    };
    var statusText = providerStatus switch
    {
        "Ausente" => "Ausente",
        "EmAtendimento" => "Em atendimento",
        _ => "Online para Servicos"
    };
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="h3 fw-bold mb-0">Bem-vindo, @User.Identity.Name! 👋</h1>
            <p class="text-muted">Veja o que está acontecendo hoje no seu radar.</p>
        </div>
        <div class="col-auto">
            <span id="provider-operational-badge" class="badge @statusBadgeClass p-2 px-3 rounded-pill shadow-sm">
                <i class="fas fa-circle me-1 small"></i> <span id="provider-operational-text">@statusText</span>
            </span>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-5 g-4 mb-5 provider-kpi-row">
        <div class="col">
            <div class="card p-3 border-0 bg-primary text-white shadow h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Oportunidades Próximas</h6>
                        <h2 id="total-matches-count" class="fw-bold mb-0">@ViewBag.TotalMatches</h2>
                    </div>
                    <i class="fas fa-map-marker-alt fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card p-3 border-0 bg-info text-white shadow h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Propostas em Aberto</h6>
                        <h2 id="active-proposals-count" class="fw-bold mb-0">@ViewBag.ActiveProposals</h2>
                    </div>
                    <i class="fas fa-paper-plane fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card p-3 border-0 bg-dark text-white shadow h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Serviços Convertidos</h6>
                        <h2 id="converted-jobs-count" class="fw-bold mb-0">@ViewBag.ConvertedJobs</h2>
                    </div>
                    <i class="fas fa-check-circle fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col">
            <a asp-controller="ServiceRequests" asp-action="Agenda" class="text-decoration-none">
                <div class="card p-3 border-0 shadow h-100" style="background: linear-gradient(135deg, #f59e0b 0%, #fcd34d 100%); color: #4a2f00; cursor: pointer;">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 opacity-75">Agendamentos Pendentes</h6>
                            <h2 id="pending-appointments-count" class="fw-bold mb-0">@ViewBag.PendingAppointments</h2>
                        </div>
                        <i class="fas fa-hourglass-half fa-3x opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a asp-controller="ServiceRequests" asp-action="Agenda" class="text-decoration-none">
                <div class="card p-3 border-0 shadow h-100" style="background: linear-gradient(135deg, #059669 0%, #6ee7b7 100%); color: #053b2d; cursor: pointer;">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 opacity-75">Proximas Visitas Confirmadas</h6>
                            <h2 id="upcoming-visits-count" class="fw-bold mb-0">@ViewBag.UpcomingConfirmedVisits</h2>
                        </div>
                        <i class="fas fa-calendar-check fa-3x opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <div class="card p-4 border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #1d976c 0%, #93f9b9 100%); color: #004d40;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase fw-bold mb-1" style="font-size: 0.75rem; letter-spacing: 1px;">Faturamento Total</h6>
                        <h1 class="fw-bold mb-0">@ViewBag.TotalRevenue.ToString("C2")</h1>
                    </div>
                    <div class="rounded-circle bg-white bg-opacity-25 p-3">
                        <i class="fas fa-wallet fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card p-4 border-0 shadow-sm bg-white h-100">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase text-muted fw-bold mb-1" style="font-size: 0.75rem; letter-spacing: 1px;">Ticket Médio por Serviço</h6>
                        <h1 class="fw-bold mb-0">@ViewBag.AverageTicket.ToString("C2")</h1>
                    </div>
                    <div class="rounded-circle bg-light p-3">
                        <i class="fas fa-chart-line fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0 py-3 d-flex flex-wrap justify-content-between gap-3 align-items-start">
            <div>
                <h5 class="fw-bold mb-1">Mapa de Cobertura e Oportunidades</h5>
                <small class="text-muted">Filtre por categoria e distancia para manter mapa e lista sincronizados.</small>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center justify-content-end">
                <select id="coverage-filter-category" class="form-select form-select-sm" style="min-width: 200px;">
                    <option value="">Todas categorias</option>
                </select>
                <select id="coverage-filter-distance" class="form-select form-select-sm" style="min-width: 170px;">
                    <option value="">Distancia padrao</option>
                    <option value="5">Ate 5 km</option>
                    <option value="10">Ate 10 km</option>
                    <option value="20">Ate 20 km</option>
                    <option value="40">Ate 40 km</option>
                    <option value="80">Ate 80 km</option>
                    <option value="120">Ate 120 km</option>
                </select>
                <div class="d-flex gap-2 small">
                    <span class="badge rounded-pill text-bg-success-subtle text-success-emphasis border border-success-subtle">Dentro do raio</span>
                    <span class="badge rounded-pill text-bg-warning-subtle text-warning-emphasis border border-warning-subtle">Fora do raio</span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="provider-coverage-map" class="provider-coverage-map d-none"></div>
            <div id="provider-coverage-empty" class="alert alert-info d-none mb-0">
                Defina CEP/base e coordenadas no seu perfil para visualizar o mapa de cobertura.
                <a href="/Profile/Index" class="fw-semibold ms-1">Ir para Perfil</a>
            </div>
            <div class="mt-3 d-flex flex-wrap gap-3 text-muted small align-items-center">
                <span><i class="fas fa-bullseye me-1"></i>Raio de interesse: <strong id="provider-coverage-radius-km">-</strong></span>
                <span><i class="fas fa-map-pin me-1"></i>Pins visiveis: <strong id="provider-coverage-pins-count">0</strong></span>
                <span><i class="fas fa-layer-group me-1"></i>Carregados: <strong id="provider-coverage-pins-loaded">0</strong>/<strong id="provider-coverage-pins-total">0</strong></span>
                <button id="provider-coverage-load-more" type="button" class="btn btn-outline-secondary btn-sm d-none">
                    <i class="fas fa-plus me-1"></i>Carregar mais pins
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Matches -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Pedidos Recentes Próximos a Você</h5>
                    <div class="d-flex align-items-center gap-3">
                        <small class="text-muted d-none d-md-inline">Top @recentMatchesLimit</small>
                        <a asp-controller="ServiceRequests" asp-action="Index" class="btn btn-sm btn-link text-decoration-none">Ver Todos</a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light text-muted small text-uppercase">
                                <tr>
                                    <th class="px-4">Categoria</th>
                                    <th>Descrição</th>
                                    <th>Localização</th>
                                    <th class="text-end px-4">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="recent-matches-tbody">
                                @if (!Model.Any())
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-5">
                                            <div class="text-muted">
                                                <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                                                <p>Nenhuma oportunidade encontrada no seu radar atual.</p>
                                                <a asp-controller="Profile" asp-action="Index" class="btn btn-outline-primary btn-sm">Aumentar Raio de Busca</a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                @foreach (var request in Model)
                                {
                                    <tr>
                                        <td class="px-4">
                                            <span class="badge bg-light text-primary border border-primary-subtle px-2 py-1">
                                                @request.Category
                                            </span>
                                        </td>
                                        <td>
                                            <div class="fw-semibold text-dark text-truncate" style="max-width: 250px;">@request.Description</div>
                                            <small class="text-muted">Pedido em @request.CreatedAt.ToString("dd/MM HH:mm")</small>
                                        </td>
                                        <td>
                                            <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i> @request.Street, @request.City</small>
                                        </td>
                                        <td class="text-end px-4">
                                            <a asp-controller="ServiceRequests" asp-action="Details" asp-route-id="@request.Id" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">Ver Detalhes</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Activity -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="fw-bold mb-0">Dicas e Avisos</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning border-0 shadow-sm small mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Complete seu perfil com fotos para aumentar suas chances em 40%!
                    </div>
                    
                    <div class="d-flex align-items-center mb-4 p-2 bg-light rounded cursor-pointer transition-hover">
                        <div class="bg-primary text-white rounded p-3 me-3">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">Verificar Avaliações</h6>
                            <small class="text-muted">Acompanhe seu feedback.</small>
                        </div>
                    </div>

                    <div class="d-flex align-items-center mb-0 p-2 bg-light rounded cursor-pointer transition-hover">
                        <div class="bg-dark text-white rounded p-3 me-3">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">Suporte Técnico</h6>
                            <small class="text-muted">Fale conosco se precisar de ajuda.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    (function () {
        const currentProviderId = "@(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty)".toLowerCase();
        const initialCoverageMapRaw = @Html.Raw(providerCoverageMapJson);
        const providerAvatarUrl = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(providerAvatarUrl));
        const statusBadgeEl = document.getElementById("provider-operational-badge");
        const statusTextEl = document.getElementById("provider-operational-text");
        const coverageMapEl = document.getElementById("provider-coverage-map");
        const coverageEmptyEl = document.getElementById("provider-coverage-empty");
        const coverageRadiusEl = document.getElementById("provider-coverage-radius-km");
        const coveragePinsCountEl = document.getElementById("provider-coverage-pins-count");
        const coveragePinsLoadedEl = document.getElementById("provider-coverage-pins-loaded");
        const coveragePinsTotalEl = document.getElementById("provider-coverage-pins-total");
        const coverageLoadMoreEl = document.getElementById("provider-coverage-load-more");
        const coverageCategoryFilterEl = document.getElementById("coverage-filter-category");
        const coverageDistanceFilterEl = document.getElementById("coverage-filter-distance");
        const defaultPinPageSize = 120;

        let coverageMapState = null;
        let leafletMap = null;
        let coverageMarkersLayer = null;
        let coverageRadiusLayer = null;
        let coverageProviderLayer = null;
        const coverageCategoryCatalog = new Map();
        const coverageMarkersByRequestId = new Map();
        let refreshDebounceHandle = null;
        let refreshAbortController = null;

        function escapeHtml(value) {
            return String(value || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        function statusPresentation(status) {
            if (status === "Ausente") {
                return { cssClass: "bg-secondary", label: "Ausente" };
            }

            if (status === "EmAtendimento") {
                return { cssClass: "bg-warning text-dark", label: "Em atendimento" };
            }

            return { cssClass: "bg-success", label: "Online para Servicos" };
        }

        function normalizeCategory(value) {
            return String(value || "")
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase();
        }

        function categoryIconClass(category) {
            const normalized = normalizeCategory(category);

            if (normalized.includes("hidraul") || normalized.includes("plumbing")) return "fas fa-faucet-drip";
            if (normalized.includes("eletric") || normalized.includes("electrical")) return "fas fa-bolt";
            if (normalized.includes("eletron") || normalized.includes("electronics")) return "fas fa-microchip";
            if (normalized.includes("eletrodomest") || normalized.includes("appliances")) return "fas fa-blender";
            if (normalized.includes("pintur")) return "fas fa-paint-roller";
            if (normalized.includes("limpez") || normalized.includes("cleaning")) return "fas fa-broom";
            if (normalized.includes("jardin")) return "fas fa-seedling";
            if (normalized.includes("alvenar") || normalized.includes("pedrei") || normalized.includes("masonry")) return "fas fa-hammer";
            if (normalized.includes("ar condicionado") || normalized.includes("arcond") || normalized.includes("climat")) return "fas fa-wind";
            if (normalized.includes("mudanc")) return "fas fa-truck";
            if (normalized.includes("montagem") || normalized.includes("moveis") || normalized.includes("mobili")) return "fas fa-screwdriver-wrench";
            if (normalized.includes("outro") || normalized.includes("other")) return "fas fa-circle-question";

            return "fas fa-screwdriver-wrench";
        }

        function createProviderAvatarIcon(avatarUrl) {
            return L.divIcon({
                className: "provider-map-provider-icon-wrap",
                html: `<div class="provider-map-provider-icon"><img src="${escapeHtml(avatarUrl)}" alt="Prestador"></div>`,
                iconSize: [44, 44],
                iconAnchor: [22, 22],
                popupAnchor: [0, -20]
            });
        }

        function createCategoryPinIcon(pin, compact) {
            const stateClass = !pin.isCategoryMatch
                ? "category-miss"
                : (pin.isWithinInterestRadius ? "inside" : "outside");
            const iconSize = compact ? 44 : 60;
            const iconAnchor = compact ? 22 : 30;
            const compactClass = compact ? "compact" : "";

            return L.divIcon({
                className: "provider-map-category-icon-wrap",
                html: `<div class="provider-map-category-icon ${stateClass} ${compactClass}" title="${escapeHtml(pin.category)}">
                           <i class="${categoryIconClass(pin.category)}" aria-hidden="true"></i>
                       </div>`,
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconAnchor, iconAnchor],
                popupAnchor: [0, -28]
            });
        }

        function updateOperationalBadge(status) {
            if (!statusBadgeEl || !statusTextEl) return;
            const presentation = statusPresentation(status);
            statusBadgeEl.className = `badge ${presentation.cssClass} p-2 px-3 rounded-pill shadow-sm`;
            statusTextEl.textContent = presentation.label;
        }

        function normalizeCoveragePin(rawPin) {
            if (!rawPin) return null;
            const latitude = Number(rawPin.latitude ?? rawPin.Latitude);
            const longitude = Number(rawPin.longitude ?? rawPin.Longitude);
            if (!Number.isFinite(latitude) || !Number.isFinite(longitude)) return null;

            return {
                requestId: String(rawPin.requestId ?? rawPin.RequestId ?? ""),
                category: String(rawPin.category ?? rawPin.Category ?? ""),
                description: String(rawPin.description ?? rawPin.Description ?? ""),
                street: String(rawPin.street ?? rawPin.Street ?? ""),
                city: String(rawPin.city ?? rawPin.City ?? ""),
                zip: String(rawPin.zip ?? rawPin.Zip ?? ""),
                createdAt: String(rawPin.createdAt ?? rawPin.CreatedAt ?? ""),
                createdAtIso: String(rawPin.createdAtIso ?? rawPin.CreatedAtIso ?? ""),
                latitude: latitude,
                longitude: longitude,
                distanceKm: Number(rawPin.distanceKm ?? rawPin.DistanceKm ?? 0),
                isWithinInterestRadius: Boolean(rawPin.isWithinInterestRadius ?? rawPin.IsWithinInterestRadius),
                isCategoryMatch: Boolean(rawPin.isCategoryMatch ?? rawPin.IsCategoryMatch)
            };
        }

        function formatRelativeTime(createdAtIso) {
            const timestamp = Date.parse(String(createdAtIso || ""));
            if (!Number.isFinite(timestamp)) return "";

            const diffMs = Math.max(0, Date.now() - timestamp);
            const minuteMs = 60 * 1000;
            const hourMs = 60 * minuteMs;
            const dayMs = 24 * hourMs;

            if (diffMs < minuteMs) return "Agora";

            const minutes = Math.floor(diffMs / minuteMs);
            if (minutes < 60) return `Ha ${minutes} minuto${minutes === 1 ? "" : "s"}`;

            const hours = Math.floor(diffMs / hourMs);
            if (hours < 24) return `Ha ${hours} hora${hours === 1 ? "" : "s"}`;

            const days = Math.floor(diffMs / dayMs);
            if (days < 7) return `Ha ${days} dia${days === 1 ? "" : "s"}`;
            if (days < 30) {
                const weeks = Math.floor(days / 7);
                return `Ha ${weeks} semana${weeks === 1 ? "" : "s"}`;
            }
            if (days < 365) {
                const months = Math.floor(days / 30);
                return `Ha ${months} mes${months === 1 ? "" : "es"}`;
            }

            const years = Math.floor(days / 365);
            return `Ha ${years} ano${years === 1 ? "" : "s"}`;
        }

        function normalizeCoverageMap(rawMap) {
            const map = rawMap || {};
            const pinsRaw = Array.isArray(map.pins)
                ? map.pins
                : (Array.isArray(map.Pins) ? map.Pins : []);

            return {
                hasBaseLocation: Boolean(map.hasBaseLocation ?? map.HasBaseLocation),
                providerLatitude: Number(map.providerLatitude ?? map.ProviderLatitude),
                providerLongitude: Number(map.providerLongitude ?? map.ProviderLongitude),
                interestRadiusKm: Number(map.interestRadiusKm ?? map.InterestRadiusKm),
                mapSearchRadiusKm: Number(map.mapSearchRadiusKm ?? map.MapSearchRadiusKm),
                baseZipCode: String(map.baseZipCode ?? map.BaseZipCode ?? ""),
                appliedCategoryFilter: String(map.appliedCategoryFilter ?? map.AppliedCategoryFilter ?? ""),
                appliedMaxDistanceKm: Number(map.appliedMaxDistanceKm ?? map.AppliedMaxDistanceKm),
                pinPage: Number(map.pinPage ?? map.PinPage ?? 1),
                pinPageSize: Number(map.pinPageSize ?? map.PinPageSize ?? defaultPinPageSize),
                totalPins: Number(map.totalPins ?? map.TotalPins ?? pinsRaw.length),
                hasMorePins: Boolean(map.hasMorePins ?? map.HasMorePins),
                pins: pinsRaw
                    .map(normalizeCoveragePin)
                    .filter(pin => !!pin)
            };
        }

        function markerRenderKey(pin) {
            return [
                pin.category,
                pin.description,
                pin.street,
                pin.city,
                pin.distanceKm,
                pin.isWithinInterestRadius,
                pin.isCategoryMatch,
                pin.latitude,
                pin.longitude,
                pin.createdAtIso
            ].join("|");
        }

        function buildPinPopupHtml(pin) {
            const isInside = !!pin.isWithinInterestRadius;
            const distanceLabel = Number.isFinite(pin.distanceKm) ? `${pin.distanceKm.toFixed(1)} km` : "-";
            const radiusLabel = isInside ? "Dentro do raio" : "Fora do raio";
            const categoryLabel = pin.isCategoryMatch ? "Categoria atendida" : "Categoria fora do seu filtro";

            return `
                <div class="provider-map-popup">
                    <div class="fw-semibold mb-1">${escapeHtml(pin.category)} - ${escapeHtml(distanceLabel)}</div>
                    <div class="small text-muted mb-1">${escapeHtml(pin.description)}</div>
                    <div class="small text-muted mb-2">${escapeHtml(pin.street)}, ${escapeHtml(pin.city)}</div>
                    <div class="small mb-2">${escapeHtml(radiusLabel)} | ${escapeHtml(categoryLabel)}</div>
                    <a href="/ServiceRequests/Details/${encodeURIComponent(pin.requestId)}" class="btn btn-sm btn-primary">Ver detalhes</a>
                </div>
            `;
        }

        function applyPinTooltip(marker, pin, highVolumeMode) {
            const relativeTimeLabel = formatRelativeTime(pin.createdAtIso);
            if (!relativeTimeLabel || highVolumeMode) {
                marker.unbindTooltip();
                return;
            }

            marker.bindTooltip(relativeTimeLabel, {
                permanent: true,
                direction: "bottom",
                offset: [0, 32],
                className: "provider-map-time-tooltip"
            });
        }

        function registerCategoryOptionsFromPins(pins) {
            (pins || []).forEach(function (pin) {
                const key = normalizeCategory(pin.category);
                if (!key) return;
                if (!coverageCategoryCatalog.has(key)) {
                    coverageCategoryCatalog.set(key, String(pin.category || "").trim());
                }
            });
        }

        function renderCategoryFilterOptions() {
            if (!coverageCategoryFilterEl) return;
            const selected = String(coverageCategoryFilterEl.value || "");
            const ordered = Array.from(coverageCategoryCatalog.entries())
                .sort((a, b) => a[1].localeCompare(b[1], "pt-BR"));

            coverageCategoryFilterEl.innerHTML = "<option value=\"\">Todas categorias</option>";
            ordered.forEach(function ([value, label]) {
                const option = document.createElement("option");
                option.value = value;
                option.textContent = label;
                coverageCategoryFilterEl.appendChild(option);
            });

            if (selected) {
                coverageCategoryFilterEl.value = selected;
            }
        }

        function syncFilterControlsFromMapData(data) {
            if (!data) return;

            if (coverageCategoryFilterEl && data.appliedCategoryFilter) {
                const normalized = normalizeCategory(data.appliedCategoryFilter);
                if (normalized && coverageCategoryCatalog.has(normalized)) {
                    coverageCategoryFilterEl.value = normalized;
                }
            }

            if (coverageDistanceFilterEl && Number.isFinite(data.appliedMaxDistanceKm) && data.appliedMaxDistanceKm > 0) {
                const value = String(Number(data.appliedMaxDistanceKm));
                coverageDistanceFilterEl.value = value;
            }
        }

        function getCurrentMapFilters() {
            return {
                category: normalizeCategory(coverageCategoryFilterEl?.value || ""),
                maxDistanceKm: String(coverageDistanceFilterEl?.value || "").trim()
            };
        }

        function buildRecentMatchesFromPins(pins) {
            return (pins || [])
                .slice()
                .sort((a, b) => Number(a.distanceKm || 0) - Number(b.distanceKm || 0))
                .slice(0, @recentMatchesLimit)
                .map(pin => ({
                    id: pin.requestId,
                    category: pin.category,
                    description: pin.description,
                    createdAt: pin.createdAt,
                    createdAtIso: pin.createdAtIso,
                    street: pin.street,
                    city: pin.city,
                    distanceKm: pin.distanceKm
                }));
        }

        function ensureLeafletMap(lat, lng) {
            if (!coverageMapEl || typeof L === "undefined") return;
            if (leafletMap) return;

            leafletMap = L.map(coverageMapEl, {
                zoomControl: true
            });

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: "&copy; OpenStreetMap contributors"
            }).addTo(leafletMap);

            leafletMap.setView([lat, lng], 12);
        }

        function showCoverageEmptyState(messageHtml) {
            if (coverageMapEl) {
                coverageMapEl.classList.add("d-none");
            }

            if (!coverageEmptyEl) return;
            coverageEmptyEl.classList.remove("d-none");
            coverageEmptyEl.innerHTML = messageHtml;
        }

        function clearCoverageMarkers() {
            coverageMarkersByRequestId.forEach(function (entry) {
                if (coverageMarkersLayer) {
                    coverageMarkersLayer.removeLayer(entry.marker);
                }
            });
            coverageMarkersByRequestId.clear();
        }

        function syncCoverageMarkers(pins, totalPins) {
            const highVolumeMode = Number(totalPins) > 120;
            const expectedIds = new Set();

            (pins || []).forEach(function (pin) {
                const pinId = String(pin.requestId || "");
                if (!pinId) return;

                expectedIds.add(pinId);
                const currentKey = markerRenderKey(pin);
                const existing = coverageMarkersByRequestId.get(pinId);
                if (existing) {
                    if (existing.renderKey !== currentKey) {
                        existing.marker.setLatLng([pin.latitude, pin.longitude]);
                        existing.marker.setIcon(createCategoryPinIcon(pin, highVolumeMode));
                        existing.marker.setPopupContent(buildPinPopupHtml(pin));
                        applyPinTooltip(existing.marker, pin, highVolumeMode);
                        existing.renderKey = currentKey;
                    } else {
                        applyPinTooltip(existing.marker, pin, highVolumeMode);
                    }
                    return;
                }

                const marker = L.marker(
                    [pin.latitude, pin.longitude],
                    { icon: createCategoryPinIcon(pin, highVolumeMode) })
                    .addTo(coverageMarkersLayer);
                marker.bindPopup(buildPinPopupHtml(pin));
                applyPinTooltip(marker, pin, highVolumeMode);
                coverageMarkersByRequestId.set(pinId, {
                    marker: marker,
                    renderKey: currentKey
                });
            });

            Array.from(coverageMarkersByRequestId.keys()).forEach(function (pinId) {
                if (expectedIds.has(pinId)) return;
                const entry = coverageMarkersByRequestId.get(pinId);
                if (entry && coverageMarkersLayer) {
                    coverageMarkersLayer.removeLayer(entry.marker);
                }
                coverageMarkersByRequestId.delete(pinId);
            });
        }

        function updateCoverageMeta(data) {
            const loadedPins = Array.isArray(data.pins) ? data.pins.length : 0;
            const totalPins = Number.isFinite(data.totalPins) ? data.totalPins : loadedPins;
            const hasMorePins = Boolean(data.hasMorePins);
            const pinPage = Number.isFinite(data.pinPage) ? Math.max(1, Number(data.pinPage)) : 1;
            const pinPageSize = Number.isFinite(data.pinPageSize) ? Math.max(1, Number(data.pinPageSize)) : defaultPinPageSize;

            if (coveragePinsCountEl) {
                coveragePinsCountEl.textContent = String(loadedPins);
            }

            if (coveragePinsLoadedEl) {
                coveragePinsLoadedEl.textContent = String(loadedPins);
            }

            if (coveragePinsTotalEl) {
                coveragePinsTotalEl.textContent = String(totalPins);
            }

            const totalMatchesEl = document.getElementById("total-matches-count");
            if (totalMatchesEl) {
                totalMatchesEl.textContent = String(totalPins);
            }

            if (coverageLoadMoreEl) {
                coverageLoadMoreEl.classList.toggle("d-none", !hasMorePins);
                coverageLoadMoreEl.dataset.nextPage = String(pinPage + 1);
                coverageLoadMoreEl.dataset.pageSize = String(pinPageSize);
                coverageLoadMoreEl.disabled = false;
            }
        }

        function renderCoverageMap(mapData) {
            const data = normalizeCoverageMap(mapData);
            coverageMapState = data;
            registerCategoryOptionsFromPins(data.pins);
            renderCategoryFilterOptions();
            syncFilterControlsFromMapData(data);
            updateCoverageMeta(data);

            if (coverageRadiusEl) {
                coverageRadiusEl.textContent = Number.isFinite(data.interestRadiusKm)
                    ? `${data.interestRadiusKm.toFixed(1)} km`
                    : "-";
            }

            if (!data.hasBaseLocation || !Number.isFinite(data.providerLatitude) || !Number.isFinite(data.providerLongitude)) {
                clearCoverageMarkers();
                showCoverageEmptyState('Defina CEP/base e coordenadas no seu perfil para visualizar o mapa de cobertura. <a href="/Profile/Index" class="fw-semibold ms-1">Ir para Perfil</a>');
                return;
            }

            if (typeof L === "undefined") {
                showCoverageEmptyState("Mapa indisponivel no momento.");
                return;
            }

            if (coverageEmptyEl) {
                coverageEmptyEl.classList.add("d-none");
            }

            if (coverageMapEl) {
                coverageMapEl.classList.remove("d-none");
            }

            ensureLeafletMap(data.providerLatitude, data.providerLongitude);
            if (!leafletMap) return;

            if (!coverageMarkersLayer) {
                coverageMarkersLayer = L.layerGroup().addTo(leafletMap);
            }

            if (!coverageProviderLayer) {
                coverageProviderLayer = L.marker(
                    [data.providerLatitude, data.providerLongitude],
                    { icon: createProviderAvatarIcon(providerAvatarUrl) })
                    .addTo(leafletMap);
            } else {
                coverageProviderLayer.setLatLng([data.providerLatitude, data.providerLongitude]);
            }
            coverageProviderLayer.bindPopup(`<strong>Sua base</strong><br/>CEP: ${escapeHtml(data.baseZipCode || "-")}`);

            if (Number.isFinite(data.interestRadiusKm) && data.interestRadiusKm > 0) {
                if (!coverageRadiusLayer) {
                    coverageRadiusLayer = L.circle([data.providerLatitude, data.providerLongitude], {
                        radius: data.interestRadiusKm * 1000,
                        color: "#2563eb",
                        fillColor: "#60a5fa",
                        fillOpacity: 0.1,
                        weight: 2
                    }).addTo(leafletMap);
                } else {
                    coverageRadiusLayer.setLatLng([data.providerLatitude, data.providerLongitude]);
                    coverageRadiusLayer.setRadius(data.interestRadiusKm * 1000);
                }
            } else if (coverageRadiusLayer) {
                coverageRadiusLayer.remove();
                coverageRadiusLayer = null;
            }

            syncCoverageMarkers(data.pins, data.totalPins);

            const bounds = L.latLngBounds([[data.providerLatitude, data.providerLongitude]]);
            coverageMarkersByRequestId.forEach(function (entry) {
                const latLng = entry.marker.getLatLng();
                bounds.extend([latLng.lat, latLng.lng]);
            });

            if (bounds.isValid()) {
                leafletMap.fitBounds(bounds.pad(0.15), { maxZoom: 13 });
            } else {
                leafletMap.setView([data.providerLatitude, data.providerLongitude], 12);
            }
        }

        function renderMatches(items) {
            const tbody = document.getElementById("recent-matches-tbody");
            if (!tbody) return;

            const list = items || [];
            if (!list.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                                <p>Nenhuma oportunidade encontrada no seu radar atual.</p>
                                <a href="/Profile/Index" class="btn btn-outline-primary btn-sm">Aumentar Raio de Busca</a>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = list.map(request => {
                const createdAt = request.createdAt
                    ? String(request.createdAt)
                    : (request.createdAtIso
                        ? new Date(request.createdAtIso).toLocaleString("pt-BR", { day: "2-digit", month: "2-digit", hour: "2-digit", minute: "2-digit" })
                        : "-");
                const distanceKm = Number(request.distanceKm);
                const distanceLabel = Number.isFinite(distanceKm) ? `${distanceKm.toFixed(1)} km` : "";
                const locationSuffix = distanceLabel ? ` <span class="ms-2 badge rounded-pill text-bg-light border">${escapeHtml(distanceLabel)}</span>` : "";
                return `
                    <tr>
                        <td class="px-4">
                            <span class="badge bg-light text-primary border border-primary-subtle px-2 py-1">
                                ${escapeHtml(request.category)}
                            </span>
                        </td>
                        <td>
                            <div class="fw-semibold text-dark text-truncate" style="max-width: 250px;">${escapeHtml(request.description)}</div>
                            <small class="text-muted">Pedido em ${escapeHtml(createdAt)}</small>
                        </td>
                        <td>
                            <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i> ${escapeHtml(request.street)}, ${escapeHtml(request.city)}</small>
                            ${locationSuffix}
                        </td>
                        <td class="text-end px-4">
                            <a href="/ServiceRequests/Details/${request.id}" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">Ver Detalhes</a>
                        </td>
                    </tr>`;
            }).join("");
        }

        async function refreshDashboard(options) {
            const settings = Object.assign({
                append: false,
                pinPage: 1,
                pinPageSize: defaultPinPageSize
            }, options || {});

            const filters = getCurrentMapFilters();
            const params = new URLSearchParams();
            if (filters.category) {
                params.set("category", filters.category);
            }
            if (filters.maxDistanceKm) {
                params.set("maxDistanceKm", filters.maxDistanceKm);
            }
            params.set("pinPage", String(Math.max(1, Number(settings.pinPage) || 1)));
            params.set("pinPageSize", String(Math.max(1, Number(settings.pinPageSize) || defaultPinPageSize)));

            const url = params.toString()
                ? `/Home/RecentMatchesData?${params.toString()}`
                : "/Home/RecentMatchesData";

            if (refreshAbortController) {
                refreshAbortController.abort();
            }

            refreshAbortController = new AbortController();
            let data;
            try {
                const response = await fetch(url, {
                    credentials: "same-origin",
                    signal: refreshAbortController.signal
                });
                if (!response.ok) return;
                data = await response.json();
            } catch (error) {
                if (error && error.name === "AbortError") return;
                throw error;
            } finally {
                refreshAbortController = null;
            }

            const totalMatches = document.getElementById("total-matches-count");
            const activeProposals = document.getElementById("active-proposals-count");
            const convertedJobs = document.getElementById("converted-jobs-count");
            const pendingAppointments = document.getElementById("pending-appointments-count");
            const upcomingVisits = document.getElementById("upcoming-visits-count");

            if (totalMatches) totalMatches.textContent = data.totalMatches;
            if (activeProposals) activeProposals.textContent = data.activeProposals;
            if (convertedJobs) convertedJobs.textContent = data.convertedJobs;
            if (pendingAppointments) pendingAppointments.textContent = data.pendingAppointments ?? 0;
            if (upcomingVisits) upcomingVisits.textContent = data.upcomingConfirmedVisits ?? 0;
            updateOperationalBadge(data.providerOperationalStatus);

            let coveragePayload = normalizeCoverageMap(data.coverageMap);
            if (settings.append && coverageMapState) {
                const mergedById = new Map();
                (coverageMapState.pins || []).forEach(pin => mergedById.set(pin.requestId, pin));
                (coveragePayload.pins || []).forEach(pin => mergedById.set(pin.requestId, pin));
                coveragePayload = Object.assign({}, coveragePayload, {
                    pins: Array.from(mergedById.values())
                        .sort((a, b) => Number(a.distanceKm || 0) - Number(b.distanceKm || 0))
                });
            }

            renderCoverageMap(coveragePayload);
            const recentMatches = buildRecentMatchesFromPins(coveragePayload?.pins ?? []);
            renderMatches(recentMatches);
        }

        function scheduleDashboardRefresh(reason, options, delayMs) {
            if (refreshDebounceHandle) {
                clearTimeout(refreshDebounceHandle);
                refreshDebounceHandle = null;
            }

            refreshDebounceHandle = setTimeout(function () {
                refreshDashboard(options).catch(function (error) {
                    console.error(`[dashboard-refresh:${reason}]`, error);
                });
            }, Number(delayMs) > 0 ? Number(delayMs) : 220);
        }

        function shouldRefreshDashboard(subject) {
            const normalized = String(subject || "").toLowerCase();
            return normalized.includes("pedido") ||
                normalized.includes("agendamento") ||
                normalized.includes("reagendamento") ||
                normalized.includes("visita");
        }

        window.addEventListener("cpm:notification", function (event) {
            const subject = event?.detail?.subject ?? "";
            if (shouldRefreshDashboard(subject)) {
                scheduleDashboardRefresh("notification", { append: false, pinPage: 1, pinPageSize: defaultPinPageSize }, 180);
            }
        });

        window.addEventListener("cpm:realtime-reconnected", function () {
            scheduleDashboardRefresh("signalr-reconnected", { append: false, pinPage: 1, pinPageSize: defaultPinPageSize }, 120);
        });

        window.addEventListener("cpm:provider-status", function (event) {
            const payload = event?.detail || {};
            if (!payload.status) return;

            const providerId = String(payload.providerId || "").toLowerCase();
            if (providerId && providerId !== currentProviderId) return;

            updateOperationalBadge(String(payload.status));
        });

        window.addEventListener("resize", function () {
            if (leafletMap) {
                leafletMap.invalidateSize();
            }
        });

        if (coverageCategoryFilterEl) {
            coverageCategoryFilterEl.addEventListener("change", function () {
                scheduleDashboardRefresh("filter-category", { append: false, pinPage: 1, pinPageSize: defaultPinPageSize }, 80);
            });
        }

        if (coverageDistanceFilterEl) {
            coverageDistanceFilterEl.addEventListener("change", function () {
                scheduleDashboardRefresh("filter-distance", { append: false, pinPage: 1, pinPageSize: defaultPinPageSize }, 80);
            });
        }

        if (coverageLoadMoreEl) {
            coverageLoadMoreEl.addEventListener("click", function () {
                const nextPage = Number(coverageLoadMoreEl.dataset.nextPage || "2");
                const pageSize = Number(coverageLoadMoreEl.dataset.pageSize || String(defaultPinPageSize));
                coverageLoadMoreEl.disabled = true;
                refreshDashboard({
                    append: true,
                    pinPage: Math.max(2, nextPage),
                    pinPageSize: Math.max(1, pageSize)
                })
                    .catch(function (error) {
                        console.error("[dashboard-refresh:load-more]", error);
                    })
                    .finally(function () {
                        coverageLoadMoreEl.disabled = false;
                    });
            });
        }

        renderCoverageMap(initialCoverageMapRaw);
        if (coverageMapState?.pins?.length) {
            renderMatches(buildRecentMatchesFromPins(coverageMapState.pins));
        }
    })();
</script>
