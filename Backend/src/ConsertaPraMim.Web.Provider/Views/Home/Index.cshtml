@model IEnumerable<ConsertaPraMim.Application.DTOs.ServiceRequestDto>
@{
    ViewData["Title"] = "Dashboard";
    var providerCoverageMapJson = (ViewBag.ProviderCoverageMapJson as string) ?? "{}";
    var providerAvatarUrl = (ViewBag.ProviderAvatarUrl as string) ?? $"https://ui-avatars.com/api/?name={System.Uri.EscapeDataString(User.Identity?.Name ?? "Prestador")}&background=0D6EFD&color=fff";
    var providerStatus = (ViewBag.ProviderOperationalStatus as string) ?? "Online";
    var recentMatchesLimit = ViewBag.RecentMatchesLimit is int limit ? limit : 15;
    var statusBadgeClass = providerStatus switch
    {
        "Ausente" => "bg-secondary",
        "EmAtendimento" => "bg-warning text-dark",
        _ => "bg-success"
    };
    var statusText = providerStatus switch
    {
        "Ausente" => "Ausente",
        "EmAtendimento" => "Em atendimento",
        _ => "Online para Servicos"
    };
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="h3 fw-bold mb-0">Bem-vindo, @User.Identity.Name! 👋</h1>
            <p class="text-muted">Veja o que está acontecendo hoje no seu radar.</p>
        </div>
        <div class="col-auto">
            <span id="provider-operational-badge" class="badge @statusBadgeClass p-2 px-3 rounded-pill shadow-sm">
                <i class="fas fa-circle me-1 small"></i> <span id="provider-operational-text">@statusText</span>
            </span>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-5 g-4 mb-5 provider-kpi-row">
        <div class="col">
            <div class="card p-3 border-0 bg-primary text-white shadow h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Oportunidades Próximas</h6>
                        <h2 id="total-matches-count" class="fw-bold mb-0">@ViewBag.TotalMatches</h2>
                    </div>
                    <i class="fas fa-map-marker-alt fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card p-3 border-0 bg-info text-white shadow h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Propostas em Aberto</h6>
                        <h2 id="active-proposals-count" class="fw-bold mb-0">@ViewBag.ActiveProposals</h2>
                    </div>
                    <i class="fas fa-paper-plane fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card p-3 border-0 bg-dark text-white shadow h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Serviços Convertidos</h6>
                        <h2 id="converted-jobs-count" class="fw-bold mb-0">@ViewBag.ConvertedJobs</h2>
                    </div>
                    <i class="fas fa-check-circle fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col">
            <a asp-controller="ServiceRequests" asp-action="Agenda" class="text-decoration-none">
                <div class="card p-3 border-0 shadow h-100" style="background: linear-gradient(135deg, #f59e0b 0%, #fcd34d 100%); color: #4a2f00; cursor: pointer;">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 opacity-75">Agendamentos Pendentes</h6>
                            <h2 id="pending-appointments-count" class="fw-bold mb-0">@ViewBag.PendingAppointments</h2>
                        </div>
                        <i class="fas fa-hourglass-half fa-3x opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a asp-controller="ServiceRequests" asp-action="Agenda" class="text-decoration-none">
                <div class="card p-3 border-0 shadow h-100" style="background: linear-gradient(135deg, #059669 0%, #6ee7b7 100%); color: #053b2d; cursor: pointer;">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 opacity-75">Proximas Visitas Confirmadas</h6>
                            <h2 id="upcoming-visits-count" class="fw-bold mb-0">@ViewBag.UpcomingConfirmedVisits</h2>
                        </div>
                        <i class="fas fa-calendar-check fa-3x opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <div class="card p-4 border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #1d976c 0%, #93f9b9 100%); color: #004d40;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase fw-bold mb-1" style="font-size: 0.75rem; letter-spacing: 1px;">Faturamento Total</h6>
                        <h1 class="fw-bold mb-0">@ViewBag.TotalRevenue.ToString("C2")</h1>
                    </div>
                    <div class="rounded-circle bg-white bg-opacity-25 p-3">
                        <i class="fas fa-wallet fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card p-4 border-0 shadow-sm bg-white h-100">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase text-muted fw-bold mb-1" style="font-size: 0.75rem; letter-spacing: 1px;">Ticket Médio por Serviço</h6>
                        <h1 class="fw-bold mb-0">@ViewBag.AverageTicket.ToString("C2")</h1>
                    </div>
                    <div class="rounded-circle bg-light p-3">
                        <i class="fas fa-chart-line fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">Mapa de Cobertura e Oportunidades</h5>
            <div class="d-flex gap-2 small">
                <span class="badge rounded-pill text-bg-success-subtle text-success-emphasis border border-success-subtle">Dentro do raio</span>
                <span class="badge rounded-pill text-bg-warning-subtle text-warning-emphasis border border-warning-subtle">Fora do raio</span>
            </div>
        </div>
        <div class="card-body">
            <div id="provider-coverage-map" class="provider-coverage-map d-none"></div>
            <div id="provider-coverage-empty" class="alert alert-info d-none mb-0">
                Defina CEP/base e coordenadas no seu perfil para visualizar o mapa de cobertura.
                <a href="/Profile/Index" class="fw-semibold ms-1">Ir para Perfil</a>
            </div>
            <div class="mt-3 d-flex flex-wrap gap-3 text-muted small">
                <span><i class="fas fa-bullseye me-1"></i>Raio de interesse: <strong id="provider-coverage-radius-km">-</strong></span>
                <span><i class="fas fa-map-pin me-1"></i>Pins no mapa: <strong id="provider-coverage-pins-count">0</strong></span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Matches -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Pedidos Recentes Próximos a Você</h5>
                    <div class="d-flex align-items-center gap-3">
                        <small class="text-muted d-none d-md-inline">Top @recentMatchesLimit</small>
                        <a asp-controller="ServiceRequests" asp-action="Index" class="btn btn-sm btn-link text-decoration-none">Ver Todos</a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light text-muted small text-uppercase">
                                <tr>
                                    <th class="px-4">Categoria</th>
                                    <th>Descrição</th>
                                    <th>Localização</th>
                                    <th class="text-end px-4">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="recent-matches-tbody">
                                @if (!Model.Any())
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-5">
                                            <div class="text-muted">
                                                <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                                                <p>Nenhuma oportunidade encontrada no seu radar atual.</p>
                                                <a asp-controller="Profile" asp-action="Index" class="btn btn-outline-primary btn-sm">Aumentar Raio de Busca</a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                @foreach (var request in Model)
                                {
                                    <tr>
                                        <td class="px-4">
                                            <span class="badge bg-light text-primary border border-primary-subtle px-2 py-1">
                                                @request.Category
                                            </span>
                                        </td>
                                        <td>
                                            <div class="fw-semibold text-dark text-truncate" style="max-width: 250px;">@request.Description</div>
                                            <small class="text-muted">Pedido em @request.CreatedAt.ToString("dd/MM HH:mm")</small>
                                        </td>
                                        <td>
                                            <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i> @request.Street, @request.City</small>
                                        </td>
                                        <td class="text-end px-4">
                                            <a asp-controller="ServiceRequests" asp-action="Details" asp-route-id="@request.Id" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">Ver Detalhes</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Activity -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="fw-bold mb-0">Dicas e Avisos</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning border-0 shadow-sm small mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Complete seu perfil com fotos para aumentar suas chances em 40%!
                    </div>
                    
                    <div class="d-flex align-items-center mb-4 p-2 bg-light rounded cursor-pointer transition-hover">
                        <div class="bg-primary text-white rounded p-3 me-3">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">Verificar Avaliações</h6>
                            <small class="text-muted">Acompanhe seu feedback.</small>
                        </div>
                    </div>

                    <div class="d-flex align-items-center mb-0 p-2 bg-light rounded cursor-pointer transition-hover">
                        <div class="bg-dark text-white rounded p-3 me-3">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">Suporte Técnico</h6>
                            <small class="text-muted">Fale conosco se precisar de ajuda.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    (function () {
        const currentProviderId = "@(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty)".toLowerCase();
        const initialCoverageMapRaw = @Html.Raw(providerCoverageMapJson);
        const providerAvatarUrl = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(providerAvatarUrl));
        const statusBadgeEl = document.getElementById("provider-operational-badge");
        const statusTextEl = document.getElementById("provider-operational-text");
        const coverageMapEl = document.getElementById("provider-coverage-map");
        const coverageEmptyEl = document.getElementById("provider-coverage-empty");
        const coverageRadiusEl = document.getElementById("provider-coverage-radius-km");
        const coveragePinsCountEl = document.getElementById("provider-coverage-pins-count");

        let coverageMapState = null;
        let leafletMap = null;
        let coverageMarkersLayer = null;
        let coverageRadiusLayer = null;
        let coverageProviderLayer = null;

        function escapeHtml(value) {
            return String(value || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        function statusPresentation(status) {
            if (status === "Ausente") {
                return { cssClass: "bg-secondary", label: "Ausente" };
            }

            if (status === "EmAtendimento") {
                return { cssClass: "bg-warning text-dark", label: "Em atendimento" };
            }

            return { cssClass: "bg-success", label: "Online para Servicos" };
        }

        function normalizeCategory(value) {
            return String(value || "")
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase();
        }

        function categoryIconClass(category) {
            const normalized = normalizeCategory(category);

            if (normalized.includes("hidraul") || normalized.includes("plumbing")) return "fas fa-faucet-drip";
            if (normalized.includes("eletric") || normalized.includes("electrical")) return "fas fa-bolt";
            if (normalized.includes("eletron") || normalized.includes("electronics")) return "fas fa-microchip";
            if (normalized.includes("eletrodomest") || normalized.includes("appliances")) return "fas fa-blender";
            if (normalized.includes("pintur")) return "fas fa-paint-roller";
            if (normalized.includes("limpez") || normalized.includes("cleaning")) return "fas fa-broom";
            if (normalized.includes("jardin")) return "fas fa-seedling";
            if (normalized.includes("alvenar") || normalized.includes("pedrei") || normalized.includes("masonry")) return "fas fa-hammer";
            if (normalized.includes("ar condicionado") || normalized.includes("arcond") || normalized.includes("climat")) return "fas fa-wind";
            if (normalized.includes("mudanc")) return "fas fa-truck";
            if (normalized.includes("montagem") || normalized.includes("moveis") || normalized.includes("mobili")) return "fas fa-screwdriver-wrench";
            if (normalized.includes("outro") || normalized.includes("other")) return "fas fa-circle-question";

            return "fas fa-screwdriver-wrench";
        }

        function createProviderAvatarIcon(avatarUrl) {
            return L.divIcon({
                className: "provider-map-provider-icon-wrap",
                html: `<div class="provider-map-provider-icon"><img src="${escapeHtml(avatarUrl)}" alt="Prestador"></div>`,
                iconSize: [44, 44],
                iconAnchor: [22, 22],
                popupAnchor: [0, -20]
            });
        }

        function createCategoryPinIcon(pin) {
            const stateClass = !pin.isCategoryMatch
                ? "category-miss"
                : (pin.isWithinInterestRadius ? "inside" : "outside");

            return L.divIcon({
                className: "provider-map-category-icon-wrap",
                html: `<div class="provider-map-category-icon ${stateClass}" title="${escapeHtml(pin.category)}">
                           <i class="${categoryIconClass(pin.category)}" aria-hidden="true"></i>
                       </div>`,
                iconSize: [60, 60],
                iconAnchor: [30, 30],
                popupAnchor: [0, -28]
            });
        }

        function updateOperationalBadge(status) {
            if (!statusBadgeEl || !statusTextEl) return;
            const presentation = statusPresentation(status);
            statusBadgeEl.className = `badge ${presentation.cssClass} p-2 px-3 rounded-pill shadow-sm`;
            statusTextEl.textContent = presentation.label;
        }

        function normalizeCoveragePin(rawPin) {
            if (!rawPin) return null;
            const latitude = Number(rawPin.latitude ?? rawPin.Latitude);
            const longitude = Number(rawPin.longitude ?? rawPin.Longitude);
            if (!Number.isFinite(latitude) || !Number.isFinite(longitude)) return null;

            return {
                requestId: String(rawPin.requestId ?? rawPin.RequestId ?? ""),
                category: String(rawPin.category ?? rawPin.Category ?? ""),
                description: String(rawPin.description ?? rawPin.Description ?? ""),
                street: String(rawPin.street ?? rawPin.Street ?? ""),
                city: String(rawPin.city ?? rawPin.City ?? ""),
                zip: String(rawPin.zip ?? rawPin.Zip ?? ""),
                createdAt: String(rawPin.createdAt ?? rawPin.CreatedAt ?? ""),
                createdAtIso: String(rawPin.createdAtIso ?? rawPin.CreatedAtIso ?? ""),
                latitude: latitude,
                longitude: longitude,
                distanceKm: Number(rawPin.distanceKm ?? rawPin.DistanceKm ?? 0),
                isWithinInterestRadius: Boolean(rawPin.isWithinInterestRadius ?? rawPin.IsWithinInterestRadius),
                isCategoryMatch: Boolean(rawPin.isCategoryMatch ?? rawPin.IsCategoryMatch)
            };
        }

        function formatRelativeTime(createdAtIso) {
            const timestamp = Date.parse(String(createdAtIso || ""));
            if (!Number.isFinite(timestamp)) return "";

            const diffMs = Math.max(0, Date.now() - timestamp);
            const minuteMs = 60 * 1000;
            const hourMs = 60 * minuteMs;
            const dayMs = 24 * hourMs;

            if (diffMs < minuteMs) return "Agora";

            const minutes = Math.floor(diffMs / minuteMs);
            if (minutes < 60) return `Ha ${minutes} minuto${minutes === 1 ? "" : "s"}`;

            const hours = Math.floor(diffMs / hourMs);
            if (hours < 24) return `Ha ${hours} hora${hours === 1 ? "" : "s"}`;

            const days = Math.floor(diffMs / dayMs);
            if (days < 7) return `Ha ${days} dia${days === 1 ? "" : "s"}`;
            if (days < 30) {
                const weeks = Math.floor(days / 7);
                return `Ha ${weeks} semana${weeks === 1 ? "" : "s"}`;
            }
            if (days < 365) {
                const months = Math.floor(days / 30);
                return `Ha ${months} mes${months === 1 ? "" : "es"}`;
            }

            const years = Math.floor(days / 365);
            return `Ha ${years} ano${years === 1 ? "" : "s"}`;
        }

        function normalizeCoverageMap(rawMap) {
            const map = rawMap || {};
            const pinsRaw = Array.isArray(map.pins)
                ? map.pins
                : (Array.isArray(map.Pins) ? map.Pins : []);

            return {
                hasBaseLocation: Boolean(map.hasBaseLocation ?? map.HasBaseLocation),
                providerLatitude: Number(map.providerLatitude ?? map.ProviderLatitude),
                providerLongitude: Number(map.providerLongitude ?? map.ProviderLongitude),
                interestRadiusKm: Number(map.interestRadiusKm ?? map.InterestRadiusKm),
                mapSearchRadiusKm: Number(map.mapSearchRadiusKm ?? map.MapSearchRadiusKm),
                baseZipCode: String(map.baseZipCode ?? map.BaseZipCode ?? ""),
                pins: pinsRaw
                    .map(normalizeCoveragePin)
                    .filter(pin => !!pin)
            };
        }

        function ensureLeafletMap(lat, lng) {
            if (!coverageMapEl || typeof L === "undefined") return;
            if (leafletMap) return;

            leafletMap = L.map(coverageMapEl, {
                zoomControl: true
            });

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: "&copy; OpenStreetMap contributors"
            }).addTo(leafletMap);

            leafletMap.setView([lat, lng], 12);
        }

        function showCoverageEmptyState(messageHtml) {
            if (coverageMapEl) {
                coverageMapEl.classList.add("d-none");
            }

            if (!coverageEmptyEl) return;
            coverageEmptyEl.classList.remove("d-none");
            coverageEmptyEl.innerHTML = messageHtml;
        }

        function renderCoverageMap(mapData) {
            const data = normalizeCoverageMap(mapData);
            coverageMapState = data;

            if (coverageRadiusEl) {
                coverageRadiusEl.textContent = Number.isFinite(data.interestRadiusKm)
                    ? `${data.interestRadiusKm.toFixed(1)} km`
                    : "-";
            }

            if (coveragePinsCountEl) {
                coveragePinsCountEl.textContent = String(data.pins.length);
            }

            if (!data.hasBaseLocation || !Number.isFinite(data.providerLatitude) || !Number.isFinite(data.providerLongitude)) {
                showCoverageEmptyState('Defina CEP/base e coordenadas no seu perfil para visualizar o mapa de cobertura. <a href="/Profile/Index" class="fw-semibold ms-1">Ir para Perfil</a>');
                return;
            }

            if (typeof L === "undefined") {
                showCoverageEmptyState("Mapa indisponivel no momento.");
                return;
            }

            if (coverageEmptyEl) {
                coverageEmptyEl.classList.add("d-none");
            }

            if (coverageMapEl) {
                coverageMapEl.classList.remove("d-none");
            }

            ensureLeafletMap(data.providerLatitude, data.providerLongitude);
            if (!leafletMap) return;

            if (coverageMarkersLayer) {
                coverageMarkersLayer.remove();
            }

            if (coverageRadiusLayer) {
                coverageRadiusLayer.remove();
            }

            if (coverageProviderLayer) {
                coverageProviderLayer.remove();
            }

            coverageMarkersLayer = L.layerGroup().addTo(leafletMap);

            coverageProviderLayer = L.marker(
                [data.providerLatitude, data.providerLongitude],
                { icon: createProviderAvatarIcon(providerAvatarUrl) })
                .addTo(leafletMap);
            coverageProviderLayer.bindPopup(`<strong>Sua base</strong><br/>CEP: ${escapeHtml(data.baseZipCode || "-")}`);

            if (Number.isFinite(data.interestRadiusKm) && data.interestRadiusKm > 0) {
                coverageRadiusLayer = L.circle([data.providerLatitude, data.providerLongitude], {
                    radius: data.interestRadiusKm * 1000,
                    color: "#2563eb",
                    fillColor: "#60a5fa",
                    fillOpacity: 0.1,
                    weight: 2
                }).addTo(leafletMap);
            }

            const bounds = L.latLngBounds([[data.providerLatitude, data.providerLongitude]]);
            data.pins.forEach(function (pin) {
                const isInside = !!pin.isWithinInterestRadius;
                const marker = L.marker(
                    [pin.latitude, pin.longitude],
                    { icon: createCategoryPinIcon(pin) })
                    .addTo(coverageMarkersLayer);
                const relativeTimeLabel = formatRelativeTime(pin.createdAtIso);
                if (relativeTimeLabel) {
                    marker.bindTooltip(relativeTimeLabel, {
                        permanent: true,
                        direction: "bottom",
                        offset: [0, 32],
                        className: "provider-map-time-tooltip"
                    });
                }

                const distanceLabel = Number.isFinite(pin.distanceKm) ? `${pin.distanceKm.toFixed(1)} km` : "-";
                const radiusLabel = isInside ? "Dentro do raio" : "Fora do raio";
                const categoryLabel = pin.isCategoryMatch ? "Categoria atendida" : "Categoria fora do seu filtro";
                marker.bindPopup(`
                    <div class="provider-map-popup">
                        <div class="fw-semibold mb-1">${escapeHtml(pin.category)} - ${escapeHtml(distanceLabel)}</div>
                        <div class="small text-muted mb-1">${escapeHtml(pin.description)}</div>
                        <div class="small text-muted mb-2">${escapeHtml(pin.street)}, ${escapeHtml(pin.city)}</div>
                        <div class="small mb-2">${escapeHtml(radiusLabel)} | ${escapeHtml(categoryLabel)}</div>
                        <a href="/ServiceRequests/Details/${encodeURIComponent(pin.requestId)}" class="btn btn-sm btn-primary">Ver detalhes</a>
                    </div>
                `);

                bounds.extend([pin.latitude, pin.longitude]);
            });

            if (bounds.isValid()) {
                leafletMap.fitBounds(bounds.pad(0.15), { maxZoom: 13 });
            } else {
                leafletMap.setView([data.providerLatitude, data.providerLongitude], 12);
            }
        }

        function renderMatches(items) {
            const tbody = document.getElementById("recent-matches-tbody");
            if (!tbody) return;

            const list = items || [];
            if (!list.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                                <p>Nenhuma oportunidade encontrada no seu radar atual.</p>
                                <a href="/Profile/Index" class="btn btn-outline-primary btn-sm">Aumentar Raio de Busca</a>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = list.map(request => `
                <tr>
                    <td class="px-4">
                        <span class="badge bg-light text-primary border border-primary-subtle px-2 py-1">
                            ${escapeHtml(request.category)}
                        </span>
                    </td>
                    <td>
                        <div class="fw-semibold text-dark text-truncate" style="max-width: 250px;">${escapeHtml(request.description)}</div>
                        <small class="text-muted">Pedido em ${escapeHtml(request.createdAt)}</small>
                    </td>
                    <td>
                        <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i> ${escapeHtml(request.street)}, ${escapeHtml(request.city)}</small>
                    </td>
                    <td class="text-end px-4">
                        <a href="/ServiceRequests/Details/${request.id}" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">Ver Detalhes</a>
                    </td>
                </tr>`).join("");
        }

        async function refreshDashboard() {
            const response = await fetch("/Home/RecentMatchesData", { credentials: "same-origin" });
            if (!response.ok) return;

            const data = await response.json();
            const totalMatches = document.getElementById("total-matches-count");
            const activeProposals = document.getElementById("active-proposals-count");
            const convertedJobs = document.getElementById("converted-jobs-count");
            const pendingAppointments = document.getElementById("pending-appointments-count");
            const upcomingVisits = document.getElementById("upcoming-visits-count");

            if (totalMatches) totalMatches.textContent = data.totalMatches;
            if (activeProposals) activeProposals.textContent = data.activeProposals;
            if (convertedJobs) convertedJobs.textContent = data.convertedJobs;
            if (pendingAppointments) pendingAppointments.textContent = data.pendingAppointments ?? 0;
            if (upcomingVisits) upcomingVisits.textContent = data.upcomingConfirmedVisits ?? 0;
            updateOperationalBadge(data.providerOperationalStatus);

            renderMatches(data.recentMatches);
            renderCoverageMap(data.coverageMap);
        }

        function shouldRefreshDashboard(subject) {
            const normalized = String(subject || "").toLowerCase();
            return normalized.includes("pedido") ||
                normalized.includes("agendamento") ||
                normalized.includes("reagendamento") ||
                normalized.includes("visita");
        }

        window.addEventListener("cpm:notification", function (event) {
            const subject = event?.detail?.subject ?? "";
            if (shouldRefreshDashboard(subject)) {
                refreshDashboard().catch(() => { });
            }
        });

        window.addEventListener("cpm:provider-status", function (event) {
            const payload = event?.detail || {};
            if (!payload.status) return;

            const providerId = String(payload.providerId || "").toLowerCase();
            if (providerId && providerId !== currentProviderId) return;

            updateOperationalBadge(String(payload.status));
        });

        window.addEventListener("resize", function () {
            if (leafletMap) {
                leafletMap.invalidateSize();
            }
        });

        renderCoverageMap(initialCoverageMapRaw);
    })();
</script>
