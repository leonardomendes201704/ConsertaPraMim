@model IEnumerable<ConsertaPraMim.Application.DTOs.ServiceRequestDto>
@using System.Globalization
@{
    ViewData["Title"] = "Dashboard";
    var providerCoverageMapJson = (ViewBag.ProviderCoverageMapJson as string) ?? "{}";
    var providerAvatarUrl = (ViewBag.ProviderAvatarUrl as string) ?? $"https://ui-avatars.com/api/?name={System.Uri.EscapeDataString(User.Identity?.Name ?? "Prestador")}&background=0D6EFD&color=fff";
    var providerStatus = (ViewBag.ProviderOperationalStatus as string) ?? "Online";
    var recentMatchesLimit = ViewBag.RecentMatchesLimit is int limit ? limit : 15;
    var statusBadgeClass = providerStatus switch
    {
        "Ausente" => "bg-secondary",
        "EmAtendimento" => "bg-warning text-dark",
        _ => "bg-success"
    };
    var statusText = providerStatus switch
    {
        "Ausente" => "Ausente",
        "EmAtendimento" => "Em atendimento",
        _ => "Online para Servicos"
    };
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:FILL@0..1" />

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="h3 fw-bold mb-0">
                Bem-vindo, @User.Identity.Name!
                <span class="ms-2 d-inline-flex align-items-center gap-1" aria-label="Avaliacao do prestador pendente">
                    @for (var starIndex = 0; starIndex < 5; starIndex++)
                    {
                        <i class="far fa-star" style="color:#f4b400;"></i>
                    }
                </span>
            </h1>
            <p class="text-muted">Veja o que esta acontecendo hoje no seu radar.</p>
        </div>
        <div class="col-auto">
            <span id="provider-operational-badge" class="badge @statusBadgeClass p-2 px-3 rounded-pill shadow-sm">
                <i class="fas fa-circle me-1 small"></i> <span id="provider-operational-text">@statusText</span>
            </span>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-5 g-4 mb-5 provider-kpi-row">
        <div class="col">
            <div class="card p-3 border-0 bg-primary text-white shadow h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Oportunidades Proximas</h6>
                        <h2 id="total-matches-count" class="fw-bold mb-0">@ViewBag.TotalMatches</h2>
                    </div>
                    <i class="fas fa-map-marker-alt fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card p-3 border-0 bg-info text-white shadow h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Propostas em Aberto</h6>
                        <h2 id="active-proposals-count" class="fw-bold mb-0">@ViewBag.ActiveProposals</h2>
                    </div>
                    <i class="fas fa-paper-plane fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card p-3 border-0 bg-dark text-white shadow h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Servicos Convertidos</h6>
                        <h2 id="converted-jobs-count" class="fw-bold mb-0">@ViewBag.ConvertedJobs</h2>
                    </div>
                    <i class="fas fa-check-circle fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col">
            <a asp-controller="ServiceRequests" asp-action="Agenda" class="text-decoration-none">
                <div class="card p-3 border-0 shadow h-100" style="background: linear-gradient(135deg, #f59e0b 0%, #fcd34d 100%); color: #4a2f00; cursor: pointer;">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 opacity-75">Agendamentos Pendentes</h6>
                            <h2 id="pending-appointments-count" class="fw-bold mb-0">@ViewBag.PendingAppointments</h2>
                        </div>
                        <i class="fas fa-hourglass-half fa-3x opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a asp-controller="ServiceRequests" asp-action="Agenda" class="text-decoration-none">
                <div class="card p-3 border-0 shadow h-100" style="background: linear-gradient(135deg, #059669 0%, #6ee7b7 100%); color: #053b2d; cursor: pointer;">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 opacity-75">Visitas Confirmadas</h6>
                            <h2 id="upcoming-visits-count" class="fw-bold mb-0">@ViewBag.UpcomingConfirmedVisits</h2>
                        </div>
                        <i class="fas fa-calendar-check fa-3x opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <div class="card p-4 border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #1d976c 0%, #93f9b9 100%); color: #004d40;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase fw-bold mb-1" style="font-size: 0.75rem; letter-spacing: 1px;">Faturamento Total</h6>
                        <h1 class="fw-bold mb-0">@ViewBag.TotalRevenue.ToString("C2")</h1>
                    </div>
                    <div class="rounded-circle bg-white bg-opacity-25 p-3">
                        <i class="fas fa-wallet fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card p-4 border-0 shadow-sm bg-white h-100">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase text-muted fw-bold mb-1" style="font-size: 0.75rem; letter-spacing: 1px;">Ticket Medio por Servico</h6>
                        <h1 class="fw-bold mb-0">@ViewBag.AverageTicket.ToString("C2")</h1>
                    </div>
                    <div class="rounded-circle bg-light p-3">
                        <i class="fas fa-chart-line fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0 py-3 d-flex flex-wrap justify-content-between gap-3 align-items-start">
            <div>
                <h5 class="fw-bold mb-1">Mapa de Cobertura e Oportunidades</h5>
                <small class="text-muted">Filtre por categoria e distancia para manter mapa e lista sincronizados.</small>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center justify-content-end">
                <select id="coverage-filter-category" class="form-select form-select-sm" style="min-width: 200px;">
                    <option value="">Todas categorias</option>
                </select>
                <select id="coverage-filter-distance" class="form-select form-select-sm" style="min-width: 170px;">
                    <option value="">Distancia padrao</option>
                    <option value="5">Ate 5 km</option>
                    <option value="10">Ate 10 km</option>
                    <option value="20">Ate 20 km</option>
                    <option value="40">Ate 40 km</option>
                    <option value="80">Ate 80 km</option>
                    <option value="120">Ate 120 km</option>
                </select>
                <div class="d-flex gap-2 small">
                    <span class="badge rounded-pill text-bg-success-subtle text-success-emphasis border border-success-subtle">Dentro do raio</span>
                    <span class="badge rounded-pill text-bg-warning-subtle text-warning-emphasis border border-warning-subtle">Fora do raio</span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="provider-coverage-map" class="provider-coverage-map d-none"></div>
            <div id="provider-coverage-empty" class="alert alert-info d-none mb-0">
                Defina CEP/base e coordenadas no seu perfil para visualizar o mapa de cobertura.
                <a href="/Profile/Index" class="fw-semibold ms-1">Ir para Perfil</a>
            </div>
            <div class="mt-3 d-flex flex-wrap gap-3 text-muted small align-items-center">
                <span><i class="fas fa-bullseye me-1"></i>Raio de interesse: <strong id="provider-coverage-radius-km">-</strong></span>
                <span><i class="fas fa-map-pin me-1"></i>Pins visiveis: <strong id="provider-coverage-pins-count">0</strong></span>
                <span><i class="fas fa-layer-group me-1"></i>Carregados: <strong id="provider-coverage-pins-loaded">0</strong>/<strong id="provider-coverage-pins-total">0</strong></span>
                <button id="provider-coverage-load-more" type="button" class="btn btn-outline-secondary btn-sm d-none">
                    <i class="fas fa-plus me-1"></i>Carregar mais pins
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Matches -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Pedidos Recentes Proximos a Voce</h5>
                    <div class="d-flex align-items-center gap-3">
                        <small class="text-muted d-none d-md-inline">Top @recentMatchesLimit</small>
                        <a asp-controller="ServiceRequests" asp-action="Index" class="btn btn-sm btn-link text-decoration-none">Ver Todos</a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light text-muted small text-uppercase">
                                <tr>
                                    <th class="text-center px-4">Categoria</th>
                                    <th>Descricao</th>
                                    <th>Localizacao</th>
                                    <th class="text-center px-4">Acao</th>
                                </tr>
                            </thead>
                            <tbody id="recent-matches-tbody">
                                @if (!Model.Any())
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-5">
                                            <div class="text-muted">
                                                <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                                                <p>Nenhuma oportunidade encontrada no seu radar atual.</p>
                                                <a asp-controller="Profile" asp-action="Index" class="btn btn-outline-primary btn-sm">Aumentar Raio de Busca</a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                @foreach (var request in Model)
                                {
                                    var neighborhood = request.City;
                                    if (!string.IsNullOrWhiteSpace(request.Street))
                                    {
                                        var streetParts = request.Street.Split('-', StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries);
                                        if (streetParts.Length > 1 && !string.IsNullOrWhiteSpace(streetParts[^1]))
                                        {
                                            neighborhood = streetParts[^1];
                                        }
                                    }
                                    var estimatedDistanceLabel = request.DistanceKm.HasValue
                                        ? $"{request.DistanceKm.Value.ToString("N1", new CultureInfo("pt-BR"))} km (estimada)"
                                        : null;
                                    var requestLatText = request.Latitude?.ToString(CultureInfo.InvariantCulture);
                                    var requestLngText = request.Longitude?.ToString(CultureInfo.InvariantCulture);
                                    var estimatedDistanceText = request.DistanceKm?.ToString(CultureInfo.InvariantCulture);
                                    <tr>
                                        <td class="text-center px-4">
                                            <span class="badge bg-light text-primary border border-primary-subtle px-2 py-1">
                                                <span class="material-symbols-outlined me-1 align-middle" style="font-size: 1rem;">@(string.IsNullOrWhiteSpace(request.CategoryIcon) ? "build_circle" : request.CategoryIcon)</span>
                                                @request.Category
                                            </span>
                                        </td>
                                        <td>
                                            <div class="fw-semibold text-dark text-truncate" style="max-width: 250px;">@request.Description</div>
                                            <small class="text-muted">Pedido em @request.CreatedAt.ToString("dd/MM HH:mm")</small>
                                        </td>
                                        <td class="text-center">
                                            <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i> @neighborhood</small>
                                            @if (!string.IsNullOrWhiteSpace(estimatedDistanceLabel))
                                            {
                                                <span class="ms-2 badge rounded-pill text-bg-light border"
                                                      data-recent-distance-cell="1"
                                                      data-request-lat="@requestLatText"
                                                      data-request-lng="@requestLngText"
                                                      data-estimated-distance="@estimatedDistanceText">
                                                    @estimatedDistanceLabel
                                                </span>
                                            }
                                        </td>
                                        <td class="text-end px-4">
                                            <a asp-controller="ServiceRequests" asp-action="Details" asp-route-id="@request.Id" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">Ver Detalhes</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Activity -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="fw-bold mb-0">Dicas e Avisos</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning border-0 shadow-sm small mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Complete seu perfil com fotos para aumentar suas chances em 40%!
                    </div>
                    
                    <div class="d-flex align-items-center mb-4 p-2 bg-light rounded cursor-pointer transition-hover">
                        <div class="bg-primary text-white rounded p-3 me-3">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">Verificar Avaliacoes</h6>
                            <small class="text-muted">Acompanhe seu feedback.</small>
                        </div>
                    </div>

                    <div class="d-flex align-items-center mb-0 p-2 bg-light rounded cursor-pointer transition-hover">
                        <div class="bg-dark text-white rounded p-3 me-3">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">Suporte Tecnico</h6>
                            <small class="text-muted">Fale conosco se precisar de ajuda.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    window.providerHomeDashboardConfig = {
        currentProviderId: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty)),
        initialCoverageMapRaw: @Html.Raw(providerCoverageMapJson),
        providerAvatarUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(providerAvatarUrl)),
        drivingRouteUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("DrivingRoute", "ServiceRequests"))),
        recentMatchesLimit: @recentMatchesLimit
    };
</script>
<script src="~/js/views/home/index.js" asp-append-version="true"></script>
