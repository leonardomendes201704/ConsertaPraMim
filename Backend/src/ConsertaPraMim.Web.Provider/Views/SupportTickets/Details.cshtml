@using ConsertaPraMim.Application.DTOs
@model ConsertaPraMim.Web.Provider.Models.SupportTicketDetailsViewModel
@{
    ViewData["Title"] = "Detalhe do chamado";
    var details = Model.Ticket;
    var ticket = details?.Ticket;
    var messages = details?.Messages ?? Array.Empty<MobileProviderSupportTicketMessageDto>();
    var isClosed = string.Equals(ticket?.Status, "Closed", StringComparison.OrdinalIgnoreCase);

    static string StatusBadgeClass(string status)
    {
        return status.ToLowerInvariant() switch
        {
            "open" => "bg-primary-subtle text-primary-emphasis",
            "inprogress" => "bg-warning-subtle text-warning-emphasis",
            "waitingprovider" => "bg-info-subtle text-info-emphasis",
            "resolved" => "bg-success-subtle text-success-emphasis",
            "closed" => "bg-secondary-subtle text-secondary-emphasis",
            _ => "bg-light text-dark"
        };
    }

    static string PriorityBadgeClass(string priority)
    {
        return priority.ToLowerInvariant() switch
        {
            "critical" => "bg-danger-subtle text-danger-emphasis",
            "high" => "bg-warning-subtle text-warning-emphasis",
            "medium" => "bg-primary-subtle text-primary-emphasis",
            "low" => "bg-success-subtle text-success-emphasis",
            _ => "bg-light text-dark"
        };
    }

    static string AuthorBadgeClass(string authorRole)
    {
        return authorRole.ToLowerInvariant() switch
        {
            "admin" => "bg-primary-subtle text-primary-emphasis",
            "provider" => "bg-success-subtle text-success-emphasis",
            _ => "bg-light text-dark"
        };
    }

    static string AttachmentIconClass(string? mediaKind)
    {
        return (mediaKind ?? string.Empty).ToLowerInvariant() switch
        {
            "image" => "fas fa-file-image text-primary",
            "video" => "fas fa-file-video text-danger",
            "audio" => "fas fa-file-audio text-success",
            _ => "fas fa-file-alt text-secondary"
        };
    }

    static string FormatAttachmentSize(long sizeBytes)
    {
        if (sizeBytes < 1024) return $"{sizeBytes} B";
        if (sizeBytes < 1024 * 1024) return $"{sizeBytes / 1024d:0.#} KB";
        return $"{sizeBytes / (1024d * 1024d):0.##} MB";
    }
}

@section Styles
{
    <style>
        .support-timeline {
            max-height: 520px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .support-message {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            background: #fff;
            margin-bottom: 10px;
        }

        .support-message.admin {
            border-left: 4px solid #2563eb;
        }

        .support-message.provider {
            border-left: 4px solid #16a34a;
        }

        .support-message.system {
            border-left: 4px solid #6b7280;
            background: #f8fafc;
        }

        .support-message-text {
            white-space: pre-wrap;
        }

        .support-message-attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .support-message-attachment {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            max-width: 100%;
            border: 1px solid #dbe4f0;
            background: #f8fbff;
            border-radius: 8px;
            padding: 6px 10px;
            text-decoration: none;
        }

        .support-message-attachment:hover {
            background: #eef5ff;
            border-color: #93c5fd;
        }

        .support-message-attachment-name {
            display: block;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.86rem;
            font-weight: 600;
            color: #0f172a;
        }

        .support-message-attachment-meta {
            display: block;
            font-size: 0.76rem;
            color: #64748b;
        }
    </style>
}

<div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1">Detalhe do chamado</h1>
            <p class="text-muted mb-0">Acompanhe a conversa e responda diretamente por este painel.</p>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar para lista
        </a>
    </div>

    @if (TempData["Success"] is string successMessage)
    {
        <div class="alert alert-success shadow-sm border-0">@successMessage</div>
    }
    @if (TempData["Error"] is string tempError)
    {
        <div class="alert alert-danger shadow-sm border-0">@tempError</div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="alert alert-danger shadow-sm border-0">@Model.ErrorMessage</div>
    }
    else if (details == null || ticket == null)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body py-4 text-center text-muted">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Carregando detalhes do chamado...
            </div>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
                    <div>
                        <h2 class="h5 fw-semibold mb-1">@ticket.Subject</h2>
                        <p class="text-muted mb-0">Categoria: @ticket.Category</p>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <span class="badge @PriorityBadgeClass(ticket.Priority)">@ticket.Priority</span>
                        <span class="badge @StatusBadgeClass(ticket.Status)">@ticket.Status</span>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <div class="border rounded p-3 h-100">
                            <div class="text-muted small">Aberto em</div>
                            <div class="fw-semibold">@ticket.OpenedAtUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="border rounded p-3 h-100">
                            <div class="text-muted small">Ultima interacao</div>
                            <div class="fw-semibold">@ticket.LastInteractionAtUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="border rounded p-3 h-100">
                            <div class="text-muted small">Admin responsavel</div>
                            <div class="fw-semibold">@(string.IsNullOrWhiteSpace(ticket.AssignedAdminName) ? "Nao atribuido" : ticket.AssignedAdminName)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white fw-semibold">Historico de mensagens</div>
            <div class="card-body support-timeline" id="supportTimeline">
                @if (!messages.Any())
                {
                    <div class="text-muted text-center py-4">
                        Nenhuma mensagem registrada ate o momento.
                    </div>
                }
                else
                {
                    @foreach (var message in messages)
                    {
                        var roleCss = message.AuthorRole.ToLowerInvariant() switch
                        {
                            "admin" => "admin",
                            "provider" => "provider",
                            _ => "system"
                        };

                        <div class="support-message @roleCss">
                            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge @AuthorBadgeClass(message.AuthorRole)">@message.AuthorRole</span>
                                    <span class="fw-semibold">@message.AuthorName</span>
                                </div>
                                <span class="text-muted small">@message.CreatedAtUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</span>
                            </div>
                            <div class="support-message-text">@message.MessageText</div>
                            @if (message.Attachments.Any())
                            {
                                <div class="support-message-attachments">
                                    @foreach (var attachment in message.Attachments)
                                    {
                                        <a class="support-message-attachment"
                                           href="@attachment.FileUrl"
                                           target="_blank"
                                           rel="noopener noreferrer"
                                           title="@attachment.FileName">
                                            <i class="@AttachmentIconClass(attachment.MediaKind)"></i>
                                            <span>
                                                <span class="support-message-attachment-name">@attachment.FileName</span>
                                                <span class="support-message-attachment-meta">@FormatAttachmentSize(attachment.SizeBytes)</span>
                                            </span>
                                        </a>
                                    }
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-body">
                @if (isClosed)
                {
                    <div class="alert alert-secondary border-0 mb-0">
                        Este chamado esta fechado e nao aceita novas mensagens.
                    </div>
                }
                else
                {
                    <form asp-action="AddMessage" method="post" id="supportMessageForm" class="mb-3" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@ticket.Id" />
                        <label class="form-label fw-semibold">Nova mensagem</label>
                        <textarea name="message" class="form-control" rows="5" maxlength="3000" placeholder="Digite aqui a sua resposta" required></textarea>
                        <div class="form-text">Maximo de 3000 caracteres.</div>
                        <div class="mt-3">
                            <label class="form-label fw-semibold" for="supportMessageAttachments">Anexos</label>
                            <input id="supportMessageAttachments"
                                   name="attachments"
                                   type="file"
                                   class="form-control"
                                   multiple
                                   accept=".jpg,.jpeg,.png,.webp,.gif,.mp4,.webm,.mov,.avi,.mp3,.wav,.ogg,.m4a,.aac,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip" />
                            <div class="form-text">Tipos permitidos: documentos, imagens, videos e audios (max. 25MB por arquivo).</div>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-3">
                            <button type="submit" class="btn btn-primary" id="supportSendMessageBtn">
                                <i class="fas fa-paper-plane me-2"></i>Enviar mensagem
                            </button>

                            <button type="submit"
                                    class="btn btn-outline-danger"
                                    id="supportCloseTicketBtn"
                                    formaction="@Url.Action("Close", "SupportTickets")"
                                    formmethod="post"
                                    formnovalidate
                                    onclick="document.getElementById('supportMessageAttachments').value=''; return confirm('Confirma o fechamento do chamado?');">
                                <i class="fas fa-lock me-2"></i>Fechar chamado
                            </button>
                        </div>
                    </form>
                }
            </div>
        </div>
    }
</div>

@section Scripts
{
    @if (ticket != null)
    {
        <script>
            window.providerSupportTicketDetailsConfig = {
                ticketId: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ticket.Id)),
                pollUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("PollDetails", "SupportTickets", new { id = ticket.Id }) ?? string.Empty)),
                pollIntervalMs: 10000,
                snapshot: {
                    status: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ticket.Status)),
                    messageCount: @messages.Count,
                    lastInteractionAtUtc: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ticket.LastInteractionAtUtc)),
                    lastMessageId: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(messages.LastOrDefault()?.Id))
                }
            };
        </script>
    }
    <script src="~/js/views/support-tickets/details.js" asp-append-version="true"></script>
}
