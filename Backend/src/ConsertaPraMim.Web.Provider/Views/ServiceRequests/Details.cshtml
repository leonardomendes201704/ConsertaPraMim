@inject IConfiguration Configuration
@model ConsertaPraMim.Application.DTOs.ServiceRequestDto
@{
    ViewData["Title"] = "Detalhes do Pedido";
    var existingProposal = ViewBag.ExistingProposal as ConsertaPraMim.Application.DTOs.ProposalDto;
    var appointment = ViewBag.Appointment as ConsertaPraMim.Application.DTOs.ServiceAppointmentDto;
    var scopeChanges = ViewBag.ScopeChanges as IEnumerable<ConsertaPraMim.Application.DTOs.ServiceScopeChangeRequestDto>
        ?? Enumerable.Empty<ConsertaPraMim.Application.DTOs.ServiceScopeChangeRequestDto>();
    var checklist = ViewBag.AppointmentChecklist as ConsertaPraMim.Application.DTOs.ServiceAppointmentChecklistDto;
    var completionTerm = ViewBag.CompletionTerm as ConsertaPraMim.Application.DTOs.ServiceCompletionTermDto;
    var ptBr = new System.Globalization.CultureInfo("pt-BR");
    var canManageServiceMedia = existingProposal?.Accepted == true &&
                                (string.Equals(Model.Status, "Completed", StringComparison.OrdinalIgnoreCase) ||
                                 string.Equals(Model.Status, "PendingClientCompletionAcceptance", StringComparison.OrdinalIgnoreCase) ||
                                 string.Equals(Model.Status, "Validated", StringComparison.OrdinalIgnoreCase));
    var requestStatusLabel = string.Equals(Model.Status, "PendingClientCompletionAcceptance", StringComparison.OrdinalIgnoreCase)
        ? "Aguardando aceite de conclusao"
        : Model.Status;
    var apiBaseUrl = (Configuration["ApiBaseUrl"] ?? string.Empty).TrimEnd('/');
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
    var scopeChangesChronological = scopeChanges
        .OrderBy(item => item.Version)
        .ThenBy(item => item.RequestedAtUtc)
        .ThenBy(item => item.CreatedAt)
        .ToList();
    var scopeChangeValueById = new Dictionary<Guid, (decimal PreviousValue, decimal NewValue)>();
    var commercialBaseValue = decimal.Round(
        Math.Max(0m, Model.CommercialBaseValue ?? Model.EstimatedValue ?? 0m),
        2,
        MidpointRounding.AwayFromZero);
    var approvedIncrementalTotal = 0m;
    foreach (var scopeChange in scopeChangesChronological)
    {
        var previousValue = decimal.Round(
            commercialBaseValue + approvedIncrementalTotal,
            2,
            MidpointRounding.AwayFromZero);
        var incrementalValue = decimal.Round(
            Math.Max(0m, scopeChange.IncrementalValue),
            2,
            MidpointRounding.AwayFromZero);
        var newValue = decimal.Round(
            previousValue + incrementalValue,
            2,
            MidpointRounding.AwayFromZero);

        scopeChangeValueById[scopeChange.Id] = (previousValue, newValue);
        if (string.Equals(scopeChange.Status, "ApprovedByClient", StringComparison.OrdinalIgnoreCase))
        {
            approvedIncrementalTotal = decimal.Round(
                approvedIncrementalTotal + incrementalValue,
                2,
                MidpointRounding.AwayFromZero);
        }
    }
    var appointmentStatusClass = appointment?.Status switch
    {
        "PendingProviderConfirmation" => "bg-warning-subtle text-warning border border-warning-subtle",
        "Confirmed" => "bg-success-subtle text-success border border-success-subtle",
        "Arrived" => "bg-info-subtle text-info border border-info-subtle",
        "InProgress" => "bg-primary-subtle text-primary border border-primary-subtle",
        "RejectedByProvider" => "bg-danger-subtle text-danger border border-danger-subtle",
        "ExpiredWithoutProviderAction" => "bg-secondary-subtle text-secondary border border-secondary-subtle",
        "RescheduleRequestedByClient" => "bg-info-subtle text-info border border-info-subtle",
        "RescheduleRequestedByProvider" => "bg-info-subtle text-info border border-info-subtle",
        "RescheduleConfirmed" => "bg-success-subtle text-success border border-success-subtle",
        "CancelledByClient" => "bg-secondary-subtle text-secondary border border-secondary-subtle",
        "CancelledByProvider" => "bg-secondary-subtle text-secondary border border-secondary-subtle",
        "Completed" => "bg-primary-subtle text-primary border border-primary-subtle",
        _ => "bg-light text-muted border border-light-subtle"
    };
    var appointmentStatusLabel = appointment?.Status switch
    {
        "PendingProviderConfirmation" => "Aguardando confirmacao",
        "Confirmed" => "Confirmado",
        "Arrived" => "Chegada registrada",
        "InProgress" => "Em atendimento",
        "RejectedByProvider" => "Recusado",
        "ExpiredWithoutProviderAction" => "Expirado",
        "RescheduleRequestedByClient" => "Cliente pediu reagendamento",
        "RescheduleRequestedByProvider" => "Reagendamento solicitado",
        "RescheduleConfirmed" => "Reagendamento confirmado",
        "CancelledByClient" => "Cancelado pelo cliente",
        "CancelledByProvider" => "Cancelado por voce",
        "Completed" => "Concluido",
        _ => appointment?.Status ?? "-"
    };
    var operationalStatus = appointment?.OperationalStatus
        ?? (appointment?.Status switch
        {
            "Arrived" => "OnSite",
            "InProgress" => "InService",
            "Completed" => "Completed",
            "Confirmed" => "OnTheWay",
            "RescheduleConfirmed" => "OnTheWay",
            _ => null
        });
    var operationalStatusLabel = operationalStatus switch
    {
        "OnTheWay" => "A caminho",
        "OnSite" => "No local",
        "InService" => "Em atendimento",
        "WaitingParts" => "Aguardando peca",
        "Completed" => "Concluido",
        _ => "Sem status"
    };
    var operationalStatusClass = operationalStatus switch
    {
        "OnTheWay" => "bg-warning-subtle text-warning border border-warning-subtle",
        "OnSite" => "bg-info-subtle text-info border border-info-subtle",
        "InService" => "bg-primary-subtle text-primary border border-primary-subtle",
        "WaitingParts" => "bg-secondary-subtle text-secondary border border-secondary-subtle",
        "Completed" => "bg-success-subtle text-success border border-success-subtle",
        _ => "bg-light text-muted border border-light-subtle"
    };
    var appointmentRiskClass = appointment?.NoShowRiskLevel?.ToLowerInvariant() switch
    {
        "high" => "bg-danger-subtle text-danger border border-danger-subtle",
        "medium" => "bg-warning-subtle text-warning border border-warning-subtle",
        "low" => "bg-success-subtle text-success border border-success-subtle",
        _ => "bg-light text-muted border border-light-subtle"
    };
    var appointmentRiskLabel = appointment?.NoShowRiskLevel?.ToLowerInvariant() switch
    {
        "high" => "Risco alto",
        "medium" => "Risco medio",
        "low" => "Risco baixo",
        _ => "Risco nao avaliado"
    };
}

<div class="container py-4">
    <div class="mb-4">
        <a asp-action="Index" class="btn btn-link text-decoration-none p-0">
            <i class="fas fa-arrow-left me-2"></i>Voltar para a lista
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success border-0 shadow-sm mb-4">
            <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger border-0 shadow-sm mb-4">
            <i class="fas fa-triangle-exclamation me-2"></i>@TempData["Error"]
        </div>
    }

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm p-4 h-100">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <span class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill mb-2">
                            @Model.Category
                        </span>
                        <h2 class="fw-bold mb-0">@Model.Description</h2>
                        <p class="text-muted small">Publicado em @Model.CreatedAt.ToString("f")</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-@(Model.Status == "Created" ? "success" : "secondary") p-2 shadow-sm">
                            @requestStatusLabel
                        </span>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <div class="mb-4">
                        <img src="@Model.ImageUrl" class="img-fluid rounded-3 shadow-sm border" alt="Foto do servico" style="max-height: 400px; width: 100%; object-fit: cover;">
                    </div>
                }

                <div class="mb-4">
                    <h6 class="fw-bold text-uppercase small text-muted">Local da Execucao</h6>
                    <p class="mb-0 fs-5"><i class="fas fa-map-marker-alt text-danger me-2"></i> @Model.Street</p>
                    <p class="text-muted">@Model.City, @Model.Zip</p>
                </div>

                <div class="mt-auto">
                    <div class="p-3 bg-light rounded-3 border border-light-subtle">
                        <div class="d-flex">
                            <i class="fas fa-info-circle text-primary me-3 mt-1"></i>
                            <div>
                                <h6 class="fw-bold mb-1">Informacoes Adicionais</h6>
                                <p class="small text-muted mb-0">O cliente esta aguardando propostas baseadas na sua estimativa de valor e tempo de resposta.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            @if (existingProposal != null)
            {
                <div class="card border-0 shadow-sm p-4 bg-light h-100">
                    <div class="text-center py-4">
                        <div class="bg-success text-white d-inline-block rounded-circle p-3 mb-3">
                            <i class="fas fa-paper-plane fa-2x"></i>
                        </div>
                        <h4 id="proposal-status-title" class="fw-bold">@(existingProposal.Accepted ? "Proposta aceita pelo Cliente!" : "Proposta Enviada!")</h4>
                        <p id="proposal-status-subtitle" class="text-muted">@(existingProposal.Accepted ? "Entre em contato para acertar os detalhes." : "Voce ja enviou uma proposta para este pedido.")</p>
                    </div>
                    <hr class="my-4">
                    <div class="mb-3">
                        <label class="text-muted small text-uppercase">Valor Estimado</label>
                        <p class="fw-bold fs-4">R$ @(existingProposal.EstimatedValue?.ToString("N2") ?? "A combinar")</p>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small text-uppercase">Sua Mensagem</label>
                        <p class="text-dark">@(string.IsNullOrEmpty(existingProposal.Message) ? "Sem mensagem adicional." : existingProposal.Message)</p>
                    </div>
                    <div class="mt-auto">
                        <span id="proposal-status-badge" class="badge @(existingProposal.Accepted ? "bg-success" : "bg-warning") w-100 py-2 mb-3">
                            @(existingProposal.Accepted ? "PROPOSTA ACEITA" : "AGUARDANDO CLIENTE")
                        </span>

                        <button type="button" id="openChatBtn" class="btn btn-outline-primary w-100">
                            Conversar com o Cliente
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="card border-0 shadow-sm p-4 h-100">
                    <h4 class="fw-bold mb-4">Enviar Proposta</h4>
                    <form asp-controller="Proposals" asp-action="Submit" method="post">
                        <input type="hidden" name="requestId" value="@Model.Id" />

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Valor Estimado (opcional)</label>
                            <input type="text" id="estimatedValueDisplay" inputmode="numeric" class="form-control bg-light border-0 mb-2" placeholder="R$ 0,00" autocomplete="off">
                            <input type="hidden" id="estimatedValue" name="estimatedValue">
                            <small class="text-muted">Deixe em branco se preferir combinar apos a conversa.</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold">Mensagem ao Cliente</label>
                            <textarea name="message" rows="4" class="form-control bg-light border-0" placeholder="Oi! Posso te ajudar com isso. Tenho experiencia em..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow-sm">
                            <i class="fas fa-paper-plane me-2"></i>Enviar Minha Proposta
                        </button>
                    </form>
                </div>
            }

            @if (appointment != null)
            {
                var canConfirmOrReject = string.Equals(appointment.Status, "PendingProviderConfirmation", StringComparison.OrdinalIgnoreCase);
                var canMarkArrival =
                    string.Equals(appointment.Status, "Confirmed", StringComparison.OrdinalIgnoreCase) ||
                    string.Equals(appointment.Status, "RescheduleConfirmed", StringComparison.OrdinalIgnoreCase);
                var canStartExecution = string.Equals(appointment.Status, "Arrived", StringComparison.OrdinalIgnoreCase);
                var canRespondPresence =
                    !string.Equals(appointment.Status, "RejectedByProvider", StringComparison.OrdinalIgnoreCase) &&
                    !string.Equals(appointment.Status, "CancelledByClient", StringComparison.OrdinalIgnoreCase) &&
                    !string.Equals(appointment.Status, "CancelledByProvider", StringComparison.OrdinalIgnoreCase) &&
                    !string.Equals(appointment.Status, "ExpiredWithoutProviderAction", StringComparison.OrdinalIgnoreCase) &&
                    !string.Equals(appointment.Status, "Completed", StringComparison.OrdinalIgnoreCase);
                var providerPresenceLabel = appointment.ProviderPresenceConfirmed switch
                {
                    true => "Confirmado",
                    false => "Nao confirmado",
                    _ => "Pendente"
                };
                var providerPresenceClass = appointment.ProviderPresenceConfirmed switch
                {
                    true => "bg-success-subtle text-success border border-success-subtle",
                    false => "bg-danger-subtle text-danger border border-danger-subtle",
                    _ => "bg-warning-subtle text-warning border border-warning-subtle"
                };
                var clientPresenceLabel = appointment.ClientPresenceConfirmed switch
                {
                    true => "Confirmado",
                    false => "Nao confirmado",
                    _ => "Pendente"
                };
                var clientPresenceClass = appointment.ClientPresenceConfirmed switch
                {
                    true => "bg-success-subtle text-success border border-success-subtle",
                    false => "bg-danger-subtle text-danger border border-danger-subtle",
                    _ => "bg-warning-subtle text-warning border border-warning-subtle"
                };
                <div class="card border-0 shadow-sm p-4 mt-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="fw-bold mb-0"><i class="fas fa-calendar-check text-primary me-2"></i>Agendamento</h5>
                        <span class="badge @appointmentStatusClass rounded-pill px-3 py-2">@appointmentStatusLabel</span>
                    </div>
                    <div class="mb-3">
                        <span class="badge @operationalStatusClass rounded-pill px-3 py-2">
                            Operacional: @operationalStatusLabel
                        </span>
                    </div>
                    <div class="mb-3 d-flex flex-wrap gap-2">
                        <span class="badge @appointmentRiskClass rounded-pill px-3 py-2">
                            <i class="fas fa-triangle-exclamation me-1"></i>
                            @appointmentRiskLabel
                            @if (appointment.NoShowRiskScore.HasValue)
                            {
                                <text>(@appointment.NoShowRiskScore.Value)</text>
                            }
                        </span>
                        @if (appointment.NoShowRiskCalculatedAtUtc.HasValue)
                        {
                            <span class="badge bg-light text-muted border border-light-subtle rounded-pill px-3 py-2">
                                Atualizado: @appointment.NoShowRiskCalculatedAtUtc.Value.ToLocalTime().ToString("dd/MM HH:mm")
                            </span>
                        }
                    </div>
                    @if (!string.IsNullOrWhiteSpace(appointment.NoShowRiskReasons))
                    {
                        <div class="small text-muted mb-3">
                            Motivos: @appointment.NoShowRiskReasons.Replace(",", ", ")
                        </div>
                    }

                    <div class="small text-muted mb-1">Janela solicitada</div>
                    <div class="fw-semibold mb-3">
                        @appointment.WindowStartUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                        -
                        @appointment.WindowEndUtc.ToLocalTime().ToString("HH:mm")
                    </div>

                    @if (!string.IsNullOrWhiteSpace(appointment.Reason))
                    {
                        <div class="small text-muted mb-1">Observacao do cliente</div>
                        <div class="mb-3">@appointment.Reason</div>
                    }

                    <div class="card border border-warning-subtle bg-warning-subtle bg-opacity-25 mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                                <div class="fw-semibold"><i class="fas fa-user-check text-warning-emphasis me-2"></i>Confirmacao de presenca</div>
                                <span class="badge @providerPresenceClass rounded-pill px-3">Sua resposta: @providerPresenceLabel</span>
                            </div>
                            <div class="small mb-2">
                                <span class="text-muted">Cliente:</span>
                                <span class="badge @clientPresenceClass rounded-pill px-2 ms-1">@clientPresenceLabel</span>
                                @if (appointment.ClientPresenceRespondedAtUtc.HasValue)
                                {
                                    <span class="text-muted ms-1">(em @appointment.ClientPresenceRespondedAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm"))</span>
                                }
                            </div>
                            @if (!string.IsNullOrWhiteSpace(appointment.ClientPresenceReason))
                            {
                                <div class="small text-muted mb-2">Motivo do cliente: @appointment.ClientPresenceReason</div>
                            }
                            @if (appointment.ProviderPresenceRespondedAtUtc.HasValue)
                            {
                                <div class="small text-muted mb-2">Sua resposta foi registrada em @appointment.ProviderPresenceRespondedAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm").</div>
                            }

                            @if (canRespondPresence)
                            {
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-8">
                                        <form asp-action="RespondAppointmentPresence" method="post" class="d-grid">
                                            <input type="hidden" name="appointmentId" value="@appointment.Id" />
                                            <input type="hidden" name="requestId" value="@Model.Id" />
                                            <input type="hidden" name="confirmed" value="true" />
                                            <button type="submit" class="btn btn-success btn-sm rounded-pill">
                                                <i class="fas fa-check me-1"></i>Confirmo presenca
                                            </button>
                                        </form>
                                    </div>
                                    <div class="col-md-4">
                                        <form asp-action="RespondAppointmentPresence" method="post">
                                            <input type="hidden" name="appointmentId" value="@appointment.Id" />
                                            <input type="hidden" name="requestId" value="@Model.Id" />
                                            <input type="hidden" name="confirmed" value="false" />
                                            <input type="text" name="reason" maxlength="250" class="form-control form-control-sm mb-2" placeholder="Motivo (opcional)" />
                                            <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill w-100">
                                                <i class="fas fa-times me-1"></i>Nao confirmo
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    @if (appointment.ArrivedAtUtc.HasValue)
                    {
                        <div class="small text-muted mb-1">Chegada registrada</div>
                        <div class="mb-2">
                            @appointment.ArrivedAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            @if (appointment.ArrivedLatitude.HasValue && appointment.ArrivedLongitude.HasValue)
                            {
                                <span class="text-muted small">
                                    (GPS: @appointment.ArrivedLatitude.Value.ToString("0.#####"), @appointment.ArrivedLongitude.Value.ToString("0.#####"))
                                </span>
                            }
                        </div>

                        @if (!string.IsNullOrWhiteSpace(appointment.ArrivedManualReason))
                        {
                            <div class="small text-muted mb-3">Motivo check-in manual: @appointment.ArrivedManualReason</div>
                        }
                    }

                    @if (appointment.StartedAtUtc.HasValue)
                    {
                        <div class="small text-muted mb-1">Atendimento iniciado</div>
                        <div class="mb-3">@appointment.StartedAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
                    }

                    @if (!string.Equals(appointment.Status, "RejectedByProvider", StringComparison.OrdinalIgnoreCase) &&
                         !string.Equals(appointment.Status, "CancelledByClient", StringComparison.OrdinalIgnoreCase) &&
                         !string.Equals(appointment.Status, "CancelledByProvider", StringComparison.OrdinalIgnoreCase) &&
                         !string.Equals(appointment.Status, "ExpiredWithoutProviderAction", StringComparison.OrdinalIgnoreCase))
                    {
                        <div class="border rounded-3 p-3 mb-3 bg-light-subtle">
                            <div class="small text-muted mb-2 text-uppercase fw-semibold">Atualizar andamento operacional</div>
                            <form asp-action="UpdateAppointmentOperationalStatus" method="post">
                                <input type="hidden" name="appointmentId" value="@appointment.Id" />
                                <input type="hidden" name="requestId" value="@Model.Id" />
                                <input type="hidden" name="returnToAgenda" value="false" />
                                <select name="operationalStatus" class="form-select mb-2">
                                    <option value="OnTheWay" selected="@(string.Equals(operationalStatus, "OnTheWay", StringComparison.OrdinalIgnoreCase))">A caminho</option>
                                    <option value="OnSite" selected="@(string.Equals(operationalStatus, "OnSite", StringComparison.OrdinalIgnoreCase))">No local</option>
                                    <option value="InService" selected="@(string.Equals(operationalStatus, "InService", StringComparison.OrdinalIgnoreCase))">Em atendimento</option>
                                    <option value="WaitingParts" selected="@(string.Equals(operationalStatus, "WaitingParts", StringComparison.OrdinalIgnoreCase))">Aguardando peca</option>
                                    <option value="Completed" selected="@(string.Equals(operationalStatus, "Completed", StringComparison.OrdinalIgnoreCase))">Concluido</option>
                                </select>
                                <input type="text"
                                       name="reason"
                                       maxlength="250"
                                       class="form-control mb-2"
                                       placeholder="Motivo (obrigatorio em aguardando peca)"
                                       value="@appointment.OperationalStatusReason" />
                                <button type="submit" class="btn btn-outline-primary rounded-pill w-100">
                                    <i class="fas fa-route me-2"></i>Atualizar status operacional
                                </button>
                            </form>
                        </div>
                    }

                    @if (canConfirmOrReject)
                    {
                        <div class="alert alert-warning border mb-3">
                            O cliente solicitou essa visita e esta aguardando sua confirmacao.
                        </div>

                        <form asp-action="ConfirmAppointment" method="post" class="d-grid mb-2">
                            <input type="hidden" name="appointmentId" value="@appointment.Id" />
                            <input type="hidden" name="requestId" value="@Model.Id" />
                            <button type="submit" class="btn btn-success rounded-pill">
                                <i class="fas fa-check me-2"></i>Confirmar visita
                            </button>
                        </form>

                        <form asp-action="RejectAppointment" method="post">
                            <input type="hidden" name="appointmentId" value="@appointment.Id" />
                            <input type="hidden" name="requestId" value="@Model.Id" />
                            <label class="form-label fw-semibold small text-uppercase mb-1">Motivo da recusa</label>
                            <input type="text" name="reason" maxlength="250" class="form-control mb-2" placeholder="Ex.: Nao consigo atender nesse horario." required />
                            <button type="submit" class="btn btn-outline-danger rounded-pill w-100">
                                <i class="fas fa-times me-2"></i>Recusar visita
                            </button>
                        </form>
                    }

                    @if (canMarkArrival)
                    {
                        <hr />
                        <div class="alert alert-info border mb-3">
                            Ao chegar ao local, registre o check-in. O sistema tentara obter sua localizacao GPS.
                        </div>
                        <form asp-action="MarkArrival" method="post" class="js-arrival-form d-grid">
                            <input type="hidden" name="appointmentId" value="@appointment.Id" />
                            <input type="hidden" name="requestId" value="@Model.Id" />
                            <input type="hidden" name="returnToAgenda" value="false" />
                            <input type="hidden" name="latitude" value="" />
                            <input type="hidden" name="longitude" value="" />
                            <input type="hidden" name="accuracyMeters" value="" />
                            <input type="hidden" name="manualReason" value="" />
                            <button type="submit" class="btn btn-primary rounded-pill">
                                <i class="fas fa-map-marker-alt me-2"></i>Registrar chegada
                            </button>
                        </form>
                    }

                    @if (canStartExecution)
                    {
                        <hr />
                        <div class="small text-muted mb-2">Opcional: informe uma observacao para inicio do atendimento</div>
                        <form asp-action="StartAppointment" method="post">
                            <input type="hidden" name="appointmentId" value="@appointment.Id" />
                            <input type="hidden" name="requestId" value="@Model.Id" />
                            <input type="hidden" name="returnToAgenda" value="false" />
                            <input type="text" name="reason" maxlength="250" class="form-control mb-2" placeholder="Ex.: Cliente no local e acesso liberado." />
                            <button type="submit" class="btn btn-success rounded-pill w-100">
                                <i class="fas fa-play me-2"></i>Iniciar atendimento
                            </button>
                        </form>
                    }

                    @if (completionTerm != null)
                    {
                        var completionBadgeClass = completionTerm.Status switch
                        {
                            "PendingClientAcceptance" => "bg-info-subtle text-info border border-info-subtle",
                            "AcceptedByClient" => "bg-success-subtle text-success border border-success-subtle",
                            "ContestedByClient" => "bg-danger-subtle text-danger border border-danger-subtle",
                            "Expired" => "bg-secondary-subtle text-secondary border border-secondary-subtle",
                            "EscalatedToAdmin" => "bg-warning-subtle text-warning border border-warning-subtle",
                            _ => "bg-light text-muted border border-light-subtle"
                        };
                        var completionBadgeLabel = completionTerm.Status switch
                        {
                            "PendingClientAcceptance" => "Aguardando aceite do cliente",
                            "AcceptedByClient" => "Aceite registrado",
                            "ContestedByClient" => "Contestacao registrada",
                            "Expired" => "PIN expirado",
                            "EscalatedToAdmin" => "Em analise admin",
                            _ => completionTerm.Status
                        };
                        var acceptanceMethodLabel = completionTerm.AcceptedWithMethod switch
                        {
                            "Pin" => "PIN one-time",
                            "SignatureName" => "Assinatura por nome",
                            _ => "-"
                        };

                        <hr />
                        <div class="card border border-success-subtle bg-success-subtle bg-opacity-10 mb-3">
                            <div class="card-body p-3">
                                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                                    <div class="fw-semibold"><i class="fas fa-file-signature text-success me-2"></i>Comprovante de conclusao</div>
                                    <span class="badge @completionBadgeClass rounded-pill px-3 py-2">@completionBadgeLabel</span>
                                </div>
                                @if (!string.IsNullOrWhiteSpace(completionTerm.Summary))
                                {
                                    <div class="small text-muted mb-2">@completionTerm.Summary</div>
                                }
                                <div class="row g-2 small">
                                    <div class="col-md-6"><span class="text-muted">Metodo:</span> @acceptanceMethodLabel</div>
                                    <div class="col-md-6"><span class="text-muted">Aceite:</span> @(completionTerm.AcceptedAtUtc?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "-")</div>
                                </div>
                                @if (!string.IsNullOrWhiteSpace(completionTerm.AcceptedSignatureName))
                                {
                                    <div class="small mt-2"><span class="text-muted">Assinado por:</span> @completionTerm.AcceptedSignatureName</div>
                                }
                                @if (!string.IsNullOrWhiteSpace(completionTerm.ContestReason))
                                {
                                    <div class="small mt-2 text-danger"><span class="text-muted">Motivo da contestacao:</span> @completionTerm.ContestReason</div>
                                }
                            </div>
                        </div>
                    }

                    @if (checklist != null && checklist.IsRequiredChecklist)
                    {
                        <hr />
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="fw-semibold">
                                <i class="fas fa-clipboard-check text-primary me-2"></i>
                                Checklist Tecnico - @checklist.TemplateName
                            </div>
                            <span class="badge @(checklist.RequiredCompletedCount == checklist.RequiredItemsCount ? "bg-success-subtle text-success-emphasis" : "bg-warning-subtle text-warning-emphasis")">
                                Obrigatorios: @checklist.RequiredCompletedCount/@checklist.RequiredItemsCount
                            </span>
                        </div>
                        <div class="text-muted small mb-3">Itens obrigatorios precisam estar concluidos para finalizar o atendimento.</div>

                        <div class="d-grid gap-3">
                            @foreach (var item in checklist.Items.OrderBy(i => i.SortOrder))
                            {
                                <form asp-action="UpdateChecklistItem" method="post" enctype="multipart/form-data" class="border rounded-3 p-3 bg-light-subtle">
                                    <input type="hidden" name="appointmentId" value="@appointment.Id" />
                                    <input type="hidden" name="requestId" value="@Model.Id" />
                                    <input type="hidden" name="templateItemId" value="@item.TemplateItemId" />
                                    <input type="hidden" name="returnToAgenda" value="false" />

                                    <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-2">
                                        <div>
                                            <div class="fw-semibold">@item.Title</div>
                                            @if (!string.IsNullOrWhiteSpace(item.HelpText))
                                            {
                                                <div class="small text-muted">@item.HelpText</div>
                                            }
                                        </div>
                                        <div class="d-flex gap-2">
                                            @if (item.IsRequired)
                                            {
                                                <span class="badge bg-danger-subtle text-danger-emphasis">Obrigatorio</span>
                                            }
                                            @if (item.RequiresEvidence)
                                            {
                                                <span class="badge bg-info-subtle text-info-emphasis">Exige evidencia</span>
                                            }
                                        </div>
                                    </div>

                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                @if (item.IsChecked)
                                                {
                                                    <input class="form-check-input" type="checkbox" value="true" name="isChecked" id="chk_@item.TemplateItemId" checked />
                                                }
                                                else
                                                {
                                                    <input class="form-check-input" type="checkbox" value="true" name="isChecked" id="chk_@item.TemplateItemId" />
                                                }
                                                <label class="form-check-label fw-semibold" for="chk_@item.TemplateItemId">Concluido</label>
                                            </div>
                                        </div>

                                        <div class="col-md-5">
                                            @if (item.AllowNote)
                                            {
                                                <label class="form-label small mb-1">Observacao</label>
                                                <input type="text" name="note" class="form-control form-control-sm" maxlength="1000" value="@item.Note" />
                                            }
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label small mb-1">Evidencia (foto/video)</label>
                                            <input type="file" name="evidenceFile" class="form-control form-control-sm" accept="image/*,video/*" />
                                        </div>
                                    </div>

                                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mt-3">
                                        <div class="small text-muted">
                                            @if (item.CheckedAtUtc.HasValue)
                                            {
                                                <span>Atualizado em @item.CheckedAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                                            }
                                            else
                                            {
                                                <span>Ainda nao concluido.</span>
                                            }
                                        </div>
                                        <div class="d-flex align-items-center gap-3">
                                            @if (!string.IsNullOrWhiteSpace(item.EvidenceUrl))
                                            {
                                                <a href="@item.EvidenceUrl" target="_blank" rel="noopener" class="btn btn-outline-secondary btn-sm rounded-pill">
                                                    <i class="fas fa-paperclip me-1"></i>Evidencia atual
                                                </a>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="true" name="clearEvidence" id="clear_@item.TemplateItemId" />
                                                    <label class="form-check-label small" for="clear_@item.TemplateItemId">Remover evidencia</label>
                                                </div>
                                            }
                                            <button type="submit" class="btn btn-outline-primary btn-sm rounded-pill">
                                                <i class="fas fa-save me-1"></i>Salvar item
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            }
                        </div>
                    }
                </div>
            }

            @if (scopeChanges.Any())
            {
                <div class="card border-0 shadow-sm p-4 mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0"><i class="fas fa-arrows-rotate text-primary me-2"></i>Historico de aditivos</h5>
                        <span class="text-muted small">Linha do tempo</span>
                    </div>
                    <div class="d-grid gap-3">
                        @foreach (var scopeChange in scopeChanges
                            .OrderByDescending(item => item.RequestedAtUtc)
                            .ThenByDescending(item => item.Version))
                        {
                            var statusClass = scopeChange.Status switch
                            {
                                "PendingClientApproval" => "bg-warning-subtle text-warning border border-warning-subtle",
                                "ApprovedByClient" => "bg-success-subtle text-success border border-success-subtle",
                                "RejectedByClient" => "bg-danger-subtle text-danger border border-danger-subtle",
                                "Expired" => "bg-secondary-subtle text-secondary border border-secondary-subtle",
                                _ => "bg-light text-muted border border-light-subtle"
                            };
                            var statusLabel = scopeChange.Status switch
                            {
                                "PendingClientApproval" => "Aguardando cliente",
                                "ApprovedByClient" => "Aprovado pelo cliente",
                                "RejectedByClient" => "Rejeitado pelo cliente",
                                "Expired" => "Expirado por timeout",
                                _ => scopeChange.Status
                            };
                            var values = scopeChangeValueById.TryGetValue(scopeChange.Id, out var comparison)
                                ? comparison
                                : (PreviousValue: 0m, NewValue: Math.Max(0m, scopeChange.IncrementalValue));

                            <div class="border rounded-3 p-3 bg-light-subtle">
                                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge @statusClass rounded-pill px-3">@statusLabel</span>
                                        <span class="badge bg-light text-muted border border-light-subtle">v@scopeChange.Version</span>
                                    </div>
                                    <small class="text-muted">@scopeChange.RequestedAtUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</small>
                                </div>
                                <div class="small text-muted mb-1">Motivo</div>
                                <div class="mb-2">@scopeChange.Reason</div>
                                <div class="small text-muted mb-1">Escopo adicional</div>
                                <div class="mb-2">@scopeChange.AdditionalScopeDescription</div>
                                <div class="rounded border border-primary-subtle bg-primary-subtle p-2 mb-2">
                                    <div class="row g-2 align-items-center">
                                        <div class="col-5">
                                            <div class="small text-muted text-uppercase">Valor anterior</div>
                                            <div class="fw-semibold">@values.PreviousValue.ToString("C2", ptBr)</div>
                                        </div>
                                        <div class="col-2 text-center text-primary">
                                            <i class="fas fa-arrow-right"></i>
                                        </div>
                                        <div class="col-5 text-end">
                                            <div class="small text-muted text-uppercase">Novo valor</div>
                                            <div class="fw-bold text-primary">@values.NewValue.ToString("C2", ptBr)</div>
                                        </div>
                                    </div>
                                    <div class="small text-success mt-1">
                                        <i class="fas fa-plus-circle me-1"></i>Incremento: @scopeChange.IncrementalValue.ToString("C2", ptBr)
                                    </div>
                                </div>
                                @if (scopeChange.ClientRespondedAtUtc.HasValue)
                                {
                                    <div class="small text-muted mb-2">
                                        Resposta do cliente em @scopeChange.ClientRespondedAtUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                        @if (!string.IsNullOrWhiteSpace(scopeChange.ClientResponseReason))
                                        {
                                            <span> · Motivo: @scopeChange.ClientResponseReason</span>
                                        }
                                    </div>
                                }
                                @if (scopeChange.Attachments.Any())
                                {
                                    <div class="d-flex flex-wrap gap-2">
                                        @foreach (var attachment in scopeChange.Attachments.OrderBy(a => a.CreatedAt))
                                        {
                                            var iconClass = attachment.MediaKind?.ToLowerInvariant() switch
                                            {
                                                "video" => "fa-video",
                                                "image" => "fa-image",
                                                _ => "fa-paperclip"
                                            };
                                            <a href="@attachment.FileUrl"
                                               target="_blank"
                                               rel="noopener noreferrer"
                                               class="btn btn-outline-secondary btn-sm rounded-pill">
                                                <i class="fas @iconClass me-1"></i>@attachment.FileName
                                            </a>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="small text-muted">Sem anexos de evidencia.</div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }

            <div class="card border-0 shadow-sm p-4 mt-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0">
                        <i class="fas fa-receipt text-success me-2"></i>Comprovantes de Pagamento
                    </h6>
                    <span class="text-muted small">HTML/PDF</span>
                </div>
                <div id="provider-payment-receipts-section" class="small text-muted">
                    Carregando comprovantes...
                </div>
            </div>
        </div>
    </div>

    @if (canManageServiceMedia)
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0">Fotos e videos deste servico</h5>
                        <a asp-controller="Gallery" asp-action="Index" asp-route-serviceRequestId="@Model.Id" class="btn btn-outline-primary btn-sm rounded-pill">
                            Abrir galeria do pedido
                        </a>
                    </div>
                    <div class="card-body">
                        <form asp-controller="Gallery" asp-action="Upload" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="serviceRequestId" value="@Model.Id" />
                            <input type="hidden" name="category" value="@Model.Category" />
                            <div class="row g-3 align-items-end">
                                <div class="col-md-7">
                                    <label class="form-label fw-semibold">Selecione fotos/videos</label>
                                    <input type="file" name="files" class="form-control" accept="image/*,video/*" multiple required />
                                    <small class="text-muted">Os arquivos enviados irao para um album automatico deste pedido na galeria.</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">Legenda (opcional)</label>
                                    <input type="text" class="form-control" name="caption" maxlength="500" placeholder="Ex.: Antes e depois" />
                                </div>
                                <div class="col-md-2 d-grid">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-cloud-upload-alt me-2"></i>Enviar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
@if (existingProposal != null)
{
<script>
    (function () {
        const button = document.getElementById("openChatBtn");
        const statusTitle = document.getElementById("proposal-status-title");
        const statusSubtitle = document.getElementById("proposal-status-subtitle");
        const statusBadge = document.getElementById("proposal-status-badge");
        const currentRequestId = "@Model.Id".toLowerCase();

        if (button) {
            button.addEventListener("click", function () {
                window.dispatchEvent(new CustomEvent("cpm:open-chat", {
                    detail: {
                        requestId: "@Model.Id",
                        providerId: "@currentUserId",
                        title: "Chat com Cliente"
                    }
                }));
            });
        }

        window.addEventListener("cpm:notification", function (event) {
            const subject = String(event?.detail?.subject || "");
            const actionUrl = String(event?.detail?.actionUrl || "").toLowerCase();
            const actionPath = actionUrl.split("?")[0];
            const expectedPath = `/servicerequests/details/${currentRequestId}`;
            const normalizedSubject = subject.toLowerCase();
            if (!actionPath.endsWith(expectedPath)) return;

            if (normalizedSubject.includes("agendamento") ||
                normalizedSubject.includes("operacional") ||
                normalizedSubject.includes("aditivo")) {
                window.location.reload();
                return;
            }

            if (subject !== "Sua Proposta foi Aceita!") return;

            if (statusTitle) statusTitle.textContent = "Proposta aceita pelo Cliente!";
            if (statusSubtitle) statusSubtitle.textContent = "Entre em contato para acertar os detalhes.";
            if (statusBadge) {
                statusBadge.className = "badge bg-success w-100 py-2 mb-3";
                statusBadge.textContent = "PROPOSTA ACEITA";
            }
        });
    })();
</script>
}
else
{
<script>
    (function () {
        const display = document.getElementById("estimatedValueDisplay");
        const hidden = document.getElementById("estimatedValue");
        if (!display || !hidden) return;

        const formatter = new Intl.NumberFormat("pt-BR", {
            style: "currency",
            currency: "BRL",
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        function onlyDigits(value) {
            return String(value || "").replace(/\D/g, "");
        }

        function applyMask(raw) {
            const digits = onlyDigits(raw);
            if (!digits) {
                display.value = "";
                hidden.value = "";
                return;
            }

            const amount = Number(digits) / 100;
            display.value = formatter.format(amount);
            hidden.value = amount.toFixed(2);
        }

        display.addEventListener("input", function () {
            applyMask(display.value);
        });

        display.addEventListener("blur", function () {
            if (!onlyDigits(display.value)) {
                display.value = "";
                hidden.value = "";
            }
        });

        const form = display.closest("form");
        if (form) {
            form.addEventListener("submit", function () {
                if (!onlyDigits(display.value)) {
                    hidden.value = "";
                }
            });
        }
    })();
</script>
}
<script>
    (function () {
        function bindArrivalForm(form) {
            if (!form) return;

            form.addEventListener("submit", function (event) {
                if (form.dataset.geoResolved === "1") {
                    return;
                }

                event.preventDefault();

                const latitudeInput = form.querySelector('input[name="latitude"]');
                const longitudeInput = form.querySelector('input[name="longitude"]');
                const accuracyInput = form.querySelector('input[name="accuracyMeters"]');
                const manualReasonInput = form.querySelector('input[name="manualReason"]');

                const submitManualFallback = function () {
                    const reason = window.prompt("Nao foi possivel obter o GPS. Informe o motivo do check-in manual:");
                    if (!reason || !reason.trim()) {
                        alert("O motivo do check-in manual e obrigatorio.");
                        return;
                    }

                    if (latitudeInput) latitudeInput.value = "";
                    if (longitudeInput) longitudeInput.value = "";
                    if (accuracyInput) accuracyInput.value = "";
                    if (manualReasonInput) manualReasonInput.value = reason.trim();
                    form.dataset.geoResolved = "1";
                    form.submit();
                };

                if (!navigator.geolocation) {
                    submitManualFallback();
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        if (latitudeInput) latitudeInput.value = String(position.coords.latitude);
                        if (longitudeInput) longitudeInput.value = String(position.coords.longitude);
                        if (accuracyInput) accuracyInput.value = String(position.coords.accuracy || "");
                        if (manualReasonInput) manualReasonInput.value = "";
                        form.dataset.geoResolved = "1";
                        form.submit();
                    },
                    function () {
                        submitManualFallback();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 8000,
                        maximumAge: 60000
                    });
            });
        }

        document.querySelectorAll(".js-arrival-form").forEach(bindArrivalForm);
    })();
</script>
<script>
    (function () {
        const receiptsContainer = document.getElementById("provider-payment-receipts-section");
        if (!receiptsContainer) return;

        const requestId = "@Model.Id";
        const receiptsDataUrl = "@Url.Action("PaymentReceiptsData", "ServiceRequests", new { id = Model.Id })";
        const receiptBaseUrl = "@Url.Action("PaymentReceipt", "ServiceRequests")";

        function escapeHtml(value) {
            return String(value || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        function statusMeta(status) {
            switch (status) {
                case "Paid":
                    return { label: "Pago", badge: "bg-success-subtle text-success border border-success-subtle" };
                case "Pending":
                    return { label: "Pendente", badge: "bg-warning-subtle text-warning border border-warning-subtle" };
                case "Failed":
                    return { label: "Falhou", badge: "bg-danger-subtle text-danger border border-danger-subtle" };
                case "Refunded":
                    return { label: "Estornado", badge: "bg-secondary-subtle text-secondary border border-secondary-subtle" };
                default:
                    return { label: status || "-", badge: "bg-light text-muted border border-light-subtle" };
            }
        }

        function methodLabel(method) {
            if (method === "Pix") return "PIX";
            if (method === "Card") return "Cartao";
            return method || "-";
        }

        function formatCurrency(value) {
            const numeric = Number(value || 0);
            return numeric.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        }

        function formatDateTime(value) {
            if (!value) return "Aguardando processamento";
            return new Date(value).toLocaleString("pt-BR", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit"
            });
        }

        function render(receipts) {
            if (!Array.isArray(receipts) || receipts.length === 0) {
                receiptsContainer.innerHTML = `<div class="text-muted">Nenhum comprovante disponivel ainda.</div>`;
                return;
            }

            receiptsContainer.innerHTML = receipts.map(receipt => {
                const status = statusMeta(receipt.status);
                const processedAt = formatDateTime(receipt.processedAtUtc);
                const url = `${receiptBaseUrl}?requestId=${encodeURIComponent(requestId)}&transactionId=${encodeURIComponent(receipt.transactionId)}`;

                return `
                    <div class="border rounded-3 p-3 mb-2">
                        <div class="d-flex justify-content-between align-items-start gap-2 mb-2">
                            <div>
                                <div class="fw-semibold">${escapeHtml(receipt.receiptNumber || "CPM")}</div>
                                <div class="text-muted small">${escapeHtml(methodLabel(receipt.method))} · ${escapeHtml(formatCurrency(receipt.amount))}</div>
                            </div>
                            <span class="badge ${status.badge}">${escapeHtml(status.label)}</span>
                        </div>
                        <div class="text-muted small mb-2">Processado: ${escapeHtml(processedAt)}</div>
                        <a href="${url}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary btn-sm rounded-pill">
                            <i class="fas fa-file-invoice me-1"></i>Ver comprovante
                        </a>
                    </div>
                `;
            }).join("");
        }

        fetch(receiptsDataUrl, {
            credentials: "same-origin",
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
            .then(response => response.ok ? response.json() : Promise.reject())
            .then(data => render(data.receipts))
            .catch(() => {
                receiptsContainer.innerHTML = `<div class="text-danger">Nao foi possivel carregar os comprovantes.</div>`;
            });
    })();
</script>
}
