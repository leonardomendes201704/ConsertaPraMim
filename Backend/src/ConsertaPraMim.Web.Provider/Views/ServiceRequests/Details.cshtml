@inject IConfiguration Configuration
@model ConsertaPraMim.Application.DTOs.ServiceRequestDto
@{
    ViewData["Title"] = "Detalhes do Pedido";
    var existingProposal = ViewBag.ExistingProposal as ConsertaPraMim.Application.DTOs.ProposalDto;
    var appointment = ViewBag.Appointment as ConsertaPraMim.Application.DTOs.ServiceAppointmentDto;
    var canManageServiceMedia = existingProposal?.Accepted == true &&
                                (string.Equals(Model.Status, "Completed", StringComparison.OrdinalIgnoreCase) ||
                                 string.Equals(Model.Status, "Validated", StringComparison.OrdinalIgnoreCase));
    var apiBaseUrl = (Configuration["ApiBaseUrl"] ?? string.Empty).TrimEnd('/');
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
    var appointmentStatusClass = appointment?.Status switch
    {
        "PendingProviderConfirmation" => "bg-warning-subtle text-warning border border-warning-subtle",
        "Confirmed" => "bg-success-subtle text-success border border-success-subtle",
        "RejectedByProvider" => "bg-danger-subtle text-danger border border-danger-subtle",
        "ExpiredWithoutProviderAction" => "bg-secondary-subtle text-secondary border border-secondary-subtle",
        "RescheduleRequestedByClient" => "bg-info-subtle text-info border border-info-subtle",
        "RescheduleRequestedByProvider" => "bg-info-subtle text-info border border-info-subtle",
        "RescheduleConfirmed" => "bg-success-subtle text-success border border-success-subtle",
        "CancelledByClient" => "bg-secondary-subtle text-secondary border border-secondary-subtle",
        "CancelledByProvider" => "bg-secondary-subtle text-secondary border border-secondary-subtle",
        "Completed" => "bg-primary-subtle text-primary border border-primary-subtle",
        _ => "bg-light text-muted border border-light-subtle"
    };
    var appointmentStatusLabel = appointment?.Status switch
    {
        "PendingProviderConfirmation" => "Aguardando confirmacao",
        "Confirmed" => "Confirmado",
        "RejectedByProvider" => "Recusado",
        "ExpiredWithoutProviderAction" => "Expirado",
        "RescheduleRequestedByClient" => "Cliente pediu reagendamento",
        "RescheduleRequestedByProvider" => "Reagendamento solicitado",
        "RescheduleConfirmed" => "Reagendamento confirmado",
        "CancelledByClient" => "Cancelado pelo cliente",
        "CancelledByProvider" => "Cancelado por voce",
        "Completed" => "Concluido",
        _ => appointment?.Status ?? "-"
    };
}

<div class="container py-4">
    <div class="mb-4">
        <a asp-action="Index" class="btn btn-link text-decoration-none p-0">
            <i class="fas fa-arrow-left me-2"></i>Voltar para a lista
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success border-0 shadow-sm mb-4">
            <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger border-0 shadow-sm mb-4">
            <i class="fas fa-triangle-exclamation me-2"></i>@TempData["Error"]
        </div>
    }

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm p-4 h-100">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <span class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill mb-2">
                            @Model.Category
                        </span>
                        <h2 class="fw-bold mb-0">@Model.Description</h2>
                        <p class="text-muted small">Publicado em @Model.CreatedAt.ToString("f")</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-@(Model.Status == "Created" ? "success" : "secondary") p-2 shadow-sm">
                            @Model.Status
                        </span>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <div class="mb-4">
                        <img src="@Model.ImageUrl" class="img-fluid rounded-3 shadow-sm border" alt="Foto do servico" style="max-height: 400px; width: 100%; object-fit: cover;">
                    </div>
                }

                <div class="mb-4">
                    <h6 class="fw-bold text-uppercase small text-muted">Local da Execucao</h6>
                    <p class="mb-0 fs-5"><i class="fas fa-map-marker-alt text-danger me-2"></i> @Model.Street</p>
                    <p class="text-muted">@Model.City, @Model.Zip</p>
                </div>

                <div class="mt-auto">
                    <div class="p-3 bg-light rounded-3 border border-light-subtle">
                        <div class="d-flex">
                            <i class="fas fa-info-circle text-primary me-3 mt-1"></i>
                            <div>
                                <h6 class="fw-bold mb-1">Informacoes Adicionais</h6>
                                <p class="small text-muted mb-0">O cliente esta aguardando propostas baseadas na sua estimativa de valor e tempo de resposta.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            @if (existingProposal != null)
            {
                <div class="card border-0 shadow-sm p-4 bg-light h-100">
                    <div class="text-center py-4">
                        <div class="bg-success text-white d-inline-block rounded-circle p-3 mb-3">
                            <i class="fas fa-paper-plane fa-2x"></i>
                        </div>
                        <h4 id="proposal-status-title" class="fw-bold">@(existingProposal.Accepted ? "Proposta aceita pelo Cliente!" : "Proposta Enviada!")</h4>
                        <p id="proposal-status-subtitle" class="text-muted">@(existingProposal.Accepted ? "Entre em contato para acertar os detalhes." : "Voce ja enviou uma proposta para este pedido.")</p>
                    </div>
                    <hr class="my-4">
                    <div class="mb-3">
                        <label class="text-muted small text-uppercase">Valor Estimado</label>
                        <p class="fw-bold fs-4">R$ @(existingProposal.EstimatedValue?.ToString("N2") ?? "A combinar")</p>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small text-uppercase">Sua Mensagem</label>
                        <p class="text-dark">@(string.IsNullOrEmpty(existingProposal.Message) ? "Sem mensagem adicional." : existingProposal.Message)</p>
                    </div>
                    <div class="mt-auto">
                        <span id="proposal-status-badge" class="badge @(existingProposal.Accepted ? "bg-success" : "bg-warning") w-100 py-2 mb-3">
                            @(existingProposal.Accepted ? "PROPOSTA ACEITA" : "AGUARDANDO CLIENTE")
                        </span>

                        <button type="button" id="openChatBtn" class="btn btn-outline-primary w-100">
                            Conversar com o Cliente
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="card border-0 shadow-sm p-4 h-100">
                    <h4 class="fw-bold mb-4">Enviar Proposta</h4>
                    <form asp-controller="Proposals" asp-action="Submit" method="post">
                        <input type="hidden" name="requestId" value="@Model.Id" />

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Valor Estimado (opcional)</label>
                            <input type="text" id="estimatedValueDisplay" inputmode="numeric" class="form-control bg-light border-0 mb-2" placeholder="R$ 0,00" autocomplete="off">
                            <input type="hidden" id="estimatedValue" name="estimatedValue">
                            <small class="text-muted">Deixe em branco se preferir combinar apos a conversa.</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold">Mensagem ao Cliente</label>
                            <textarea name="message" rows="4" class="form-control bg-light border-0" placeholder="Oi! Posso te ajudar com isso. Tenho experiencia em..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow-sm">
                            <i class="fas fa-paper-plane me-2"></i>Enviar Minha Proposta
                        </button>
                    </form>
                </div>
            }

            @if (appointment != null)
            {
                var canConfirmOrReject = string.Equals(appointment.Status, "PendingProviderConfirmation", StringComparison.OrdinalIgnoreCase);
                <div class="card border-0 shadow-sm p-4 mt-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="fw-bold mb-0"><i class="fas fa-calendar-check text-primary me-2"></i>Agendamento</h5>
                        <span class="badge @appointmentStatusClass rounded-pill px-3 py-2">@appointmentStatusLabel</span>
                    </div>

                    <div class="small text-muted mb-1">Janela solicitada</div>
                    <div class="fw-semibold mb-3">
                        @appointment.WindowStartUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                        -
                        @appointment.WindowEndUtc.ToLocalTime().ToString("HH:mm")
                    </div>

                    @if (!string.IsNullOrWhiteSpace(appointment.Reason))
                    {
                        <div class="small text-muted mb-1">Observacao do cliente</div>
                        <div class="mb-3">@appointment.Reason</div>
                    }

                    @if (canConfirmOrReject)
                    {
                        <div class="alert alert-warning border mb-3">
                            O cliente solicitou essa visita e esta aguardando sua confirmacao.
                        </div>

                        <form asp-action="ConfirmAppointment" method="post" class="d-grid mb-2">
                            <input type="hidden" name="appointmentId" value="@appointment.Id" />
                            <input type="hidden" name="requestId" value="@Model.Id" />
                            <button type="submit" class="btn btn-success rounded-pill">
                                <i class="fas fa-check me-2"></i>Confirmar visita
                            </button>
                        </form>

                        <form asp-action="RejectAppointment" method="post">
                            <input type="hidden" name="appointmentId" value="@appointment.Id" />
                            <input type="hidden" name="requestId" value="@Model.Id" />
                            <label class="form-label fw-semibold small text-uppercase mb-1">Motivo da recusa</label>
                            <input type="text" name="reason" maxlength="250" class="form-control mb-2" placeholder="Ex.: Nao consigo atender nesse horario." required />
                            <button type="submit" class="btn btn-outline-danger rounded-pill w-100">
                                <i class="fas fa-times me-2"></i>Recusar visita
                            </button>
                        </form>
                    }
                </div>
            }
        </div>
    </div>

    @if (canManageServiceMedia)
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0">Fotos e videos deste servico</h5>
                        <a asp-controller="Gallery" asp-action="Index" asp-route-serviceRequestId="@Model.Id" class="btn btn-outline-primary btn-sm rounded-pill">
                            Abrir galeria do pedido
                        </a>
                    </div>
                    <div class="card-body">
                        <form asp-controller="Gallery" asp-action="Upload" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="serviceRequestId" value="@Model.Id" />
                            <input type="hidden" name="category" value="@Model.Category" />
                            <div class="row g-3 align-items-end">
                                <div class="col-md-7">
                                    <label class="form-label fw-semibold">Selecione fotos/videos</label>
                                    <input type="file" name="files" class="form-control" accept="image/*,video/*" multiple required />
                                    <small class="text-muted">Os arquivos enviados irao para um album automatico deste pedido na galeria.</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">Legenda (opcional)</label>
                                    <input type="text" class="form-control" name="caption" maxlength="500" placeholder="Ex.: Antes e depois" />
                                </div>
                                <div class="col-md-2 d-grid">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-cloud-upload-alt me-2"></i>Enviar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
@if (existingProposal != null)
{
<script>
    (function () {
        const button = document.getElementById("openChatBtn");
        const statusTitle = document.getElementById("proposal-status-title");
        const statusSubtitle = document.getElementById("proposal-status-subtitle");
        const statusBadge = document.getElementById("proposal-status-badge");
        const currentRequestId = "@Model.Id".toLowerCase();

        if (button) {
            button.addEventListener("click", function () {
                window.dispatchEvent(new CustomEvent("cpm:open-chat", {
                    detail: {
                        requestId: "@Model.Id",
                        providerId: "@currentUserId",
                        title: "Chat com Cliente"
                    }
                }));
            });
        }

        window.addEventListener("cpm:notification", function (event) {
            const subject = String(event?.detail?.subject || "");
            const actionUrl = String(event?.detail?.actionUrl || "").toLowerCase();
            const expectedPath = `/servicerequests/details/${currentRequestId}`;
            if (subject !== "Sua Proposta foi Aceita!") return;
            if (!actionUrl.endsWith(expectedPath)) return;

            if (statusTitle) statusTitle.textContent = "Proposta aceita pelo Cliente!";
            if (statusSubtitle) statusSubtitle.textContent = "Entre em contato para acertar os detalhes.";
            if (statusBadge) {
                statusBadge.className = "badge bg-success w-100 py-2 mb-3";
                statusBadge.textContent = "PROPOSTA ACEITA";
            }
        });
    })();
</script>
}
else
{
<script>
    (function () {
        const display = document.getElementById("estimatedValueDisplay");
        const hidden = document.getElementById("estimatedValue");
        if (!display || !hidden) return;

        const formatter = new Intl.NumberFormat("pt-BR", {
            style: "currency",
            currency: "BRL",
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        function onlyDigits(value) {
            return String(value || "").replace(/\D/g, "");
        }

        function applyMask(raw) {
            const digits = onlyDigits(raw);
            if (!digits) {
                display.value = "";
                hidden.value = "";
                return;
            }

            const amount = Number(digits) / 100;
            display.value = formatter.format(amount);
            hidden.value = amount.toFixed(2);
        }

        display.addEventListener("input", function () {
            applyMask(display.value);
        });

        display.addEventListener("blur", function () {
            if (!onlyDigits(display.value)) {
                display.value = "";
                hidden.value = "";
            }
        });

        const form = display.closest("form");
        if (form) {
            form.addEventListener("submit", function () {
                if (!onlyDigits(display.value)) {
                    hidden.value = "";
                }
            });
        }
    })();
</script>
}
}
