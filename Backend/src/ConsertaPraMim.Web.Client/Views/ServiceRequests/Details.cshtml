@inject IConfiguration Configuration
@model ConsertaPraMim.Application.DTOs.ServiceRequestDto
@{
    ViewData["Title"] = "Detalhes do Pedido";
    var proposals = ViewBag.Proposals as IEnumerable<ConsertaPraMim.Application.DTOs.ProposalDto>;
    var providerReputations = ViewBag.ProviderReputations as IReadOnlyDictionary<Guid, ConsertaPraMim.Application.DTOs.ReviewScoreSummaryDto>
        ?? new Dictionary<Guid, ConsertaPraMim.Application.DTOs.ReviewScoreSummaryDto>();
    var acceptedProviders = ViewBag.AcceptedProviders as IEnumerable<ConsertaPraMim.Web.Client.Controllers.ServiceRequestsController.AcceptedProviderOptionDto>
        ?? Enumerable.Empty<ConsertaPraMim.Web.Client.Controllers.ServiceRequestsController.AcceptedProviderOptionDto>();
    var appointments = ViewBag.Appointments as IEnumerable<object> ?? Enumerable.Empty<object>();
    var evidences = ViewBag.Evidences as IEnumerable<object> ?? Enumerable.Empty<object>();
    var scopeChanges = ViewBag.ScopeChanges as IEnumerable<object> ?? Enumerable.Empty<object>();
    var warrantyClaims = ViewBag.WarrantyClaims as IEnumerable<object> ?? Enumerable.Empty<object>();
    var disputes = ViewBag.Disputes as IEnumerable<object> ?? Enumerable.Empty<object>();
    var appointmentPayload = ViewBag.AppointmentPayload;
    var apiBaseUrl = (Configuration["ApiBaseUrl"] ?? string.Empty).TrimEnd('/');
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
    var statusBadgeClass = Model.Status switch
    {
        "Created" => "bg-info",
        "Matching" => "bg-primary",
        "Scheduled" => "bg-warning",
        "PendingClientCompletionAcceptance" => "bg-info",
        "Completed" => "bg-success",
        _ => "bg-secondary"
    };
    var statusBadgeLabel = Model.Status switch
    {
        "PendingClientCompletionAcceptance" => "Aguardando aceite de conclusao",
        _ => Model.Status
    };

    var acceptedProvidersJson = System.Text.Json.JsonSerializer.Serialize(
        acceptedProviders.Select(p => new
        {
            providerId = p.ProviderId,
            providerName = p.ProviderName
        }));
    var providerReputationsJson = System.Text.Json.JsonSerializer.Serialize(
        providerReputations.ToDictionary(
            entry => entry.Key,
            entry => new
            {
                averageRating = entry.Value.AverageRating,
                totalReviews = entry.Value.TotalReviews
            }));

    var initialAppointmentJson = appointmentPayload == null
        ? "null"
        : System.Text.Json.JsonSerializer.Serialize(appointmentPayload);

    var initialAppointmentsJson = System.Text.Json.JsonSerializer.Serialize(appointments);
    var initialEvidencesJson = System.Text.Json.JsonSerializer.Serialize(evidences);
    var initialScopeChangesJson = System.Text.Json.JsonSerializer.Serialize(scopeChanges);
    var initialWarrantyClaimsJson = System.Text.Json.JsonSerializer.Serialize(warrantyClaims);
    var initialDisputesJson = System.Text.Json.JsonSerializer.Serialize(disputes);
    var canStartPayment = string.Equals(Model.Status, "Completed", StringComparison.OrdinalIgnoreCase);
}

<div class="container py-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <span class="badge bg-primary-subtle text-primary rounded-pill px-3 mb-2">@Model.Category</span>
                            <h2 class="fw-bold mb-0">@Model.Description</h2>
                        </div>
                        <div class="text-end">
                            <span class="text-muted d-block small">Status do Pedido</span>
                            <span id="request-status-badge" class="badge @statusBadgeClass rounded-pill px-3 py-2 fs-6">@statusBadgeLabel</span>
                            <span class="text-muted d-block small mt-2">Pagamento</span>
                            <span id="payment-status-summary-badge" class="badge bg-light text-muted border border-light-subtle rounded-pill px-3 py-2">Sem pagamento</span>
                        </div>
                    </div>

                    <div class="row g-4 pt-3 border-top">
                        <div class="col-md-6">
                            <h6 class="text-uppercase text-muted fw-bold mb-2" style="font-size: 0.7rem; letter-spacing: 1px;">Localizacao</h6>
                            <p class="mb-0 fw-semibold"><i class="fas fa-map-marker-alt text-danger me-2"></i> @Model.Street, @Model.City</p>
                            <small class="text-muted">CEP: @Model.Zip</small>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-uppercase text-muted fw-bold mb-2" style="font-size: 0.7rem; letter-spacing: 1px;">Data da Solicitacao</h6>
                            <p class="mb-0 fw-semibold"><i class="far fa-calendar-alt text-primary me-2"></i> @Model.CreatedAt.ToLongDateString()</p>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.ImageUrl))
                    {
                        <div class="mt-4">
                            <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.7rem; letter-spacing: 1px;">Foto do Problema</h6>
                            <img src="@Model.ImageUrl" class="img-fluid rounded-4 shadow-sm" style="max-height: 300px;" alt="Foto do pedido">
                        </div>
                    }
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="fw-bold mb-0"><i class="fas fa-calendar-check text-primary me-2"></i>Agendamento do Servico</h4>
                        <span class="text-muted small">Sem refresh completo</span>
                    </div>
                    <div id="appointment-feedback" class="alert d-none" role="alert"></div>
                    <div id="appointment-section"></div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="fw-bold mb-0"><i class="fas fa-arrows-rotate text-primary me-2"></i>Aditivos de Escopo</h4>
                        <span class="text-muted small">Historico com versoes</span>
                    </div>
                    <div id="scope-change-timeline-section"></div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="fw-bold mb-0"><i class="fas fa-shield-heart text-primary me-2"></i>Historico de Garantia</h4>
                        <span class="text-muted small">Linha do tempo completa</span>
                    </div>
                    <div id="warranty-timeline-section"></div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="fw-bold mb-0"><i class="fas fa-scale-balanced text-primary me-2"></i>Historico de Disputas</h4>
                        <span class="text-muted small">Mediacao e evidencias</span>
                    </div>
                    <div id="dispute-timeline-section"></div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="fw-bold mb-0"><i class="fas fa-camera-retro text-primary me-2"></i>Evidencias do Servico</h4>
                        <span class="text-muted small">Ordenacao temporal</span>
                    </div>
                    <div id="evidence-timeline-section"></div>
                </div>
            </div>

            <h4 class="fw-bold mb-4 mt-5">
                <i class="fas fa-hand-holding-usd text-success me-2"></i>
                Propostas Recebidas (<span id="proposals-count">@(proposals?.Count() ?? 0)</span>)
            </h4>

            <div id="proposals-section">
                @if (proposals == null || !proposals.Any())
                {
                    <div class="card border-0 shadow-sm p-5 text-center bg-white rounded-4">
                        <div class="mb-3 text-muted">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Procurando...</span>
                            </div>
                        </div>
                        <h5>Buscando profissionais disponiveis...</h5>
                        <p class="text-muted">Nossa rede esta sendo notificada. Aguarde alguns minutos para receber os primeiros orcamentos.</p>
                    </div>
                }
                else
                {
                    <div class="row g-4">
                        @foreach (var prop in proposals)
                        {
                            providerReputations.TryGetValue(prop.ProviderId, out var providerReputation);
                            var hasProviderReviews = providerReputation != null && providerReputation.TotalReviews > 0;
                            var providerAverageRatingLabel = hasProviderReviews
                                ? providerReputation!.AverageRating.ToString("0.0", new System.Globalization.CultureInfo("pt-BR"))
                                : "Novo";
                            var providerReviewCountLabel = hasProviderReviews
                                ? $"{providerReputation!.TotalReviews} avaliacoes"
                                : "sem avaliacoes";
                            <div class="col-12">
                                <div class="card border-0 shadow-sm @(prop.Accepted ? "border border-success bg-success-subtle" : "bg-white") rounded-4 transition-hover">
                                    <div class="card-body p-4">
                                        <div class="row align-items-center g-3">
                                            <div class="col-md-1">
                                                <img src="https://ui-avatars.com/api/?name=@prop.ProviderName&background=random" class="rounded-circle shadow-sm" width="60" alt="Provider">
                                            </div>
                                            <div class="col-md-5 ps-md-4">
                                                <h5 class="fw-bold mb-0">@prop.ProviderName</h5>
                                                <div class="text-warning small mb-1">
                                                    <i class="fas fa-star"></i> @providerAverageRatingLabel <span class="text-muted small fw-normal">(@providerReviewCountLabel)</span>
                                                </div>
                                                <p class="text-muted small mb-0">@prop.Message</p>
                                            </div>
                                            <div class="col-md-3 text-md-center">
                                                <h4 class="fw-bold text-success mb-0">@(prop.EstimatedValue.HasValue ? prop.EstimatedValue.Value.ToString("C") : "A combinar")</h4>
                                                <small class="text-muted">Valor estimado</small>
                                            </div>
                                            <div class="col-md-3 text-end">
                                                <div class="d-grid gap-2 justify-content-end">
                                                    @if (prop.Accepted)
                                                    {
                                                        <button type="button" class="btn btn-success rounded-pill px-4 disabled"><i class="fas fa-check-circle me-1"></i> Aceita</button>
                                                    }
                                                    else
                                                    {
                                                        <form asp-controller="Proposals" asp-action="Accept" method="post">
                                                            <input type="hidden" name="proposalId" value="@prop.Id">
                                                            <button type="submit" class="btn btn-primary rounded-pill px-4">Aceitar Proposta</button>
                                                        </form>
                                                    }

                                                    <button type="button"
                                                            class="btn btn-outline-secondary rounded-pill px-4 open-chat-btn"
                                                            data-provider-id="@prop.ProviderId"
                                                            data-provider-name="@prop.ProviderName">
                                                        Conversar com o Prestador
                                                    </button>
                                                    <a asp-controller="PublicProfiles"
                                                       asp-action="Provider"
                                                       asp-route-providerId="@prop.ProviderId"
                                                       class="btn btn-outline-primary rounded-pill px-4">
                                                        Ver perfil publico
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm bg-white p-4 mb-4">
                <h6 class="fw-bold mb-3"><i class="fas fa-shield-alt text-primary me-2"></i> Dicas de Seguranca</h6>
                <ul class="list-unstyled small mb-0">
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Compare o preco e as avaliacoes do profissional.</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Tire todas as duvidas pelo chat antes de aceitar.</li>
                    <li><i class="fas fa-check text-success me-2"></i> Nunca antecipe pagamentos fora da plataforma.</li>
                </ul>
            </div>

            <div class="card border-0 shadow-sm bg-white p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0">
                        <i class="fas fa-credit-card text-primary me-2"></i>Pagamento do Servico
                    </h6>
                    <span class="text-muted small">Retry + troca de metodo</span>
                </div>
                <div class="small text-muted mb-3">
                    Se houver falha, tente novamente ou troque entre PIX e Cartao.
                </div>

                <div id="payment-provider-select-wrapper" class="mb-3 d-none">
                    <label class="form-label fw-semibold small" for="payment-provider-select">Prestador para pagamento</label>
                    <select id="payment-provider-select" class="form-select form-select-sm"></select>
                </div>

                <div class="d-grid gap-2 mb-3">
                    <button type="button" id="pay-with-pix-btn" class="btn btn-success rounded-pill" @(canStartPayment ? "" : "disabled")>
                        <i class="fas fa-qrcode me-1"></i>Pagar com PIX
                    </button>
                    <button type="button" id="pay-with-card-btn" class="btn btn-primary rounded-pill" @(canStartPayment ? "" : "disabled")>
                        <i class="fas fa-credit-card me-1"></i>Pagar com Cartao
                    </button>
                </div>

                <div id="payment-checkout-feedback" class="alert d-none py-2 px-3 mb-2 small"></div>
                <div id="payment-checkout-last-attempt" class="small text-muted"></div>
            </div>

            <div class="card border-0 shadow-sm bg-white p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0">
                        <i class="fas fa-receipt text-success me-2"></i>Comprovantes de Pagamento
                    </h6>
                    <span class="text-muted small">HTML/PDF</span>
                </div>
                <div id="payment-receipts-section" class="small text-muted">
                    Carregando comprovantes...
                </div>
            </div>

            @if (string.Equals(Model.Status, "Completed", StringComparison.OrdinalIgnoreCase) ||
                 string.Equals(Model.Status, "Validated", StringComparison.OrdinalIgnoreCase))
            {
                <div class="card border-0 shadow-sm bg-white p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold mb-0">
                            <i class="fas fa-star text-warning me-2"></i>Avaliar Prestador
                        </h6>
                    </div>

                    @if (Model.Rating.HasValue)
                    {
                        <div class="small text-muted mb-2">Voce ja avaliou este atendimento.</div>
                        <div class="text-warning mb-2">
                            @for (var i = 1; i <= 5; i++)
                            {
                                <i class="fas fa-star @(i <= Model.Rating.Value ? string.Empty : "text-secondary opacity-25")"></i>
                            }
                        </div>
                        @if (!string.IsNullOrWhiteSpace(Model.ReviewComment))
                        {
                            <p class="small mb-0">"@Model.ReviewComment"</p>
                        }
                    }
                    else
                    {
                        <div class="small text-muted mb-3">Servico concluido. Compartilhe sua experiencia com o prestador.</div>
                        <button type="button" class="btn btn-outline-warning rounded-pill w-100" data-bs-toggle="modal" data-bs-target="#clientReviewModal">
                            Avaliar agora
                        </button>
                    }
                </div>
            }

            <div class="card border-0 shadow-sm bg-dark text-white p-4">
                <h6 class="fw-bold mb-3">Precisa de ajuda?</h6>
                <p class="small mb-3">Nossa equipe de suporte esta online para te auxiliar com qualquer duvida sobre seu pedido.</p>
                <button class="btn btn-outline-light btn-sm rounded-pill w-100">Falar com Suporte</button>
            </div>
        </div>
    </div>
</div>

@if ((string.Equals(Model.Status, "Completed", StringComparison.OrdinalIgnoreCase) ||
      string.Equals(Model.Status, "Validated", StringComparison.OrdinalIgnoreCase)) &&
     !Model.Rating.HasValue)
{
    <div class="modal fade" id="clientReviewModal" tabindex="-1" aria-labelledby="clientReviewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="SubmitProviderReview" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="clientReviewModalLabel">Avaliar prestador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="requestId" value="@Model.Id" />
                        <div class="mb-3">
                            <label class="form-label fw-semibold" for="client-review-rating">Nota</label>
                            <select id="client-review-rating" name="rating" class="form-select" required>
                                <option value="">Selecione</option>
                                <option value="5">5 - Excelente</option>
                                <option value="4">4 - Muito bom</option>
                                <option value="3">3 - Bom</option>
                                <option value="2">2 - Regular</option>
                                <option value="1">1 - Ruim</option>
                            </select>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-semibold" for="client-review-comment">Comentario (opcional)</label>
                            <textarea id="client-review-comment" name="comment" rows="4" maxlength="500" class="form-control" placeholder="Conte como foi seu atendimento."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning rounded-pill px-4">Enviar avaliacao</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
<script>
    window.serviceRequestDetailsConfig = {
        requestId: "@Model.Id",
        paymentReceiptsDataUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("PaymentReceiptsData", "ServiceRequests", new { id = Model.Id }))),
        paymentReceiptBaseUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("PaymentReceipt", "ServiceRequests"))),
        paymentCheckoutUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("CreatePaymentCheckout", "ServiceRequests"))),
        simulatePaymentResultUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Url.Action("SimulatePaymentResult", "ServiceRequests"))),
        acceptedProviders: @Html.Raw(acceptedProvidersJson),
        providerReputations: @Html.Raw(providerReputationsJson),
        initialAppointments: @Html.Raw(initialAppointmentsJson),
        initialEvidences: @Html.Raw(initialEvidencesJson),
        initialScopeChanges: @Html.Raw(initialScopeChangesJson),
        initialWarrantyClaims: @Html.Raw(initialWarrantyClaimsJson),
        initialDisputes: @Html.Raw(initialDisputesJson),
        initialAppointment: @Html.Raw(initialAppointmentJson),
        initialStatus: "@Model.Status"
    };
</script>
<script src="~/js/views/service-requests/details.js" asp-append-version="true"></script>
}
