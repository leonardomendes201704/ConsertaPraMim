name: backend-api

services:
  api:
    container_name: cpm-api
    build:
      context: .
      dockerfile: docker/vps/Dockerfile.api
    restart: unless-stopped
    ports:
      - "${API_PORT:-5193}:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: "${APP_ENVIRONMENT:-Development}"
      ASPNETCORE_URLS: "http://+:8080"
      VPS_PUBLIC_HOST: "${VPS_PUBLIC_HOST}"
      ADMIN_PORT: "${ADMIN_PORT:-5151}"
      CLIENT_PORT: "${CLIENT_PORT:-5069}"
      PROVIDER_PORT: "${PROVIDER_PORT:-5140}"
      DOTNET_SYSTEM_GLOBALIZATION_INVARIANT: "false"
      LANG: "pt_BR.UTF-8"
      LC_ALL: "pt_BR.UTF-8"
      ConnectionStrings__DefaultConnection: "Server=${DB_HOST:-mssql},1433;Database=${DB_NAME};User Id=${DB_USER};Password='${DB_PASSWORD}';TrustServerCertificate=True;Encrypt=True;MultipleActiveResultSets=True;Connection Timeout=30;"
      JwtSettings__SecretKey: "${JWT_SECRET_KEY}"
      JwtSettings__Issuer: "ConsertaPraMim"
      JwtSettings__Audience: "ConsertaPraMimWebApps"
      Seed__Enabled: "true"
      Seed__Reset: "false"
      Seed__CreateDefaultAdmin: "true"
      Seed__DefaultPassword: "${SEED_DEFAULT_PASSWORD}"
      Seed__ResetSecurityCode: "${SEED_RESET_SECURITY_CODE:-}"
      Cors__AllowedOrigins__0: "http://${VPS_PUBLIC_HOST}:${ADMIN_PORT:-5151}"
      Cors__AllowedOrigins__1: "http://${VPS_PUBLIC_HOST}:${CLIENT_PORT:-5069}"
      Cors__AllowedOrigins__2: "http://${VPS_PUBLIC_HOST}:${PROVIDER_PORT:-5140}"
      Cors__AllowedOrigins__3: "http://localhost:${ADMIN_PORT:-5151}"
      Cors__AllowedOrigins__4: "http://localhost:${CLIENT_PORT:-5069}"
      Cors__AllowedOrigins__5: "http://localhost:${PROVIDER_PORT:-5140}"
      PushNotifications__Firebase__ServiceAccountPath: "${FIREBASE_SERVICE_ACCOUNT_PATH:-}"
    volumes:
      - api_uploads:/app/wwwroot/uploads
    networks:
      - conserta_net

volumes:
  api_uploads:

networks:
  conserta_net:
    external: true
