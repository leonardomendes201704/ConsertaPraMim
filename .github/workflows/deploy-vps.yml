name: Deploy VPS

on:
  push:
    branches: ["master", "main"]
  workflow_dispatch:

concurrency:
  group: deploy-vps
  cancel-in-progress: false

jobs:
  targets:
    name: Resolve Deploy Targets
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 10
    outputs:
      deploy_api: ${{ steps.targets.outputs.deploy_api }}
      deploy_web_admin: ${{ steps.targets.outputs.deploy_web_admin }}
      deploy_web_client: ${{ steps.targets.outputs.deploy_web_client }}
      deploy_web_provider: ${{ steps.targets.outputs.deploy_web_provider }}
      any: ${{ steps.targets.outputs.any }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate required secrets
        shell: bash
        run: |
          missing=0
          [ -n "${{ secrets.VPS_PUBLIC_HOST }}" ] || { echo "::error::Missing secret VPS_PUBLIC_HOST"; missing=1; }
          [ -n "${{ secrets.VPS_DB_PASSWORD }}" ] || { echo "::error::Missing secret VPS_DB_PASSWORD"; missing=1; }
          [ -n "${{ secrets.JWT_SECRET_KEY }}" ] || { echo "::error::Missing secret JWT_SECRET_KEY"; missing=1; }
          [ -n "${{ secrets.SEED_DEFAULT_PASSWORD }}" ] || { echo "::error::Missing secret SEED_DEFAULT_PASSWORD"; missing=1; }
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Detect changed projects
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            global:
              - '.github/workflows/deploy-vps.yml'
              - 'scripts/deploy/**'
              - 'Backend/.env.vps.example'
              - 'Backend/DEPLOY_VPS.md'
              - 'Backend/docker-compose.vps.yml'
              - 'Backend/docker-compose.vps.api.yml'
              - 'Backend/docker-compose.vps.web-admin.yml'
              - 'Backend/docker-compose.vps.web-client.yml'
              - 'Backend/docker-compose.vps.web-provider.yml'
            api:
              - 'Backend/src/ConsertaPraMim.API/**'
              - 'Backend/src/ConsertaPraMim.Application/**'
              - 'Backend/src/ConsertaPraMim.Domain/**'
              - 'Backend/src/ConsertaPraMim.Infrastructure/**'
              - 'Backend/docker/vps/Dockerfile.api'
            web_admin:
              - 'Backend/src/ConsertaPraMim.Web.Admin/**'
              - 'Backend/src/ConsertaPraMim.Application/**'
              - 'Backend/src/ConsertaPraMim.Domain/**'
              - 'Backend/docker/vps/Dockerfile.web.admin'
            web_client:
              - 'Backend/src/ConsertaPraMim.Web.Client/**'
              - 'Backend/src/ConsertaPraMim.Application/**'
              - 'Backend/src/ConsertaPraMim.Domain/**'
              - 'Backend/docker/vps/Dockerfile.web.client'
            web_provider:
              - 'Backend/src/ConsertaPraMim.Web.Provider/**'
              - 'Backend/src/ConsertaPraMim.Application/**'
              - 'Backend/src/ConsertaPraMim.Domain/**'
              - 'Backend/docker/vps/Dockerfile.web.provider'

      - name: Resolve deploy targets
        id: targets
        shell: bash
        run: |
          deploy_api="${{ steps.changes.outputs.api }}"
          deploy_web_admin="${{ steps.changes.outputs.web_admin }}"
          deploy_web_client="${{ steps.changes.outputs.web_client }}"
          deploy_web_provider="${{ steps.changes.outputs.web_provider }}"

          if [[ "${{ steps.changes.outputs.global }}" == "true" ]]; then
            deploy_api="true"
            deploy_web_admin="true"
            deploy_web_client="true"
            deploy_web_provider="true"
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            deploy_api="true"
            deploy_web_admin="true"
            deploy_web_client="true"
            deploy_web_provider="true"
          fi

          any="false"
          if [[ "$deploy_api" == "true" || "$deploy_web_admin" == "true" || "$deploy_web_client" == "true" || "$deploy_web_provider" == "true" ]]; then
            any="true"
          fi

          echo "deploy_api=$deploy_api" >> "$GITHUB_OUTPUT"
          echo "deploy_web_admin=$deploy_web_admin" >> "$GITHUB_OUTPUT"
          echo "deploy_web_client=$deploy_web_client" >> "$GITHUB_OUTPUT"
          echo "deploy_web_provider=$deploy_web_provider" >> "$GITHUB_OUTPUT"
          echo "any=$any" >> "$GITHUB_OUTPUT"

  deploy-api:
    name: Deploy API
    needs: targets
    if: needs.targets.outputs.deploy_api == 'true'
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Write VPS env file
        shell: bash
        run: |
          APP_ENVIRONMENT_VALUE="${{ secrets.VPS_APP_ENVIRONMENT }}"
          if [[ -z "$APP_ENVIRONMENT_VALUE" ]]; then
            APP_ENVIRONMENT_VALUE="Production"
          fi

          cat > Backend/.env.vps <<EOF
          APP_ENVIRONMENT=$APP_ENVIRONMENT_VALUE
          VPS_PUBLIC_HOST=${{ secrets.VPS_PUBLIC_HOST }}
          API_PORT=5193
          ADMIN_PORT=5151
          CLIENT_PORT=5069
          PROVIDER_PORT=5140
          DB_NAME=ConsertaPraMimDb
          DB_USER=sa
          DB_PASSWORD=${{ secrets.VPS_DB_PASSWORD }}
          DB_HOST=${{ secrets.VPS_DB_HOST }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          SEED_DEFAULT_PASSWORD=${{ secrets.SEED_DEFAULT_PASSWORD }}
          FIREBASE_SERVICE_ACCOUNT_PATH=${{ secrets.FIREBASE_SERVICE_ACCOUNT_PATH }}
          EOF

      - name: Deploy API
        shell: bash
        run: |
          chmod +x scripts/deploy/vps-deploy-service.sh
          export MSSQL_CONTAINER_NAME="${{ secrets.VPS_MSSQL_CONTAINER_NAME }}"
          export MSSQL_HOST_ALIAS="${{ secrets.VPS_MSSQL_HOST_ALIAS }}"
          export SKIP_GIT_PULL=1
          ./scripts/deploy/vps-deploy-service.sh "$GITHUB_WORKSPACE" api

  deploy-web-admin:
    name: Deploy Web Admin
    needs: targets
    if: needs.targets.outputs.deploy_web_admin == 'true'
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Write VPS env file
        shell: bash
        run: |
          APP_ENVIRONMENT_VALUE="${{ secrets.VPS_APP_ENVIRONMENT }}"
          if [[ -z "$APP_ENVIRONMENT_VALUE" ]]; then
            APP_ENVIRONMENT_VALUE="Production"
          fi

          cat > Backend/.env.vps <<EOF
          APP_ENVIRONMENT=$APP_ENVIRONMENT_VALUE
          VPS_PUBLIC_HOST=${{ secrets.VPS_PUBLIC_HOST }}
          API_PORT=5193
          ADMIN_PORT=5151
          CLIENT_PORT=5069
          PROVIDER_PORT=5140
          DB_NAME=ConsertaPraMimDb
          DB_USER=sa
          DB_PASSWORD=${{ secrets.VPS_DB_PASSWORD }}
          DB_HOST=${{ secrets.VPS_DB_HOST }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          SEED_DEFAULT_PASSWORD=${{ secrets.SEED_DEFAULT_PASSWORD }}
          FIREBASE_SERVICE_ACCOUNT_PATH=${{ secrets.FIREBASE_SERVICE_ACCOUNT_PATH }}
          EOF

      - name: Deploy Web Admin
        shell: bash
        run: |
          chmod +x scripts/deploy/vps-deploy-service.sh
          export MSSQL_CONTAINER_NAME="${{ secrets.VPS_MSSQL_CONTAINER_NAME }}"
          export MSSQL_HOST_ALIAS="${{ secrets.VPS_MSSQL_HOST_ALIAS }}"
          export SKIP_GIT_PULL=1
          ./scripts/deploy/vps-deploy-service.sh "$GITHUB_WORKSPACE" web-admin

  deploy-web-client:
    name: Deploy Web Client
    needs: targets
    if: needs.targets.outputs.deploy_web_client == 'true'
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Write VPS env file
        shell: bash
        run: |
          APP_ENVIRONMENT_VALUE="${{ secrets.VPS_APP_ENVIRONMENT }}"
          if [[ -z "$APP_ENVIRONMENT_VALUE" ]]; then
            APP_ENVIRONMENT_VALUE="Production"
          fi

          cat > Backend/.env.vps <<EOF
          APP_ENVIRONMENT=$APP_ENVIRONMENT_VALUE
          VPS_PUBLIC_HOST=${{ secrets.VPS_PUBLIC_HOST }}
          API_PORT=5193
          ADMIN_PORT=5151
          CLIENT_PORT=5069
          PROVIDER_PORT=5140
          DB_NAME=ConsertaPraMimDb
          DB_USER=sa
          DB_PASSWORD=${{ secrets.VPS_DB_PASSWORD }}
          DB_HOST=${{ secrets.VPS_DB_HOST }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          SEED_DEFAULT_PASSWORD=${{ secrets.SEED_DEFAULT_PASSWORD }}
          FIREBASE_SERVICE_ACCOUNT_PATH=${{ secrets.FIREBASE_SERVICE_ACCOUNT_PATH }}
          EOF

      - name: Deploy Web Client
        shell: bash
        run: |
          chmod +x scripts/deploy/vps-deploy-service.sh
          export MSSQL_CONTAINER_NAME="${{ secrets.VPS_MSSQL_CONTAINER_NAME }}"
          export MSSQL_HOST_ALIAS="${{ secrets.VPS_MSSQL_HOST_ALIAS }}"
          export SKIP_GIT_PULL=1
          ./scripts/deploy/vps-deploy-service.sh "$GITHUB_WORKSPACE" web-client

  deploy-web-provider:
    name: Deploy Web Provider
    needs: targets
    if: needs.targets.outputs.deploy_web_provider == 'true'
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Write VPS env file
        shell: bash
        run: |
          APP_ENVIRONMENT_VALUE="${{ secrets.VPS_APP_ENVIRONMENT }}"
          if [[ -z "$APP_ENVIRONMENT_VALUE" ]]; then
            APP_ENVIRONMENT_VALUE="Production"
          fi

          cat > Backend/.env.vps <<EOF
          APP_ENVIRONMENT=$APP_ENVIRONMENT_VALUE
          VPS_PUBLIC_HOST=${{ secrets.VPS_PUBLIC_HOST }}
          API_PORT=5193
          ADMIN_PORT=5151
          CLIENT_PORT=5069
          PROVIDER_PORT=5140
          DB_NAME=ConsertaPraMimDb
          DB_USER=sa
          DB_PASSWORD=${{ secrets.VPS_DB_PASSWORD }}
          DB_HOST=${{ secrets.VPS_DB_HOST }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          SEED_DEFAULT_PASSWORD=${{ secrets.SEED_DEFAULT_PASSWORD }}
          FIREBASE_SERVICE_ACCOUNT_PATH=${{ secrets.FIREBASE_SERVICE_ACCOUNT_PATH }}
          EOF

      - name: Deploy Web Provider
        shell: bash
        run: |
          chmod +x scripts/deploy/vps-deploy-service.sh
          export MSSQL_CONTAINER_NAME="${{ secrets.VPS_MSSQL_CONTAINER_NAME }}"
          export MSSQL_HOST_ALIAS="${{ secrets.VPS_MSSQL_HOST_ALIAS }}"
          export SKIP_GIT_PULL=1
          ./scripts/deploy/vps-deploy-service.sh "$GITHUB_WORKSPACE" web-provider

  skip:
    name: Skip Deploy
    needs: targets
    if: needs.targets.outputs.any != 'true'
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 5
    steps:
      - name: Skip deploy (no relevant changes)
        shell: bash
        run: |
          echo "Nenhuma alteracao nos projetos de deploy. Nada a publicar."
