name: Deploy VPS

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          missing=0
          [ -n "${{ secrets.VPS_PUBLIC_HOST }}" ] || { echo "::error::Missing secret VPS_PUBLIC_HOST"; missing=1; }
          [ -n "${{ secrets.VPS_DB_PASSWORD }}" ] || { echo "::error::Missing secret VPS_DB_PASSWORD"; missing=1; }
          [ -n "${{ secrets.JWT_SECRET_KEY }}" ] || { echo "::error::Missing secret JWT_SECRET_KEY"; missing=1; }
          [ -n "${{ secrets.SEED_DEFAULT_PASSWORD }}" ] || { echo "::error::Missing secret SEED_DEFAULT_PASSWORD"; missing=1; }
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Write VPS env file
        shell: bash
        run: |
          cat > Backend/.env.vps <<'EOF'
          APP_ENVIRONMENT=Development
          VPS_PUBLIC_HOST=${{ secrets.VPS_PUBLIC_HOST }}
          API_PORT=5193
          ADMIN_PORT=5151
          CLIENT_PORT=5069
          PROVIDER_PORT=5140
          DB_NAME=ConsertaPraMimDb
          DB_USER=sa
          DB_PASSWORD=${{ secrets.VPS_DB_PASSWORD }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          SEED_DEFAULT_PASSWORD=${{ secrets.SEED_DEFAULT_PASSWORD }}
          FIREBASE_SERVICE_ACCOUNT_PATH=${{ secrets.FIREBASE_SERVICE_ACCOUNT_PATH }}
          EOF

      - name: Deploy on self-hosted runner
        shell: bash
        run: |
          chmod +x scripts/deploy/vps-deploy.sh
          export MSSQL_CONTAINER_NAME="${{ secrets.VPS_MSSQL_CONTAINER_NAME }}"
          export SKIP_GIT_PULL=1
          ./scripts/deploy/vps-deploy.sh "$GITHUB_WORKSPACE"
